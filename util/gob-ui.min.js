
bombermine.config(function($httpProvider){$httpProvider.defaults.headers.common["X-Requested-With"]="XMLHttpRequest";});bombermine.config(['$stateProvider','$urlRouterProvider',function($stateProvider,$urlRouterProvider){$urlRouterProvider.deferIntercept();}])
bombermine.config(['ngClipProvider',function(ngClipProvider){ngClipProvider.setPath("/js/lib/ZeroClipboard.swf");}]).run(function($rootScope,$urlRouter,$state,community){$rootScope.$on('$locationChangeSuccess',function(evt,newUrl,oldUrl){evt.preventDefault();if(newUrl.indexOf('/#/forum/')===-1||$state.current.name!=='forum'){$urlRouter.sync();}else{if(newUrl.split('/#/forum/')[1].length===0){var $iframe=$('#community_iframe');if($iframe.length==1){community.post({type:'goHome'});}}}});$urlRouter.listen();});
function CensorManager(){var censors={};var MIN_SIGNIF_PART=0.25;var NICK_SIGNIF_LENGTH=2;this.process=function(str,nicks,languages){if(!languages||languages.length==0)
return str;updateNickExp(nicks);var parts=splitByNicks(str,nicks,nickExp);if(languages.indexOf("caps")>=0)
removeCaps(parts);var partsLength=0;for(var i=0;i<parts.length;i++){if(parts[i].nick)
continue;parts[i].str=shortenAAAAAA(parts[i].str,10);partsLength+=str.length;}
function checkCondition(condition){if(!condition)
return true;for(var i=0;i<parts.length;i++){if(!parts[i].nick&&parts[i].str.search(condition)>=0)
return true;}
return false;}
for(var j=0;j<languages.length;j++){var lang=languages[j].replace("?","");var config=this.configs[lang];if(!config)
continue;if(lang!=languages[j]&&!checkCondition(config.condition))
continue;if(!censors[lang])
censors[lang]=new Censor(config);var bad=false;var signifLength=0;for(var i=0;i<parts.length;i++){if(parts[i].nick){signifLength+=NICK_SIGNIF_LENGTH;continue;}
if(parts[i].str.search(/\S/)<0)
continue;var res=censors[lang].process(parts[i]);if(res.evil)
return"";signifLength=signifLength+(res.signifLength||0);bad=bad||res.bad;}
if(bad&&signifLength<partsLength*MIN_SIGNIF_PART)
return"";}
var result="";for(var i=0;i<parts.length;i++)
result+=parts[i].str;return result;}
var escapeAllExp=/([\(\{\[\)\}\]\/\|\*\+\?\-\$\^\:\=\!\\])/g;function escapeAll(str){return str.replace(escapeAllExp,"\\$1");}
var nickExp;var lastNicksLength=0;function updateNickExp(nicks){if(lastNicksLength==nicks.length)
return;lastNicksLength=nicks.length;if(nicks.length){var pat="";for(var i=0;i<nicks.length;i++)
pat+=(i?"|":"")+"@"+escapeAll(nicks[i]);nickExp=new RegExp(pat,"g");}else
nickExp=null;}
function splitByNicks(str,nicks,nickExp){var parts=[];while(str!=""){var ind=nickExp?str.search(nickExp):-1;if(ind<0){parts.push({nick:false,str:str});break;}
var nickEnd;for(var i=0;i<nicks.length;i++){nickEnd=ind+1+nicks[i].length;if(str.substring(ind+1,nickEnd)==nicks[i])
break;}
if(ind>0){parts.push({nick:false,str:str.substring(0,ind)});}
parts.push({nick:true,str:str.substring(ind,nickEnd)});str=str.substring(nickEnd);}
return parts;}
function removeCaps(parts){var totalCAPS=0;var totalLow=0;for(var i=0;i<parts.length;i++){if(parts[i].nick)
continue;var str=parts[i].str;var strCAPS=str.toUpperCase();var strLow=str.toLowerCase();for(var j=0;j<str.length;j++){if(str[j]!=strCAPS[j])
totalLow++;else if(str[j]!=strLow[j])
totalCAPS++;}}
if(totalCAPS<=2||(totalLow>0&&totalCAPS<=15))
return;for(var i=0;i<parts.length;i++){if(!parts[i].nick)
parts[i].str=parts[i].str.toLowerCase();}}
function shortenAAAAAA(str,max){if(str.length==0)
return"";var result=str[0];var counter=1;for(var i=1;i<str.length;i++){counter=str[i]==str[i-1]?counter+1:1;if(counter<=max)
result+=str[i];}
return result;}}
CensorManager.prototype.configs={};function Censor(config_){function createTransMap(from,to){var map={};for(var i=0;i<from.length;i++){map[from[i]]=to[i];}
return map;}
function expandPattern(s,options,chars){function expandCharSet(s){if(s==='.'){return{value:'.',canMergeWithSep:false,hasSep:true}}
var res="";var chng=false;var noBrackets=s[0]!=='[';var canMergeWithSep=options.separators&&(noBrackets||s[1]!=='^');var hasSep=false;for(var i=0;i<s.length;i++){var c=s[i];if(c==='\\'){i++;res+=c+s[i];}else{if(chars[c]){res+=chars[c];chng=true;}else if(canMergeWithSep&&c===' '){res+=config.separatorChars;hasSep=true;chng=true;}else{res+=c;}}}
return{value:(noBrackets&&chng)?'['+res+']':res,canMergeWithSep:canMergeWithSep,hasSep:hasSep}}
function separatorForItem(item){return item.hasSep?item.value:'['+config.separatorChars+
(item.canMergeWithSep?(item.value[0]==='['?item.value.substr(1)+'*':item.value+']*'):']*');}
function setSep(i,before,after){items[i].canSepAfter=items[i].canSepBefore=false;items[i].sepBefore=before;items[i].sepAfter=after;}
var stackLength=0;var items=[];var sectionStart;var composite=false;for(var i=0;i<s.length;i++){var c=s[i];var quant=null;if(stackLength==0){if("([{".indexOf(c)>=0){sectionStart=i;stackLength++;}else if("*+?".indexOf(c)>=0){quant=c;}else if("^$|".indexOf(c)>=0){items.push({value:c,nonString:true});composite=composite||c=='|';}else{if(c=='\\'){c+=s[++i];}else if(c==' ')
c="\\s";items.push(expandCharSet(c));}}else{if(c=='\\'){i++;}else if("([{".indexOf(c)>=0){stackLength++;}else if(")]}".indexOf(c)>=0){stackLength--;if(stackLength==0){switch(c){case")":var nonCapturing=s[sectionStart+1]=='?';var lookAhead=nonCapturing&&"=!".indexOf(s[sectionStart+2])>=0;var innerStart=sectionStart+(nonCapturing?3:1);items.push({value:s.substring(sectionStart,innerStart)+
expandPattern(s.substring(innerStart,i),options,chars).str+")",nonString:lookAhead,quant:""});break;case"]":items.push(expandCharSet(s.substring(sectionStart,i+1)));break;case"}":quant=s.substring(sectionStart,i+1);break;}}}}
if(quant){if(s[i+1]=='?'){quant+='?';i++;}
items[items.length-1].quant=quant;}}
if(stackLength!=0)
throw"censor: stackLength != 0 "+s;for(var i=0;i<items.length;i++){var item=items[i];if(!item.nonString){var q=item.quant;if(options.repeat&&q==null)
q=item.quant="+";item.quantPositive=q==null||q==""||q[0]=='+'||(q[0]=='{'&&q[1]!='0');item.quantInfinite=q&&q.match(/\+|\{\d+\,\}/);item.canMergeWithSep=item.canMergeWithSep&&item.quantInfinite;}}
if(options.separators){var f=false;for(var i=items.length-1;i>=0;i--){items[i].canSepAfter=f;f=!items[i].nonString&&(f||items[i].quantPositive);}
f=false;for(var i=0;i<items.length;i++){items[i].canSepBefore=f;f=!items[i].nonString&&(f||items[i].quantPositive);}
for(var i=0;i<items.length-1;i++){items[i].canSepAfter=items[i].canSepAfter&&items[i+1].canSepBefore;items[i+1].canSepBefore=items[i+1].canSepBefore&&items[i].canSepAfter;}
for(var i=0;i<items.length;i++){var item=items[i];if(item.hasSep)
setSep(i,true,true);else if(item.canMergeWithSep&&options.repeat){if(!item.canSepAfter&&item.canSepBefore)
setSep(i,true);else if(item.canSepAfter&&!item.canSepBefore)
setSep(i,false,true);}}
for(var i=1;i<items.length;i++){if(items[i].canMergeWithSep&&items[i].canSepAfter&&items[i-1].sepAfter)
setSep(i,false,true);}
for(var i=items.length-2;i>=0;i--){if(items[i].canMergeWithSep&&items[i].canSepBefore&&items[i+1].sepBefore)
setSep(i,true);}
for(var i=1;i<items.length;i++){if(items[i].canSepBefore&&!items[i-1].sepAfter)
setSep(i,true);else if(items[i-1].canSepAfter&&!items[i].sepBefore)
setSep(i-1,false,true);}
if(options.repeat){for(var i=0;i<items.length;i++){if(items[i].canMergeWithSep){if(items[i].canSepBefore)
setSep(i,true);else if(items[i].canSepAfter)
setSep(i,false,true);}}}}
var dst="";for(var i=0;i<items.length;i++){var item=items[i];if(item.nonString){dst+=item.value;}else{var t="";if(item.sepBefore&&!item.hasSep)
t+=separatorForItem(item);t+=item.value;if(item.quant)
t+=items[i].quant;if(item.sepAfter&&!item.hasSep)
t+=separatorForItem(item);dst+=t;}}
return{str:dst,composite:composite};}
function setDefaults(obj,defaults){for(var dkey in defaults){if(obj[dkey]==null){obj[dkey]=defaults[dkey];}}}
function createPatternFor(group,words,chars){var result="";var composite=words.length>1;setDefaults(group,{repeat:true,separators:true,part:" x "});for(var i=0;i<words.length;i++){var v=expandPattern(words[i],group,chars,true);result+=(i?"|":"")+v.str;composite=composite||v.composite;}
function boundaryExp(ch,capt){switch(ch){case' ':return"("+capt+config.wordBoundary+")";case'x':return"("+capt+"\\S)";case'.':return"";default:throw"censor: invalid part "+group.part;}}
var before=boundaryExp(group.part[0],"");var after=boundaryExp(group.part[2],"?=");if((before+after).length){if(composite)
result="(?:"+result+")"
result=before+result+after;}
return result;}
function createTo(group){if(group.part[0]!='.'){var to=group.to;var result="$1";for(var i=0;i<to.length;i++){if(i>0&&to[i-1]=='$')
result+=String.fromCharCode(to.charCodeAt(i)+1);else
result+=to[i];}
return result;}else
return group.to;}
function createRegExps(list,chars){var regExps=[];for(var i=0;i<list.length;i++){var pat=createPatternFor(list[i],list[i].words,chars);var flags="g"+(list[i].sensCase?"":"i");var group={from:new RegExp(pat,flags)};if("     ".search(group.from)>=0||"".search(group.from)>=0){throw"censor: regexp matches an empty string "+group.from;continue;}
if(typeof list[i].to=="string")
group.to=createTo(list[i]);if(list[i].condition)
group.condition=createPatternFor(list[i],list[i].condition,chars);regExps.push(group);}
return regExps;}
function transliterate(str,map){var result="";for(var i=0;i<str.length;i++)
result+=map[str[i]]||str[i];return result;}
this.process=function(part){function replace(str,exps,to){for(var i=0;i<exps.length;i++){var to_=to||exps[i].to;if(to_){if(exps[i].condition&&original.search(exps[i].condition)<0)
continue;str=str.replace(exps[i].from,to_);}}
return str;}
function removeSpaces(){if(part.str.length>=2&&part.str[0]==' '&&part.str[part.str.length-1]==' ')
part.str=part.str.substring(1,part.str.length-1);}
part.str=" "+part.str+" ";var original=part.str;var signifStr=replace(part.str,badExps,"\x07");var bad=(signifStr!=part.str);if(bad)
part.str=replace(part.str,badExps);var signifStr=transliterate(signifStr,transGood);var signifStr=replace(signifStr,insignifExps,"\x07");var signifStr=signifStr.replace(removeInsignifExp," ");var signifStr=signifStr.replace(separatorExp,"");if(signifStr.length==0){removeSpaces();return{bad:bad};}
var newStr=transliterate(part.str,transGood);newStr=replace(newStr,goodExps," ");newStr=transliterate(newStr,transEvil);for(var i=0;i<evilExps.length;i++){if(evilExps[i].condition&&newStr.search(evilExps[i].condition)<0)
continue;if(newStr.search(evilExps[i].from)>=0)
return{evil:true};}
removeSpaces();return{bad:bad,signifLength:signifStr.length};}
var config=config_;var removeInsignifExp=new RegExp("[^"+config.separatorChars+"]*\x07+[^"+config.separatorChars+"]*","g");var separatorExp=new RegExp("["+config.separatorChars+"]*","g");var transGood=createTransMap(config.transGoodFrom,config.transGoodTo);var transEvil=createTransMap(config.transEvilFrom,config.transEvilTo);var badExps=createRegExps(config.bad,config.chars);var insignifExps=createRegExps(config.insignificant,config.chars);var goodExps=createRegExps(config.good,config.chars);var evilExps=createRegExps(config.evil,config.charsBad);}
function inherits(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}});}
function EventEmitter(){this._events=this._events||{};this._maxListeners=this._maxListeners||10;}
EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(!this._events)
this._events={};if(type==='error'){if(!this._events.error||(typeof this._events.error==='object'&&!this._events.error.length)){er=arguments[1];if(er instanceof Error){throw er;}else{throw TypeError('Uncaught, unspecified "error" event.');}
return false;}}
handler=this._events[type];if(typeof handler==='undefined')
return false;if(typeof handler==='function'){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++)
args[i-1]=arguments[i];handler.apply(this,args);}}else if(typeof handler==='object'){len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++)
args[i-1]=arguments[i];listeners=handler.slice();len=listeners.length;for(i=0;i<len;i++)
listeners[i].apply(this,args);}
return true;};EventEmitter.prototype.on=function(type,listener){var m;if(typeof listener!=='function')
throw TypeError('listener must be a function');if(!this._events)
this._events={};if(this._events.newListener)
this.emit('newListener',type,typeof listener.listener==='function'?listener.listener:listener);if(!this._events[type])
this._events[type]=listener;else if(typeof this._events[type]==='object')
this._events[type].push(listener);else
this._events[type]=[this._events[type],listener];if(typeof this._events[type]==='object'&&!this._events[type].warned){m=this._maxListeners;if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error('(node) warning: possible EventEmitter memory '+'leak detected. %d listeners added. '+'Use emitter.setMaxListeners() to increase limit.',this._events[type].length);console.trace();}}
return this;};EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(typeof listener!=='function')
throw TypeError('listener must be a function');if(!this._events||!this._events[type])
return this;list=this._events[type];length=list.length;position=-1;if(list===listener||(typeof list.listener==='function'&&list.listener===listener)){delete this._events[type];if(this._events.removeListener)
this.emit('removeListener',type,listener);}else if(typeof list==='object'){for(i=length;i-->0;){if(list[i]===listener||(list[i].listener&&list[i].listener===listener)){position=i;break;}}
if(position<0)
return this;if(list.length===1){list.length=0;delete this._events[type];}else{list.splice(position,1);}
if(this._events.removeListener)
this.emit('removeListener',type,listener);}
return this;};
bombermine.service("IgnoreService",function($http,$rootScope,Realtime){var ids={},recIds={};Realtime.events.on("chatIgnore",function(msg){if(msg.data){if(msg.data.addedRecId)
recIds[msg.data.addedRecId]=true;if(msg.data.removedRecId)
delete recIds[msg.data.removedRecId];}});function reloadIds(cb){cb=cb||function(){};$http.get("/api/v3/chat/getIgnoreIds").success(function(data,status,headers){console.log("IGNORE DATA: ")
console.log(data)
ids={};for(var i=0;i<data.ids.length;i++)
ids[data.ids[i]]=true;recIds={}
for(var i=0;i<data.recIds.length;i++)
recIds[data.recIds[i]]=true;cb();}).error(function(err){cb(err);});}
function add(troll_id,troll_name,hours,cb){cb=cb||function(){};var req={troll_id:troll_id,troll_name:troll_name,hours:hours};$http.post('/api/v3/chat/addIgnore',req).success(function(){ids[troll_id]=true;cb();}).error(function(err){cb(err);});}
function remove(troll_id,cb){cb=cb||function(){};$http.post('/api/v3/chat/removeIgnore',{troll_id:troll_id}).success(function(){delete ids[troll_id];cb();}).error(function(err){cb(err);});}
reloadIds();return{isIgnored:function(userId){return ids[userId]||recIds[userId];},isIgnoredByMe:function(userId){return ids[userId];},add:add,remove:remove}});
bombermine.service("Keys",function($http,$location,$rootScope,Game){var lock=0,keys=0;var locks={}
function keyLock(name){if(!name)name="default"
if(!locks[name])
lock++;locks[name]=1;keys=0;}
function keyUnlock(name){if(!name)name="default"
if(locks[name])
lock--;locks[name]=0;}
function keyUp(key){var keys2=(keys&~key);if(keys2!=keys){keys=keys2;Game.appInputKeys(keys);}}
function keyDown(key){var keys2=(keys|key);if(keys2!=keys){keys=keys2;if(serv.listener)
serv.listener(keys);Game.appInputKeys(keys);}}
function lockOnTrue(scope,variable,name){if(scope[variable])
keyLock(name)
scope.$watch(variable,function(newValue,oldValue){if(newValue)keyLock(name);else keyUnlock(name);})
scope.$on('$destroy',function(){if(scope[variable])keyUnlock(name)})}
var serv=$rootScope.Keys={lock:keyLock,unlock:keyUnlock,keyUp:keyUp,keyDown:keyDown,isLocked:function(){return lock!=0;},lockOnTrue:lockOnTrue,listener:null}
return serv;});
bombermine.service("Payment",function($http,$location,$rootScope,Social){var errorFunction=function(data,status){if(status>=500){$rootScope.messageBox("server_error",["ok"],function(result){});}else{$rootScope.messageBox(data,["ok"],function(result){});}};var prices=$rootScope.config.plutoPrices;var Payment={prices:prices,plutMin:prices.plut[0],plutMax:prices.plut[prices.plut.length-1],symbol:{"EUR":"€","USD":"$","RUB":String.fromCharCode(0x20BD),"ok":"ОК","JPY":"¥","vk":"голосов","kong":"K"},toPluto:function(money,currency){var x1,x2,y1,y2;var res;var price=prices[currency]
if(money<price[0]){return'min';}else if(money>price[price.length-1]){return'max';}else if(money==''){return false;}
for(var i=1;i<price.length;i++){if(money<=price[i]){x1=price[i-1];x2=price[i];y1=prices.plut[i-1];y2=prices.plut[i];res=(money-x1)*(y2-y1)/(x2-x1)+y1;return Math.floor(res);}}
return false;},toMoney:function(plut,currency){var x1,x2,y1,y2;var res;var price=prices[currency]
if(plut<Payment.plutMin){return'min';}else if(plut>Payment.plutMax){return'max';}else if(plut==''){return false;}
for(var i=1;i<price.length;i++){if(plut<=prices.plut[i]){x1=prices.plut[i-1];x2=prices.plut[i];y1=price[i-1];y2=price[i];res=(plut-x1)*(y2-y1)/(x2-x1)+y1;if(currency=="vk")
return Math.ceil(res);return Math.ceil(res*100)/100;}}
return false;},showPayment:function(calc,goalId){if(config.auth=="vk"&&(typeof goalId==="undefined")){VK.callMethod('showOrderBox',{type:'item',item:'plut_'+calc.plut});}else if(config.auth=="kong"&&(typeof goalId==="undefined")){if($rootScope.user.is_guest)
Social.showRegister()
else
Social.kong.mtx.purchaseItemsRemote("plut_"+calc.plut,function(event){if(event.success){UserService.updateCurrentUser()}})}else if(config.auth=="facebook"){$http.post('/api/v3/facebook/invoice',{amount:+calc.money,currency:calc.currency,plutonium:+calc.plut,goalId:goalId}).success(function(data){FB.ui({method:'pay',action:'purchaseitem',product:data.product,quantity:data.plutonium,request_id:data.invoiceId+''},function(answer){console.log("facebook answer",answer);if(answer.error_code)return;$http.post('/api/v3/facebook/fulfill',{signed_request:answer.signed_request}).success(function(data){UserService.updateCurrentUser();}).error(errorFunction)});}).error(errorFunction)}else if(config.auth=="spil"){$http.post('/api/v3/spil/invoice',{amount:+calc.money,currency:calc.currency,plutonium:+calc.plut,goalId:goalId}).success(function(data){Social.spil.User.getUser(function(userData){var client=new PaymentClient();var options={'siteId':config.siteId,'gameId':258,'userId':userData.displayName,'token':data.invoiceId+'','selectedSku':'plutonium','dynamic_pricing':1,'params':'pluto='+calc.plut};client.showPaymentSelectionScreen(options);})}).error(errorFunction)}else if(config.auth=="ok"){var plut=+calc.plut;var money=+Payment.toMoney(plut,"ok");$http.post('/api/v3/ok/invoice',{amount:money,currency:"ok",plutonium:+calc.plut,goalId:goalId}).success(function(data){var options={name:plut+" плутония",description:"Плутоний позволяет покупать скины, улучшения и поддерживать команду своими взносами",code:data.invoiceId+'',price:money};Social.fapi.UI.showPayment(options.name,options.description,options.code,options.price);}).error(errorFunction)}else
{$http.post('/api/v3/xsollaCheckout',{amount:+calc.money,currency:calc.currency,plutonium:+calc.plut,goalId:goalId}).success(function(data){XPSLightBox.open(data.url,900,650);}).error(errorFunction)}}}
return Payment;});
bombermine.service('Realtime',function($rootScope,$q){var socket=null;var TRY_AFTER_MIN=5000;var TRY_AFTER_MAX=5000;var tryAfter=TRY_AFTER_MIN;function randomUUID(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=='x'?r:(r&0x3|0x8);return v.toString(16);});}
function onopen(){realtime.events.emit("connected","yay");}
function onclose(evt){for(var key in byUUID)
if(byUUID.hasOwnProperty(key)){byUUID[key].reject("server_no_connection");}
byUUID={};socket=null;window.setTimeout(createSocket,tryAfter);tryAfter=Math.min(tryAfter+1000,TRY_AFTER_MAX);}
function createSocket(){var ws=new WebSocket((location.protocol=="https:"?"wss:":"ws:")+"//"+location.host+"/api/v3/user/ws?token="+$rootScope.user.token);ws.onopen=onopen;ws.onclose=onclose;ws.onmessage=onmessage;socket=ws;}
var byUUID={};var ttl=5;function onmessage(event){var msg=JSON.parse(event.data);if(msg.backendAuthError){console.log("backend auth error: "+msg.backendAuthError);return;}
tryAfter=TRY_AFTER_MIN;if(byUUID.hasOwnProperty(msg.uuid)){if(msg.error)byUUID[msg.uuid].reject(msg.error);else byUUID[msg.uuid].resolve(msg.data);delete byUUID[msg.uuid];}else{realtime.events.emit(msg.method,msg);}}
var realtime={onLogin:createSocket,getReadyState:function(){if(ws==null)return 3;return ws.readyState;},ask:function(method,data){var deferred=$q.defer();if(socket==null||socket.readyState!=1){deferred.reject("server_no_connection");return deferred.promise;}
var msg={uuid:randomUUID(),method:method,data:data};socket.send(JSON.stringify(msg));byUUID[msg.uuid]=deferred;return deferred.promise;},send:function(method,data){var msg={uuid:randomUUID(),method:method,data:data};if(socket!=null&&socket.readyState==1)socket.send(JSON.stringify(msg));},events:new EventEmitter()};return realtime;});
bombermine.service("ShopService",function($http,$location,$rootScope,i18nFilter,Game,UserService){var shopmodel={};function setModel(model){shopmodel=model;for(var i=0;i<model.chests.length;i++)
if(model.chests[i].bonus_perk_amount){for(var j=0;j<model.countperks.length;j++){if(model.countperks[j].name==model.chests[i].bonus_perk_name){model.chests[i].bonus_perk_count=model.chests[i].bonus_perk_amount*model.countperks[j].count;}}}
for(var key in model)
if(model.hasOwnProperty(key)){if(model[key]instanceof Array){for(var i=0;i<model[key].length;i++)
model[key][i].type=key;}else{var m2=model[key];for(var key2 in m2)
if(m2.hasOwnProperty(key2)){m2[key2].type=key;}}}
return model;}
setModel($rootScope.config.shopModel)
function updateModel(cb){if(!cb)cb=function(){};if(shopmodel.length==0){shopmodel=$rootScope.config.shopModel;}
$http.get("/api/v3/shopmodel").success(function(data){setModel(data);cb(null,shopmodel);}).error(function(){cb('Error!')})};var getModel=function(){return shopmodel;};var buyItemSrv=function(item,currency,hud,cb){if(!cb)cb=function(){};function myCb(err,data){if(!err){$rootScope.user.plutonium=data.plutonium;$rootScope.user.gold=data.gold;switch(item.type){case"chests":case"timeperks":UserService.updateCurrentUser();break;case"slots":$rootScope.user.slots_limit=item.slotNumber;$rootScope.$broadcast("buyslot");break;}
Game.appInputRejoin();}else
console.log("Server error: "+err);cb(err,data)}
switch(item.type){case'chests':buyChest({hud:hud,name:item.name,currency:currency},myCb);break;case'timeperks':buyTimePerk({hud:hud,name:item.name,hours:1,currency:currency},myCb);break;case'slots':buySlot({hud:hud,slotNumber:item.slotNumber,currency:currency},myCb);break;case'skin_pack':buySkinPack({hud:hud,name:item.name,currency:currency},myCb);break;case'skins':buySkin({hud:hud,name:item.name,price:item.price,currency:currency,days:item.days,mode:item.mode},myCb);break;}};function buyChest(data,cb){query("/api/v3/buyChest",data,function(err,data){if(err)return cb(err);var perks=[],i,j,p;for(i=0;i<data.timeperks.length;i++){p=data.timeperks[i];for(j=0;j<p.amount;j++){perks.push({name:p.name});}}
for(i=0;i<data.roundperks.length;i++){p=data.roundperks[i];for(j=0;j<p.amount;j++){perks.push({name:p.name});}}
for(i=0;i<data.countperks.length;i++){p=data.countperks[i];for(j=0;j<p.amount;j++){perks.push({name:p.name});}}
cb(null,{notification:{title:i18nFilter("open_chest"),text:i18nFilter("your_randomed_perks"),perks:perks,type:"success"},plutonium:data.plutonium,gold:data.gold});});}
function buyTimePerk(data,cb){var id=data.name;query("/api/v3/buyTimePerk",data,function(err,data){if(err)return cb(err);cb(null,{notification:{title:i18nFilter("time_added"),text:i18nFilter("you_ve_bought_1_hour")+" '"+id+"'",type:"success"},plutonium:data.plutonium,gold:data.gold});});}
function buySlot(data,cb){query("/api/v3/buyAdditionalSlot",data,function(err,data){if(err)return cb(err);cb(null,{notification:{title:i18nFilter("slot_unlocked"),text:i18nFilter("you_can_use_new_slot"),type:"success"},slots_limit:data.slotsLimit,plutonium:data.plutonium,gold:data.gold});});}
function buySkinPack(data,cb){query("/api/v3/buySkinPack",data,function(err,data){if(err)return cb(err);cb(null,{notification:{title:i18nFilter("buy_Megapack2"),text:i18nFilter("you_can_use_new_skins"),type:"success"},plutonium:data.plutonium,gold:data.gold});});}
function buySkin(data,cb){query("/api/v3/buySkin",data,function(err,data){if(err)return cb(err);cb(null,{notification:{title:i18nFilter("buy_Megapack2"),text:i18nFilter("you_can_use_new_skins"),type:"success"},plutonium:data.plutonium,gold:data.gold});});}
function query(url,data,cb){$http.post(url,data).success(function(data){cb(null,data);}).error(function(err,status){if(status==0)
cb('server_no_connection')
else if(status>=500)
cb("server_error")
else
cb(err);});}
return{getModel:getModel,buyItemSrv:buyItemSrv,updateModel:updateModel}});
bombermine.service("Sounds",function($http,$location,$rootScope,i18nFilter,Game,UserService,storage){var path="assets/sounds/";var Sounds={mute:!(storage.getItem("sounds")=="true"),howls:{},howlsList:[],events:{},eventsList:[],setMute:function(value){if(Sounds.mute&&!value)
Sounds.reload();Sounds.mute=value;storage.setItem("sounds",!value);},setMuteDontSave:function(value){if(Sounds.mute&&!value)
Sounds.reload();Sounds.mute=value;},isMuted:function(){return Sounds.mute},setVolume:function(value){Howler.volume(value/100.0);storage.setItem("volume",value);},getVolume:function(){return Howler.volume();},init:function(){Howler.volume(storage.getItem("volume",100.0)/100.0)},playRandom:function(){if(Sounds.howlsList.length==0)return;return Sounds.howlsList[Math.random()*Sounds.howlsList.length|0].play();},reload:function(){$http.get("assets/sounds/fx.json").success(function(data){Sounds.howls={};Sounds.howlsList=[];var hh=data.howls;for(var i=0;i<hh.length;i++){var obj=hh[i];if(typeof hh[i]==="string"){obj={name:hh[i],src:[path+hh[i]+".wav"]};}else{for(var j=0;j<obj.src.length;j++)
if(obj.src[j].indexOf("://")<0)
obj.src[j]=path+obj.src[j];}
var howl=new Howl(obj);Sounds.howls[obj.name]=howl;Sounds.howlsList.push(howl);}
var ee=data.events;Sounds.events={};Sounds.eventsList=[];for(var i=0;i<ee.length;i++){var obj=ee[i];if(typeof ee[i]==="string"){obj={name:ee[i],list:[ee[i]]};}
Sounds.events[obj.name]=obj;Sounds.eventsList.push(obj);}}).error(function(err,status){console.log("cant load fx.json file")})},playEvent:function(name,dx,dy,dz){if(Sounds.mute)return;var howl=null;var panner=null;var maxDistance=10000;if(Sounds.events.hasOwnProperty(name)){var ev=Sounds.events[name];panner=ev.panner||null;maxDistance=ev.maxDistance||maxDistance;howl=Sounds.howls[ev.list[Math.random()*ev.list.length|0]];}
if(!howl&&Sounds.howls.hasOwnProperty(name)){howl=Sounds.howls[name];}
if(!howl)return;var p;if(typeof dx!=="undefined"&&panner!=null){if(dx<-maxDistance||dx>maxDistance||dy<-maxDistance||dy>maxDistance||dz<-maxDistance||dz>maxDistance)return;p=howl.play();howl.pannerAttr(panner,p);console.log("sound "+howl._src+" at position ("+dx+","+dy+","+dz+")");howl.pos(dx,dy,dz,p);}else{p=howl.play();}
return p;}};Sounds.init();if(!Sounds.mute)
Sounds.reload();window.Sounds=Sounds;return Sounds;})
bombermine.service("Tracking",function($http,$location,$rootScope){return{track:function(key,value){_gaq.push(['_trackEvent',"user_track_"+key,"user_track_"+key+"_"+value,""]);$http.post("/api/v3/user/track",[{key:key,value:value}])},settings:function(key,value){$http.post("/api/v3/user/settings",[{key:key,value:value}])}}});
bombermine.service("UserService",function($http,$location,$rootScope,Realtime){function setUserData(user){$rootScope.user=user;user.isRegistered=function(){return!this.is_guest&&(this.perm_mask&1);}
user.canBuy=function(){return!this.is_guest;}
if(user.result_code){$rootScope.messageBox(user.result_code,["ok"],function(){});user.result_code=null;}}
function updateCurrentUser(){$http.get("/api/v3/user/current-user").success(function(data,status,headers){setUserData(data);$rootScope.config.token=data.token;})}
function setFullData(data){var oldId=$rootScope.user?$rootScope.user.id:0;var newId=data.user.id;setUserData(data.user);window.config.token=data.user.token;$rootScope.notifications=data.notifications;$rootScope.progress=data.progress;if(oldId==0&&newId!=0){$rootScope.$broadcast("login")}else if(oldId!=0&&newId==0){$rootScope.$broadcast("logout")}else if(oldId!=0&&oldId!=newId){$rootScope.$broadcast("switch")}}
Realtime.events.on("currentUser",function(msg){var data=msg.data;if(data)$rootScope.$apply(function(){data.user.token=data.user.token||$rootScope.user.token;setFullData(data);});});return{updateCurrentUser:updateCurrentUser,isLoggedIn:function(){return $rootScope.user.id!=0},setFullData:setFullData,setUserData:setUserData}});
Utils={getElementRelativePos:function(element,containerElement){var res={x:-containerElement.offsetLeft,y:-containerElement.offsetTop};containerElement=containerElement.offsetParent;while(element!=containerElement){res.x+=element.offsetLeft;res.y+=element.offsetTop;element=element.offsetParent;if(element==null)
return null;}
return res;},scroll:function($scope,element,scrollTop){if(element)
Utils.outOfPhase($scope,function(){element.scrollTop=scrollTop;});},repeatUntilTrue:function(cb,interval,maxTime){interval=interval||50;maxTime=maxTime||20000;function waiter(){if(!cb()&&maxTime>0){maxTime-=interval;setTimeout(waiter,interval);}}
waiter();},whenExist:function(things,cb){if(typeof things!="object"||!things.__proto__.push)
things=[things];Utils.repeatUntilTrue(function(){var res=[];for(var i=0;i<things.length;i++){var v=typeof things[i]=="string"?document.getElementById(things[i]):things[i]();if(!v)
return false;res.push(v);}
cb.apply(window,res);return true;});},apply:function($scope,cb){$scope.$$phase?cb():$scope.$apply(cb)},digest:function($scope){if(!$scope.$$phase)$scope.$digest();},outOfPhase:function($scope,cb){Utils.repeatUntilTrue(function(){return!$scope.$$phase&&(cb()||true);},15);},inNextPhase:function($scope,cb){Utils.outOfPhase($scope,function(){Utils.apply($scope,cb);});},randomElement:function(arr){return arr.length?arr[(Math.random()*arr.length)|0]:null;},validateEmail:function(email){var pattern=/^([a-z0-9_\.-])+@[a-z0-9-]+\.([a-z]{2,4}\.)?[a-z]{2,4}$/i;if(email=="")return"email_must_not_be_empty";if(!pattern.test(email))return"incorrect_email";return false;}}
bombermine.service("actions",function($rootScope,storage,Keys,Game){function InputList(name){this.actionMap={};this.keyMap={};this.name=name;}
InputList.prototype={loadKeyMap:function(keyMap){this.keyMap={};this.actionMap={};for(var action in keyMap)
if(keyMap.hasOwnProperty(action)){this.bind(action,keyMap[action]);}},load:function(def){var res=def;var test=storage.getItem("Input/"+this.name,null);if(test){try{res=JSON.parse(test);}
catch(e){}}
this.loadKeyMap(res);},save:function(){storage.setItem("Input/"+this.name,JSON.stringify(this.keyMap));},bind:function(action,keyCode){this.unbind(action);this.unbindKey(keyCode);this.keyMap[action]=keyCode;this.actionMap[keyCode]=action;},unbind:function(action){var keyCode=this.keyMap[action];if(typeof keyCode!=="undefined"){delete this.actionMap[keyCode];delete this.keyMap[action];}},unbindKey:function(keyCode){var action=this.actionMap[keyCode];if(typeof action!=="undefined"){delete this.actionMap[keyCode];delete this.keyMap[action];}}};function Actions(){this.up={};this.down={};this.list=[];this.defs={kb0:new InputList("key0"),kb1:new InputList("key1"),gp:new InputList("gamepad")};this.inputs={kb:new InputList("keyboard"),gp:new InputList("none")};}
Actions.prototype.add=function(name,kb,gp,fn,fnUp){var def=this.defs;if(kb.length==2){def.kb0.bind(name,kb[0]);def.kb1.bind(name,kb[1]);}else{def.kb1.bind(name,kb[0]);}
if(gp.length==1){def.gp.bind(name,gp[0]);}
this.list.push(name);this.down[name]=fn;if(fnUp)
this.up[name]=fnUp;};Actions.prototype.addDown=function(name,fn){this.down[name]=fn;};Actions.prototype._press=function(type,action){try{this[type][action]&&this[type][action]();}catch(e){console.log('Error while action: ',e);}};Actions.prototype.pressKeyboardUp=function(keyCode){var action=this.defs.kb0.actionMap[keyCode]||this.inputs.kb.actionMap[keyCode];this._press('up',action);};Actions.prototype.pressKeyboardDown=function(keyCode){var action=this.defs.kb0.actionMap[keyCode]||this.inputs.kb.actionMap[keyCode];this._press('down',action);};Actions.prototype.pressGamepadUp=function(action){this._press('up',action);};Actions.prototype.pressGamepadDown=function(action){this._press('down',action);};Actions.prototype.isKeyboardCode=function(keyCode){return(this.defs.kb0.actionMap.hasOwnProperty(keyCode)||this.inputs.kb.actionMap.hasOwnProperty(keyCode))};Actions.prototype.connectGamepad=function(name){var gp=this.inputs.gp=new InputList(name);gp.load(this.defs.gp.keyMap);return gp;};Actions.prototype.getKeyName=function(keyCode){if(typeof keyCode==="undefined")return"";return kbInv[keyCode]||String.fromCharCode(keyCode);};Actions.prototype.getButtonName=function(buttonCode){if(typeof buttonCode==="undefined")return"";if(buttonCode<100)
return'B'+buttonCode;return'AXIS'+((buttonCode-100)>>1)+(buttonCode%2?"-":"+");};Actions.prototype.loadSettings=function(){this.inputs.kb.load(this.defs.kb1.keyMap);this.inputs.gp.load(this.defs.gp.keyMap);};Actions.prototype.saveSettings=function(){this.inputs.kb.save();if(this.inputs.gp.name!="none")
this.inputs.gp.save();};var act=new Actions();var specialKeys={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,SPACE:32,ARROW_LEFT:37,ARROW_UP:38,ARROW_RIGHT:39,ARROW_DOWN:40}
var kbInv={};for(var key in specialKeys){kbInv[specialKeys[key]]=key;}
var kb={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,SPACE:32,ARROW_LEFT:37,ARROW_UP:38,ARROW_RIGHT:39,ARROW_DOWN:40,NUM_1:49,NUM_8:56,A:65,D:68,I:73,K:75,L:76,P:80,Q:81,W:87,S:83,Z:90};act.add('up',[kb.ARROW_UP,kb.W],[103],function(){Keys.keyDown(2);},function(){Keys.keyUp(2);});act.add('down',[kb.ARROW_DOWN,kb.S],[102],function(){Keys.keyDown(8);},function(){Keys.keyUp(8);});act.add('left',[kb.ARROW_LEFT,kb.A],[101],function(){Keys.keyDown(4);},function(){Keys.keyUp(4);});act.add('right',[kb.ARROW_RIGHT,kb.D],[100],function(){Keys.keyDown(1);},function(){Keys.keyUp(1);});act.add('bomb',[kb.SPACE,kb.K],[2],function(){Game.appInputBomb();Keys.keyDown(32);},function(){Keys.keyUp(32);});act.add('observe',[kb.Q],[0],function(){Keys.keyDown(16);},function(){Keys.keyUp(16);});act.add('detonation',[kb.SHIFT,kb.L],[1],function(){Game.appInputDetonation();});act.add('chat',[kb.ENTER],[],function(){Game.appInputChat();});act.add('scoreboard',[kb.TAB],[],function(){Game.appInputTab();});act.add('fullscreen',[kb.P],[],function(){Game.toggleFullScreen();});act.add('pause',[kb.I],[3],function(){Game.appInputPause();});act.loadSettings();return act;});
bombermine.service("community",function($rootScope,$location,$state){var msg=null;var iframe=null;if(window.addEventListener){window.addEventListener("message",postMessage,false);}else{window.attachEvent("onmessage",postMessage);}
function postMessage(event){if(event.data=="process-tick")return;if(event.data&&event.data.type==='routeDone'){var path='/forum/'+event.data.url;if(decodeURIComponent(window.location.hash)!=='#'+path){$rootScope.$apply(function(){var query,queryIndex=path.indexOf('?');if(queryIndex!==-1){query=path.slice(queryIndex+1);path=path.slice(0,queryIndex);console.log('queryIndex',path,query);$location.path(path).search(query).replace();}else{$location.path(path).search({}).replace();}});}}}
function doTheJob(){msg&&iframe&&iframe.contentWindow.postMessage(msg,'*');msg=null;}
return{attach:function(element){iframe=element;doTheJob();},detach:function(){iframe=null;},post:function(msg0){msg=msg0;doTheJob();},open:function(msg0){msg=msg0;$rootScope.showMenu=true;$location.path("/forum/");doTheJob();}}});
bombermine.directive('hover',function(){return{restrict:'A',link:function(scope,element){element.bind('mouseenter',function(){element.addClass('hover');});element.bind('mouseleave',function(){element.removeClass('hover');});}}});bombermine.directive('watchSize',function(){return{link:function(scope,elem,attrs){scope.$watch(function(){if(scope.__height!=elem[0].offsetHeight){scope.__height=elem[0].offsetHeight;scope.$emit("eventsize",scope.__height);}});}}});bombermine.directive('perfectScrollbar',function(){return{link:function(scope,elem,attrs){function create(){if(attrs['perfectScrollbar']=='down'){$(elem[0]).scrollTop(9999).perfectScrollbar({wheelSpeed:20,wheelPropagation:false,suppressScrollX:true,minScrollbarLength:20});}
else{$(elem[0]).perfectScrollbar({wheelSpeed:20,wheelPropagation:false,suppressScrollX:true,minScrollbarLength:20});}}
function update(){if(attrs['perfectScrollbar']=='down'){$(elem[0]).scrollTop(9999).perfectScrollbar('update');}
else{$(elem[0]).perfectScrollbar('update');}}
scope.$on("eventsize",update);create();}}});bombermine.directive('areaHelper',function(){return{link:function(scope,elem,attrs){scope.$on('areaChange',function(event,param){elem.width(param.width).text(param.text+'w');scope.$emit('areaHeight',elem.height());});}}});bombermine.directive('areaAuto',function(){return{link:function(scope,elem,attrs){elem.on('change keyup paste keydown',function(){scope.$emit('areaChange',{width:elem.width(),text:elem.val()})})
scope.$on('areaHeight',function(event,value){elem.height(value);})}}});bombermine.directive('areaBottom',function(){return{link:function(scope,elem,attrs){scope.$on('areaHeight',function(event,value){var bott=attrs.areaBottom-value;if(bott<0)
bott=0;elem.css('bottom',bott+'px');})}}});bombermine.directive('dropdownOnEvent',["dropdownConfig","dropdownService",'$animate',function(dropdownConfig,dropdownService,$animate){return{link:function(scope,elem,attrs){var scope0=scope.$new();var toggleElement=null;var openClass=dropdownConfig.openClass;scope.$on(attrs["dropdownOnEvent"],function(event,param){var elem1=toggleElement=param;var topParent=elem.parent().offset().top;var leftParent=elem.parent().offset().left;var top=elem1.offset().top-topParent+elem1.height();var left=elem1.offset().left-leftParent;elem.css({'top':top+'px','left':left+'px'});dropdownService.open(scope0)
scope0.isOpen=true;})
scope0.getToggleElement=function(){return toggleElement;};scope0.focusToggleElement=function(){};scope0.$watch('isOpen',function(isOpen,wasOpen){$animate[isOpen?'addClass':'removeClass'](elem,openClass);if(isOpen){scope0.focusToggleElement();dropdownService.open(scope0);}else{dropdownService.close(scope0);}});scope.$on('$destroy',function(){scope0.$destroy();});}}}]);bombermine.directive('size',function($window){return{link:function(scope,element){scope.getWindowDimensions=function(){return{'w':element.width(),'h':element.height()};};scope.$watch(scope.getWindowDimensions,function(newValue,oldValue){if(scope.elemW&&(element.context.classList.contains("ng-hide")||newValue.w==0||newValue.h==0))
return;scope.elemW=newValue.w;scope.elemH=newValue.h;},true);}}});bombermine.directive('watchInclude',function(){return{restrict:'A',scope:{text:"@watchInclude"},link:function(scope,elem,attrs){scope.$watch("text",function(){elem.addClass('rotate');setTimeout(function(){elem.removeClass('rotate');},1000);});}}});bombermine.directive('toggleMenu',function($document,Keys){return{link:function(scope,elem,attrs){$document.bind("keydown",onKey);scope.$on("$destroy",function(){$document.unbind("keydown",onKey);});function onKey(e){if(attrs['toggleMenu']>0&&attrs['toggleMenu']<5&&!Keys.isLocked()){if((e.which==65)||(e.which==37)){moveMenu(0,scope.MenuTab,scope.activeTab)}
if((e.which==68)||(e.which==39)){moveMenu(1,scope.MenuTab,scope.activeTab)}}}
function moveMenu(direction,arrMenu,activeTab){var i=0;for(i;i<arrMenu.length;i++){if(arrMenu[i].name==activeTab)break;}
if((direction==0)&&(i>0)){while(i==0||arrMenu[i-1].visible!=true){i--;}
scope.activeTab=arrMenu[i-1].name;}
if((direction==1)&&(i+1<arrMenu.length)){var j=i;while((i<arrMenu.length-1)&&(arrMenu[i+1].visible!=true)){i++;}
if(i==arrMenu.length-1)i=j-1;scope.activeTab=arrMenu[i+1].name;}
scope.$digest();}}}});bombermine.directive('closeModal',function(){return{link:function(scope,elem,attrs){var child=angular.element(elem.children());child.bind('click',function(event){event=event||window.event;if(event.stopPropagation){event.stopPropagation()}else{event.cancelBubble=true}});elem.bind('click',function(){var visible=attrs.ngShow||attrs.ngIf;visible=visible.split('.');if(visible.length==1){scope[visible[0]]=false;}
else{var scopeVis=scope[visible[0]];for(var i=1;i<visible.length;i++){if(i+1==visible.length){scopeVis[visible[i]]=false;break;}
scopeVis=scopeVis[visible[i]];};}
scope.$digest();});}}});bombermine.directive('jplayer',["$http","$rootScope",function($http,$rootScope){return{link:function(scope,elem,attrs){var stream={title:"Game of Bombs radio"},ready=false;var el=$(elem[0]),soundtrackArtists={};el.jPlayer({ready:function(event){ready=true;parseRadioData(config.radio);},pause:function(){$(this).jPlayer("clearMedia");},error:function(event){if(ready&&event.jPlayer.error.type===$.jPlayer.error.URL_NOT_SET){$(this).jPlayer("setMedia",stream).jPlayer("play");}},volume:0.5,solution:"html",supplied:"oga",preload:"none",wmode:"window",useStateClassSkin:true,autoBlur:false,keyEnabled:true});$rootScope.jpPlay=function(){el.jPlayer("play");};function parseRadioData(str){if(!str)return;var src=str.icestats.source;var t=src.server_url.split(",");for(var i=0;i+1<t.length;i+=2)
soundtrackArtists[t[i]]=t[i+1];var link=soundtrackArtists[src.artist.toLowerCase()];if(link&&!config.hideExternalLinks){stream.title='<a target="_blank" href="'+link+'">'+src.artist+'</a> - '+src.title;}else
stream.title=src.artist+' - '+src.title;if(!stream.oga||stream.oga!=str.icestats.source.listenurl){stream.oga=str.icestats.source.listenurl;el.jPlayer("setMedia",stream);}
el.parent().find(".jp-title").html(stream.title);}
var interval=setInterval(function(){if(ready&&(!el.data().jPlayer.status.paused||!stream.oga)){$.getJSON("/api/v3/radio",parseRadioData)}},10000);scope.$on('$destroy',function(){clearInterval(interval);});}}}]);
var FILTERS=angular.module('filters',[])
FILTERS.filter('tierTitled',function(){var TIERS=['Passerby','Friend','Supporter','Fan','Addict'];return function(tier){return TIERS[tier];}});FILTERS.filter('titledRank',function(){var RANKS=['Rookie','Private','Private First Class','Corporal','Sergeant','Second Lieutenant','First Lieutenant','Captain','Major','Lieutenant Colonel','Colonel','Brigadier General','Major General','Lieutenant General','General'];return function(rank){return RANKS[rank];}});FILTERS.filter('shortNumber',function(){return function(value){if(value<1000)
return value;else if(value<10000){var str=value.toString();return str.slice(0,1)+','+str.slice(1);}else if(value<1000000){value/=1000;value=value<100?parseFloat(value.toFixed(2)):parseFloat(value.toFixed(1));return value.toString()+'k';}else{value/=1000000;value=value<100?parseFloat(value.toFixed(2)):parseFloat(value.toFixed(1));return value.toString()+'kk';}}});FILTERS.filter('floor',function(){return function(value){return~~Math.floor(value);}});FILTERS.filter('startFrom',function(){return function(input,start){start=+start;if(!input)
return;return input.slice(start);}});
bombermine.service("gamepad",function($rootScope,storage,actions){function Gamepad(){EventEmitter.call(this);this.ticking=false;this.gamepads={};this.buttons={};this.axes={};this.prevGamepadIndexes=[];this.prevTimestamps=[];this.codeProfiles={};this.init();}
inherits(Gamepad,EventEmitter);Gamepad.prototype.init=function(){var thisAvailable=navigator.getGamepads||!!navigator.webkitGetGamepads||!!navigator.webkitGamepads;if(!thisAvailable){console.log('Gamepad API is not supported!');}else{if('ongamepadconnected'in window){window.addEventListener('gamepadconnected',this.onGamepadConnect.bind(this),false);window.addEventListener('gamepaddisconnected',this.onGamepadDisconnect.bind(this),false);}else{this.startPolling();}}};Gamepad.prototype.onGamepadConnect=function(event){this.gamepads[event.gamepad.index]=event.gamepad;this.connectGamepad(event.gamepad.index);this.startPolling();};Gamepad.prototype.onGamepadDisconnect=function(event){delete this.gamepads[event.gamepad.index];if(Object.keys(this.gamepads).length==0){this.stopPolling();}
this.disconnectGamepad(event.gamepad.index);};Gamepad.prototype.startPolling=function(){if(!this.ticking){this.ticking=true;this.tick();}};Gamepad.prototype.stopPolling=function(){this.ticking=false;};Gamepad.prototype.tick=function(){this.pollStatus();this.scheduleNextTick();};Gamepad.prototype.scheduleNextTick=function(){if(this.ticking){if(window.requestAnimationFrame){window.requestAnimationFrame(this.tick.bind(this));}else if(window.mozRequestAnimationFrame){window.mozRequestAnimationFrame(this.tick.bind(this));}else if(window.webkitRequestAnimationFrame){window.webkitRequestAnimationFrame(this.tick.bind(this));}}};Gamepad.prototype.pollStatus=function(){this.pollGamepads();for(var i in this.gamepads){var gamepad=this.gamepads[i];if(gamepad.timestamp&&(gamepad.timestamp==this.prevTimestamps[i])){continue;}
this.prevTimestamps[i]=gamepad.timestamp;this.updateDisplay(i);}};Gamepad.prototype.pollGamepads=function(){var rawGamepads=(navigator.getGamepads&&navigator.getGamepads())||(navigator.webkitGetGamepads&&navigator.webkitGetGamepads());if(rawGamepads){this.gamepads={};var gamepadInexes=[];for(var i=0;i<rawGamepads.length;i++){if(rawGamepads[i]){this.gamepads[rawGamepads[i].index]=rawGamepads[i];gamepadInexes.push(rawGamepads[i].index);}}
var addedGamepad=difference(gamepadInexes,this.prevGamepadIndexes);var removedGamepad=difference(this.prevGamepadIndexes,gamepadInexes);addedGamepad.forEach(this.connectGamepad.bind(this));removedGamepad.forEach(this.disconnectGamepad.bind(this));this.prevGamepadIndexes=gamepadInexes;}};Gamepad.prototype.connectGamepad=function(gamepadNum){this.emit('gamepadConnected',gamepadNum);this.buttons[gamepadNum]=[];this.axes[gamepadNum]=[];var gamePadName=this.getGamepadName(gamepadNum);console.log('connected gamepad:',gamePadName);this.codeProfiles[gamepadNum]=actions.connectGamepad(gamePadName);};Gamepad.prototype.disconnectGamepad=function(gamepadNum){console.log('removed gamepads',gamepadNum);this.emit('gamepadDisconnected',gamepadNum);delete this.buttons[gamepadNum];delete this.axes[gamepadNum];delete this.codeProfiles[gamepadNum]};Gamepad.prototype.getGamepadName=function(index){return this.gamepads[index]&&this.gamepads[index].id;;};Gamepad.prototype.updateDisplay=function(gamepadId){var gamepad=this.gamepads[gamepadId];var buttonsChanged=false;for(var i=0;i<gamepad.buttons.length;i++){var button=gamepad.buttons[i];var oldButton=this.buttons[gamepadId][i];if(this._isKeyDown(button,oldButton)){this.emit('keydown',i,gamepadId);buttonsChanged=true;}
if(this._isKeyUp(button,oldButton)){this.emit('keyup',i,gamepadId);buttonsChanged=true;}}
if(buttonsChanged){this.buttons[gamepadId]=gamepad.buttons.map(function(button){var obj={pressed:button.pressed,value:button.value};return obj;});}
var axesChanged=false;var axes=this.convertAxes(gamepad.axes);for(i=0;i<axes.length;i++){var axe=axes[i];var oldAxe=this.axes[gamepadId][i];if(this._isKeyDown(axe,oldAxe)){this.emit('keydown',100+i,gamepadId);axesChanged=true;}
if(this._isKeyUp(axe,oldAxe)){this.emit('keyup',100+i,gamepadId);axesChanged=true;}}
if(axesChanged){this.axes[gamepadId]=axes;}};Gamepad.prototype.mapCode=function(code,gamepadNum){return this.codeProfiles[gamepadNum][String(code)];};Gamepad.prototype._isKeyDown=function(newKey,oldKey){return newKey.pressed&&(!oldKey||!oldKey.pressed);};Gamepad.prototype._isKeyUp=function(newKey,oldKey){return!newKey.pressed&&oldKey&&oldKey.pressed;};Gamepad.prototype.convertAxes=function(axes){var result=[];for(var i=0;i<axes.length;i++){var axe=axes[i];result.push({pressed:axe>0.5});result.push({pressed:axe<-0.5});}
return result;};function difference(a,b){return a.filter(function(n){return b.indexOf(n)===-1});}
return new Gamepad();});'use strict';var common=angular.module('common',[]);common.factory('localize',['$http','$rootScope','$window','$filter','storage',function($http,$rootScope,$window,$filter,storage){var PERK_TYPE_COUNT=2;var PERK_TYPE_SECONDS=4;var regexSwitch=/\$(\d+)\[([^\]]+)\]/g
var regexIfElse=/\$(\d+){([^}]*)}(?:{([^}]*)})?/g
var regexPlace=/\$(\d+)/g
var regexFunc=/\$t\(([^)]*)\)/g
var regexChar=/&#(\d+);/g
var localize={dictionary:null,loaded:false,success:function(data){$rootScope.currentLocale=storage.getItem('locale',window.config.lang||'en');localize.dictionary=data;},init:function(){localize.success(window.lang)},getStringOpt:function(key,index){if(localize.dictionary==null)
return null;var obj=localize.dictionary[key];if(obj==null){if(index!=null||typeof key!=="string"||key.indexOf('+')<0)
return null;var keys=key.split('+');var result="";for(var i=0;i<keys.length;i++){var tail='';keys[i]=keys[i].replace(/\W+$/g,function(match){tail=match;return'';});var r=localize.getStringOpt(keys[i]);if(r==null)
return null;result+=r+tail;}
return result;}
while(typeof obj==="string"){var objValue=localize.dictionary[obj];if(objValue){obj=localize.dictionary[key]=objValue;}else{var t=obj;obj=localize.dictionary[key]={};obj[$rootScope.currentLocale]=t;break;}}
var v=obj[$rootScope.currentLocale]||obj["en"];if(typeof v==="undefined")
return null;if(index==null){if(typeof v==="string")
return v;return v.join('|');}else{if(typeof v==="string")
v=obj[$rootScope.currentLocale]=v.split('|');return v[index]||'';}},getString:function(key,index){var res=localize.getStringOpt(key,index);return res!=null?res:(index==null?key:''+key+'['+index+']');},withCorrectEnding:function(key,number){var modKey=key;switch($rootScope.currentLocale){case"ru":if((~~(number/10))%10!=1){number%=10;if(number==1)modKey+="_ru1";else if(number>=2&&number<=4)modKey+="_ru2";}
break;}
return localize.getStringOpt(modKey)||localize.getString(key);},formatArr:function(parts){if(!parts||!parts[0]||!parts[0].replace)return parts;return parts[0].replace(regexSwitch,function(match,ind,inBrackets){var arg=parts[ind|0];if(arg==='')return match;var argNum=Number(arg);return argNum===(argNum|0)?inBrackets.split(',')[argNum]:match;}).replace(regexIfElse,function(match,ind,inBrackets,inBrackets2){var arg=parts[ind|0];return(arg&&arg!=='false'&&arg!=='0'&&arg!=='null'&&arg!=='undefined')?inBrackets:inBrackets2||'';}).replace(regexPlace,function(match,ind){return parts[ind|0];}).replace(regexFunc,function(match,inBrackets){return localize.getString(inBrackets);}).replace(regexChar,function(match,ind){return String.fromCharCode(ind);});},format:function(varArgs){return localize.formatArr(arguments);},getStringMsgOpt:function(msg){if(typeof msg!=='string')
return null;var wholeString=localize.getStringOpt(msg);if(wholeString!=null)
return wholeString;var parts=msg.split('|');if(parts.length<=1)
return null;localize.preprocessSpecialMsg(parts);parts[0]=localize.getStringOpt(parts[0]);return parts[0]!=null?localize.formatArr(parts):null;},getStringMsg:function(msg){var res=localize.getStringMsgOpt(msg);return res!=null?res:msg;},preprocessSpecialMsg:function(parts){switch(parts[0]){case"msg_perk_added":if(parts[2]==PERK_TYPE_SECONDS)
parts[1]/=60;parts[2]-=PERK_TYPE_COUNT;parts[3]=localize.getString("perk_"+parts[3]);break;}}};localize.init()
window.setLocale=function(val){localize.success(window.lang);$rootScope.$apply(function(){$rootScope.currentLocale=val;})};return localize;}]).filter('i18n',['localize',function(localize){return function(input,index){var s=localize.getString(input,index);if(s=='')return"`"+input+"`";return s;};}]).filter('format',['localize',function(localize){return localize.format;}]).filter('i18nHtml',['$sce','localize',function($sce,localize){return function(input,index){var s=localize.getString(input,index);if(s=='')return"`"+input+"`";return $sce.trustAsHtml(s);};}]);
(function(){window.page_params={};var p=location.search.substring(1).split("&");for(var i=0;i<p.length;i++){var v=p[i].indexOf("=");if(v>=0)
page_params[p[i].substring(0,v)]=p[i].substring(v+1);}})();bombermine.service('params',function(){var params={"auth":config.auth||"b"};if(page_params['api_id']){params['api_id']=page_params['api_id'],params['viewer_id']=page_params['viewer_id'],params['auth_key']=page_params['auth_key'],params['user_id']=page_params['user_id'],params['group_id']=page_params['group_id'],params['is_app_user']=page_params['is_app_user'],params['api_result']=page_params['api_result'],params['api_settings']=page_params['api_settings'],params['referrer']=page_params['referrer']}
return{get:function(key){if(key)return params[key];return params;},getParam:function(key){if(key)return page_params[key]||null;return page_params}}})
bombermine.factory('myHttpResponseInterceptor',function($q,$location,params,$rootScope){var override_params=params.get();var apiUri='/api/';return{request:function(config){if(config.url.substring(0,apiUri.length)==apiUri){config.params=config.params||{}
for(var key in override_params)
if(override_params.hasOwnProperty(key))
config.params[key]=override_params[key];if(document.cookie.length==0&&$rootScope.user&&$rootScope.user.id>0){config.params['cookieToken']=$rootScope.user.token;}}
return config;}}})
bombermine.config(function($httpProvider){$httpProvider.interceptors.push('myHttpResponseInterceptor');$httpProvider.defaults.headers.common["X-Requested-With"]='XMLHttpRequest';});
bombermine.config(['$stateProvider','$urlRouterProvider',function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/");$urlRouterProvider.deferIntercept();$stateProvider.state('profile',{url:"/",templateUrl:'tmpl/profile.tmpl'}).state("money",{abstract:true,url:"/money",templateUrl:"tmpl/money.tmpl"}).state("money.buy_now",{url:"/buy_now",templateUrl:"tmpl/money/buy_pluto_or_register_inner.tmpl"}).state("money.goal",{url:"/goal",templateUrl:"tmpl/money/goal.tmpl"}).state('character',{url:"/character/",templateUrl:'tmpl/profile/character.tmpl'}).state('servers',{url:"/servers/*path",templateUrl:'tmpl/servers.tmpl'}).state('start',{url:"/start/",templateUrl:'tmpl/start.tmpl'}).state('modal',{url:"/modal/",templateUrl:'tmpl/modal.tmpl'}).state('shop',{url:"/shop/",templateUrl:'tmpl/shop.tmpl'}).state('shopnew',{url:"/shopnew/",templateUrl:'tmpl/shopnew.tmpl'}).state('settings',{url:"/settings/",templateUrl:'tmpl/settings.tmpl'}).state("skins",{abstract:true,url:"/skins",templateUrl:"tmpl/skins.tmpl"}).state("skins.skins",{url:"/skins",templateUrl:"tmpl/skins/skins.tmpl"}).state("skins.character",{url:"/character",templateUrl:"tmpl/skins/character.tmpl"}).state('achievements',{url:"/achievements/",templateUrl:'tmpl/achievements.tmpl'}).state('rankingsOld',{url:"/rankingsOld/",templateUrl:'tmpl/rankings.tmpl',controller:'RankingsPageCtrl'}).state('rankings',{url:"/rankings/",templateUrl:'tmpl/top_stats.tmpl',controller:'TopStatsCtrl'}).state('play',{url:"/play/",templateUrl:'tmpl/profile.tmpl',onEnter:function(){}}).state('forum',{url:"/forum/*path",templateUrl:'tmpl/community.tmpl',onEnter:function(){console.log('forum enter',arguments);},onExit:function(){console.log('forum exit',arguments);}}).state('referrals',{url:"/referrals/",templateUrl:'tmpl/referrals.tmpl'}).state('password',{url:"/recover-password/",templateUrl:'tmpl/recover-password.tmpl'});var s=$stateProvider.state("wiki",{abstract:true,url:"/wiki",templateUrl:"tmpl/wiki.tmpl"});var wikiLangs=["en","ru","jp","es","fr","pt-BR","de"];for(var i=0;i<wikiLangs.length;i++){var lc=wikiLangs[i];s=s.state("wiki."+lc+"credits",{url:"/"+lc+"/credits",templateUrl:"tmpl/wiki/"+lc+"/credits.tmpl"}).state("wiki."+lc+"faq",{url:"/"+lc+"/faq",templateUrl:"tmpl/wiki/"+lc+"/faq.tmpl"}).state("wiki."+lc+"howToPlay",{url:"/"+lc+"/how-to-play",templateUrl:"tmpl/wiki/"+lc+"/how-to-play.tmpl"}).state("wiki."+lc+"troubleshooting",{url:"/"+lc+"/troubleshooting",templateUrl:"tmpl/wiki/"+lc+"/problems.tmpl"}).state("wiki."+lc+"referrals",{url:"/"+lc+"/referrals",templateUrl:"tmpl/wiki/"+lc+"/referrals.tmpl"}).state("wiki."+lc+"services",{url:"/"+lc+"/services",templateUrl:"tmpl/wiki/"+lc+"/services.tmpl"})}}]);
bombermine.service("serverList",function($rootScope,Game,storage,Realtime){var ROOM_FLAG_ACCESS_ONLY_HOME=1;window.game=Game;var hosts={};var initialized=false;var pingReady=true;var current={serverId:0,roomId:0,ssl:false,roomType:0};function acceptAndSaveCurrent(){var room=serverList.rooms[current.roomId];if(room)
current.roomType=room.roomType;storage.setItem('game/'+config.auth+'/currentServer',JSON.stringify(current));}
function loadCurrent(){var s=storage.getItem('game/'+config.auth+'/currentServer');if(s){try{serverList.current=current=JSON.parse(s);}catch(e){s=storage.getItem('game/currentServer');if(s){try{serverList.current=current=JSON.parse(s);}catch(e){}}}}}
function dropWrongCurrent(){if(!initialized)return;var room=activeRoom();if(room){if(room.serverId!=current.serverId){current.serverId=room.serverId;current.roomId=findRoomId(current.serverId,room.roomType);}}else{current.roomId=0;if(!activeServer())
current.serverId=0;}}
function Server(){this.status=new Status();this.players=0}
function Room(srvId){this.status=new Status();this.roomType="hardcore";this.serverId=srvId;}
function Host(server,domain){this.status=new Status();this.server=server;this.domain=domain;this.rooms=[];}
function Status(latency){this.pinged=false;this.latency=latency||"-";this.players=0;this.ssl=(location.protocol=="https:");}
function pingServer(host,times,cb,debug){var cb2=function(msg,res){if(msg==null){res.ssl=false;cb(msg,res);}
else
pingServer_internal(host,true,times,cb1,debug);};var cb1=function(msg,res){if(msg==null){res.ssl=true}
cb(msg,res);};if(location.protocol=="https:"){pingServer_internal(host,true,times,cb1,debug);}
else
pingServer_internal(host,false,times,cb2,debug);}
function pingServer_internal(host,ssl,times,cb,debug){times=times||10;var pings=[];if(ssl&&host.substring(host.length-5,host.length)==":8080")
host=host.substring(0,host.length-5)+":8443";var s=new WebSocket((ssl?"wss:":"ws:")+"//"+host);var started=Date.now();debug&&console.log('fn started (0 ms):',started);s.onmessage=function(msg){if(!s)return;var res=JSON.parse(msg.data);if(res.pingtest){for(var i=0;i<times;i++){(function(i){setTimeout(function(){ping(i)},i*10);})(i);}
return;}
var timestamp=msg.timeStamp;if(timestamp<1450000000000)timestamp=Date.now();if(timestamp>=10000000000000)timestamp=timestamp/1000;var latency=timestamp-res.time;if(--times){pings.push(latency);}else{if(debug){console.log('fn ended:',(Date.now()-started)+' ms');console.log('pings:',pings);console.log('latency (median):',median(pings)|0);console.log('server response:',res);}
s.closed=true;s.close(1000);if(cb&&cb instanceof Function){return cb(null,angular.extend(new Status(median(pings)|0),res));}}};s.onclose=function(){debug&&console.log('ws onclose:',(Date.now()-started)+' ms');if(!pings.length&&!s.error){cb('ws no results');}
s=null;};s.onopen=function(){debug&&console.log('ws onopen:',(Date.now()-started)+' ms');s.send(JSON.stringify({pingtest:Date.now()}));};s.onerror=function(err){if(!s||s.closed)return;debug&&console.log('ws err',err);s.error=true;return cb('ws onerror');};function ping(i){s.send(JSON.stringify({time:Date.now()}));debug&&console.log('sent msg #'+i+':',(Date.now()-started)+' ms');}
function median(values){values.sort(function(a,b){return a-b;});var half=Math.floor(values.length/2);if(values.length%2)
return values[half];else
return(values[half-1]+values[half])/2.0;}}
var hostsToPing={};var pingTimeout=0,lastPingTime=0;var hostsCounter=0;function doPing(){if(pingTimeout){window.clearTimeout(pingTimeout)}
lastPingTime=Date.now();var servers=serverList.servers;pingTimeout=window.setTimeout(doPingReady,15000);pingReady=false;serverList.onlineTotal=0;var newHostsToPing={};for(var id in servers)if(servers.hasOwnProperty(id)){servers[id].pinged=false;}
hostsCounter=0;for(var domain in hosts)if(hosts.hasOwnProperty(domain)){newHostsToPing[domain]=1;if(hostsToPing[domain])continue;hostsCounter++;(function(host){pingServer(host.domain,null,function(err,result){hostsToPing[host.domain]=0;var srv=host.server;if(!srv.pinged){srv.status.players=0;srv.status.latency="-";srv.pinged=true;srv.down=true}
if(!err){var timeleft=result.timeLeft/10|0;result.timeLeft=timeleft>=0?secToHms(timeleft):'00:00';if(result.rooms){var players=0;for(var i=0;i<result.rooms.length;i++){players+=result.rooms[i].players;}
result.players=players;}
angular.extend(host.status,result);serverList.onlineTotal+=host.status.players||0;srv.status.players+=host.status.players||0;if(srv.status.latency=="-"||srv.status.latency>host.status.latency)
srv.status.latency=host.status.latency;host.down=false;srv.down=false}else{host.down=true;host.status=new Status();}
for(var i=0;i<host.rooms.length;i++){var room=host.rooms[i];room.status={}
angular.extend(room.status,host.status);if(result&&result.rooms){var sr=result.rooms;for(var j=0;j<sr.length;j++)
if(sr[j].id==host.rooms[i].id){var timeleft=sr[j].timeLeft/10|0;sr[j].timeLeft=timeleft>=0?secToHms(timeleft):'00:00';angular.extend(room.status,sr[j]);}}
room.down=host.down;}
hostsCounter--;if(hostsCounter==0)
doPingReady();dropWrongCurrent()
$rootScope.$broadcast("serversUpdate");});})(hosts[domain]);}
hostsToPing=newHostsToPing}
function doPingReady(){if(!pingReady){pingReady=true;$rootScope.$broadcast("serversPing")}}
function idlePing(){if(!lastPingTime||lastPingTime+300*1000<Date.now()){doPing()}}
window.setInterval(idlePing,60*1000);function nearestServer(){var nearest=null;var latency=100000;var servers=serverList.servers;for(var id in servers)if(servers.hasOwnProperty(id)){var srv=servers[id];if(srv.status.latency!="-"&&srv.status.latency<latency&&selectGoodRoomId(id)){latency=srv.status.latency;nearest=srv}}
return nearest;}
function checkIfTutor(){var roomId=current.roomId;if(roomId&&serverList.rooms[roomId]&&serverList.rooms[roomId].roomType=="tutorial"&&$rootScope.tutorLevel()>0)
changeCurrentRoomId(0);}
function init(srvs){var servers=serverList.servers||{};var newServers={};var rooms=serverList.rooms||{};var newRooms={};hosts={};var perms=$rootScope.user?$rootScope.user.perm_mask:0;for(var i=0;i<srvs.length;i++){var srv=srvs[i];if(!srv.access||(perms&98)==98||(perms&4)==4||(perms&2)==2||srv.access.indexOf("all")>=0||srv.access.indexOf("dev")>=0&&(perms&18)!=0||srv.access.indexOf(config.auth)>=0){var server=servers[srv.id]||new Server();angular.extend(server,srv);newServers[server.id]=server;for(var j=0;j<server.rooms.length;j++){var room=rooms[server.rooms[j].id]||new Room(server.id);server.rooms[j]=angular.extend(room,server.rooms[j]);newRooms[room.id]=room;room.name=room.name||room.roomType;if(room.roomType=="sandbox")room.roomType=="pvm";if(!hosts[room.domain])
hosts[room.domain]=new Host(server,room.domain);hosts[room.domain].rooms.push(room)}}}
serverList.rooms=newRooms;serverList.servers=newServers;initialized=true;$rootScope.$broadcast("serversInit")
dropWrongCurrent();}
function doAfterInit(callback){if(initialized)callback();else{var c=$rootScope.$on("serversInit",function(){c();callback();});}}
function findRoomId(serverId,roomType){var srv=serverList.servers[serverId];if(typeof roomType=='undefined'){return selectGoodRoomId(serverId);}
for(var i=0;i<srv.rooms.length;i++){var room=srv.rooms[i];if(!room.down&&!room.cantPlayReason)
if(roomType===false||room.roomType==roomType)
return srv.rooms[i].id}
return 0;}
function selectGoodRoomId(serverId){var MIN_PRIO=-999999;var MAX_PRIO=999999;var rooms=serverList.servers[serverId].rooms;var curDomain=$rootScope.connectionStatus==1?current.domain:'';var variants=[];var curPrio=MIN_PRIO;var lastRoomType=current.roomType||activeRoom()&&activeRoom().roomType;for(var i=0;i<rooms.length;i++){var room=rooms[i];if(!room.cantPlayReason&&(!room.down||room.domain==curDomain)){if(room.id==current.roomId)
return room.id;var roomPrio=room.priority;if(room.id==config.defaultRoom){roomPrio=MAX_PRIO/2;}else switch(room.roomType){case"tutorial":roomPrio=$rootScope.tutorLevel()>0?MIN_PRIO:MAX_PRIO;break;case"sandbox":case"pvm":if($rootScope.user.rank<3)roomPrio+=5;else if($rootScope.user.rank>4)roomPrio-=5;break;}
if(room.roomType==lastRoomType&&roomPrio>MIN_PRIO){roomPrio=MAX_PRIO;}
if(curPrio<roomPrio){variants=[room];curPrio=roomPrio;}else if(curPrio==roomPrio){variants.push(room);}}}
var room=Utils.randomElement(variants);return room?room.id:0;}
function autoSelect(){dropWrongCurrent();var srv=activeServer();if(!srv){srv=nearestServer();if(!srv)return false;current.serverId=srv.id}
if(!current.roomId||serverList.rooms[current.roomId].cantPlayReason){current.roomId=selectGoodRoomId(current.serverId);if(!current.roomId)
srv.down=true;}}
function onChangeRoom(room0){if(!room0||current.roomId==room0.id)return;var room=serverList.rooms[room0.id];if(room){current.roomId=room.id;current.serverId=room.serverId;var ssl=hosts[room.domain].status.ssl;var host=room.domain;if(ssl&&host.substring(host.length-5,host.length)==":8080")
host=host.substring(0,host.length-5)+":8443";$rootScope.config.SERVER_ADDRESS=(ssl?"wss:":"ws:")+"//"+host+"/?room="+room.id}}
function tryConnect(){dropWrongCurrent();if(current.roomId==0)
return false;var room=serverList.rooms[current.roomId];var ssl=hosts[room.domain]?hosts[room.domain].status.ssl:(location.protocol=="https:");current.ssl=ssl;var host=room.domain;if(ssl&&host.substring(host.length-5,host.length)==":8080")
host=host.substring(0,host.length-5)+":8443";var serverAddress=(ssl?"wss:":"ws:")+"//"+host+"/?room="+room.id;current.domain=room.domain;acceptAndSaveCurrent();if($rootScope.config.SERVER_ADDRESS==serverAddress){if($rootScope.connectionStatus==1)
return true;}else{$rootScope.config.SERVER_ADDRESS=serverAddress}
Game.emit('gameEventNetDisconnect',200);return true;}
function activeServer(){return serverList.servers[current.serverId]};function activeRoom(){return serverList.rooms[current.roomId]};function failsafe(attempt_number){var roomId=serverList.current.roomId;var serverAddress=$rootScope.config.SERVER_ADDRESS;var domain=serverList.current.domain;Realtime.ask("conn_fail",{roomId:roomId,url:serverAddress,domain:domain,attempt:attempt_number}).then(function(data){if(data.code==1){if(serverList.rooms[data.roomId]){serverList.rooms[data.roomId].domain=data.domain;tryConnect();}
else{}}else{}},function(){})}
var serverList={rooms:{},servers:{},doPing:doPing,init:init,autoSelect:autoSelect,tryConnect:tryConnect,current:current,isPingReady:function(){return pingReady},activeServer:activeServer,activeRoom:activeRoom,findRoomId:findRoomId,idlePing:idlePing,checkIfTutor:checkIfTutor,onChangeRoom:onChangeRoom,doAfterInit:doAfterInit,failsafe:failsafe};loadCurrent();return serverList;});
bombermine.service("skinModel",function($http,$location,$rootScope,i18nFilter,Game,UserService){var skinsAllowed=[];var curSkin=$rootScope.user.skin||"default";var ctorBaseDir="/ctor/";var freeCtorSkins=[{type:"B",skin_code:"!BAQAC6vCqtPbsLgKLVB8=",saved:-1},{type:"B",skin_code:"!BAQAAADusqtqsdhdZ1xWEAFikEg==",saved:-1},{type:"B",skin_code:"!BAQAAjk9wPB7bXWRdVxAC6g==",saved:-1}];var skinModel={groups:{list:[]},shopList:[],byName:{},ctorThumbStyles:{},ctorConfigs:{},ownsSkin:false,ownsCtorSkin:false,my:{},checkSkin:function(){curSkin=$rootScope.user.skin||"default";skinModel.activeSkin=skinModel.getSkinByName(curSkin);skinModel.activeSkin.active=true;skinModel.my[curSkin]=1;},getSkinByName:function(name){for(var i=0;i<skinModel.groups.list.length;i++){var skins=skinModel.groups.list[i].skins;for(var j=0;j<skins.length;j++){if(skins[j].name==name){return skins[j];}}}
return skinModel.activeSkin={group:{name:"all"},id:sprites._dynamic[name]?sprites._dynamic[name].index:0,name:name,active:true};},getActiveSkin:function(){curSkin=$rootScope.user.skin||"default";if(skinModel.activeSkin.name!=curSkin)
skinModel.checkSkin();return skinModel.activeSkin;},activateSkin:function(skin,cb){var name=skin.name;if(name==curSkin){if(cb)cb();return;}
function onSuccess(){skinModel.activeSkin=skin;$rootScope.user.skin=curSkin=name;Game.appInputRejoin();if(cb)cb();}
if(name[0]=="!"){$http.post('/api/ctor/set_or_buy',{code:name,cost:Costs.zero()}).success(onSuccess);}else
$http.post('/api/v2/change-skin/',{skin:name}).success(onSuccess);},saveOrRemoveSkin:function(skin,cb){if(skin.name[0]!="!")
throw"saveRemoveSkin - non constructor skin";$http.post('/api/ctor/manage_saved',{skin_code:skin.name,saved:!skin.saved}).success(function(){if(skin.saved){var mySkins=skinModel.groups.list[0];delete mySkins.byName[skin.name];for(var i=0;i<mySkins.skins.length;i++){if(mySkins.skins[i].name==skin.name){mySkins.skins.splice(i,1);break;}}
if(skin.name==skinModel.activeSkin.name)
skinModel.activateSkin(mySkins.skins[0],cb);}else{skin.saved=true;if(cb)cb();}});},numberOfSameTypeSkins:function(skin){if(skin.name[0]!="!")
throw"numberOfTheSameType - non constructor skin";var type=SkinConfig.splitCode(skin.name).type;var count=0;var skins=skinModel.groups.list[0].skins;for(var i=0;i<skins.length;i++){if(skins[i].name[0]=="!"&&SkinConfig.splitCode(skins[i].name).type==type)
count++;}
return count;},whenReady:function(cb){var self=this;var wait=20000;function waiter(){if(self.shopList.length){cb();}else if(wait>0){wait-=100;setTimeout(waiter,100);}}
waiter();},getSkinBuilder:function(cb){Utils.whenExist(function(){return sprites.skinBuilder},function(sb){cb(sb,sprites.ctorData)});},getDynamicSprite:function(name,cb){Utils.repeatUntilTrue(function(){return sprites._dynlist.length&&(cb(sprites._dynamic[name])||true);});},getSpriteWithCnavas:function(name,cb){if(name[0]=="!"||name[0]=="?"){this.getSkinBuilder(function(sb){sb.build({name:name},function(result){result.skin.skin=new Skin(result.skin.skin);cb(result.skin,result.canvas);});});}else{this.getDynamicSprite(name,function(sprite){if(sprite){var img=new Image();var done=false;img.onload=function(){if(done)return;done=true;cb(sprite,img);};img.src=sprite.src;if(img.complete)
img.onload();}});}},setCtorConfigs:function(cc){this.ownsCtorSkin=false;this.ctorConfigs=cc;for(var j=0;j<freeCtorSkins.length;j++)
freeCtorSkins[j].add=true;for(var i=0;i<cc.length;i++){var isDefault=false;for(var j=0;j<freeCtorSkins.length;j++){if(cc[i].skin_code==freeCtorSkins[j].skin_code){freeCtorSkins[j].add=false;isDefault=true;}}
this.ownsCtorSkin=this.ownsCtorSkin||!isDefault;}
for(var j=0;j<freeCtorSkins.length;j++){if(!this.ownsCtorSkin&&freeCtorSkins[j].add)
cc.push(freeCtorSkins[j]);}
ctorMakeThumbs();},reload:function(cb){sprites.loadAsync(function(){$.ajax({url:'/api/v2/skins',headers:{"X-Matroid-Auth":config.auth||'b'},success:function(data){skinModel.my=my=data.my;skinModel.groups=data.groups;skinModel.shopList=[];skinModel.byName={};var cc=data.ctor_configs;my["free"]=-1;skinModel.setCtorConfigs(cc);if($rootScope.user.personal_skin)
my[$rootScope.user.personal_skin]=-1;if(config.hideLicenseSkins){skinModel.groups.list=skinModel.groups.list.filter(function(group){return!group.defaults.license;});}
skinModel.groups.list.forEach(function(group){group.skins=[];group.byName={};group.active=false;group.mode=group.mode||0;if(typeof my[group.name]=="number"){group.expire=my[group.name];my[group.name]=group;group.active=true;}
var list=group.items;list&&list.forEach(function(skin){if(typeof skin=="string")skin={name:skin}
var dyn=sprites._dynamic[skin.name];if(dyn){skin.id=dyn.index;if(!skin.license||!config.hideLicenseSkins)
addSkinInGroup(group,skin);}else{list2=sprites.byGroup[group.name];list2&&list2.forEach(function(dyn){var skin={id:dyn.index,name:dyn.name}
addSkinInGroup(group,skin);});}});});var myGroup={name:"my_skins",active:true,skins:[],byName:{},alwaysVisible:true}
var count=0;for(var name in my){if(sprites._dynamic.hasOwnProperty(name)){count++;var dyn=sprites._dynamic[name];if(typeof my[name]=="number"){var skin={id:dyn.index,name:dyn.name,active:true,expire:my[name]}
addSkinInGroup(myGroup,skin);}else{var skin=my[name];addSkinInSecondGroup(myGroup,skin);}}}
skinModel.ownsSkin=count>1;for(var i=0;i<cc.length;i++){var skin={name:cc[i].skin_code,active:true,expire:-1,saved:cc[i].saved};if(!skinModel.ownsCtorSkin)
skin.tooltip=i18nFilter("you_can_edit_this_skin");addSkinInSecondGroup(myGroup,skin);}
if(myGroup.skins.length>0){skinModel.groups.list.unshift(myGroup);}
skinModel.checkSkin();if(!$rootScope.$$phase){$rootScope.$digest();}
skinModel.dirty=false;if(cb)cb();}});});},getSkinStyle:function(skin){return skin.name&&skin.name[0]=="!"?(skinModel.ctorThumbStyles[skin.name]?skinModel.ctorThumbStyles[skin.name].thumb:{}):sprites.getSkinStyleById(skin.id);},getShadowStyle:function(skin){var meta=skin.name&&skin.name[0]=="!"?(skinModel.ctorThumbStyles[skin.name]?skinModel.ctorThumbStyles[skin.name].meta:null):sprites._dynlist[skin.id].shad;return shadowStyle(meta);}};var my=skinModel.my;function addSkinInGroup(group,skin){if(group.byName[skin.name])return;group.skins.push(skin);group.byName[skin.name]=skin;if(!skinModel.byName[skin.name]){skinModel.shopList.push(skin);skinModel.byName[skin.name]=skin;}
skin.shopGroup=group;skin.expire=0;skin.active=false;if(typeof my[skin.name]=="number"){skin.expire=my[skin.name];skin.active=true;my[skin.name]=skin;}else if(group.active){skin.active=true;skin.expire=group.expire;}
if(group.defaults){for(var key in group.defaults)
if(group.defaults.hasOwnProperty(key)&&!skin.hasOwnProperty(key))
skin[key]=group.defaults[key];}
var durations=group.durations||skinModel.groups.durations;var price=skin.price||0;skin.durations=[];for(var i=0;i<durations.length;i++){var dur=durations[i];skin.durations.push({type:"skins",price:Math.ceil(dur.mul*price),gold_price:0,name:skin.name,days:dur.days,skin:skin,mode:group.mode});}
if(!skin.hasOwnProperty("platform")){skin.platform=0;}}
function addSkinInSecondGroup(group,skin){if(group.byName[skin.name])return;group.skins.push(skin);group.byName[skin.name]=skin;skin.shopGroup=group;if(my.hasOwnProperty(skin.name))
my[skin.name]=skin;}
skinModel.checkSkin();skinModel.reload();console.log("skins service started")
function ctorMakeThumbs(sb){var tmpStyles={};function body(sb){for(var i=0;i<skinModel.ctorConfigs.length;i++){var code=skinModel.ctorConfigs[i].skin_code;tmpStyles[code]=tmpStyles[code]||skinModel.ctorThumbStyles[code];if(!tmpStyles[code]){sb.build({name:code,onlyPublicFrame:true},function(result){if(result.canvas){var canvas=makeBigThumbForCanvas(result.canvas,result.skin.skin.renderWidth,sprites.shopThumbSize);tmpStyles[code]={thumb:{'background-image':'url(\''+canvas.toDataURL()+'\')'},meta:def(result.skin.skin.shadow)?{}:calcShadow(canvas.getContext("2d"),0,0,sprites.shopThumbSize,sprites.shopThumbSize)}}
body(sb);});return;}}
skinModel.ctorThumbStyles=tmpStyles;if(!$rootScope.$$phase)
$rootScope.$digest();}
skinModel.getSkinBuilder(body);}
return skinModel;});
bombermine.factory('SocialBase',function($rootScope){return{active:false,ready:false,onLogin:function(){},showRegister:function(){},referralLink:function(){return"https://gameofbombs.com/landing?referral="+$rootScope.user.id;},onReady:function(err){if(this.ready){return;}
if(!err){this.ready=true;$rootScope.$broadcast("socialReady")}else{$rootScope.socialError=err;console.log("Social init failed")}}}});var _dumbIeCallback=false;bombermine.factory('SafariHack',function(){var safariCallback=null;var dumbIeTimeout=0;function SafariHack(callback){if(window.parent==window||document.cookie){callback();}else{window.open("/safariFix","login","width=20,height=20");safariCallback=callback;if(dumbIeTimeout==0)
dumbIeTimeout=setInterval(function(){if(_dumbIeCallback){safariHack2({data:'cookieHack'})}},100);}}
function safariHack2(event){if(event.data=='cookieHack'&&safariCallback){safariCallback();safariCallback=null;if(dumbIeTimeout){clearInterval(dumbIeTimeout);dumbIeTimeout=0;}}}
if(window.addEventListener){window.addEventListener("message",safariHack2,false);}else{window.attachEvent("onmessage",safariHack2);}
return SafariHack;});
common.factory('storage',['$rootScope',function($rootScope){var cache={};var available=false,wasError=false;try{localStorage['test']="123";if(localStorage['test']=="123")
available=true;}catch(e){console.log("localStorage is not available, or it is full",e);}
return{isAvailable:function(){return available;},hasError:function(){return!available||wasError;},getItem:function(key,def){if(!cache.hasOwnProperty(key)&&available){if(localStorage[key])
cache[key]=localStorage[key];}
if(cache.hasOwnProperty(key))
return cache[key];return def;},setItem:function(key,value){cache[key]=value;if(available){try{localStorage[key]=value;}catch(e){console.log("localStorage is full",e);}}},removeItem:function(key){if(cache.hasOwnProperty(key))
delete cache[key];if(available){localStorage.removeItem(key);}}}}]);
bombermine.directive('animatedPreview',function($rootScope,skinModel){return{restrict:'A',scope:{selectedSkin:"@animatedPreview",size:"@previewSize",},template:'<div class="platform"></div><div class="shadow"></div><div class="skin"><canvas width="{{size}}" height="{{size}}"></canvas></div>',link:function(scope,elem,attrs){var canvas=elem.find("canvas")[0];var shadow=elem.find(".shadow");var ap=new AnimatedPreview(skinModel,canvas,{shadow:shadow});scope.$watch("selectedSkin",function(newVal,oldVal){ap.stop();ap.startName(newVal);});scope.$on("$destroy",function(){ap.stop()});}}});bombermine.directive('animatedPreviewAds',function($rootScope,$state,Game,skinModel){var size=72;return{restrict:'A',scope:{skinType:"@skinType",size:"@previewSize"},template:'<canvas width="{{size}}" height="{{size}}"></canvas>',link:function(scope,elem,attrs){var activeSkin=null;elem.bind('click',function(){$rootScope.proposedSkin=scope.skinType||ap.curSkin;_gaq.push(['_trackEvent','animatedPreviewAds','click',$rootScope.proposedSkin]);$rootScope.menu();$state.go(scope.skinType?"skins.character":"skins.skins");});var canvas=elem.find("canvas")[0];var ap=new AnimatedPreview(skinModel,canvas,{randomness:true,changeInterval:1000,size:scope.size});var timeout=null;function startNextSkin(){function start(name){activeSkin=name;skinModel.getSpriteWithCnavas(name,function(sprite,img){if(name==activeSkin){ap.start(sprite,img);var t=~~(8000+Math.random()*12000);timeout=setTimeout(startNextSkin,t);}});}
if(scope.skinType==null){var awaited=activeSkin="_wait"+Math.random();skinModel.whenReady(function(){if(activeSkin==awaited)
start(skinModel.shopList[~~(Math.random()*skinModel.shopList.length)].name);});}else
start(scope.skinType+Math.random());}
startNextSkin();function stop(){if(timeout){clearTimeout(timeout);timeout=null;}
activeSkin=null;ap.stop();}
scope.$on("$destroy",function(){stop();off_tabMenuOpen();off_tabMenuClose();});var off_tabMenuOpen=$rootScope.$on('tabMenuOpen',function(e,tab){if(tab=='skins'&&activeSkin==null)
startNextSkin();});var off_tabMenuClose=$rootScope.$on('tabMenuClose',stop);}}});AnimatedPreview=function(skinModel,canvas,options){var self=this;options=options||{};var animTempCanvas;var timeout=null;var curShadowStyle=false;var thumbSize=options.size||sprites.shopThumbSize;this.curSkin=null;this.stop=function(){if(timeout!=null){clearTimeout(timeout);timeout=null;}
canvas.getContext('2d').clearRect(0,0,canvas.height,canvas.width);curShadowStyle=null;this.curSkin=null;}
this.startName=function(name){skinModel.getSpriteWithCnavas(name,function(sprite,img){self.start(sprite,img)});}
this.start=function(sprite,img){var ctx=canvas.getContext('2d');this.stop();this.curSkin=sprite.name;if(!this.curSkin)
return;this.sprite=sprite;this.img=img;var skin=sprite.skin;var modes;if(skin.alwaysRun){modes=["alwaysRun"];}else{modes=[skin.idleAnim?"idle":"stand"];if(options.randomness)
modes.push("run");}
var sx,sy=0,dir,mode,col,interval,timeToModeChange,changeMode=true;function initMode(){timeout=-1;timeToModeChange=(options.changeInterval||0xFFFFFFFF)*(Math.random()+1);var rows=skin.animMirrorLeft?3:4;var oldMode=mode;var oldSy=sy%rows;do{mode=modes[~~(Math.random()*modes.length)];var pf=getPublicFrame(skin);sx=pf[1];sy=pf[0];if(options.randomness){sy=1+(~~(Math.random()*2));if(skin.row)
sy=skin.row[sy];}}while(options.randomness&&oldMode&&(mode==oldMode&&sy==oldSy||mode!=oldMode&&sy!=oldSy));var dir=sy;if(skin.row&&options.randomness){for(dir=0;dir<4;dir++){if(skin.row[dir]==sy)
break;}}
if(mode=="idle"&&sy<rows)
sy+=rows;if(mode=="stand"){col=[sx];sx=0;interval=100;}else{if(mode=="idle"){col=skin.idleCol||defArray(dir%2?skin.idleAnimCountSide:skin.idleAnimCount);}else{col=skin.col||defArray(dir%2?skin.animCountSide:skin.animCount);if(skin.animStand&&!skin.col)
col=col.map(function(v){return v+1});}
if(mode=="run"){interval=skin.animSpeed/Math.max(skin.animCount,skin.animCountSide)/4;}else{interval=skin.idleAnimSpeed/Math.max(skin.idleAnimCount,skin.idleAnimCountSide)/4;}}}
function defArray(n){var r=[];for(var i=0;i<n;i++)r.push(i);return r;}
function updateShadow(){if(options.shadow&&curShadowStyle==null){var meta=calcShadow(ctx,0,0,thumbSize,thumbSize);curShadowStyle=shadowStyle(meta);options.shadow.css(curShadowStyle);}}
function drawFrame(sx){if(canvas.clientHeight==0)
return;ctx.clearRect(0,0,canvas.height,canvas.width);var pixelScale=options.randomness?2*skin.renderWidth/skin.frameWidth:thumbSize/Math.max(skin.frameWidth,skin.frameHeight);if(pixelScale>2&&pixelScale<=2.5)pixelScale=2;var rw=~~(skin.frameWidth*pixelScale);var rh=~~(skin.frameHeight*pixelScale);var dx=~~((thumbSize-rw)/2);var dyDown=~~Math.min((thumbSize-rh)/2,4);var dy=thumbSize-rh-dyDown;if(options.randomness){var renderShiftY=(skin.renderShiftY||0)*pixelScale/(skin.renderWidth/skin.frameWidth);dy=~~((thumbSize-skin.frameHeight*pixelScale+renderShiftY)/2);}
var smoothing=pixelScale!=~~pixelScale;ctx.imageSmoothingEnabled=smoothing;ctx.webkitImageSmoothingEnabled=smoothing;ctx.mozImageSmoothingEnabled=smoothing;ctx.drawImage(img,sx*skin.frameWidth,sy*skin.frameHeight,skin.frameWidth,skin.frameHeight,dx,dy,rw,rh);updateShadow();}
var timeoutSkin=this.curSkin;function playAnim(){if(timeoutSkin!=self.curSkin||timeout==null)
return;if(mode==null||(timeToModeChange<0&&sx==0))
initMode();drawFrame(col[sx]);var delay=interval;if(mode=="idle"&&sx==0&&skin.idlePauseMax){delay=timeout==-1?Math.min(skin.idlePauseMin,700):skin.idlePauseMin+Math.random()*(skin.idlePauseMax-skin.idlePauseMin);}
sx=(sx+1)%col.length;timeout=setTimeout(playAnim,delay);timeToModeChange-=delay;}
function drawThumb(){var pf=getPublicFrame(skin);if(undef(animTempCanvas))
animTempCanvas=document.createElement("canvas");animTempCanvas.width=img.width;animTempCanvas.height=img.height;var srcCtx=animTempCanvas.getContext("2d");srcCtx.drawImage(img,0,0);drawBigThumb(animTempCanvas,srcCtx,skin.frameWidth,skin.frameHeight,default_(skin.renderWidth,skin.frameWidth),ctx,thumbSize,0,pf[1]*skin.frameWidth,pf[0]*skin.frameHeight);updateShadow();}
if(modes.length==1&&modes[0]=="stand"){drawThumb();}else{timeout=-1;playAnim();}}}
angular.module('ui.bootstrap.dropdown',[]).constant('dropdownConfig',{openClass:'open'}).service('dropdownService',['$document',function($document){var openScope=null;this.open=function(dropdownScope){if(!openScope){$document.bind('click',closeDropdown);$document.bind('keydown',escapeKeyBind);}
if(openScope&&openScope!==dropdownScope){openScope.isOpen=false;}
openScope=dropdownScope;};this.close=function(dropdownScope){if(openScope===dropdownScope){openScope=null;$document.unbind('click',closeDropdown);$document.unbind('keydown',escapeKeyBind);}};var closeDropdown=function(evt){var toggleElement=openScope.getToggleElement();if(evt&&toggleElement&&toggleElement[0].contains(evt.target)){return;}
openScope.$apply(function(){openScope.isOpen=false;});};var escapeKeyBind=function(evt){if(evt.which===27){openScope.focusToggleElement();closeDropdown();}};}]).controller('DropdownController',['$scope','$attrs','$parse','dropdownConfig','dropdownService','$animate',function($scope,$attrs,$parse,dropdownConfig,dropdownService,$animate){var self=this,scope=$scope.$new(),openClass=dropdownConfig.openClass,getIsOpen,setIsOpen=angular.noop,toggleInvoker=$attrs.onToggle?$parse($attrs.onToggle):angular.noop;this.init=function(element){self.$element=element;if($attrs.isOpen){getIsOpen=$parse($attrs.isOpen);setIsOpen=getIsOpen.assign;$scope.$watch(getIsOpen,function(value){scope.isOpen=!!value;});}};this.toggle=function(open){return scope.isOpen=arguments.length?!!open:!scope.isOpen;};this.isOpen=function(){return scope.isOpen;};scope.getToggleElement=function(){return self.toggleElement;};scope.focusToggleElement=function(){if(self.toggleElement){self.toggleElement[0].focus();}};scope.$watch('isOpen',function(isOpen,wasOpen){$animate[isOpen?'addClass':'removeClass'](self.$element,openClass);if(isOpen){scope.focusToggleElement();dropdownService.open(scope);}else{dropdownService.close(scope);}
setIsOpen($scope,isOpen);if(angular.isDefined(isOpen)&&isOpen!==wasOpen){toggleInvoker($scope,{open:!!isOpen});}});$scope.$on('$locationChangeSuccess',function(){scope.isOpen=false;});$scope.$on('$destroy',function(){scope.$destroy();});}]).directive('dropdown',function(){return{controller:'DropdownController',link:function(scope,element,attrs,dropdownCtrl){dropdownCtrl.init(element);}};}).directive('dropdownToggle',function(){return{require:'?^dropdown',link:function(scope,element,attrs,dropdownCtrl){if(!dropdownCtrl){return;}
dropdownCtrl.toggleElement=element;var toggleDropdown=function(event){event.preventDefault();if(!element.hasClass('disabled')&&!attrs.disabled){scope.$apply(function(){dropdownCtrl.toggle();});}};element.bind('click',toggleDropdown);element.attr({'aria-haspopup':true,'aria-expanded':false});scope.$watch(dropdownCtrl.isOpen,function(isOpen){element.attr('aria-expanded',!!isOpen);});scope.$on('$destroy',function(){element.unbind('click',toggleDropdown);});}};});
angular.module('ui.bootstrap.modal',[]).factory('$$stackedMap',function(){return{createNew:function(){var stack=[];return{add:function(key,value){stack.push({key:key,value:value});},get:function(key){for(var i=0;i<stack.length;i++){if(key==stack[i].key){return stack[i];}}},keys:function(){var keys=[];for(var i=0;i<stack.length;i++){keys.push(stack[i].key);}
return keys;},top:function(){return stack[stack.length-1];},remove:function(key){var idx=-1;for(var i=0;i<stack.length;i++){if(key==stack[i].key){idx=i;break;}}
return stack.splice(idx,1)[0];},removeTop:function(){return stack.splice(stack.length-1,1)[0];},length:function(){return stack.length;}};}};}).directive('modalBackdrop',['$timeout',function($timeout){return{restrict:'EA',replace:true,templateUrl:'tmpl/modal/backdrop.tmpl',compile:function(tElement,tAttrs){tElement.addClass(tAttrs.backdropClass);return linkFn;}};function linkFn(scope,element,attrs){scope.animate=false;$timeout(function(){scope.animate=true;});}}]).directive('modalWindow',['$modalStack','$q',function($modalStack,$q){return{restrict:'EA',scope:{index:'@',animate:'='},replace:true,transclude:true,templateUrl:function(tElement,tAttrs){return tAttrs.templateUrl||'tmpl/modal/window.tmpl';},link:function(scope,element,attrs){element.addClass(attrs.windowClass||'');scope.size=attrs.size;scope.close=function(evt){var modal=$modalStack.getTop();if(modal&&modal.value.backdrop&&modal.value.backdrop!='static'&&(evt.target===evt.currentTarget)){evt.preventDefault();evt.stopPropagation();$modalStack.dismiss(modal.key,'backdrop click');}};scope.$isRendered=true;var modalRenderDeferObj=$q.defer();attrs.$observe('modalRender',function(value){if(value=='true'){modalRenderDeferObj.resolve();}});modalRenderDeferObj.promise.then(function(){scope.animate=true;var inputsWithAutofocus=element[0].querySelectorAll('[autofocus]');if(inputsWithAutofocus.length){inputsWithAutofocus[0].focus();}else{element[0].focus();}
var modal=$modalStack.getTop();if(modal){$modalStack.modalRendered(modal.key);}});}};}]).directive('modalAnimationClass',[function(){return{compile:function(tElement,tAttrs){if(tAttrs.modalAnimation){tElement.addClass(tAttrs.modalAnimationClass);}}};}]).directive('modalTransclude',function(){return{link:function($scope,$element,$attrs,controller,$transclude){$transclude($scope.$parent,function(clone){$element.empty();$element.append(clone);});}};}).factory('$modalStack',['$animate','$timeout','$document','$compile','$rootScope','$$stackedMap',function($animate,$timeout,$document,$compile,$rootScope,$$stackedMap){var OPENED_MODAL_CLASS='modal-open';var backdropDomEl,backdropScope;var openedWindows=$$stackedMap.createNew();var $modalStack={};function backdropIndex(){var topBackdropIndex=-1;var opened=openedWindows.keys();for(var i=0;i<opened.length;i++){if(openedWindows.get(opened[i]).value.backdrop){topBackdropIndex=i;}}
return topBackdropIndex;}
$rootScope.$watch(backdropIndex,function(newBackdropIndex){if(backdropScope){backdropScope.index=newBackdropIndex;}});function removeModalWindow(modalInstance,elementToReceiveFocus){var body=$document.find('body').eq(0);var modalWindow=openedWindows.get(modalInstance).value;openedWindows.remove(modalInstance);removeAfterAnimate(modalWindow.modalDomEl,modalWindow.modalScope,function(){body.toggleClass(OPENED_MODAL_CLASS,openedWindows.length()>0);checkRemoveBackdrop();});if(elementToReceiveFocus&&elementToReceiveFocus.focus){elementToReceiveFocus.focus();} else{body.focus();}}
function checkRemoveBackdrop(){if(backdropDomEl&&backdropIndex()==-1){var backdropScopeRef=backdropScope;removeAfterAnimate(backdropDomEl,backdropScope,function(){backdropScopeRef=null;});backdropDomEl=undefined;backdropScope=undefined;}}
function removeAfterAnimate(domEl,scope,done){scope.animate=false;if(domEl.attr('modal-animation')&&$animate.enabled()){domEl.one('$animate:close',function closeFn(){$rootScope.$evalAsync(afterAnimating);});}else{$timeout(afterAnimating);}
function afterAnimating(){if(afterAnimating.done){return;}
afterAnimating.done=true;domEl.remove();scope.$destroy();if(done){done();}}}
$document.bind('keydown',function(evt){var modal;if(evt.which===27){modal=openedWindows.top();if(modal&&modal.value.keyboard){evt.preventDefault();$rootScope.$apply(function(){$modalStack.dismiss(modal.key,'escape key press');});}}});$modalStack.open=function(modalInstance,modal){var modalOpener=$document[0].activeElement;openedWindows.add(modalInstance,{deferred:modal.deferred,renderDeferred:modal.renderDeferred,modalScope:modal.scope,backdrop:modal.backdrop,keyboard:modal.keyboard});var body=$document.find('body').eq(0),currBackdropIndex=backdropIndex();if(currBackdropIndex>=0&&!backdropDomEl){backdropScope=$rootScope.$new(true);backdropScope.index=currBackdropIndex;var angularBackgroundDomEl=angular.element('<div modal-backdrop="modal-backdrop"></div>');angularBackgroundDomEl.attr('backdrop-class',modal.backdropClass);if(modal.animation){angularBackgroundDomEl.attr('modal-animation','true');}
backdropDomEl=$compile(angularBackgroundDomEl)(backdropScope);body.append(backdropDomEl);}
var angularDomEl=angular.element('<div modal-window="modal-window"></div>');angularDomEl.attr({'template-url':modal.windowTemplateUrl,'window-class':modal.windowClass,'size':modal.size,'index':openedWindows.length()-1,'animate':'animate'}).html(modal.content);if(modal.animation){angularDomEl.attr('modal-animation','true');}
var modalDomEl=$compile(angularDomEl)(modal.scope);openedWindows.top().value.modalDomEl=modalDomEl;openedWindows.top().value.modalOpener=modalOpener;body.append(modalDomEl);body.addClass(OPENED_MODAL_CLASS);};function broadcastClosing(modalWindow,resultOrReason,closing){return!modalWindow.value.modalScope.$broadcast('modal.closing',resultOrReason,closing).defaultPrevented;}
$modalStack.close=function(modalInstance,result){var modalWindow=openedWindows.get(modalInstance);if(modalWindow&&broadcastClosing(modalWindow,result,true)){modalWindow.value.deferred.resolve(result);removeModalWindow(modalInstance,modalWindow.value.modalOpener);return true;}
return!modalWindow;};$modalStack.dismiss=function(modalInstance,reason){var modalWindow=openedWindows.get(modalInstance);if(modalWindow&&broadcastClosing(modalWindow,reason,false)){modalWindow.value.deferred.reject(reason);removeModalWindow(modalInstance,modalWindow.value.modalOpener);return true;}
return!modalWindow;};$modalStack.dismissAll=function(reason){var topModal=this.getTop();while(topModal&&this.dismiss(topModal.key,reason)){topModal=this.getTop();}};$modalStack.getTop=function(){return openedWindows.top();};$modalStack.modalRendered=function(modalInstance){var modalWindow=openedWindows.get(modalInstance);if(modalWindow){modalWindow.value.renderDeferred.resolve();}};return $modalStack;}]).provider('$modal',function(){var $modalProvider={options:{animation:true,backdrop:true,keyboard:true},$get:['$injector','$rootScope','$q','$templateRequest','$controller','$modalStack',function($injector,$rootScope,$q,$templateRequest,$controller,$modalStack){var $modal={};function getTemplatePromise(options){return options.template?$q.when(options.template):$templateRequest(angular.isFunction(options.templateUrl)?(options.templateUrl)():options.templateUrl);}
function getResolvePromises(resolves){var promisesArr=[];angular.forEach(resolves,function(value){if(angular.isFunction(value)||angular.isArray(value)){promisesArr.push($q.when($injector.invoke(value)));}});return promisesArr;}
$modal.open=function(modalOptions){var modalResultDeferred=$q.defer();var modalOpenedDeferred=$q.defer();var modalRenderDeferred=$q.defer();var modalInstance={result:modalResultDeferred.promise,opened:modalOpenedDeferred.promise,rendered:modalRenderDeferred.promise,close:function(result){return $modalStack.close(modalInstance,result);},dismiss:function(reason){return $modalStack.dismiss(modalInstance,reason);}};modalOptions=angular.extend({},$modalProvider.options,modalOptions);modalOptions.resolve=modalOptions.resolve||{};if(!modalOptions.template&&!modalOptions.templateUrl){throw new Error('One of template or templateUrl options is required.');}
var templateAndResolvePromise=$q.all([getTemplatePromise(modalOptions)].concat(getResolvePromises(modalOptions.resolve)));templateAndResolvePromise.then(function resolveSuccess(tplAndVars){var modalScope=(modalOptions.scope||$rootScope).$new();modalScope.$close=modalInstance.close;modalScope.$dismiss=modalInstance.dismiss;var ctrlInstance,ctrlLocals={};var resolveIter=1;if(modalOptions.controller){ctrlLocals.$scope=modalScope;ctrlLocals.$modalInstance=modalInstance;angular.forEach(modalOptions.resolve,function(value,key){ctrlLocals[key]=tplAndVars[resolveIter++];});ctrlInstance=$controller(modalOptions.controller,ctrlLocals);if(modalOptions.controllerAs){modalScope[modalOptions.controllerAs]=ctrlInstance;}}
$modalStack.open(modalInstance,{scope:modalScope,deferred:modalResultDeferred,renderDeferred:modalRenderDeferred,content:tplAndVars[0],animation:modalOptions.animation,backdrop:modalOptions.backdrop,keyboard:modalOptions.keyboard,backdropClass:modalOptions.backdropClass,windowClass:modalOptions.windowClass,windowTemplateUrl:modalOptions.windowTemplateUrl,size:modalOptions.size});},function resolveError(reason){modalResultDeferred.reject(reason);});templateAndResolvePromise.then(function(){modalOpenedDeferred.resolve(true);},function(reason){modalOpenedDeferred.reject(reason);});return modalInstance;};return $modal;}]};return $modalProvider;});
angular.module('ngClipboard',[]).provider('ngClip',function(){var self=this;this.path='//cdnjs.cloudflare.com/ajax/libs/zeroclipboard/2.1.6/ZeroClipboard.swf';return{setPath:function(newPath){self.path=newPath;},setConfig:function(config){self.config=config;},$get:function(){return{path:self.path,config:self.config};}};}).run(['ngClip',function(ngClip){var config={swfPath:ngClip.path,trustedDomains:["*"],allowScriptAccess:"always",forceHandCursor:true,};ZeroClipboard.config(angular.extend(config,ngClip.config||{}));}]).directive('clipCopy',['ngClip',function(ngClip){return{scope:{clipCopy:'&',clipClick:'&',clipClickFallback:'&'},restrict:'A',link:function(scope,element,attrs){if(ZeroClipboard.isFlashUnusable()){element.bind('click',function($event){scope.$apply(scope.clipClickFallback({$event:$event,copy:scope.$eval(scope.clipCopy)}));});return;}
var client=new ZeroClipboard(element);if(attrs.clipCopy===""){scope.clipCopy=function(scope){return element[0].previousElementSibling.innerText;};}
client.on('ready',function(readyEvent){client.on('copy',function(event){var clipboard=event.clipboardData;clipboard.setData('text/plain',scope.$eval(scope.clipCopy));});client.on('aftercopy',function(event){if(angular.isDefined(attrs.clipClick)){scope.$apply(scope.clipClick);}});scope.$on('$destroy',function(){client.destroy();});});}};}]);
function Players(){this.playersModified=false;this.players=[];this.idx_ids={};this.myId;this.sorted=[];}
Players.prototype={add:function(players){if(!Object.keys(players).length)return;var index;if(typeof players=='object'&&players instanceof Array){for(var i=0,l=players.length,player;i<l;i++){player=players[i];index=this.players.push(player)-1;this.idx_ids[player.id]=index;player.pos=index+1;}}else{var player=players;index=this.players.push(player)-1;this.idx_ids[player.id]=index;player.pos=index+1;}
this.onChange();},get:function(id){if(!id)return;return this.players[this.idx_ids[id]];},update:function(ids){this.onChange();},del:function(id){if(!id)return;var index=this.idx_ids[id],player;if(index===undefined)return;player=this.players[index];this.players.splice(index,1);delete this.idx_ids[player.id];for(var i=0;i<this.players.length;i++){this.idx_ids[this.players[i].id]=i;}
this.onChange();},delAll:function(){this.players=[];this.idx_ids={};this.myId=null;this.onChange();},getNicknames:function(){var result=[];for(var i in this.players){result.push(this.players[i].nickname);}
return result;},getIdByNickname:function(nickname){for(var i in this.players){if(this.players[i].nickname==nickname)
return this.players[i].id;}
return 0;},updateIndex:function(fromIdx){var self=this;for(var i=fromIdx||0;i<this.players.length;i++){this.players[i].pos=i+1;this.idx_ids[this.players[i].id]=i;}},onChange:function(){},onSort:function(){}}
function Squad(opts){if(!opts||!opts.id||!opts.ownerId)return;this.id=opts.id;this.ownerId=opts.ownerId;this.players=[];this.full=false;this.idx={};this.private=opts.private||false;if(opts.players)this.add(opts.players);}
bombermine.run(function(Game){Squad.prototype.Game=Game})
Squad.prototype={add:function(players){players=players instanceof Array?players:[players];for(var i=0;i<players.length;i++){var playerId=players[i].id;this.idx[playerId]=this.players.push(players[i])-1;}},get:function(playerId){return this.players[this.idx[playerId]];},getAll:function(){return this.players;},del:function(playerId){var idx=this.idx[playerId];this.players.splice(idx,1);this.updateIdx(idx);},delAll:function(){this.players=[];this.idx={};this.full=false;},updateIdx:function(fromIdx){for(var i=fromIdx||0;i<this.players.length;i++){this.idx[this.players[i].id]=i;}}}
function Squads(squads){this.squads=[];this.idx={};this.mySquadId=null;this.$el=null;if(squads)this.add(squads);}
Squads.prototype={add:function(squads){if(!squads)return;squads=squads instanceof Array?squads:[squads];for(var i=0;i<squads.length;i++){var squad=squads[i];if(squad)
this.idx[squad.id]=this.squads.push(new Squad(squad))-1;}
this.onUpdate();},get:function(id){return this.squads[this.idx[id]];},getAll:function(){return this.squads;},del:function(id){var idx=this.idx[id];this.squads.splice(idx,1);this.updateIdx(idx);if(this.mySquadId==id)this.mySquadId=null;this.onUpdate();},delAll:function(){this.squads=[];this.idx={};this.mySquadId=null;this.onUpdate();},updateIdx:function(fromIdx){for(var i=fromIdx||0;i<this.squads.length;i++){this.idx[this.squads[i].id]=i;}},onCreate:function(id){if(this._mySquadId&&this.get(this._mySquadId)){delete this.get(this._mySquadId).my;delete this._mySquadId;}
this._mySquadId=this.mySquadId;this.get(this.mySquadId).my=true;this.onUpdate();if(this.$el)
this.$el.animate({'scrollTop':0},100);},onJoin:function(id){if(this._mySquadId&&this.get(this._mySquadId)){delete this.get(this._mySquadId).my;delete this._mySquadId;}
this._mySquadId=this.mySquadId;this.get(this.mySquadId).my=true;this.onUpdate();if(this.$el)
this.$el.animate({'scrollTop':0},100);},onLeave:function(id){if(this._mySquadId&&this.get(this._mySquadId)){delete this.get(this._mySquadId).my;delete this._mySquadId;}
console.log('Leaved squad! id: %d',this.mySquadId);this.onUpdate();},onInvite:function(id){},onUpdate:function(){}}
bombermine.controller('AbilitiesCtrl',function($scope,$rootScope,$http,ShopService,Game,storage,parseTimeFilter){$scope.shopmodel=ShopService.getModel();$scope.UNIT_NONE=0;$scope.UNIT_COUNT=2;$scope.UNIT_ROUNDS=3;$scope.UNIT_SECONDS=4;$scope.FLAG_NO_STATS=8;$scope.buyMore=function(curr){if($scope.selectedPerk&&$scope.shopPerkByName[$scope.selectedPerk.name]){$scope.selectedPerk.type='timeperks';$rootScope.showBuyItemModal($scope.selectedPerk,curr,'buymore');}};function copy(src,dst){if(src){for(var key in src)
if(src.hasOwnProperty(key))
dst[key]=src[key];}}
function calcNames(a){var b={};for(var key in a)
b[a[key].name]=a[key];return b;}
$scope.backendPerks=$scope.shopmodel.timeperks;$scope.backendPerkByName=calcNames($scope.shopmodel.timeperks);$scope.shopPerks=[];$scope.shopPerkByName={};$scope.gameData={};$scope.slotsLimit=0;$scope.inventoryPerks=[];$scope.perkByName={}
$scope.slots=[{perk:null,open:true,index:1},{perk:null,open:true,index:2},{perk:null,open:false,index:3},{perk:null,open:false,index:4}]
$scope.loaded=false;$scope.selectedPerkName="";$scope.favoritePerks=null;$scope.getSlotStatus=function(slot){if(!slot.open)return 0;if(!slot.perk)return 1;return 2;}
Game.on('gamePerksChange',function(perks){if(!$scope.$$phase)return $scope.$apply(function(){Game.emit('gamePerksChange',perks)})
$scope.loaded=true;$scope.gameData=perks;$rootScope.clientCanChangePerks=typeof perks.clientCanChange!="undefined"?perks.clientCanChange:!perks.respawned;function ugradeFormat(p){if(typeof p.unit=="undefined"){if(p.type>=2&&p.type<=4){p.unit=p.type;p.canActivate=true;p.quantity=p.seconds+p.rounds+p.count;}else if(p.type==8){p.unit=$scope.UNIT_SECONDS;p.canActivate=false;p.quantity=p.seconds;}else{p.unit=$scope.UNIT_NONE;p.canActivate=true;}
p.flags=0;delete p.type;delete p.seconds;delete p.count;delete p.rounds;}}
$rootScope.respawned=perks.respawned;for(var i=0;i<perks.available.length;i++)
ugradeFormat(perks.available[i]);for(var i=0;i<perks.active.length;i++)
ugradeFormat(perks.active[i]);for(var i=0;i<perks.all.length;i++)
ugradeFormat(perks.all[i]);$scope.slotsLimit=$rootScope.user.slots_limit;$scope.recalcPerks();})
function isTimePerkAndCanActivate(p){return p.type==$scope.UNIT_SECONDS&&p.canActivate;}
$scope.loadActivePerks=function(){$scope.favoritePerks=[null,null,null,null];for(var i=0;i<$scope.gameData.active.length&&i<4;i++){$scope.favoritePerks[i]=$scope.gameData.active[i].name;}
return $scope.favoritePerks;}
$scope.loadFavoritePerks=function(){var value=storage.getItem("game/selected_perks");if(value)
return $scope.favoritePerks=JSON.parse(value);else
return $scope.favoritePerks||[null,null,null,null];}
$scope.saveFavoritePerks=function(){$scope.favoritePerks=[];for(var i=0;i<$scope.slots.length;i++)
$scope.favoritePerks.push($scope.slots[i].perk?$scope.slots[i].perk.name:null);storage.setItem("game/selected_perks",JSON.stringify($scope.favoritePerks));$scope.saveSelectedPerks();}
$scope.saveSelectedPerks=function(){Game.perksSelected=[];for(var i=0;i<$scope.slots.length;i++)
Game.perksSelected.push($scope.slots[i].perk!=null?$scope.slots[i].perk.id:-1);};$scope.$on("buySlot",function(){$scope.slotsLimit=$rootScope.user.slots_limit;})
$scope.recalcPerks=function(){var g=$scope.gameData;$scope.powerupsActive=0;$scope.shopPerks=[]
for(var i=0;i<g.all.length;i++){var perk=g.all[i];var b=$scope.backendPerkByName[perk.name];if(b){copy(b,perk);$scope.shopPerks.push(perk);perk.canActivate=false;}}
$scope.shopPerkByName=calcNames($scope.shopPerks);$scope.inventoryPerks=[];for(var i=0;i<g.available.length;i++){var perk=g.available[i];var b=$scope.shopPerkByName[perk.name];if(b){copy(perk,b);if(perk.unit==$scope.UNIT_SECONDS){$scope.powerupsActive++;}}else{$scope.inventoryPerks.push(perk);}}
$scope.inventoryPerkByName=calcNames($scope.inventoryPerks);$scope.perkByName={}
copy($scope.shopPerkByName,$scope.perkByName)
copy($scope.inventoryPerkByName,$scope.perkByName)
var fromGame=$scope.gameData.respawned;var p=fromGame?$scope.loadActivePerks():$scope.loadFavoritePerks();for(var i=0;i<$scope.slots.length;i++){$scope.slots[i].open=i<$scope.slotsLimit;$scope.slots[i].perk=null;if(i<$scope.slotsLimit){if(p[i]){var perk=$scope.perkByName[p[i]];if(perk&&(fromGame||$scope.canActivatePerk(perk))){$scope.slots[i].perk=perk;$scope.slots[i].perk.slotIndex=i+1;}}}}
var b=$scope.selectedPerk;$scope.selectedPerk=(b&&$scope.perkByName[b])?$scope.perkByName[b]:null;$scope.saveFavoritePerks();updateTutor();}
$scope.canActivatePerk=function(perk){return perk&&perk.canActivate&&$rootScope.clientCanChangePerks;}
$scope.selectPerk=function(perk){$scope.selectedPerk=perk;updateTutor()}
$scope.getFirstFreeSlot=function(){for(var i=0;i<$scope.slots.length;i++)
if(!$scope.slots[i].perk&&$scope.slots[i].open)
return i+1;return 0;}
$scope.isThereLocketSlot=function(){for(var i=0;i<$scope.slots.length;i++)
if(!$scope.slots[i].open)return true;return false;};$scope.togglePerk=function(perk){if(typeof $rootScope.clientCanChangePerks=="undefined"){if($rootScope.respawned)return;}else{if(!$rootScope.clientCanChangePerks)return;}
if(perk.slotIndex){$scope.slots[perk.slotIndex-1].perk=null;perk.slotIndex=0;$scope.selectedPerk=null;$scope.saveFavoritePerks();}else{if($scope.canActivatePerk(perk)){perk.slotIndex=$scope.getFirstFreeSlot();if(perk.slotIndex){$scope.slots[perk.slotIndex-1].perk=perk;$scope.selectedPerk=null;$scope.saveFavoritePerks();}else{if($scope.isThereLocketSlot()){$rootScope.showBuySlot($scope.slots);}}}else{}}
updateTutor()}
$scope.selectLockedSlot=function(index){$scope.selectedPerk={name:"slot_"+index,type:0}
updateTutor()}
$scope.movePerk=function(perk,slot){if(!$rootScope.clientCanChangePerks)return;if(perk.slotIndex){$scope.slots[perk.slotIndex-1].perk=null;perk.slotIndex=0;}
perk.slotIndex=slot.index;slot.perk=perk;$scope.saveFavoritePerks();updateTutor()}
$scope.clearSlots=function(){if(!$rootScope.clientCanChangePerks)return;for(var i=0;i<$scope.slots.length;i++){var perk=$scope.slots[i].perk;if(perk){$scope.slots[i].perk=null;perk.slotIndex=0;}}
$scope.saveFavoritePerks();}
$scope.slotClick=function(slot){if(slot.open){if(slot.perk)
$scope.selectedPerk=slot.perk;else if($scope.selectedPerk&&$scope.canActivatePerk($scope.selectedPerk))
$scope.movePerk($scope.selectedPerk,slot);}else{}
updateTutor()}
$scope.slotDblClick=function(slot){if(slot.open){if(slot.perk)
$scope.togglePerk(slot.perk);}else{}}
$scope.$on('tabMenuOpen',function(){if($scope.menuState==0){$scope.selectedPerk=null;}else{updateTutor()}})
$scope.$on('selectPerk',function(event,data){$scope.selectedPerk=($scope.perkByName[data])?$scope.perkByName[data]:null;})
function updateTutor(){if(!$scope.tutor)return;var t=null;var sel=$scope.selectedPerk;if($scope.menuTitle=='help_buy_powerup'){for(var i=0;i<$scope.slots.length;i++)
if($scope.slots[i].perk!=null&&isTimePerkAndCanActivate($scope.slots[i].perk)){$scope.tutor['help_buy_powerup']="respawn";return;}
if(sel!=null){if(sel.unit==$scope.UNIT_SECONDS){if(sel.canActivate){t="select_slot"
for(var i=0;i<$scope.slots.length;i++)
if($scope.slots[i].perk!=null&&isTimePerkAndCanActivate($scope.slots[i].perk)){t="respawn";break;}}else t="buy_more"}else t="select_powerup"}else t="select_powerup"}
$scope.tutor['help_buy_powerup']=t;console.log("current powerup buy state: "+t);}
$scope.quantityStr=function(perk){if(perk==null||perk.unit==null)
return'';var s='';switch(perk.unit){case $scope.UNIT_NONE:s='\u221e';break;case $scope.UNIT_SECONDS:s=parseTimeFilter(perk.quantity);break;default:s=''+perk.quantity;break;}
if(perk.flags&$scope.FLAG_NO_STATS)s='\u2605'+s;return s;}})
FILTERS.filter('parseTime',function(i18nFilter){return function(seconds){var str='';if(seconds<60)
str=seconds+i18nFilter("seconds_short");else{var minutes=seconds/60|0;seconds=seconds%60;if(minutes<60){str=minutes+i18nFilter("minutes_short");if(seconds)
str+=' '+seconds+i18nFilter("seconds_short");}else{var hours=minutes/60|0;minutes=minutes%60;if(hours<24){str=hours+i18nFilter("hours_short");if(minutes)
str+=' '+minutes+i18nFilter("minutes_short");}else{var days=hours/24|0;hours=hours%24;str=days+i18nFilter("days_short");if(hours)
str+=' '+hours+i18nFilter("hours_short");}}}
return str;}});FILTERS.filter('parseRelativeTime',function(parseTime,i18nFilter){return function(seconds){seconds-=Date.now()/1000;return seconds<=0?i18nFilter("expired"):parseTime(seconds);}});FILTERS.filter('parseRelativeTimeDHM',function(i18nFilter,localize){return function(seconds){seconds-=Date.now()/1000;if(seconds<=0)return i18nFilter("expired");var str='';if(seconds<60)
str=seconds+i18nFilter("secods_short");else{var minutes=Math.ceil(seconds/60);if(minutes<60){str=minutes+' '+localize.withCorrectEnding("minutes",minutes);}else{var hours=Math.ceil(minutes/60);if(hours<24){str=hours+' '+localize.withCorrectEnding("hours",hours);}else{var days=Math.ceil(hours/24);str=days+' '+localize.withCorrectEnding("days",days);}}}
return str;}});FILTERS.filter('parseDay',function(i18nFilter){return function(day){var str='';if(day==1)
str='day';if(day>1&&day<5)
str='day2';if(day>4)
str='day3';return str;}});
bombermine.controller('BombEventCtrl',function($location,$scope,$rootScope,$http){$scope.disable_buttons_flag=false;$scope.buyPumpkin=function(){$scope.disable_buttons_flag=true;$http.post("/api/v3/buyCountPerk",{name:"pumpkin_bomb",count:$scope.pumpkin_number,currency:"plutonium"}).success(function(data){$scope.user.plutonium=data.plutonium;$scope.user.gold=data.gold;$scope.disable_buttons_flag=false;Game.appInputRejoin();$scope.purchase_msg=true;$scope.purchase_msg_success=true;$scope.purchase_msg_nepu=false;}).error(function(){$scope.disable_buttons_flag=false;$scope.purchase_msg=true;$scope.purchase_msg_success=false;$scope.purchase_msg_nepu=true;})}
$scope.pumpkin_number=50;$scope.disable_buttons_flag=false;$scope.purchase_msg=false;update_pu_amount=function(){$scope.pu_amount=Math.ceil($scope.pumpkin_number/2);$scope.bonus_amount=Math.floor($scope.pumpkin_number/50)*5;}
update_pu_amount();$scope.pumpkin_more=function(){if($scope.pumpkin_number<990)$scope.pumpkin_number+=10;update_pu_amount();}
$scope.pumpkin_less=function(){if($scope.pumpkin_number>10)$scope.pumpkin_number-=10;update_pu_amount();}
$scope.update_pu=function(){if(parseInt($("input.pumpkin_number").val())>0)$scope.pumpkin_number=parseInt($("input.pumpkin_number").val())
else if(parseInt($("input.pumpkin_number").val())<=0)$("input.pumpkin_number").val(1);update_pu_amount();}});
bombermine.controller('ChatCtrl',function($rootScope,$scope,$sce,dropdownService,community,Game,serverList,storage,$http,IgnoreService,i18nFilter,localize){var TYPE_COMMON='c';var TYPE_SERVER='s';var TYPE_KILL='k';var TYPE_MOD='m';var TYPE_PRIVATE='p';var TYPE_PRIVATE_MOD='!';var CENS_DISABLED="C";var CHAT_DISABLED="A";var SCROLL_DISABLED="S";var actualFilters=/[^ckmCAS]/g
var SHOW_TIME_INTERVAL=1000*60*2;var SHOW_IGNORED_INTERVAL=1000*60*5;var MAX_IGNORED=50;var defaultIgnoresHidden=($scope.user.perm_mask&2)==0;var censorManager=new CensorManager();$scope.filtered=storage.getItem('game/chatFilters',"").replace(actualFilters,"");$scope.chat=[];var oldTime=0,oldCensTime=0,oldHiddenTime=0,oldIgnoreTime=0;var chatHistoryRecieved=false;var recentlyIgnored=[];$scope.toggleFilter=function(type){var filtered=$scope.filtered;var index=filtered.indexOf(type);index===-1?filtered+=type:filtered=filtered.substring(0,index)+filtered.substring(index+1);$scope.filtered=filtered;storage.setItem('game/chatFilters',filtered);scrollChat();}
$scope.chatDisabled=function(){return $scope.filtered.indexOf(CHAT_DISABLED)!==-1;}
$scope.hasFilter=function(type){return $scope.filtered.indexOf(type)!==-1||$scope.chatDisabled();}
$scope.isVisible=function(msg){return!msg.hidden&&!$scope.hasFilter(msg.type)&&($scope.hasFilter(CENS_DISABLED)||!msg.hideCensored);}
$scope.getText=function(msg){return $scope.hasFilter(CENS_DISABLED)?msg.text:(msg.censored||msg.text);}
function getServerProperty(key){var server=serverList.activeServer();if(server&&server[key])return server[key];return $rootScope.config[key];}
var globalIdByNickname={};function sanitizeLite(str){return str.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#x27;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\//g,'&#x2F;').replace(/\`/g,'&#96;').replace(/[\x00-\x1F\x7F\u2500-\u259F]/g,'');}
function processColor(msg){if(msg.text.slice(0,2)=='# '){msg.green=true;msg.text=msg.text.replace(/^\#\s?/,'');}else if(msg.text.slice(0,2)=='! '){msg.red=true;msg.text=msg.text.replace(/\!\s?/,'');}}
function formatServerResonse(msg){msg.text=localize.getStringMsgOpt('msg_'+msg.text)||msg.text;processColor(msg);}
function createMessage(name,text,admin,secsAgo,obs,rejected,globalUserId,options){var user=$rootScope.user;if(globalUserId)
globalIdByNickname[name]=globalUserId;var date_time=Date.now()-secsAgo*1000;var msg={nickname:name,text:text,admin:admin,date_time:date_time,obs:obs,type:globalUserId==0?TYPE_SERVER:TYPE_COMMON,my:false,ngclass:''};options=options||{};for(var key in options)
msg[key]=options[key];if(Game.players.myId>=0&&Game.players.get(Game.players.myId).nickname==msg.nickname){msg.type=TYPE_PRIVATE;msg.my=true;}
if(secsAgo==0)
chatHistoryRecieved=true;if(secsAgo!=0&&chatHistoryRecieved==true)
return"";if(admin){processColor(msg);if((msg.red||msg.green)&&globalUserId)
msg.type=(msg.type==TYPE_PRIVATE)?TYPE_PRIVATE_MOD:TYPE_MOD;}
var censors=getServerProperty("censors");if(name!="SERVER"&&!rejected&&!msg.red&&!msg.green&&!msg.my&&typeof censors!="undefined")
{var censored=censorManager.process(msg.text,Game.players.getNicknames(),censors);if(censored!=msg.text){if(censored=="")
msg.hideCensored=true;else
msg.censored=censored;if((user.perm_mask&2)==0){if(!$scope.hasFilter(CENS_DISABLED)){msg.text=msg.hideCensored?"":(msg.censored||msg.text);}
delete msg.hideCensored;delete msg.censored;}}}
var retText=name=="SERVER"?"":$scope.hasFilter(CENS_DISABLED)?msg.text:msg.hideCensored?"":(msg.censored||msg.text);msg.text=sanitizeLite(msg.text);if(msg.censored)
msg.censored=sanitizeLite(msg.censored);if(Game.players.myId){var nickname=Game.players.get(Game.players.myId).nickname;if(nickname&&nickname.length>0){nickname=nickname.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");var regexp=RegExp('@'+nickname+'\\b','ig');if(regexp.test(msg.text)){msg.type=msg.type==TYPE_PRIVATE_MOD||msg.type==TYPE_MOD?TYPE_PRIVATE_MOD:TYPE_PRIVATE;msg.text=msg.text.replace(regexp,'<b class="me">$&</b>');if(msg.censored)
msg.censored=msg.censored.replace(regexp,'<b class="me">$&</b>');}}}
if(rejected){if(Game.gameChatReadOnlyExpires>Date.now()){msg.special='RO';msg.moment=$sce.trustAsHtml(moment(Game.gameChatReadOnlyExpires).format('[<b>]H:mm[</b>] DD.MM.YY'));}else if(!user.isRegistered()){msg.special=user.email?'email':'guest';}else{msg.special='RO';msg.moment='';}}else if(options.ignoreList){msg.special="ignoreList";}else if(name=="SERVER"){formatServerResonse(msg);}
if(IgnoreService.isIgnored(globalUserId)&&msg.type!=TYPE_PRIVATE_MOD){msg.hidden=defaultIgnoresHidden;msg.ngclass+='ignored ';recentlyIgnored.push(msg);if(msg.hidden)
retText="";}
var d=new Date(date_time)
msg.time=(d.getHours()+':'+d.getMinutes()).replace(/^(\d{1,2})\:(\d{1})$/,'$1:0$2');msg.showTime=false;if(date_time-oldTime>SHOW_TIME_INTERVAL&&!msg.hideCensored&&!msg.hidden){oldTime=date_time;msg.showTime=true;}
if(msg.hideCensored&&date_time-Math.max(oldTime,oldCensTime)>SHOW_TIME_INTERVAL){oldCensTime=date_time;msg.showTime=true;}
if(msg.hidden&&date_time-Math.max(oldTime,oldHiddenTime)>SHOW_TIME_INTERVAL){oldHiddenTime=date_time;msg.showTime=true;}
pushMessage(msg);return retText;}
function scrollChat(){if(!$scope.hasFilter(SCROLL_DISABLED))
Utils.scroll($scope,document.querySelector('#chat ul.chat-list'),1e7);}
function pushMessage(msg){if(msg.text==""&&msg.special==null)
return;msg.ngclass=msg.ngclass||'';if(msg.obs)msg.ngclass+='obs ';if(msg.red)msg.ngclass+='red ';if(msg.green)msg.ngclass+='green ';if(msg.killinfo)msg.ngclass+='kill-info ';msg.text=$sce.trustAsHtml(msg.text);if(msg.censored)
msg.censored=$sce.trustAsHtml(msg.censored);$scope.chat.push(msg);Utils.digest($scope);if(!msg.hidden)
scrollChat();}
Game.on('gameEventChat',createMessage);Game.on('gameNecroLog',function(who,whom,me){if(!me)
return;var d,now=((d=new Date).getHours()+':'+d.getMinutes()).replace(/^(\d{1,2})\:(\d{1})$/,'$1:0$2');$li=$('<li>');if(who.length!=0){$li.append('<i class="ico grid"></i> ',$('<span class="who">').text(who.join(', ')),' <i class="ico bombed"></i> ',$('<span class="whom">').text(whom.join(', ')))}else{$li.append('<i class="ico grid"></i> <i class="ico self-bombed"></i> ',$('<span class="whom">').text(whom[0]))}
pushMessage({killinfo:true,text:$li.html(),time:now,type:TYPE_KILL});})
var myLastChatMsg='';Game.on('gameEventSendChat',function(msg){if(~msg.indexOf('--s'))
return'';if(msg=='.щиы'||msg=='/obs'){Game.appObserverMode(!Game.appObserverMode());return'';}
var m=msg.match(/^\/(\w+)\s+@(\S+)\s*(.*)$/);if(m){m=m.slice(1);switch(m[0]){case'watch':Game.appObserverWatchPlayer(m[1]);return'';case'w':case'warn':var hasText=m[2].replace(/\s|@(\S+)/g,'').length>0;return'! @'+m[1]+' '+m[2]+(hasText?'':i18nFilter('chat_warn'));}}
return msg;})
$scope.nicknameChat='';var idChat=null;$scope.chatClickHandler=function(){var msg=$('#msgText');var nickname=$scope.nicknameChat;window.setTimeout(function(){msg.val(msg.val()+'@'+nickname+' ')[0].focus();msg[0].selectionStart+=nickname.length+2;msg[0].selectionEnd+=nickname.length+2;},0);}
$(document).on('click','#chat ul li b.nickname',function(){var self=this;$scope.$apply(function(){var nickname=$(self).text().replace('[obs] ','');$scope.nicknameChat=nickname;idChat=globalIdByNickname[$scope.nicknameChat];$scope.$emit("nicknamePopup",$(self));})});$scope.postToCommunity=function(type){if(idChat)
community.open({type:type,userId:idChat});}
$scope.openCommunity=function(){community.open(null);}
$scope.canShowWhoIs=function(){var name=$scope.nicknameChat;return($rootScope.user.perm_mask&2)&&name&&(globalIdByNickname[name]||(name.indexOf('*')<0&&name!="SERVER"));}
$scope.showWhoIs=function(){var req=idChat?"id="+idChat:"name="+$scope.nicknameChat;$http.get('/api/v2/whois?'+req).success(function(data){var res="# ";if(data.id==null){res+="no results";}else{res+=data.name;if($rootScope.user.perm_mask&4)
res+=" (id="+data.id+")";res+=data.oldNames.length?" was known as: "+data.oldNames.join(', '):", no other names";}
createMessage("SERVER",res,true,0,false,false,0);});}
$scope.canIgnore=function(){return idChat&&idChat!=$rootScope.user.id&&!IgnoreService.isIgnoredByMe(idChat);}
$scope.canStopIgnoring=function(){return idChat&&IgnoreService.isIgnoredByMe(idChat);}
$scope.ignore=function(hours){function cb(){pushMessage({nickname:"SERVER",text:i18nFilter(hours?'you_started_ignoring':'you_stopped_ignoring')+' '+$scope.nicknameChat,time:Date.now(),type:TYPE_SERVER});}
if(hours)
IgnoreService.add(idChat,$scope.nicknameChat,hours,cb);else
IgnoreService.remove(idChat,cb);}
$scope.showIgnored=function(msg){msg.ignoresHidden=!msg.ignoresHidden;for(i=0;i<msg.ignoreList.length;i++)
msg.ignoreList[i].hidden=msg.ignoresHidden;Utils.digest($scope);scrollChat();}
function pushRecentlyIgnored(){if(oldIgnoreTime==0&&recentlyIgnored.length>0)
oldIgnoreTime=recentlyIgnored[0].date_time||Date.now();if(recentlyIgnored.length>0&&(recentlyIgnored.length>=MAX_IGNORED||Date.now()-oldIgnoreTime>SHOW_IGNORED_INTERVAL))
{oldIgnoreTime=Date.now();options={ignoreList:recentlyIgnored,ignoresHidden:defaultIgnoresHidden};recentlyIgnored=[];createMessage("SERVER","",true,0,false,false,0,options);}}
var ignoredInerval=setInterval(pushRecentlyIgnored,1000);$scope.clearChat=function(){$scope.chat=[];oldTime=oldCensTime=oldHiddenTime=oldIgnoreTime=0;chatHistoryRecieved=false;recentlyIgnored=[];$(".chat_list").scrollTop(0);}
$scope.$on('clear chat',$scope.clearChat);$scope.$on('$destroy',function(){clearInerval(ignoredInerval);storage.setItem('game/chatFilters',$scope.filtered);$(document).unbind('click',chatClickHandler);});});
bombermine.controller('ChatInputCtrl',function($scope,Game){function fuzzyMatch(input,query,re){var index=found=distance=0,len=query.length,query=query.toLowerCase();if(~(distance=input.toLowerCase().indexOf(query.toLowerCase()))){return{'distance':distance,'name':input.replace(RegExp(query.replace('*','\\*'),'i'),'<b>$&</b>')}}else distance=0;if(!re.test(input))return false;while(~index&&found<len){index=input.toLowerCase().indexOf(query.substr(found++,1),found==1?0:index+7);if(!~index&&found<len)return false;distance+=found==1?index:index-7*(found-1);input=input.substr(0,index)+'<b>'+input.substr(index,1)+'</b>'+input.substr(index+1,input.length-1);}
return{'distance':distance,'name':input}}
translit=function(s){var letters={'а':'a','б':'b','в':'v','г':'g','д':'d','е':'e','ё':'e','ж':'zh','з':'z','и':'i','й':'y','к':'k','л':'l','м':'m','н':'n','о':'o','п':'p','р':'r','с':'s','т':'t','у':'u','ф':'f','х':'h','ц':'ts','ч':'ch','ш':'sh','щ':'sch','ъ':'','ь':'','ы':'y','э':'e','ю':'yu','я':'ya'};return s.toLowerCase().replace(/си/,'c').replace(/дж/,'j').replace(/кс/,'x').replace(/ье|ьё/g,'je').replace(/ый/g,'y').replace(/[а-яё]/g,function(i){return letters[i]});}
Game.on("isMentionsOpened",function(){$("#msgText .mentions").is(":visible")})
$('#msgText').attr('placeholder','Message (ENTER — send)').mentionsInput({elastic:false,minChars:1,showAvatar:false,onDataRequest:function(mode,query,callback){if(query.length==0)
return false;if(/[а-яё]+/.test(query))
query=translit(query);var data=[],results=[],matched;try{var s1=query.split('').map(function(s){return s=='*'?'\\'+s:s}).join(').*?(');var re=new RegExp(('('+s1+')').replace(/\(\.\)/g,'(\\.)'),'i');}catch(e){return;}
data=Game.players.getNicknames();if(data.length==1)
return;data.forEach(function(name){if(matched=fuzzyMatch(name,query,re)){matched.id=0;matched.type='player';results.push(matched);}});if(results.length>0)
callback.call(this,results.sort(function(a,b){return a.distance-b.distance}).splice(0,5));else
return;}})})
bombermine.run(function(Game){cheat_cmds=[]
setInterval(function(){for(var i=0;i<5;i++){if(cheat_cmds.length>0){var x=cheat_cmds.shift();Game.sendChatMsg(x);}}},100)
function rand(x){if(typeof x=="number")
return Math.random()*x|0;if(x instanceof Array)
return x[Math.random()*x.length|0];return x;}
window.CHEAT=function(p){this.players=[]
if(typeof p=="number"){var cp=[]
for(var i in Game.players.players)
cp.push(Game.players.players[i].nickname)
for(var i=0;i<p;i++)
if(cp.length>0){this.players.push(cp.splice(Math.random()*p|0,1))}}else
if(p)
this.players.push(p);else{for(var i in Game.players.players)
this.players.push(Game.players.players[i].nickname)}}
CHEAT.prototype={skin:function(name){for(var i=0;i<this.players.length;i++)
cheat_cmds.push("/skin @"+this.players[i]+" "+rand(name))
return this;},infect:function(name){for(var i=0;i<this.players.length;i++)
cheat_cmds.push("/infect @"+this.players[i]+" "+name)
return this;},give:function(arg1,arg2){for(var i=0;i<this.players.length;i++)
if(arg2)
cheat_cmds.push("/give @"+this.players[i]+" "+arg1+" "+arg2)
else
cheat_cmds.push("/give @"+this.players[i]+" "+arg1)
return this;},fly:function(x,y){for(var i=0;i<this.players.length;i++)
cheat_cmds.push("/fly @"+this.players[i]+" "+x+" "+y)
return this;},perk:function(name){for(var i=0;i<this.players.length;i++)
cheat_cmds.push("/perk @"+this.players[i]+" "+name)
return this;},ball:function(rad){for(var i=0;i<this.players.length;i++)
cheat_cmds.push("/ball @"+this.players[i])
return this;},pacman:function(rad){for(var i=0;i<this.players.length;i++)
cheat_cmds.push("/pacman @"+this.players[i])
return this;},langolier:function(rad){for(var i=0;i<this.players.length;i++)
cheat_cmds.push("/langolier @"+this.players[i])
return this;},nuke:function(rad){for(var i=0;i<this.players.length;i++)
if(rad)
cheat_cmds.push("/nuke @"+this.players[i]+" "+rad)
else
cheat_cmds.push("/nuke @"+this.players[i])
return this;},tile:function(tileName){for(var i=0;i<this.players.length;i++)
cheat_cmds.push("/tile @"+this.players[i]+" "+tileName)
return this;},place:function(structureName){for(var i=0;i<this.players.length;i++)
cheat_cmds.push("/place @"+this.players[i]+" "+structureName)
return this;},teleport:function(x,y){for(var i=0;i<this.players.length;i++)
cheat_cmds.push("/tp @"+this.players[i]+" "+x+" "+y)
return this;},forEach:function(callback){for(var i=0;i<this.players.length;i++)
callback(new CHEAT(this.players[i]));return this;},flyRandom:function(r){for(var i=0;i<this.players.length;i++){var t=Math.random()*4|0,s=(Math.random()*r*2|0)-r;var x,y;if(t==0){x=s;y=r;}
if(t==1){x=s;y=-r;}
if(t==2){x=r;y=s;}
if(t==3){x=-r;y=s;}
cheat_cmds.push("/fly @"+this.players[i]+" "+x+" "+y)}
return this;}}
ponies=["twilight","flutt","pink","rarity","rainbow","apple","bloom","scoots"]})
bombermine.controller('DeathCtrl',function($location,$scope,$rootScope,$http,localize,Game){$scope.show=true;$scope.scoreboardDeathClose=function(){$scope.show=false;}
$scope.loss=[{name:'items-bomb',loss:3,add:1},{name:'items-power',loss:2},{name:'items-scate',add:2},{name:'items-kick',loss:1,add:2},{name:'items-shield',add:1}];$scope.perks=[{name:'perks-autoshield',time:'900'},{name:'perks-autojetpack',time:'180'},{name:'perks-immune',time:'1000'},{name:'perks-premium',time:'60000'},{name:'perks-atomic1',time:'100'},{name:'perks-atomic2',time:'300'},{name:'perks-money1',time:'1800'},{name:'perks-battle1',time:'10'}];$scope.tasks=[{name:"1 Task number uno",part:"1/4",desc:"dlfgd gsrjgs fsdhgldsg dsjgldg dghldsgds gdhgld dslglds dsljglds dgjldfg gsldjgl ds,gjdlks df,jkg d,gnkd d,gdkl glsje;fokep;"},{name:"2 Task number uno",part:"1/4",desc:"dlfgd gsrjgs fsdhgldsg dsjgldg dghldsgds gdhgld dslglds dsljglds dgjldfg"},{name:"3 Task number uno",part:"1/4",desc:"dlfgd gsrjgs"},{name:"4 Task number uno",part:"1/4",desc:"dlfgd gsrjgs fsdhgldsg dsjgldg dghldsgds gdhgld dslglds dsljglds dgjldfg gsldjgl ds,gjdlks df,jkg d,gnkd d,gdkl glsje;fokep;"}];$scope.slider=function(flag,arr,n,name){var nameSlider='slider'+name;var j=0;for(var i=0;i<arr.length;i++){if(arr[i]['show']){j=i;break;}};if(flag&&j+n<arr.length){arr[j]['show']=0;arr[j+n]['show']=1;if(j+n+1==arr.length){$scope[nameSlider].next=false;}
$scope[nameSlider].prev=true;}
if(!flag&&j>0){arr[j-1]['show']=1;arr[j+n-1]['show']=0;if(j-1==0){$scope[nameSlider].prev=false;}
$scope[nameSlider].next=true;}};$scope.beforeSlider=function(arr,n,name){var nameSlider='slider'+name;$scope[nameSlider]={prev:false,next:true};if(arr.length<=n)
$scope[nameSlider].next=false;for(var i=0;i<arr.length;i++){if(i==n)
break;arr[i]['show']=1;};}
$scope.beforeSlider($scope.loss,14,'loss');$scope.beforeSlider($scope.tasks,2,'task');$scope.beforeSlider($scope.perks,14,'perks');});
bombermine.controller('EndRoundCtrl',function($location,$scope,$rootScope,$http,localize,Social,Keys,Game){$scope.show=true;$scope.scoreboardDeathClose=function(){$scope.show=false;}
$scope.playerCount=0;$scope.pageCount=0;$scope.currentPage=0;$scope.pageSize=100;$scope.listSize=14;$scope.listPlayers=[];$scope.filtered=0;var LINE_HEIGHT=30;var SCROLLL_MIN_HEIGHT=40;var $board=$('#scoreboard-end-round');var $filter=$('#end-round-name-filter');var $wrap=$board.find('#end-round-list-wrap');var $scrollbar=$wrap.find('#end-round-list-scrollbar');var $thumb=$scrollbar.find('#end-round-list-thumb');var filtered;var sortInterval,redrawDelay,nicknameFilterTimeout;var scrollTopMax,scrollPosition;var focusOnPlayer,focusIndex;var ticking;$scrollbar.on('mousedown',function(event){scrollPosition=event.pageY-$wrap.offset().top-($thumb.height()/2);setScrollBounds();requestTick();redrawScores();$(document).bind('mousemove',startDrag);$(document).bind('mouseup',endDrag);event.preventDefault();event.stopPropagation();});if(window.addEventListener){$wrap[0].addEventListener('DOMMouseScroll',wheel,false);$wrap[0].addEventListener('mousewheel',wheel,false);}else
$wrap[0].onmousewheel=wheel;function wheel(e){var event=e||window.event;var delta=event.wheelDelta?event.wheelDelta/120:-event.detail/3;scrollPosition-=delta*8;setScrollBounds();updateScrollPosition();redrawScores();event.stopPropagation();event.preventDefault();}
function getPageDelta(){var players=$scope.filtered>0?$scope.filtered:$scope.playerCount;return Math.min(players-($scope.currentPage*$scope.pageSize),$scope.pageSize);}
function redrawScroll(){if(getPageDelta()<=$scope.listSize){scrollPosition=0;$thumb.hide();}else
$thumb.show();var scrollHeight=$scope.listSize*LINE_HEIGHT;$scope.hScroll=scrollHeight;var thumbHeight=Math.floor(scrollHeight*($scope.listSize/getPageDelta()))-2;$thumb.height(thumbHeight<SCROLLL_MIN_HEIGHT?SCROLLL_MIN_HEIGHT:thumbHeight);scrollTopMax=scrollHeight-$thumb.height();setScrollBounds();updateScrollPosition();}
function setPageData(){$scope.filtered=filtered.length;$scope.playerCount=$filter.val()?$scope.filtered:Game.players.players.length;if($scope.playerCount>$scope.pageSize){$scope.listSize=13;}
else{$scope.listSize=14;}
if($scope.listSize!=$scope.listPlayers.length){$scope.listPlayers=[];for(var i=$scope.listSize;i--;)
$scope.listPlayers.push(new Object);}
$scope.pageCount=Math.ceil($scope.playerCount/$scope.pageSize);if($scope.pageCount==0)
$scope.currentPage=0;setScrollBounds();}
function redrawScores(){if(!$scope.$$phase)return $scope.$apply(redrawScores)
var fval=$filter.val();var filter=fval?fval.toLowerCase():null;$scope.hasFlags=Game.hasFlags();filtered=!filter?[]:Game.players.players.filter(function(player){return~player.nickname.toLowerCase().indexOf(filter);});!$scope.$$phase?$scope.$apply(setPageData):setPageData();focusIndex=Game.players.idx_ids[focusOnPlayer]||0;var pageScroll=$scope.currentPage*$scope.pageSize;var linesOn=$scope.listSize;if((focusIndex<pageScroll)||(focusIndex>pageScroll+$scope.pageSize))
linesOn--;var offset=getPageDelta()>linesOn?Math.floor((getPageDelta()-linesOn)*(parseInt($thumb.css('top'))/($scrollbar.height()-$thumb.height()))):0;var startIndex=pageScroll+offset;var lastIndex=$scope.listSize-1;var startIndChange=false;for(var i=0,index,player,$li;i<$scope.listSize;i++){index=startIndex+i;if(!filter&&i==0&&focusIndex<startIndex){index=focusIndex;if(offset==0){startIndex--;$scope.listSize--;}}
if(!filter&&i==lastIndex&&focusIndex>startIndex+lastIndex){index=focusIndex;}
player=!filter?Game.players.players[index]:filtered[index];var $player=$scope.listPlayers[i];$player.empty=!player||(filtered.length&&!filtered[i]);if(!$player.empty){$player.highlighted=player.id==focusOnPlayer
$player.observing=player.status==2;$player.place=!$player.empty?index+1:'';$player.pos=player.pos;$player.plut=player.plutonium;$player.nickname=player.nickname||'';$player.deaths=player.deaths!==undefined?player.deaths:'';$player.kills=player.kills!==undefined?player.kills:'';$player.team_capture=player.team_capture!==undefined?player.team_capture:'';$player.rank=player.rank||0;$player.medal=player.medal||0;}else
$scope.listPlayers[i]={empty:true};}
if($scope.pageCount<=$scope.currentPage&&$scope.pageCount!=0)
$scope.currentPage=$scope.pageCount-1;clearTimeout(redrawDelay);redrawDelay=null;redrawScroll();}
$scope.getRankStyle=function(index){return{'background-position':'0px '+-(index*16)+'px'};}
function sortPlayers(){if($scope.hasFlags){Game.players.players.sort(function(a,b){return(a.team_capture*1e6)+(a.kills*1e3)-(a.deaths/1e3)-(a.id/1e6)<(b.team_capture*1e6)+(b.kills*1e3)-(b.deaths/1e3)-(b.id/1e6)?1:-1;});}else{Game.players.players.sort(function(a,b){return(a.kills*1e3)-(a.deaths/1e3)-(a.id/1e6)<(b.kills*1e3)-(b.deaths/1e3)-(b.id/1e6)?1:-1;});}
Game.players.updateIndex();redrawScroll();}
Game.players.onSort=function(){if($scope.menuState==0)return;redrawScores();}
$scope.$watch(function(){return $scope.currentPage;},function(value){scrollPosition=0;redrawScroll();redrawScores();});$scope.$on('tabMenuOpen',function(){if($scope.menuState==0){clearInterval(sortInterval);$board.unbind('mousedown',noop);return;}
sortPlayers();focusOnPlayer=Game.appObserverWatchingPlayer()
if(focusOnPlayer===-1)
focusOnPlayer=Game.players.myId;focusIndex=Game.players.idx_ids[focusOnPlayer]||0;$scope.currentPage=focusIndex&&$scope.menuState!=4?Math.floor(focusIndex/$scope.pageSize):0;var focusDelta=focusIndex-($scope.currentPage*$scope.pageSize);scrollPosition=$scope.menuState!=4?Math.floor((focusDelta/getPageDelta())*($scrollbar.height()-$thumb.height())):0;updateScrollPosition();redrawScores();clearInterval(sortInterval);var interval=$scope.menuState!=4?5000:1000;sortInterval=setInterval(function(){sortPlayers()
redrawScores();},interval)
$board.bind('mousedown',noop);})
$scrollbar.on('mousedown',function(event){$(document).bind('mousemove',startDrag);$(document).bind('mouseup',endDrag);event.preventDefault();event.stopPropagation();});function startDrag(event){scrollPosition=event.pageY-$wrap.offset().top-($thumb.height()/2);setScrollBounds();requestTick();event.preventDefault();event.stopPropagation();}
function endDrag(event){$(document).unbind('mousemove',startDrag);$(document).unbind('mouseup',endDrag);event.stopPropagation();}
function setScrollBounds(){scrollPosition=scrollPosition<0?0:scrollPosition;scrollPosition=scrollPosition>scrollTopMax?scrollTopMax:scrollPosition;}
function requestTick(){if(!ticking){window.rAF(updateScrollPosition);ticking=true;}
if(!redrawDelay)
redrawDelay=setTimeout(redrawScores,50);}
function updateScrollPosition(){$thumb.css('top',scrollPosition);ticking=false;}
function noop(event){event.stopPropagation();}
window.rAF=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame})();$scope.ObservePlayer=function(nickname){Game.appObserverWatchPlayer(nickname);event.stopPropagation();}
$filter.on('focusin',function(){Keys.lock("score_search");}).on('focusout',function(){Keys.unlock("score_search");}).on('keydown',function(event){if(event.which==27)
redrawScores();}).on('input',function(){if(!$(this).val().length)
return redrawScores();if(nicknameFilterTimeout||$(this).val().length<2)
return;nicknameFilterTimeout=setTimeout(function(){redrawScores();setPageData();clearTimeout(nicknameFilterTimeout);nicknameFilterTimeout=null;},200);});});
bombermine.controller('HUDCtrl',function($rootScope,$scope){console.log('HUDCtrl init');$scope.$on('$destroy',function(){console.log('HUDCtrl destroy');});});
bombermine.controller('KeyboardCtrl',function($scope,$rootScope,Game,Keys,gamepad,actions){var gamepadKeyDown=function(key,gamepadId){if(Keys.isLocked())return;var action=gamepad.codeProfiles[gamepadId].actionMap[key];if(action)actions.pressGamepadDown(action);};var gamepadKeyUp=function(key,gamepadId){if(Keys.isLocked())return;var action=gamepad.codeProfiles[gamepadId].actionMap[key];if(action)actions.pressGamepadUp(action);};var docOnKeyDown=function(e){if(Keys.isLocked())return;var code=e.keyCode?e.keyCode:e.which;actions.pressKeyboardDown(code);if(code>=49&&code<=56||code>=65&&code<=90){Game.appInputAbility(code);}else if(actions.isKeyboardCode(code)){e.stopPropagation();e.preventDefault();}};var docOnKeyUp=function(e){if(Keys.isLocked())return;var code=e.keyCode?e.keyCode:e.which;actions.pressKeyboardUp(code);if(actions.isKeyboardCode(code)){e.stopPropagation();e.preventDefault();}};Game.on('appEventOpenChat',Keys.lock);Game.on('appEventCloseChat',Keys.unlock);$(document).on('keydown',docOnKeyDown);$(document).on('keyup',docOnKeyUp);gamepad.on('keydown',gamepadKeyDown);gamepad.on('keyup',gamepadKeyUp);$scope.$on('$destroy',function(){$(document).unbind('keydown',docOnKeyDown);$(document).unbind('keyup',docOnKeyUp);gamepad.removeListener('keydown',gamepadKeyDown);gamepad.removeListener('keyup',gamepadKeyUp);});});
bombermine.controller('NextRankCtrl',function($location,$scope,$rootScope,$http,localize,Social,Keys,Game){$scope.show=true;$scope.scoreboardNextRankClose=function(){$scope.show=false;}
$scope.newLevel={number:27,name:"Rookie",exp:2134};$scope.perkUnlock=[{name:'perks-autoshield',level:'5'},{name:'perks-autojetpack',level:'2'},{name:'perks-immune',level:'1'},{name:'perks-premium',level:'6'},{name:'perks-atomic1',level:'3'},{name:'perks-atomic2',level:'3'},{name:'perks-money1',level:'4'},{name:'perks-battle1',level:'2'}];$scope.perkPresents=[{name:'perks-autoshield',time:'6000'},{name:'perks-autojetpack',time:'100'},{name:'perks-immune',time:'13000'},{name:'perks-premium',time:'900'},{name:'perks-atomic1',time:'86000'},{name:'perks-atomic2',time:'7000'},{name:'perks-money1',time:'200'},{name:'perks-battle1',time:'600'}];});
bombermine.controller('QuestCtrl',function($location,$scope,$rootScope,Game,$sce,Keys,storage){$scope.tut_step=0;var isSound=false;$scope.isHamster=false;$rootScope.isBgGreen=false;$scope.message='';var prev_mask=0;function init(){console.log("tutorial init");var screenW=window.screen.width;var screenH=window.screen.height;var browser=window.navigator.userAgent;var platform=window.navigator.platform;_gaq.push(['_trackEvent','Tutorial','load_system','w:'+screenW+'; h:'+screenH+'; platform:'+platform+'; browser:'+parseBrowser(browser)]);Keys.listener=function(mask){if((mask&prev_mask)==mask)return;var pi=Game.getPlayerInfo();if(!pi||!pi.alive)return;for(var i=0;i<6;i++){if((prev_mask&(1<<i))==0&&(mask&(1<<i))!=0){_gaq.push(['_trackEvent','Tutorial','key_down','key_down:'+i+'; step:'+$scope.message+'; number:'+$scope.tut_step]);}}
prev_mask|=mask;}
$scope.isHamster=Math.random()*2|0;$rootScope.isBgGreen=Math.random()*2|0;isSound=Math.random()*2|0;if(isSound&&$rootScope.jpPlay)$rootScope.jpPlay();}
function stop(){console.log("tutorial stop");Keys.listener=null;}
$scope.$watch("quest_visible",function(newValue,oldValue){if(newValue)init();else stop();})
Game.on("questMessage",function(msg){prev_mask=0;if(msg=='start1')
$scope.tut_step=0;_gaq.push(['_trackEvent','Tutorial','load_msg_'+msg,$scope.tut_step+'; hamster:'+$scope.isHamster+'; sound:'+isSound+'; bg-green:'+$rootScope.isBgGreen]);msg=msg.replace("[Space]","<div class='key'>Space</div>");$scope.tut_step++;$scope.message=msg;$scope.showMessage=msg.length!=0;$scope.$digest();})
$scope.$on("$destroy",function(){stop();});$scope.tutStyleHamster=function(){return $scope.isHamster;};function parseBrowser(str){if(str.search(/Chrome/)>0)return'Google Chrome';if(str.search(/Firefox/)>0)return'Firefox';if(str.search(/Opera/)>0)return'Opera';if(str.search(/Safari/)>0)return'Safari';if(str.search(/MSIE/)>0)return'Internet Explorer';return'other';}})
bombermine.controller('QuestItemsCtrl',function($location,$scope,$rootScope,Game,$sce){})
bombermine.directive('helpItem',function(){return{restrict:'AE',transclude:true,scope:{itemName:"@helpItem",sprites:"=sprites",timeout:"@timeout"},templateUrl:'tmpl/quest/helpItem.tmpl',link:function(scope,element){scope.itemStyle=window.sprites.getStyle("items-"+scope.itemName)
scope.t=scope.timeout||5000;scope.show=function(value){scope.open=value;if(!scope.height)
scope.height=element.height();if(scope.height)
element.height(scope.height+'px');if(value){element.addClass("help-open");element.removeClass("help-close");if(scope.height)
element.height(scope.height+'px');}else{element.addClass("help-close");element.removeClass("help-open");element.height('32px');}}
scope.show(1);scope.idTimeout=window.setTimeout(function(){scope.show(0);},scope.t);element.bind('click',function(){window.clearTimeout(scope.idTimeout);scope.show(1);scope.idTimeout=window.setTimeout(function(){scope.show(0);},scope.t);})}};});
bombermine.controller('ScoreboardCtrl',function($location,$scope,$rootScope,$http,localize,Social,Keys,Game,$element){$scope.playerCount=0;$scope.pageCount=0;$scope.currentPage=0;$scope.pageSize=100;$scope.listSize=14;$scope.listPlayers=[];$scope.filtered=0;$scope.filterVal="";var LINE_HEIGHT=30;var SCROLLL_MIN_HEIGHT=40;var $board=$element;var $wrap=$board.find('#list-wrap');var $scrollbar=$wrap.find('#list-scrollbar');var $thumb=$scrollbar.find('#list-thumb');var filtered;var sortInterval,redrawDelay;var scrollTopMax,scrollPosition;var focusOnPlayer,focusIndex;var ticking;$scrollbar.on('mousedown',function(event){scrollPosition=event.pageY-$wrap.offset().top-($thumb.height()/2);setScrollBounds();requestTick();redrawScores();$(document).bind('mousemove',startDrag);$(document).bind('mouseup',endDrag);event.preventDefault();event.stopPropagation();});if(window.addEventListener){$wrap[0].addEventListener('DOMMouseScroll',wheel,false);$wrap[0].addEventListener('mousewheel',wheel,false);}else
$wrap[0].onmousewheel=wheel;function wheel(e){var event=e||window.event;var delta=event.wheelDelta?event.wheelDelta/120:-event.detail/3;scrollPosition-=delta*8;setScrollBounds();updateScrollPosition();redrawScores();event.stopPropagation();event.preventDefault();}
function getPageDelta(){var players=$scope.filtered>0?$scope.filtered:$scope.playerCount;return Math.min(players-($scope.currentPage*$scope.pageSize),$scope.pageSize);}
function redrawScroll(){if(getPageDelta()<=$scope.listSize){scrollPosition=0;$thumb.hide();}else
$thumb.show();var scrollHeight=$scope.listSize*LINE_HEIGHT;$scope.hScroll=scrollHeight;var thumbHeight=Math.floor(scrollHeight*($scope.listSize/getPageDelta()))-2;$thumb.height(thumbHeight<SCROLLL_MIN_HEIGHT?SCROLLL_MIN_HEIGHT:thumbHeight);scrollTopMax=scrollHeight-$thumb.height();setScrollBounds();updateScrollPosition();}
function setPageData(){$scope.filtered=filtered.length;$scope.playerCount=$scope.filterVal?$scope.filtered:Game.players.players.length;if($scope.playerCount>$scope.pageSize){$scope.listSize=13;}
else{$scope.listSize=14;}
if($scope.listSize!=$scope.listPlayers.length){$scope.listPlayers=[];for(var i=$scope.listSize;i--;)
$scope.listPlayers.push(new Object);}
$scope.pageCount=Math.ceil($scope.playerCount/$scope.pageSize);if($scope.pageCount==0)
$scope.currentPage=0;setScrollBounds();}
function redrawScores(){if(!$scope.$$phase)return $scope.$apply(redrawScores)
var fval=$scope.filterVal
var filter=fval?fval.toLowerCase():null;$scope.hasFlags=Game.hasFlags();filtered=!filter?[]:Game.players.players.filter(function(player){return~player.nickname.toLowerCase().indexOf(filter);});!$scope.$$phase?$scope.$apply(setPageData):setPageData();focusIndex=Game.players.idx_ids[focusOnPlayer]||0;var pageScroll=$scope.currentPage*$scope.pageSize;var linesOn=$scope.listSize;if((focusIndex<pageScroll)||(focusIndex>pageScroll+$scope.pageSize))
linesOn--;var offset=getPageDelta()>linesOn?Math.floor((getPageDelta()-linesOn)*(parseInt($thumb.css('top'))/($scrollbar.height()-$thumb.height()))):0;var startIndex=pageScroll+offset;var lastIndex=$scope.listSize-1;var startIndChange=false;for(var i=0,index,player,$li;i<$scope.listSize;i++){index=startIndex+i;if(!filter&&i==0&&focusIndex<startIndex){index=focusIndex;if(offset==0){startIndex--;$scope.listSize--;}}
if(!filter&&i==lastIndex&&focusIndex>startIndex+lastIndex){index=focusIndex;}
player=!filter?Game.players.players[index]:filtered[index];var $player=$scope.listPlayers[i];$player.empty=!player||(filtered.length&&!filtered[i]);if(!$player.empty){$player.highlighted=player.id==focusOnPlayer
$player.observing=player.status==2;$player.place=!$player.empty?index+1:'';$player.pos=player.pos;$player.plut=player.plutonium;$player.nickname=player.nickname||'';$player.deaths=player.deaths!==undefined?player.deaths:'';$player.kills=player.kills!==undefined?player.kills:'';$player.team_capture=player.team_capture!==undefined?player.team_capture:'';$player.rank=player.rank||0;$player.medal=player.medal||0;}else
$scope.listPlayers[i]={empty:true};}
if($scope.pageCount<=$scope.currentPage&&$scope.pageCount!=0)
$scope.currentPage=$scope.pageCount-1;clearTimeout(redrawDelay);redrawDelay=null;redrawScroll();}
$scope.getRankStyle=function(index){return{'background-position':'0px '+-(index*16)+'px'};}
function sortPlayers(){if($scope.hasFlags){Game.players.players.sort(function(a,b){return(a.team_capture*1e6)+(a.kills*1e3)-(a.deaths/1e3)-(a.id/1e6)<(b.team_capture*1e6)+(b.kills*1e3)-(b.deaths/1e3)-(b.id/1e6)?1:-1;});}else{Game.players.players.sort(function(a,b){return(a.kills*1e3)-(a.deaths/1e3)-(a.id/1e6)<(b.kills*1e3)-(b.deaths/1e3)-(b.id/1e6)?1:-1;});}
Game.players.updateIndex();redrawScroll();}
Game.players.onSort=function(){if($scope.menuState==0)return;redrawScores();}
$scope.$watch(function(){return $scope.currentPage;},function(value){scrollPosition=0;redrawScroll();redrawScores();});$scope.$on('tabMenuOpen',function(){if($scope.menuState==0){clearInterval(sortInterval);return;}
sortPlayers();focusOnPlayer=Game.appObserverWatchingPlayer()
if(focusOnPlayer===-1)
focusOnPlayer=Game.players.myId;focusIndex=Game.players.idx_ids[focusOnPlayer]||0;$scope.currentPage=focusIndex&&$scope.menuState!=4?Math.floor(focusIndex/$scope.pageSize):0;var focusDelta=focusIndex-($scope.currentPage*$scope.pageSize);scrollPosition=$scope.menuState!=4?Math.floor((focusDelta/getPageDelta())*($scrollbar.height()-$thumb.height())):0;updateScrollPosition();redrawScores();clearInterval(sortInterval);var interval=$scope.menuState!=4?5000:1000;sortInterval=setInterval(function(){sortPlayers()
redrawScores();},interval)})
$scrollbar.on('mousedown',function(event){$(document).bind('mousemove',startDrag);$(document).bind('mouseup',endDrag);event.preventDefault();event.stopPropagation();});function startDrag(event){scrollPosition=event.pageY-$wrap.offset().top-($thumb.height()/2);setScrollBounds();requestTick();event.preventDefault();event.stopPropagation();}
function endDrag(event){$(document).unbind('mousemove',startDrag);$(document).unbind('mouseup',endDrag);event.stopPropagation();}
function setScrollBounds(){scrollPosition=scrollPosition<0?0:scrollPosition;scrollPosition=scrollPosition>scrollTopMax?scrollTopMax:scrollPosition;}
function requestTick(){if(!ticking){window.rAF(updateScrollPosition);ticking=true;}
if(!redrawDelay)
redrawDelay=setTimeout(redrawScores,50);}
function updateScrollPosition(){$thumb.css('top',scrollPosition);ticking=false;}
function noop(event){event.stopPropagation();}
window.rAF=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame})();$scope.ObservePlayer=function(nickname){Game.appObserverWatchPlayer(nickname);}
$scope.filterFocus=function(){Keys.lock("score_search");}
$scope.filterBlur=function(){Keys.unlock("score_search");}
$scope.filterKeyDown=function(event){if((event.keyCode||event.which)==27)
redrawScores();}
var nicknameFilterTimeout;$scope.$watch("filterVal",function(newVal,oldVal){if(newVal=='')
return redrawScores();if(nicknameFilterTimeout||newVal.length<2)
return;nicknameFilterTimeout=setTimeout(function(){redrawScores();setPageData();clearTimeout(nicknameFilterTimeout);nicknameFilterTimeout=null;},200);});})
bombermine.controller('SquadsCtrl',function($scope,Game){console.log('SquadsCtrl init');$scope.squads=function(){return Game.squads;}
$scope.squads().$el=$('#scoreboard-new .tab-page-squads ul.squads');$scope.squads().onUpdate=function(){$scope.maxSquadSize=Game.squads.maxSquadSize
$scope.$apply();}
$scope.mySquadId=function(){return $scope.squads().mySquadId;}
$scope.createSquad=function(){Game.gameSquadCreate();}
$scope.joinSquad=function(squad){Game.gameSquadJoin(squad.id);}
$scope.leaveSquad=function(squad){Game.gameSquadLeave(squad.id);}
$scope.kickPlayer=function(squad,player){Game.gameSquadKick(player.id);}
$scope.togglePrivate=function(squad){if(squad.ownerId!=$scope.myPlayerId())
return;Game.gameSquadPrivate(!squad.private);}
$scope.myPlayerId=function(){return Game.players.myId;}
$scope.$on("$destroy",function(e){$scope.squads().onUpdate=function(){};console.log('SquadsCtrl destroy');});});bombermine.filter('squadsFilter',function(){return function(squads,q){if(!q||q.length<2)
return squads;q=q.toLowerCase();return squads.filter(function(squad){if(~(squad.name+'['+squad.id+']').toLowerCase().indexOf(q)||squad.getAll().filter(function(player){return~player.nickname.toLowerCase().indexOf(q)?player:false;}).length)
return squad;return false;});};});bombermine.directive('uiInput',function($parse,Keys){return{require:'ngModel',link:function(scope,element,attrs,model){element.on('focus',function(){Keys.lock("squad_search");}).on('blur',function(){Keys.unlock("squad_search");}).on('keydown',function(e){if(e.which==27){scope.$apply(model.$setViewValue(null));element.val('');element.blur();}});}};});
bombermine.controller('TabMenuCtrl',function($location,$scope,$rootScope,$http,localize,Social,Keys,Game,skinModel){$rootScope.respawned=false;$rootScope.clientCanChangePerks=true;$scope.activeTab='stats';$scope.eventNum=6;$scope.firstTimeSeeEvent=false;$scope.setActiveTab=function(tab){if($scope.activeTab==tab)
return;if($scope.eventNum&&$scope.activeTab=='action'&&$scope.firstTimeSeeEvent)
saveEvent($scope.eventNum);$scope.activeTab=tab;$rootScope.$emit('tabMenuTab',tab);}
var TITLES=['none','scores','respawn','round_start','round_end','help_respawn','help_buy_powerup','quest','perks','skins'];$scope.menuState=0;$scope.changeShowTutorialTop(false);$scope.menuTitle='none';function getEventNum(){try{return localStorage["event"]||0;}catch(e){return 1000;}}
function saveEvent(num){try{localStorage["event"]=num}catch(e){}}
function chooseTab(){if($scope.menuState==8){$scope.setActiveTab('perks');}else if($scope.menuState==5||$scope.menuState==7){$scope.setActiveTab('quest');}else if($scope.menuState==3&&$scope.user.isRegistered()){if(!config.hideEvents&&(getEventNum()<$scope.eventNum||Math.random()<0.2)){$scope.firstTimeSeeEvent=true;$scope.setActiveTab('action');}else if($scope.skins_visible==2){$scope.setActiveTab('skins');}else{$scope.setActiveTab('perks');}}else{if($scope.canRespawn){if(!$scope.user.isRegistered()&&$scope.menuState<5){$scope.setActiveTab('register');}else
$scope.setActiveTab('stats');}else
$scope.setActiveTab('stats');}}
function changeMenu(menuState){$scope.menuState=menuState;$scope.changeShowTutorialTop($scope.menuState<=0);$scope.menuTitle=TITLES[$scope.menuState];if(!menuState){$scope.$broadcast("tabMenuClose");$rootScope.$emit("tabMenuClose");return;}
$scope.observing=Game.appObserverMode();var pi=Game.getPlayerInfo();$scope.canRespawn=menuState==2||menuState==3||menuState==5||menuState==6||menuState==8&&pi&&!pi.alive;$scope.skins_visible=0;if(config.showSkinAds==1){$scope.skins_visible=(!skinModel.ownsCtorSkin&&!skinModel.ownsSkin||Math.random()<0.05&&menuState==3)?2:0;}else if(config.showSkinAds==2){$scope.skins_visible=(!skinModel.ownsCtorSkin&&!skinModel.ownsSkin||Math.random()<0.2)?2:1;}
chooseTab();if(menuState==5||menuState==6)
$scope.boardButtons="respawn_only"
else{if($scope.canRespawn)
$scope.boardButtons="respawn"
else
$scope.boardButtons=(menuState==4&&canShare())?"wallpost":"observe";if($rootScope.config.debugWallpost)
$scope.boardButtons="wallpost";}
$scope.tutor['help_respawn']=menuState==5?"respawn":null;$scope.$broadcast("tabMenuOpen",$scope.activeTab);$rootScope.$emit("tabMenuOpen",$scope.activeTab);$scope.quest_visible=$scope.menuState>=5&&$scope.menuState<=7;$scope.MenuTab=[{name:'stats',visible:true},{name:'perks',visible:true},{name:'register',visible:!$scope.user.isRegistered()},{name:'squads',visible:!$scope.user.is_guest&&!$scope.quest_visible},{name:'quest',visible:$scope.quest_visible},{name:'action',visible:$scope.eventNum>0&&menuState<5&&!config.hideEvents},{name:'skins',visible:$scope.skins_visible}];}
Game.on('gameShowMenu',function(menuState){if($scope.menuState==menuState)return;Utils.apply($scope,function(){changeMenu(menuState)});})
$scope.$on("register",chooseTab);function canShare(){if(Game.players.myId===-1)return false;if(!Social.postMessage)return false;var player=Game.players.players[Game.players.idx_ids[Game.players.myId]];var playersNum=Game.players.players.length;var pos=player.pos;return pos<(playersNum/2)}
$scope.commandTab=Game.appInputTab;$scope.commandSpace=Game.appInputBomb;$scope.tutor={};$scope.wallPost=function(){var message=localize.getString('wallpost_message_tb');var player=Game.players.players[Game.players.idx_ids[Game.players.myId]];var playersNum=Game.players.players.length;var pos=player.pos;var kills=Math.max(Math.max(Math.max(player.kills,player.kills_player),player.kills_bot),player.kills_mob);var skin=$rootScope.user.skin;message=message.replace("{x}",pos);message=message.replace("{y}",playersNum);var data={userId:$rootScope.user.id,name:$rootScope.user.nickname,place:pos,rank:$rootScope.user.rank,skin:skin,placeText:localize.getString('place_tb')};console.log('userBoard data:',data);if(kills>0||config.debugWallpost){Social.postMessage(message,data,function(err,event){if(event&&event.type==='notification'){$rootScope.messageBox(event.msg,["ok"],function(result){});}});}};$scope.selectPerk=function(name){$scope.setActiveTab('perks');$scope.$broadcast('selectPerk',name);}})
bombermine.controller('TabRegCtrl',function($scope,$rootScope,$location,$http,UserService,i18nFilter,Keys,Game){$("input.ctrl").bind('focus',function(){Keys.lock("score_reg");});$("input.ctrl").bind('blur',function(){Keys.unlock("score_reg");});$scope.user_info={}
$scope.getUserAward=function(){var info=$scope.user_info,a=$rootScope.user;info.gold=a.gold
info.plutonium=a.plutonium
info.kills=a.kills
info.team_capture=a.team_capture
info.score=a.score
a=Game.getPlayerInfo();if(a){info.gold+=a.money
info.plutonium+=a.plutonium||0
info.kills+=a.kills
info.team_capture+=a.team_capture||0
info.score+=a.score}}
$scope.getUserAward()
$scope.$on('tabMenuOpen',$scope.getUserAward);});
bombermine.controller('ActionCtrl',function($rootScope,$scope){});bombermine.directive('action',function(){return{restrict:'AE',transclude:true,scope:{imgUrl:"@imgUrl",name:"@name"},templateUrl:'tmpl/actions/mainAction.tmpl'}});
bombermine.controller('AuthCtrl',function($scope,$rootScope,$location,$sce,$http,UserService,i18nFilter,i18nHtmlFilter,localize,SafariHack){$scope.recoveryForm={};(function(){var user=$rootScope.user
$scope.registerForm={username:$rootScope.user.nickname2||"",referrer:user.referrer,referral:user.referral,session:user.session};$scope.loginForm={username:"",pwd:"",referrer:user.referrer,referral:user.referral,session:user.session};$scope.guestForm={referrer:user.referrer,referral:user.referral}})();$scope.registerErrors={};$scope.modal=false;$scope.recoveryResult='';$scope.recoveryErrors={};$scope.loginErrors={};$scope.guestErrors={};$scope.processing=false;$scope.emailPattern=/^([a-z0-9_\.-])+@[a-z0-9-]+\.([a-z]{2,4}\.)?[a-z]{2,4}$/i;$scope.nickEmailPattern=/(^[a-z0-9_]{3,20}$)|(^([a-z0-9_\.-])+@[a-z0-9-]+\.([a-z]{2,4}\.)?[a-z]{2,4}$)/i;function error_function(name){function isPlainObject(o){return!!o&&typeof o==='object'&&o.constructor===Object;};return function(data,status){if(status>=500){data="unknown_error";}
console.log('error',data);if(isPlainObject(data)){var errors=[];for(var key in data){errors.push(localize.getString(data[key]));$scope[name]['common']=errors.join(', ');$scope.processing=false;}}else{$scope[name]['common']=localize.getString(data);$scope.processing=false;}};}
$scope.register=function(form){$scope.processing=true;SafariHack(function(){$http.post('/api/v3/user/registerId',$scope.registerForm).success(function(data){UserService.setFullData(data)
$location.path("/start/")}).error(error_function('registerErrors'));})};$scope.login=function(){$scope.processing=true;SafariHack(function(){$http.post('/api/v3/user/loginId',$scope.loginForm).success(function(data){UserService.setFullData(data)
$location.path("/")}).error(error_function('loginErrors'))})};$scope.guest=function(){$scope.processing=true;SafariHack(function(){$http.post('/api/v3/user/guest',$scope.guestForm).success(function(data){UserService.setFullData(data)
$location.path("/start/")}).error(error_function('guestErrors'))})};$scope.signup=function(){if(config.auth=="kong"){kongregate.services.showRegistrationBox();}}});
bombermine.controller('BonusNotificationsCtrl',function($scope,$rootScope,$location,$http,i18nFilter,$timeout,localize,UserService){var notifications=[];$scope.nextNotification=function(){$http.post("/api/v3/bonuses/close-notification",{notificationId:notifications.shift().id})
$scope.notification=notifications[0]}
$rootScope.show_notifications=function(bonus_list){if(bonus_list.length>0){notifications=bonus_list;$scope.notification=notifications[0]}}
function load_bonus_list(data_list){var bonus_list=[];var data=$rootScope.config.achievements;var mapping={};for(var i=0;i<data.length;i++){mapping[data[i].name]=data[i];}
for(var key in data_list){var record=data_list[key];var config=mapping[record.bonus_type].list[record.bonus_level-1];record.display_type=config.display_type;record.reward_type=config.reward_type;record.reward_name=config.reward_name;record.reward_amount=config.reward_amount;record.limit=config.limit;bonus_list.push(record);$rootScope.show_notifications(bonus_list);}}
$rootScope.check_for_notifications=function(){$http.get("/api/v3/bonuses/list").success(function(data){load_bonus_list(data)})}
load_bonus_list($rootScope.notifications);$rootScope.notifications=null;window.testnotify=function(){$scope.$apply(function(){var bonus_list=[{"id":96,"user_id":10,"bonus_type":"days","bonus_level":3,"checked":false,"display_type":"gold","reward_type":"gold","reward_name":"","reward_amount":5000,"limit":1200},{"id":96,"user_id":10,"bonus_type":"days","bonus_level":4,"checked":false,"display_type":"pu","reward_type":"plutonium","reward_name":"","reward_amount":1,"limit":1200},{"id":96,"user_id":10,"bonus_type":"days","bonus_level":5,"checked":false,"display_type":"chest","reward_type":"time_perk","reward_name":"autoshield","reward_amount":3600,"limit":1200},{"id":96,"user_id":10,"bonus_type":"kills","bonus_level":1,"checked":false,"display_type":"star","reward_type":"star","reward_name":"","reward_amount":0,"limit":10},{"id":97,"user_id":10,"bonus_type":"kills","bonus_level":2,"checked":false,"display_type":"star","reward_type":"star","reward_name":"","reward_amount":0,"limit":100},{"id":98,"user_id":10,"bonus_type":"kills","bonus_level":3,"checked":false,"display_type":"star","reward_type":"star","reward_name":"","reward_amount":0,"limit":500},{"id":99,"user_id":10,"bonus_type":"kills","bonus_level":4,"checked":false,"display_type":"star","reward_type":"star","reward_name":"","reward_amount":0,"limit":1000},{"id":100,"user_id":10,"bonus_type":"kills","bonus_level":5,"checked":false,"display_type":"star","reward_type":"star","reward_name":"","reward_amount":0,"limit":2000},{"id":101,"user_id":10,"bonus_type":"kills","bonus_level":6,"checked":false,"display_type":"star","reward_type":"star","reward_name":"","reward_amount":0,"limit":5000},{"id":102,"user_id":10,"bonus_type":"kills_per_round","bonus_level":1,"checked":false,"display_type":"star","reward_type":"star","reward_name":"","reward_amount":0,"limit":10},{"id":103,"user_id":10,"bonus_type":"kills_per_round","bonus_level":2,"checked":false,"display_type":"star","reward_type":"star","reward_name":"","reward_amount":0,"limit":25},{"id":104,"user_id":10,"bonus_type":"kills_per_round","bonus_level":3,"checked":false,"display_type":"star","reward_type":"star","reward_name":"","reward_amount":0,"limit":50},{"id":105,"user_id":10,"bonus_type":"kills_per_round","bonus_level":4,"checked":false,"display_type":"star","reward_type":"star","reward_name":"","reward_amount":0,"limit":75},{"id":106,"user_id":10,"bonus_type":"kills_per_round","bonus_level":5,"checked":false,"display_type":"star","reward_type":"star","reward_name":"","reward_amount":0,"limit":100},{"id":107,"user_id":10,"bonus_type":"kills_per_round","bonus_level":6,"checked":false,"display_type":"star","reward_type":"star","reward_name":"","reward_amount":0,"limit":125},{"id":108,"user_id":10,"bonus_type":"kills_per_round","bonus_level":7,"checked":false,"display_type":"star","reward_type":"star","reward_name":"","reward_amount":0,"limit":150},{"id":109,"user_id":10,"bonus_type":"kills_per_round","bonus_level":8,"checked":false,"display_type":"star","reward_type":"star","reward_name":"","reward_amount":0,"limit":175},{"id":110,"user_id":10,"bonus_type":"kills_per_round","bonus_level":9,"checked":false,"display_type":"star","reward_type":"star","reward_name":"","reward_amount":0,"limit":200},{"id":111,"user_id":10,"bonus_type":"gold","bonus_level":1,"checked":false,"display_type":"star","reward_type":"star","reward_name":"","reward_amount":0,"limit":1000},{"id":112,"user_id":10,"bonus_type":"gold","bonus_level":2,"checked":false,"display_type":"star","reward_type":"star","reward_name":"","reward_amount":0,"limit":10000},{"id":113,"user_id":10,"bonus_type":"gold","bonus_level":3,"checked":false,"display_type":"star","reward_type":"star","reward_name":"","reward_amount":0,"limit":50000},{"id":114,"user_id":10,"bonus_type":"gold","bonus_level":4,"checked":false,"display_type":"star","reward_type":"star","reward_name":"","reward_amount":0,"limit":100000},{"id":115,"user_id":10,"bonus_type":"rounds","bonus_level":1,"checked":false,"display_type":"star","reward_type":"star","reward_name":"","reward_amount":0,"limit":1}]
$rootScope.show_notifications(bonus_list);})}});
bombermine.controller('CommunityCtrl',function($scope,$rootScope,community,serverList){var iframe=$("#community_iframe")[0];iframe.onload=function(){iframe.style.visibility='visible';community.attach(iframe);};var path=window.location.hash.replace("#/forum/",'');function setParam(path,s){if(path.indexOf(s)===-1){if(path.indexOf('?')===-1){path+='?'+s}else{path+='&'+s}}
return path}
path=setParam(path,"iframe=1")
if(config.auth)
path=setParam(path,"auth="+config.auth)
var protocol=(location.protocol=="https:"||serverList.current.ssl)?"https:":"http:";iframe.src=protocol+"//gameofbombs.com/community/"+path;$scope.$on("$destroy",community.detach);});
function secToHms(d){d=Number(d);var h=Math.floor(d/3600);var m=Math.floor(d%3600/60);var s=Math.floor(d%3600%60);return((h>0?h+":":"")+(m>0?(h>0&&m<10?"0":"")+m+":":"0:")+(s<10?"0":"")+s);}
bombermine.controller('GameServersCtrl',function($scope,$rootScope,$location,Game,serverList,Tracking){function afterUpdate(){angular.extend($scope,serverList)
sort()
if(!$scope.$$phase)
$scope.$digest()}
function afterInit(){var rooms=serverList.rooms,servers=serverList.servers;var ss=$scope.sortedServers=[]
for(var id in servers)if(servers.hasOwnProperty(id)){ss.push(servers[id])}
var sr=$scope.sortedRooms=[]
for(var id in rooms)if(rooms.hasOwnProperty(id)){sr.push(rooms[id])}
sort()}
function sort(){var ss=$scope.sortedServers,sr=$scope.sortedRooms;ss.sort(function(a,b){var la=a.status.latency,lb=b.status.latency;if(la=="-")la=100000;if(lb=="-")lb=100000;return la-lb;});var sid={};for(var i=0;i<ss.length;i++)
sid[ss[i].id]=i;sr.sort(function(a,b){var s=sid[a.serverId]-sid[b.serverId];if(s!=0)return s;if(a.name>b.name)return 1;if(a.name<b.name)return-1;return 0;})}
$scope.getServerIconPosition=function(type,value){var x,y;y=0;switch(type){case'players':x=0;y=Math.floor(value/100);if(y>3)
y=3;break;case'timeLeft':value=16-parseInt(value);if(value<0)
value=0;x=1;y=Math.ceil(value/2);break;case'latency':x=2;y=0;var l=64;while(l<value){l*=2;y++;}
break;}
return{'background-position':-(x*16)+'px '+-(y*16)+'px'};};$scope.selectServer=function(srv){var current=serverList.current
var mem={serverId:current.serverId,roomId:current.roomId};current.serverId=srv.id;current.roomId=0;$rootScope.reconnectTimer=0;serverList.autoSelect();if(serverList.tryConnect())
$rootScope.showMenu=false;else{current.serverId=mem.serverId;current.roomId=mem.roomId;}}
$scope.selectRoom=function(room,track_key){var current=serverList.current
var mem={serverId:current.serverId,roomId:current.roomId};current.serverId=room.serverId;current.roomId=room.id;$rootScope.reconnectTimer=0;serverList.autoSelect();if(serverList.tryConnect()){$rootScope.showMenu=false;if(track_key)Tracking.track(track_key,serverList.current.roomId);}
else{current.serverId=mem.serverId;current.roomId=mem.roomId;}}
afterInit();afterUpdate();$scope.idlePing();$scope.$on("serversUpdate",afterUpdate);$scope.$on("serversInit",afterInit);var path=window.location.hash.replace("#/servers/",'');$scope.$on("serversPing",function(){if(!$scope.searchOptimal)return;serverList.current.serverId=0;serverList.current.roomId=0;$scope.searchOptimal=false;$location.path("/servers/")
$rootScope.play()});if(path.substring(0,4)=="init"){$scope.searchOptimal=true;}
$scope.$on("$destroy",function(){$scope.searchOptimal=false;})});
bombermine.controller('GoalsCtrl',function($rootScope,$http,$sce,$scope,$location,UserService,Social,Payment){$scope.section="Projects";function event(p1,p2){_gaq.push(['_trackEvent',$scope.section,$scope.section.toLowerCase()+'_'+p1,p2]);}
$scope.event_section=function(name){$scope.section=name;event('projects_main','Click on projects');}
$scope.goals=[];$scope.curGoal=null;$scope.nextGoal=function(){var g=$scope.goals;if($scope.curGoal==null){if(g.length>=5)$scope.curGoal=g[$scope.firstTimeSeeEvent?4:0];else $scope.curGoal=g[Math.random()*g.length|0];return;}
for(var i=0;i<g.length;i++){if(g[i]==$scope.curGoal){$scope.curGoal=g[(i+1)%g.length];break;}}}
$scope.selectGoal=function(goal){$scope.curGoal=goal;event('project_click','Click on project');}
function reload(){$http.get('/api/v3/goals/list').success(function(data){$scope.goals=data.all;for(var i=0;i<data.all.length;i++){var goal=data.all[i];goal.current=goal.status==2;goal.donated=0;goal.progress=Math.ceil(100*goal.amount/goal.goal);goal.calc={money:goal.tier1};if(goal.imageUrl){goal.imageUrl=$sce.trustAsResourceUrl(goal.imageUrl);}
goal.topDonators=[];for(var j=0;j<data.my.length;j++){var donation=data.my[j];if(goal.id==donation.goalId){goal.donated=Math.round(donation.amount*10)/10;}}}
if($scope.curGoal!=null){var name=$scope.curGoal.name;$scope.curGoal=null;for(var i=0;i<$scope.goals.length;i++)
if($scope.goals[i].name==name){$scope.curGoal=$scope.goals[i];}}
if($scope.curGoal==null){$scope.nextGoal();}}).error(function(data,status){});}
$scope.$watch(function(){return $rootScope.user.plutonium;},reload);$scope.toggle=function(elem,flag){elem.tab=flag||0;event('project_toggle_click','toggle project tab');if(flag==1){$http.get('/api/v3/goals/top?id='+elem.id).success(function(data){elem.topDonators=data;for(var i=0;i<data.length;i++){data[i].amount=Math.round(data[i].amount*10)/10;}})}}
$scope.topDonators=[];$scope.buy=function(goal,scrbrd){event('projects_donate_'+goal.name,'Click on donate');Payment.showPayment(goal.calc,goal.id);}
$scope.getSkinThumbSrc=function(skin){return'/api/ctor/getskin?name='+encodeURIComponent(skin||'default')+'&thumb=1';}
$scope.pluttyProgressStyle=function(w,flag){if(w>42&&w<61&&flag){return{"margin-left":"-10rem","left":w+'%'}}
return{};}})
bombermine.controller('LearnCtrl',function($http,$scope,$rootScope,i18nFilter,UserService){$scope.levels2learn=[];for(var i=0;i<12;++i){$scope.levels2learn[i]={n_level:i+1,header:"header_"+(i+1),descr:"desc_"+(i+1)};}
$scope.notAvailableFlag=false;$scope.levelUpFlag=false;$scope.disableLevelUpFlag=true;$scope.isLoggedIn=UserService.isLoggedIn();$rootScope.showTutorial=function(n1,n2){$rootScope.cur_level=n1;$rootScope.max_level=n2;$rootScope.lrnModalActive=true;}
$scope.switch_level=function(i_level){if(i_level>$scope.max_level){$scope.notAvailableFlag=true;$scope.disableLevelUpFlag=true;}else{$scope.cur_level=i_level;}};$scope.level_up=function(){$scope.max_level++;console.log(UserService.isLoggedIn());$scope.last_level=($scope.levels2learn.length==$scope.max_level);$scope.disableLevelUpFlag=true;$scope.levelUpFlag=true;};$scope.closeNotification=function(){if($scope.levelUpFlag){$scope.switch_level($scope.max_level);}
$scope.levelUpFlag=false;$scope.disableLevelUpFlag=true;$scope.notAvailableFlag=false;if($scope.last_level){$scope.disableLevelUpFlag=true;}};});
bombermine.controller('ModalCtrl',function($http,$scope,$rootScope,$modal,i18nFilter,UserService,Social){$rootScope.showPerks=function(){var modalInstance=$modal.open({animation:false,templateUrl:'tmpl/modal/show_perks.tmpl',controller:'CloseModal'});}
$rootScope.showChangePassword=function(){var modalInstance=$modal.open({animation:false,templateUrl:'tmpl/modal/change_password.tmpl',controller:'CloseModal'});}
$rootScope.showChangeEmail=function(){var modalInstance=$modal.open({animation:false,templateUrl:'tmpl/modal/change_email.tmpl',controller:'CloseModal'});}
$rootScope.showChangeNickname=function(){return $modal.open({animation:false,templateUrl:'tmpl/modal/change_nickname.tmpl',controller:'ChangeNickname'}).result;}
$rootScope.messageBox=function(text,buttons,callback){var modalInstance=$modal.open({animation:false,templateUrl:'tmpl/modal/message_box.tmpl',controller:'MessageBox',resolve:{params:function(){return{text:text,buttons:buttons}}}});modalInstance.result.then(callback,function(){callback(1);});}
$rootScope.showBuyChests=function(){var modalInstance=$modal.open({animation:false,templateUrl:'tmpl/modal/buy_chests.tmpl',controller:'CloseModal'});}
$rootScope.showBuyPlut=function(){var modalInstance=$modal.open({animation:false,templateUrl:'tmpl/modal/buy_plut.tmpl',controller:'CloseModal'});}
$rootScope.showRooms=function(hideTutor){var modalInstance=$modal.open({animation:false,templateUrl:'tmpl/modal/show_rooms.tmpl',controller:'ShowRooms',resolve:{params:function(){var trackRoomKey=hideTutor?"tutor_next_room":false;var doFilter=hideTutor||false;return{doFilter:doFilter,trackRoomKey:trackRoomKey}}}});}
$rootScope.showChangeButtons=function(){var modalInstance=$modal.open({animation:false,templateUrl:'tmpl/modal/show_change_buttons.tmpl',controller:'ShowChangeButtons'});}
$rootScope.showBuyItemModal=function(item,curr,hud,cb){if($rootScope.cantBuyAskRegister())
return;var modalInstance=$modal.open({animation:false,templateUrl:'tmpl/modal/selling_box.tmpl',controller:'SellingBox',resolve:{params:function(){return{item:item,curr:curr,hud:hud,cb:cb}}}});}
$rootScope.showNotEnoughMoney=function(curr,cb){$modal.open({animation:false,templateUrl:'tmpl/modal/selling_box.tmpl',controller:'SellingBox',resolve:{params:function(){return{curr:curr,cb:cb,error:curr=="plut"?"not_enough_plutonium":"not_enough_gold"}}}});}
$rootScope.showRegister=function(){if(Social.active){Social.showRegister();return;}
else{var modalInstance=$modal.open({animation:false,templateUrl:'tmpl/modal/register_modal.tmpl',controller:'RegisterModal'});}}
$rootScope.showBuySlot=function(slots){var modalInstance=$modal.open({animation:false,templateUrl:'tmpl/modal/buy_slot.tmpl',controller:'BuySlot',resolve:{params:function(){return{slots:slots}}}});}
$rootScope.askLogoutInGame=function(){var modalInstance=$modal.open({animation:false,templateUrl:'tmpl/modal/login_in_game.tmpl',controller:'LoginInGame'});}
$rootScope.canChangeNickname=function(){var user=$rootScope.user;if(!user.is_guest){if(user.nickname.indexOf("~")>=0)
return"must"
if(!user.when_update_username||user.when_update_username<Date.now())
return"yes"
return"pay"}
return"no"}
$rootScope.checkProblems=function(){var user=$rootScope.user;var hasReliableProvider=user.identities.filter(function(x){return window.config.providersWithoutPassword.indexOf(x)<0;}).length>0;if(!user.is_guest&&(user.providerId=="recover"&&user.pwd_status=='recovering'||!hasReliableProvider&&!user.pwd_status)){$rootScope.showChangePassword();}
if($rootScope.canChangeNickname()=="must"){function changeNicknameRecursive(){$rootScope.showChangeNickname().then(function(){},changeNicknameRecursive);}
changeNicknameRecursive();}}
$rootScope.checkProblems();});
bombermine.controller('MoneyCtrl',function($rootScope,$http,$sce,$scope,$location,UserService,Social,Payment){if(!UserService.isLoggedIn())return $location.path("/")
var prices=$scope.prices=Payment.prices;var calc=$scope.calc={};$scope.symbol=Payment.symbol;if(config.auth=="vk"||config.auth=="kong"||config.auth=="ok")
calc.currencies=[config.auth];else
calc.currencies=["USD"];var errorFunction=function(data,status){if(status>=500){$rootScope.messageBox("server_error",["ok"],function(result){});}else{$rootScope.messageBox(data,["ok"],function(result){});}};function skuIndex(){for(var i=1;i<prices.plut.length;i++){if(calc.plut<prices.plut[i])
return i-1;}
return prices.plut.length-1;}
$scope.buy=function(){Payment.showPayment(calc);};if(config.auth!="kong"&&config.auth!="facebook"){var moneyChecker=window.setInterval(UserService.updateCurrentUser,10000)
$scope.$on("$destroy",function(){window.clearInterval(moneyChecker)})}});
bombermine.controller('MoneyTabCtrl',function($rootScope,$http,$sce,$scope,$location,UserService,Social,$state){$scope.ulTab=[{name:"buy_now",route:"money.buy_now"},{name:"projects",route:"money.goal"}];$scope.go=function(route){$state.go(route);};$scope.active=function(route){return $state.is(route);};$scope.$on("$stateChangeSuccess",function(){$scope.ulTab.forEach(function(tab){tab.active=$scope.active(tab.route);});});});
bombermine.controller('NotificationsCtrl',function($scope){var id=0;$scope.notifications=[];$scope.$on('addNotification',function(event,data){$scope.notifications.push({id:id++,msg:data});console.log(data);});$scope.close_notification=function(id){$scope.notifications.shift();$("#notification"+id).hide()}});
bombermine.controller('PlayPageCtrl',function($scope,$rootScope,$location,$sce,$http,UserService,Game,Social,serverList,storage,Sounds,Tracking,i18nFilter,Realtime){config.ZIndex=0;config.connectOnAttach=false;Game.gameAttach();$scope.showTutorialTop={val:true};$scope.changeShowTutorialTop=function(val){$scope.showTutorialTop.val=val;}
Game.on('gameConnectionChanged',function(){if(!$scope.$$phase)return $scope.$apply(function(){Game.emit('gameConnectionChanged')});$rootScope.showGame=Game.gameIsRunning();if(Game.gameIsRunning()){Social.onConnect&&Social.onConnect();if(serverList.firstConnection){Tracking.track("start_connected",serverList.current.roomId);serverList.firstConnection=false;}}
if($rootScope.connectionStatus!=4)
$rootScope.connectionStatus=Game.gameConnectionStatus();if($rootScope.connectionStatus==3){$rootScope.showConnection=!$rootScope.showMenu;}else{if($rootScope.connectionStatus!=0)
$rootScope.reconnectTimer=0;$rootScope.showConnection=!$rootScope.showGame;}});$rootScope.play=function(){$rootScope.banMessage=null;$rootScope.showMenu=false;if($rootScope.connectionStatus==3){$rootScope.reconnectTimer=0;serverList.autoSelect();if(serverList.tryConnect()){}else{}}};$rootScope.play2=function(){if($rootScope.connectionStatus==3){serverList.autoSelect();$rootScope.showRooms();}else{$rootScope.showMenu=false;}};Game.on("forceChangeRoom",function(roomType){$rootScope.showRooms(true);$rootScope.$digest();});$rootScope.abort=function(){$rootScope.banMessage=null;$rootScope.reconnectTimer=-1;Game.gameDisconnect();Game.emit("gameConnectionChanged");};$rootScope.choose=function(){$rootScope.banMessage=null;$rootScope.showMenu=true;$rootScope.showConnection=false;$location.path("/servers/");}
Game.on("gameEventAdmin",function(msg){if(window.DEBUG){console.log('gameEventAdmin:',msg);return;}
if(msg.substring(0,7)=="version"){var ver=msg.substring(8);if(ver==config.versionBad){alert('Server version deffers from client version, please choose other server');}else{function setParam(path,s){if(path.indexOf(s)===-1){if(path.indexOf('?')===-1){path+='?'+s}else{path+='&'+s}}
return path}
if(storage.isAvailable()){storage.setItem("version",ver);storage.setItem("changeVersion",ver);window.location.reload();}else{window.location=location.pathname+setParam(location.search,"version="+ver)+location.hash;}
$rootScope.connectionStatus=4;}
return;}
if(msg.substring(0,4)=="ban "){var comment="ban_msg_default";var i=msg.indexOf("//");if(i>0){comment=msg.substr(i+2);msg=msg.substr(0,i);}
$rootScope.banMessage=$sce.trustAsHtml(i18nFilter('banned_till')+' '+
new Date(+msg.substr(4)*1000)+'<br>'+i18nFilter(comment));return;}
switch(msg){case'pleaseLogin':$rootScope.logout();break;case'kick':alert('You have been kicked');break;case'playersLimitExceeded':alert('Players limit exceeded. Try again later.');$location.path('/');break;case'disconnect':alert('Disconnected from server');$location.path('/');break;case'duplicate':alert('You connected from other browser');break;default:Game.emit('gameEventNetDisconnect');break;}})
Game.on('gameEventNetDisconnect',function(reconnectInterval){if($rootScope.connectionStatus==0){var tt=$rootScope.reconnectTimer;serverList.failsafe(tt>=0?6-tt:1);}
if($rootScope.reconnectTimer==-1)return;var connTimeout;var callback=function(){if($rootScope.reconnectTimer>0){$rootScope.reconnectTimer--;if($rootScope.reconnectTimer==0)
$rootScope.reconnectTimer=-1;Game.gameConnect();if(Game.gameConnectionStatus()==2){connTimeout=setTimeout(callback,reconnectInterval||3000);return;}
if(Game.gameConnectionStatus()!=1){$rootScope.$apply(function(){$rootScope.$broadcast('clear chat')});}}}
if($rootScope.reconnectTimer==0)
$rootScope.reconnectTimer=5;Game.gameDisconnect();connTimeout=setTimeout(callback,reconnectInterval||3000);})
Game.on('gameEventRoundEnd',function(data){if(!data)
return;})
$scope.msgHello=function(){window.gameEventChat('bombermine','! Hey! We\'re inviting:\n 1. Country community leaders\n2. Moderators\n3. Translators\n4. Artists/Illustrators\n5. Skinmakers\n\nAlso we\'re welcome for partnership in hosting servers for your country.\nLet us know via bombermine.com@gmail.com',true,0);}
var fullScreen=0;var resizeHandler=function(){if(fullScreen){var v=$('#viewport');Game.gameSetViewportSize(v.outerWidth(),v.outerHeight());}else{Game.gameSetViewportSize(800,600);}}
$scope.toggleFullScreen=function(on){fullScreen=on||!fullScreen;resizeHandler();}
$scope.toggleFullScreen();$(window).on('resize',resizeHandler);var _w=0,_h=0;function checkResize(){var v=$('#viewport');var w=v.outerWidth(),h=v.outerHeight();if(w!=_w||h!=_h){_w=w;_h=h;resizeHandler();}}
var resizeInterval=setInterval(checkResize,1000)
$scope.$on('$destroy',function(){$(window).unbind('resize',resizeHandler);clearInterval(resizeInterval)
console.log('PlayPageCtrl destroy');$rootScope.reconnectTimer=-1;Game.gameDetach();});$scope.changeH=function(){$scope.msgH=angular.element('#msgText')[0].scrollHeight;$scope.msgH1=angular.element('#msgText')[0].offsetHeight;$scope.msgH2=angular.element('#msgText')[0].clientHeight;$scope.msgBott=114-$scope.msgH;if($scope.msgBott<0)
$scope.msgBott=0;}
serverList.doAfterInit(function(){if(storage.getItem("changeVersion")||page_params&&page_params["version"]){$rootScope.play();storage.removeItem("changeVersion");}});$scope.changeH();Game.on("questContext",function(msg){msg=msg.replace("[Space]","<div class='key'>Space</div>");$scope.context=$sce.trustAsHtml(msg);$scope.showContext=msg.length!=0;$scope.$digest();})
Game.on("achievementGet",function(msg){Social.onCompleteTutorial&&Social.onCompleteTutorial();$rootScope.setTutorLevel(1);UserService.updateCurrentUser();$rootScope.check_for_notifications()})});
bombermine.controller('ProfileCtrl',function($scope,$rootScope,$location,$http,i18nFilter,UserService){if(!UserService.isLoggedIn())return $location.path('/')
if($rootScope.profileTab){$scope.activeTab=$rootScope.profileTab;$rootScope.profileTab=null;}else{$scope.activeTab='stats';}
UserService.updateCurrentUser();_gaq.push(['_setCustomVar',1,'user_load_profile',$scope.user.id,1]);$scope.notification=null;$scope.setNotification=function(value){$scope.notification=value;}
$scope.disable_buttons_flag=false;$scope.toggleModal=function(cart){$scope.disable_buttons_flag=false;if(!cart){$scope.notification=null;$rootScope.modalActive=false;}else{$scope.cart=cart;$rootScope.modalActive=true;}}
$scope.errorModal=function(err){$scope.setNotification({title:i18nFilter("error"),text:i18nFilter(err),type:"error"});}
$scope.referralsEnabled=function(){return!($scope.user.flags&1);}
var _userId=$scope.user.id;$scope.$on('$destroy',function(){$rootScope.modalActive=false
console.log('ProfileCtrl destroy');_gaq.push(['_setCustomVar',1,'user_close_profile',_userId,1]);});});
bombermine.controller('RecoverPasswordCtrl',function($scope,$location,$http,i18nFilter,UserService){if(UserService.isLoggedIn())return $location.path('/profile/')
$scope.is_hash_checked=false;$http.post("/api/v3/user/password/is_hash_correct",{hash:$location.search().hash}).success(function(){$scope.is_hash_checked=true;}).error(function(data,status){switch(status){case 400:$location.path("/").search({})
break;default:$scope.error=i18nFilter("unknown_error")
break;}})
$scope.keypress=function(key){if(key.which==13){$scope.change_password()}}
$scope.change_password=function(){$scope.processing=true;$http.post("/api/v3/user/password/update",{hash:$location.search().hash,new_password:$scope.new_password}).success(function(){$location.path("/").search({})}).error(function(data){$scope.error=i18nFilter(data.error)
$scope.processing=false;})}});
bombermine.controller('ReferralNotificationsCtrl',function($scope,$location,$http,i18nFilter,$timeout,UserService){(function poll_refferals_data(){$http.get("/api/v3/referrals/poll").success(function(data,status){if(status==200)
$scope.notifications=data
else $scope.notifications=[];})
$timeout(poll_refferals_data,5*60*1000)})()
$scope.close_notification=function(id){$scope.notifications.shift();$http.post("/api/v3/referrals/close-notification",{id:id})
$("#notification"+id).hide()}});
bombermine.controller('ReferralsListCtrl',function($scope,$location,$http,i18nFilter,UserService){$http.get("/api/v3/referrals/list").success(function(data){$scope.referrals=data.referrals
$scope.referrals_gain=data.referrals_gain})});
bombermine.controller('RegisterCtrl',function($scope,$rootScope,$location,$http,UserService){$scope.form={email:"",pwd:"",username:"",referrer:document.referrer}
$scope.processing=false;function error_function(data,status){if(status>=500){data={nickname:"c_server_error"};}
$scope.errors=data;$scope.processing=false;};$scope.auth=function(action){var errors=$scope.errors={}
var form;form=$scope.form;if(errors.email=Utils.validateEmail(form.email))errors.exist=true;if(errors.pwd=checkPass(form.pwd))errors.exist=true;if(errors.nickname=check_username(form.username))errors.exist=true;console.log($scope.errors);if(!errors.exist){$scope.processing=true;$http.post('/api/v3/user/'+action,form).success(function(data){UserService.setUserData(data);$rootScope.config.token=data.token;$location.path("/")
$rootScope.$broadcast("register");}).error(error_function)
console.log($scope.errors);}
console.log($scope.errors);}
function check_username(nickname){console.log(nickname)
if(nickname==""){console.log('empty');return("nickname_must_not_be_empty")}
else if(nickname.length>20)return("nickname_length_must_not_be_longer_then_20")
else if(nickname.length<3)return("nickname_length_must_be_longer_then_3")
else if(!(/^[a-zA-Z0-9_]+$/.test(nickname)))return("incorrect_nickname")
else return false}
function checkPass(password){if(password=="")return"password_must_not_be_empty";if(password.length>20)return"password_length_must_not_be_greather_then_20";if(password.length<5)return"password_length_must_not_be_less_then_5";return false;}})
bombermine.controller('RoomCtrl',function($scope,$rootScope,$location){$scope.roomSelect=0;$scope.arrRooms=[{'name':'Hardcore','players':'7','time':'10.09'},{'name':'Teamplay','players':'11','time':'11.45'},{'name':'name1','players':'9','time':'07.08'},{'name':'name2','players':'2674','time':'03.54'}];$scope.changeRoom=function(i){$scope.roomSelect=i;}})
bombermine.controller('RootCtrl',function($scope,$rootScope,$location,$http,localize,storage,UserService,ShopService,serverList,Keys,Social,$sce,Game,Realtime){console.log('RootCtrl init');$rootScope.min=Math.min;$rootScope.Social=Social;$rootScope.state={};$rootScope.browserSupport=!!window.WebSocket;$rootScope.chatRight=storage.getItem('chatRight',"false")=="true";$rootScope.$watch("user.is_guest",function(val){$rootScope.landingName=val?"1":(config.regLanding||"3");});$rootScope.switchLanding=function(){$rootScope.landingName=5-$rootScope.landingName;};if(($location.path()=="/"||$location.path()=="")&&$rootScope.user.score==0&&!$rootScope.user.region&&!config.defaultRoom){$location.path("/start/");}
function loginEvent(){serverList.init($rootScope.user.servers);serverList.doPing()
Realtime.onLogin()
Social.onLogin()
if(config.defaultRoom){setTimeout(function(){serverList.current.serverId=config.defaultServer;serverList.current.roomId=config.defaultRoom||0;$rootScope.play();},500);}}
function readyEvent(){if($rootScope.user.id!=0)loginEvent();else $rootScope.$on("login",loginEvent)
if(!$rootScope.$$phase)$rootScope.$digest()}
if(Social.ready)readyEvent();else $rootScope.$on("socialReady",readyEvent);$rootScope.$on("swicth",loginEvent);$rootScope.showPlay=false;$rootScope.showMenu=true;$rootScope.showConnection=false;$rootScope.reconnectTimer=0;$rootScope.connectionStatus=3;Keys.lockOnTrue($rootScope,'showMenu','menu');$rootScope.profileTab=null;$rootScope.openProfile=function(profileTab){$rootScope.profileTab=profileTab;$location.path("/");}
$rootScope.menu=function(){$rootScope.showMenu=true;}
$rootScope.topBannerHeight=config.showTopBanner?95:0;$rootScope.menuStyle=function(){var usedSpaceHeight=300+$rootScope.topBannerHeight;var itemBaseHeight=26;var nItems=$("#sideMenuUl li").length;var p=~~Math.max(0,Math.min(16,(($(window).height()-usedSpaceHeight-itemBaseHeight*nItems)/nItems)));return{'padding-top':''+(p>>1)+'px','padding-bottom':''+(p-(p>>1))+'px'};}
$rootScope.online={total:0};$rootScope.askOnline=function(callback){$http.get('/api/v3/online').success(function(data){$rootScope.online=data
if(callback)callback();}).error(function(err,status){if(callback)callback();})}
$rootScope.askOnline();localize.init();$rootScope.getPermission=function(value){var player=$rootScope.user;if(!!player&&(player.perm_mask&value)!=0)
return true
else
return false;}
$rootScope.getIconPosition=function(index,dx,dy,x,y){var U='undefined';dx=typeof(dx)===U?0:dx;dy=typeof(dy)===U?0:dy;x=typeof(x)===U?0:x;y=typeof(y)===U?0:y;return{'background-position':(x-(index*dx))+'px '+(y-(index*dy))+'px'};}
$scope.logout=function(){location.href="/logout?auth="+(config.auth||"b")}
$rootScope.$watch(ShopService.getModel,function(newVal){$rootScope.shopmodel=newVal;});var tutorLevel=0;$rootScope.$watch("progress",function(newVal,oldVal){tutorLevel=0;for(var i=0;i<newVal.bonuses.length;i++)
if(newVal.bonuses[i].bonus_type=="tutorial"){tutorLevel=newVal.bonuses[i].bonus_level;break;}
if($rootScope.connectionStatus>=3){serverList.checkIfTutor();}});$rootScope.tutorLevel=function(){return tutorLevel;};$rootScope.setTutorLevel=function(val){var newVal=$rootScope.progress
for(var i=0;i<newVal.bonuses.length;i++)
if(newVal.bonuses[i].bonus_type=="tutorial"){newVal.bonuses[i].bonus_level=val;}};$rootScope.getForumLink=function(){if(config.auth=='vk')
return $sce.trustAsResourceUrl("//gameofbombs.com/?section=2aec1bca-b261-4518-b042-a42f7be6efc5&token="+$rootScope.user.token);else
return $sce.trustAsResourceUrl("//gameofbombs.com/?token="+$rootScope.user.token);}
$rootScope.openForum=function(){window.open("//gameofbombs.com/community/");}
$scope.$watch(function(){return{'w':$(window).width(),'h':$(window).height()-$rootScope.topBannerHeight};},function(newVal,oldVal){$scope.h=newVal.h;$scope.w=newVal.w;},true);var resizeWndTimer=setInterval(function(){if(($scope.h!=$(window).height()-$rootScope.topBannerHeight)||($scope.w!=$(window).width())){$scope.h=$(window).height()-$rootScope.topBannerHeight;$scope.w=$(window).width();$scope.$digest()}},300);$scope.showTestModal=function(){$rootScope.messageBox("are_you_sure",["ok","cancel"],function(result){alert(result);});}
$scope.askLogout=function(){if(!Social.active){$rootScope.messageBox("are_you_sure",["ok","cancel"],function(result){if(result==0){location.href="/logout?auth="+(config.auth||"b")}});}else{if($rootScope.user.is_guest){$rootScope.reconnectTimer=-1;Game.gameDisconnect();$rootScope.user.id=0;}}}
$rootScope.logout=function(){$rootScope.messageBox("auth_error",[],function(result){});}
$rootScope.showTrialPay=function(){$rootScope.iframeLightBox("https://www.trialpay.com/dispatch/1244083a86d7551a622d9a729598f97e?sid="+$rootScope.user.id+"&domain="+$rootScope.config.auth,760,2400);}
$rootScope.checkFlash=function(){var flashinstalled=false;if(navigator.plugins){if(navigator.plugins["Shockwave Flash"]){flashinstalled=true;}
else if(navigator.plugins["Shockwave Flash 2.0"]){flashinstalled=true;}}
else if(navigator.mimeTypes){var x=navigator.mimeTypes['application/x-shockwave-flash'];if(x&&x.enabledPlugin){flashinstalled=true;}}
else{flashinstalled=true;}
return flashinstalled;}
$rootScope.goMoneyOrRegister=function(){if($rootScope.user.is_guest&&Social.active&&Social.showRegister){Social.showRegister();setInterval(function(){$rootScope.path="profile";$location.path("/profile/");});}else{$rootScope.path="money";}}
$rootScope.cantBuyAskRegister=function(){if($rootScope.user.canBuy())
return false;$rootScope.showRegister();return true;}
$rootScope.bitwiseOr=function(a,b){return a|b;};$rootScope.bitwiseAnd=function(a,b){return a&b;};});
bombermine.controller('ScreenShotCtrl',function($scope,$rootScope,$location,storage){$scope.Screenshot=false;$scope.showScreenshot=function(){$scope.Screenshot=!($scope.Screenshot);}
$scope.$slideIndex=0;$scope.slides=[];$scope.next=function(){var total=$scope.slides.length;if(total>0){$scope.$slideIndex=($scope.$slideIndex==total-1)?0:$scope.$slideIndex+1;}};$scope.last=function(){var total=$scope.slides.length;if(total>0){$scope.$slideIndex=($scope.$slideIndex==0)?total-1:$scope.$slideIndex-1;}};$scope.clickLiSlider=function(i){$scope.$slideIndex=i;};$scope.scr=function(){var canvas0=$('#layer0')[0];var canvas1=$('#layer1')[0];var image0=canvas0.toDataURL('image/png');var imageObj0=new Image();imageObj0.src=image0;imageObj0.width=canvas0.width;imageObj0.height=canvas0.height;var image1=canvas1.toDataURL('image/png');var imageObj1=new Image();imageObj1.src=image1;imageObj1.width=canvas1.width;imageObj1.height=canvas1.height;var canvas=document.createElement('canvas');canvas.width=canvas0.width;canvas.height=canvas0.height;var context=canvas.getContext('2d');context.drawImage(imageObj0,0,0);context.drawImage(imageObj1,0,0);var data=canvas.toDataURL('image/png');canvas.remove();if($scope.saveImg(data)==true){alert('Изображение сохранено');$scope.addSliders();}}
$scope.saveImg=function(img){if(typeof(localStorage)=='undefined'){alert('Ваш браузер не поддерживает localStorage()');return false;}
else{try{var arrImg=localStorage.img?JSON.parse(localStorage.img):[];arrImg.push(img);localStorage.setItem('img',JSON.stringify(arrImg));}
catch(e){if(e==QUOTA_EXCEEDED_ERR){alert('Кончилось место');return false;}}
return true;}}
$scope.deleteSlide=function(i){var arrImg=localStorage.img?JSON.parse(localStorage.img):[];if(arrImg.length==0){return false;}
arrImg.splice(i,1);localStorage.setItem('img',JSON.stringify(arrImg));alert('Элемент удалён');if(i==arrImg.length){$scope.$slideIndex=0;}
$scope.addSliders();}
$scope.saveSlide=function(i){alert('save');}
$scope.addSliders=function(){$scope.slides=[];var arrImg=config.localStorage&&localStorage.img?JSON.parse(localStorage.img):[];for(var i=0;i<arrImg.length;i++){$scope.slides.push({'image':arrImg[i]});}}
$scope.addSliders();});
bombermine.controller('ShuffleCtrl',function($scope,$rootScope){var back=new BackgroundApp('bg','html5');$scope.$on('$destroy',function(){back.free();});})
bombermine.controller('SizeCtrl',function($http,$scope){})
bombermine.controller('SkinsTabCtrl',function($scope,$rootScope,$sce,$location,$http,i18nFilter,UserService,$state,skinModel)
{$scope.ulTab=[{name:"skins",route:"skins.skins"},{name:"skin_constructor",route:"skins.character"},];$scope.go=function(route){if(route=="skins.skins"&&skinModel.dirty){skinModel.reload(function(){$state.go(route);});}else
$state.go(route);};$scope.active=function(route){return $state.is(route);};$scope.$on("$stateChangeSuccess",function(){$scope.ulTab.forEach(function(tab){tab.active=$scope.active(tab.route);});});});
bombermine.controller('StartCtrl',function($scope,$rootScope,$location,Game,serverList,Tracking,Social){function afterInit(){var servers=serverList.servers;$scope.servers=[];for(var id in servers)if(servers.hasOwnProperty(id)){$scope.servers.push(servers[id])}}
if(config.defaultRoom){$location.path("/");}
function afterUpdate(){selectBest();if(!$scope.$$phase)
$scope.$digest()}
$scope.servers=[];$scope.selectedServer=null;$scope.selectedRoom=null;$scope.bestServer=null;$scope.rooms=["hardcore","tutorial"];$scope.selReg=true;$scope.next=function(srv){if($scope.selectedServer==null)return;Tracking.track("start_region",$scope.selectedServer.id);Tracking.settings("region",$scope.selectedServer.id);$scope.selReg=false;}
$scope.selectServ=function(server){$scope.selectedServer=server;};$scope.selectRoom=function(mode){$scope.selectedRoom=mode;}
function selectBest(){var ss=[];if($scope.servers.length==0)return;for(var i=0;i<$scope.servers.length;i++){ss.push($scope.servers[i]);}
ss.sort(function(a,b){var la=a.status.latency,lb=b.status.latency;if(la=="-")la=100000;if(lb=="-")lb=100000;return la-lb;});$scope.bestServer=ss[0];}
$scope.playGameFirstTime=function(){if($scope.selectedServer==null)return;Tracking.track("start_room",$scope.selectedRoom);serverList.current.serverId=$scope.selectedServer.id;serverList.current.roomId=serverList.findRoomId($scope.selectedServer.id,$scope.selectedRoom);$rootScope.reconnectTimer=0;serverList.firstConnection=true;if(serverList.tryConnect()){Tracking.track("start_connecting",serverList.current.roomId);$location.path("/profile/");$rootScope.showMenu=false;}}
$scope.onlineTotal=function(){return serverList.onlineTotal;}
$scope.doPing=serverList.doPing;afterInit();afterUpdate();serverList.idlePing();$scope.$on("serversUpdate",afterUpdate);$scope.$on("serversInit",afterInit);$scope.videoHardcore=$('#video-starthardcore');$scope.videoTutorial=$('#video-starttutorial');function videoPlay(video){video[0].play();var isChrome=!!window.chrome;video.bind("ended",function(){if(isChrome){this.load();}
this.play();});};if(config.defaultServer){for(var i=0;i<$scope.servers.length;i++){if($scope.servers[i].id==Social.defaultServer)
$scope.selectedServer=$scope.servers[i];$scope.next();break;}}
videoPlay($scope.videoHardcore);videoPlay($scope.videoTutorial);});
bombermine.controller('TopPersonCtrl',function($rootScope,$scope){$scope.show=false;$scope.numList=1;$scope.listPlayers=[{"empty":0,"highlighted":false,"observing":false,"place":1,"nickname":"oups303","deaths":0,"kills":2,"rank":5,"medal":0},{"empty":0,"highlighted":false,"observing":false,"place":17,"nickname":"fgfgfg123","deaths":0,"kills":0,"rank":9,"medal":0},{"empty":0,"highlighted":false,"observing":false,"place":18,"nickname":"salami023","deaths":0,"kills":0,"rank":4,"medal":0},{"empty":0,"highlighted":false,"observing":false,"place":19,"nickname":"Mark","deaths":0,"kills":0,"rank":8,"medal":0},{"empty":0,"highlighted":false,"observing":false,"place":20,"nickname":"sonnyhung","deaths":0,"kills":0,"rank":0,"medal":0},{"empty":0,"highlighted":false,"observing":false,"place":21,"nickname":"2256434334376","deaths":0,"kills":0,"rank":4,"medal":0},{"empty":0,"highlighted":false,"observing":false,"place":22,"nickname":"USiT","deaths":0,"kills":0,"rank":9,"medal":0},{"empty":0,"highlighted":false,"observing":false,"place":23,"nickname":"hjulia","deaths":0,"kills":0,"rank":0,"medal":0},{"empty":0,"highlighted":false,"observing":false,"place":24,"nickname":"Nekit_Nelson","deaths":1,"kills":0,"rank":4,"medal":0},{"empty":0,"highlighted":false,"observing":false,"place":25,"nickname":"Anglus","deaths":1,"kills":0,"rank":5,"medal":0},{"empty":0,"highlighted":false,"observing":false,"place":26,"nickname":"FOZZIK","deaths":1,"kills":0,"rank":1,"medal":0},{"empty":0,"highlighted":false,"observing":false,"place":27,"nickname":"~Hydras_","deaths":2,"kills":0,"rank":0,"medal":0}]});
bombermine.controller('TopStatsCtrl',function($scope,$rootScope,$http,UserService,$location,serverList,$sce,i18nFilter){var FLAG_INACTIVE=1;var countryNames={'RU':'RU','EU':'EU','US':'US','BR':'BR'};$scope.PERIODS=[{id:'alltime'},{id:'30days',showFilters:true},{id:'month_t',name:'month',info:'month_t_desc',hideSorts:true,showMonthly:true},{id:'month_l',name:'month',info:'month_l_desc',hideSorts:true,showMonthly:true},{id:'7days',showFilters:true},{id:'yesterday',showFilters:true},{id:'today',showFilters:true},{id:'tournaments',hideSorts:true}];$scope.FILTERS=['all','RU','EU','US','BR','JP','classic','pvm','team'];$scope.MONTHLY=[{id:'lastMonth'},{id:'thisMonth'}]
$scope.SORTS={'all':['score','kills','money','medals','team','killsMob'],'classic':['kills','score','medals','money'],'pvm':['killsMob','score','money'],'team':['team','score','kills','money']};$scope.period=$scope.PERIODS[1];$scope.filter=$scope.FILTERS[0];$scope.sorts=$scope.SORTS.all;$scope.sort=$scope.sorts[0];$scope.monthly=$scope.MONTHLY[1];$scope.busy=false;var lastCustomSorts=null;var srv=serverList.activeServer();if(srv&&$scope.FILTERS.indexOf(srv.country.toUpperCase())>0){$scope.filter=srv.country.toUpperCase();}
$scope.currentPage=0;$scope.pageSize=25;$scope.pagesTotal=0;$scope.playersTotal=0;$scope.data=[];$scope.tours=[];$scope.tour={};function updateTours(){$http.get('/api/v3/stat/tournaments?limit=5').success(function(json){$scope.tours=json.list;var updatedTour={};for(var i=0;i<$scope.tours.length;i++){var t=$scope.tours[i];t.ends=new Date(t.starts+t.duration*1000);t.starts=new Date(t.starts);t.minutes=Math.floor(t.duration/60);t.room=t.room||i18nFilter('rankings_all');t.sortKey=t.sortKey||$scope.SORTS.all[0];t.sortName=i18nFilter('rankings_'+t.sortKey);t.countryName=countryNames[t.countryName]||i18nFilter('rankings_'+t.countryName);t.mapName=i18nFilter('rankings_'+t.mapName);if(!config.hideReferralLinks)
t.info=t.infoWithURL||t.info;if(t.info)t.info=$sce.trustAsHtml(t.info)
if($scope.tour.id==t.id)
updatedTour=t;}
$scope.tour=updatedTour;})}
updateTours();$scope.getPeriodStatus=function(){var t=$scope.tour;if(!t.starts)return 0;var now=Date.now()
if(now<t.starts)return 0;if(now>t.ends)return 3;return(t.periodFlags&FLAG_INACTIVE)?1:2;}
function setPeriod(value){$scope.period=value;$scope.tour={};switch(value.id){case'alltime':$scope.sorts=$scope.SORTS.all;$scope.currentPage=0;requestStatistics();break;case'tournaments':updateTours();setTour($scope.tours[0]);break;case'month_t':case'month_l':$scope.sort='money';setFilter('BR');break;default:setFilter($scope.filter);}}
$scope.clickPeriod=function(value){if(!$scope.busy&&$scope.period!=value)setPeriod(value);}
function setTour(value){$scope.tour=value;$scope.sort=$scope.tour.sortKey;$scope.currentPage=0;requestStatistics();}
$scope.clickTour=function(value){if(!$scope.busy&&$scope.tour!=value)setTour(value);}
function setFilter(value){$scope.sorts=$scope.SORTS[value]||$scope.SORTS.all;if($scope.sorts.indexOf($scope.sort)<0||$scope.sorts!=$scope.SORTS.all&&$scope.sorts!=lastCustomSorts){$scope.sort=$scope.sorts[0];}
if($scope.sorts!=$scope.SORTS.all)
lastCustomSorts=$scope.sorts;$scope.filter=value;$scope.currentPage=0;requestStatistics();}
$scope.clickFilter=function(value){if(!$scope.busy&&$scope.filter!=value)setFilter(value);}
function setSort(value){$scope.sort=value;$scope.currentPage=0;requestStatistics();}
$scope.clickSort=function(value){if(!$scope.busy&&$scope.sort!=value)setSort(value);}
function setMonthly(value){$scope.monthly=value;$scope.currentPage=0;requestStatistics();}
$scope.clickMonthly=function(value){if(!$scope.busy&&$scope.monthly!=value)setMonthly(value);}
$scope.getSkinThumbSrc=function(skin){return'/api/ctor/getskin?name='+encodeURIComponent(skin||'default')+'&thumb=1';}
function requestStatistics(){var moreParams='';var from=$scope.currentPage*$scope.pageSize;var period=$scope.period.id;if(period=='month_t'){moreParams+='&providerId=tibia';}else if(period=='month_l'){moreParams+='&providerId=lol';}
if($scope.period.showMonthly)period=$scope.monthly.id
var path='/api/v3/stat/top'
+'?period='+period
+'&filter='+($scope.tour.id||$scope.filter)
+'&sort='+$scope.sort
+'&from='+from
+'&count='+$scope.pageSize
+moreParams;$scope.busy=true;$http.get(path).success(function(json){$scope.data=json.data;function createRow(ar,place){var obj={place:place};for(var i=0;i<json.keys.length;i++)
obj[json.keys[i]]=ar[i];return obj;}
for(var i=0;i<$scope.data.length;i++){$scope.data[i]=createRow($scope.data[i],i+json.from);}
$scope.playersTotal=json.total;$scope.pagesTotal=Math.ceil($scope.playersTotal/$scope.pageSize);if(json.me){var me=createRow(json.me,json.myIndex);if(me.place>from+$scope.pageSize)
$scope.data.push(me)
else if(me.place<from)
$scope.data.unshift(me);}
$scope.busy=false;}).error(function(json){$scope.data=[];$scope.busy=false;});}
$scope.getTibiaLink=function(tibia){return $sce.trustAsResourceUrl('https://secure.tibia.com/community/?subtopic=characters&name='+encodeURIComponent(tibia));}
$scope.filterName=function(s){return countryNames[s]||i18nFilter('rankings_'+s);}
$scope.$watch(function(){return $scope.currentPage;},function(value){requestStatistics();});});
bombermine.controller('TopbarCtrl',function($scope,$rootScope,$location,i18nFilter,$http,UserService,localize){$scope.is_current_user_exists=function(){return UserService.isLoggedIn()}
$scope.$on('localized',function(event){$scope.currentLocale=localize.locale;});});
bombermine.controller('WikiCtrl',function($scope,$rootScope,$sce,$location,$http,i18nFilter,UserService,$state){var lc=$rootScope.currentLocale;$scope.ulTab=[{name:"menu_faq",route:"wiki."+lc+"faq"},{name:"menu_htp",route:"wiki."+lc+"howToPlay"},{name:"menu_ts",route:"wiki."+lc+"troubleshooting"},{name:"menu_credits",route:"wiki."+lc+"credits"}];$scope.go=function(route){$state.go(route);};$scope.active=function(route){return $state.is(route);};$scope.$on("$stateChangeSuccess",function(){$scope.ulTab.forEach(function(tab){tab.active=$scope.active(tab.route);});$scope.$broadcast('rebuild:scroll');});$scope.$broadcast('rebuild:scroll');});
bombermine.directive('buyPackage',function($rootScope,Social,Payment){return{restrict:'AE',templateUrl:'/tmpl/money/buyPackage.tmpl',scope:{calc:"="},link:function(scope,elem,attrs){var calc;function init(){scope.symbol=Payment.symbol;scope.prices=Payment.prices;if(!calc.currency){calc.currency=["USD"];}}
scope.$watch("calc",function(newValue,oldValue){calc=newValue;init(scope);})}}})
bombermine.directive('buyPluto',function($rootScope,Social,Payment){var prices=Payment.prices;return{restrict:'AE',templateUrl:'/tmpl/money/buyPluto.tmpl',scope:{calc:"="},link:function(scope,elem,attrs){var calc;function init(){scope.plutMin=Payment.plutMin;scope.plutMax=Payment.plutMax;scope.symbol=Payment.symbol;if(!calc.currencies){calc.currencies=["USD"];}
calc.currency=calc.currencies[0];if(!calc.money){calc.money=prices[calc.currency][3];calc.plut=prices['plut'][3];}else{calc.money=''+calc.money;scope.checkMoney();}}
scope.checkMoney=function(){calc.money=checkNumber(calc.money);calc.plut=Payment.toPluto(calc.money,calc.currency);}
scope.checkPlut=function(){calc.plut=checkNumber(calc.plut);calc.money=Payment.toMoney(calc.plut,calc.currency);}
function checkNumber(val){if(typeof val=="number")return val;var res=val.replace(/[^\d]+/g,"");return res;}
scope.$watch("calc",function(newValue,oldValue){calc=newValue;init(scope);})}}})
bombermine.controller('BuyChests',function($scope,$rootScope){$scope.visible=false;$rootScope.showBuyChests=function(){$scope.visible=true;}
$scope.modalClose=function(){$scope.visible=false;}});
bombermine.controller('BuyPlut',function($scope,$rootScope){$scope.visible=false;$rootScope.showBuyPlut=function(){$scope.visible=true;}
$scope.modalClose=function(){$scope.visible=false;}});
bombermine.controller('BuySlot',function($scope,$rootScope,ShopService,$modalInstance,params){$scope.slots=params.slots||[];$scope.shopmodel=ShopService.getModel();$scope.modalClose=function(){$modalInstance.close();};$scope.getSlotStatus=function(slot){if(!slot.open)return 0;if(!slot.perk)return 1;return 2;}});
bombermine.controller('ChangeEmail',function($scope,$rootScope,$http){function clear(){$scope.forceChange=false
$scope.errors={}
$scope.newEmail=$rootScope.user.email
$scope.processing=false
$scope.msgErr={'text':null,'style':'txt-green'}}
$scope.checkEmail=function(email){var pattern=/^([a-z0-9_\.-])+@[a-z0-9-]+\.([a-z]{2,4}\.)?[a-z]{2,4}$/i;if(email=="")return"email_must_not_be_empty";if(!pattern.test(email))return"incorrect_email";return'ok';}
clear();$scope.msgErr={'text':null,'style':'txt-green'}
$scope.changeEmail=function(){$scope.msgErr={text:"server_processing",style:"txt-green"}
$scope.processing=true
var postData={newEmail:$scope.newEmail}
$http.post("/api/v3/changeEmail",postData).success(function(data){$scope.processing=false
$scope.modalClose();$rootScope.user.email=$scope.newEmail;$rootScope.messageBox(data,["ok"],function(result){});}).error(function(errors,status){$scope.processing=false
$scope.msgErr.style="txt-red";if(status==0){$scope.msgErr.text='server_no_connection';$scope.forceChange=false;}
else if(status>=500){$scope.msgErr.text='server_error';$scope.forceChange=false;}
else
$scope.msgErr.text=errors;})}
$scope.clickOk=function(){var err=Utils.validateEmail($scope.newEmail)
if(err){$scope.msgErr.text=err;$scope.msgErr.style='txt-red';}
else{$scope.changeEmail();}}});
bombermine.controller('ChangeNickname',function($scope,$rootScope,$modalInstance,$http,localize,$location){$scope.clear=function(){$scope.msgErr={'text':null,'style':"txt-green"}
$scope.newNickname='';}
$scope.clear();$scope.newUser=$scope.user.nickname.indexOf("~")>=0;$scope.pay=$rootScope.canChangeNickname()=="pay"?$rootScope.shopmodel.utils.changeNick:0;$scope.newNickname=$scope.user.nickname.replace("~","");$scope.modalClose=function(){$modalInstance.close();if($scope.newUser){$location.path("/servers/initVk")}
$scope.clear()}
function changeNickname(){$scope.msgErr={text:"server_processing",style:"txt-green"}
$scope.processing=true
var postData={newNickname:$scope.newNickname,pay:$scope.pay}
$http.post("/api/v3/changeNickname",postData).success(function(data){$scope.processing=false
$scope.modalClose()
$rootScope.user.nickname=$rootScope.user.username=data.username
$rootScope.user.when_update_username=data.when_update_username
$rootScope.user.plutonium=data.plutonium
$rootScope.user.gold=data.gold
if(!$scope.newUser)
$rootScope.messageBox("Nickname changed to '"+data.username+"'",["ok"],function(result){})}).error(function(errors,status){$scope.processing=false;if($scope.newUser&&(errors=="nickname_denied"||status>=500)){$scope.modalClose();$rootScope.messageBox(localize.getString("nickname_cant_update_now"),["ok"],function(result){})
return}
$scope.msgErr.style="txt-red";if(status>=500)
$scope.msgErr.text='server_error';else
$scope.msgErr.text=errors;})}
$scope.clickOk=function(){var err=checkNickname($scope.newNickname)
if(err!='ok'){$scope.msgErr.text=err;$scope.msgErr.style='txt-red';}
else{if($scope.newUser&&$scope.newNickname==$rootScope.user.nickname.replace("~","")){$rootScope.messageBox($scope.newNickname+"? "+localize.getString("are_you_sure"),["ok","cancel"],function(result){if(result==0){changeNickname();}});}else
changeNickname();}}
function checkNickname(nick){var r=/[^a-zA-Z0-9_]/g;if(!nick)
return'nickname_must_not_be_empty';if(r.test(nick))
return'incorrect_nickname';if(nick.length<3)
return'nickname_length_must_be_longer_then_3';if(nick.length>20)
return'nickname_length_must_not_be_longer_then_20'
else
return'ok';}});
bombermine.controller('ChangePassword',function($scope,$rootScope,$http){function clear(){$scope.dontAskOld=false;$scope.forceChange=false
$scope.isOldPasswordWrong=false
$scope.errors={}
$scope.newPassword=""
$scope.newPassword2=""
$scope.oldPassword=""
$scope.processing=false
$scope.msgErr={'text':null,'style':'txt-green'}}
clear();$scope.msgErr={'text':null,'style':'txt-green'}
$scope.checkNewPass=function(pass){if(pass.length<5)
return'password_length_must_be_greather_5';if(pass.length>20)
return'password_length_must_be_shorter_20 characters';else
return'ok';}
$scope.checkPass=function(newPass,newPass2,oldPass){if($scope.checkNewPass(newPass)!='ok')
return $scope.checkNewPass(newPass);else if(newPass!=newPass2)
return'passwords_do_not_match';else if(oldPass==''&&!$scope.dontAskOld)
return'old_password_is_empty';else
return'ok';}
$scope.changePassword=function(){$scope.msgErr={text:"server_processing",style:"txt-green"}
$scope.processing=true
var postData={newPassword:$scope.newPassword,oldPassword:$scope.oldPassword}
$http.post("/api/v3/changePassword",postData).success(function(data){$scope.processing=false
$scope.modalClose();$rootScope.user.pwdStatus="changed";$rootScope.messageBox("password_changed",["ok"],function(result){});}).error(function(errors,status){$scope.processing=false
$scope.msgErr.style="txt-red";if(status==0){$scope.msgErr.text='server_no_connection';$scope.forceChange=false;}
else if(status>=500){$scope.msgErr.text='server_error';$scope.forceChange=false;}
else
$scope.msgErr.text=errors.newPassword||errors.oldPassword;})}
$scope.clickOk=function(){var err=$scope.checkPass($scope.newPassword,$scope.newPassword2,$scope.oldPassword)
if(err!='ok'){$scope.msgErr.text=err;$scope.msgErr.style='txt-red';}
else{$scope.changePassword();}}
var user=$rootScope.user;$scope.dontAskOld=!user.pwd_status;if(user.providerId=="recover"&&user.pwd_status=='recovering'||user.identities.filter(function(x){return x!="tibia"}).length==0){$scope.visible=true;$scope.forceChange=true;$scope.dontAskOld=true;}});
bombermine.controller('CloseModal',function($scope,$rootScope,$modalInstance){$scope.modalClose=function(){$modalInstance.close();};});
bombermine.controller('LoginInGame',function($scope,$rootScope,$modalInstance){$scope.modalClose=function(){$modalInstance.close();}
$scope.logout=function(){$scope.modalClose();location.href="/logout?auth="+(config.auth||"b");}});
bombermine.controller('MessageBox',function($scope,$rootScope,$modalInstance,params){var default_buttons={"ok":{text:"ok",style:"buy_border"},"cancel":{text:"cancel",style:""}}
$scope.params=params;var buttons=params.buttons;for(var i=0;i<buttons.length;i++)
if(typeof buttons[i]=='string'){if(!default_buttons.hasOwnProperty(buttons[i]))
throw"bad button code"
var btn0=default_buttons[buttons[i]];var btn=buttons[i]={};for(var key in btn0)
if(btn0.hasOwnProperty(key))
btn[key]=btn0[key];}
for(var i=0;i<buttons.length;i++)
buttons[i].result=buttons[i].result||i;$scope.clickButton=function(button){$modalInstance.close(button.result);}});
bombermine.controller('PublishScreenshot',function($scope,$rootScope,$http){$scope.visible=false;$scope.img='';$scope.closePostSlide=function(){console.log('close');$scope.visible=false;}
$rootScope.postSlide=function(i){var arrImg=localStorage.img?JSON.parse(localStorage.img):[];$scope.img=arrImg[i];$scope.visible=true;}});
bombermine.controller('RegisterModal',function($scope,$rootScope,Social,$modalInstance){$scope.modalClose=function(){$modalInstance.close();}
$scope.$on("register",$scope.modalClose);});
bombermine.controller('SellingBox',function($scope,$rootScope,ShopService,i18nFilter,$modalInstance,params){$scope.disableButton=false;$scope.item=params.item;$scope.curr=params.curr;$scope.hud=params.hud;$scope.cb=params.cb;$scope.init=function(item,curr,hud,cb){if(params.error){$scope.disableButton=true;$scope.showError(params.error);return;}
$scope.disableButton=false;$scope.notification=null;if(hud instanceof Function)
$scope.cb=hud;else{$scope.cb=cb;$scope.hud=hud;}
$scope.itemType=item.type;$scope.curr=curr;console.log('item',item);switch($scope.itemType){case('chests'):case('timeperks'):case('slots'):$scope.type='perk';break;case('skin_pack'):$scope.type='skinpack';break;default:$scope.type='skin';}
$scope.item=item;}
$scope.close=function(){$modalInstance.close();};$scope.showError=function(err){$scope.errorModal(err);$scope.errMod=true;};$scope.buyIt=function(currency){$scope.disableButton=true;ShopService.buyItemSrv($scope.item,currency,$scope.hud,function(err,data){$scope.errMod=false;if(err){$scope.showError(err);}else{$scope.setNotification(data.notification);$scope.cb&&$scope.cb(data);}});};$scope.setNotification=function(value){$scope.notification=value;};$scope.errorModal=function(err){var title=i18nFilter("error");if((err=="not_enough_gold")||(err=="not_enough_plutonium")){title="no_money";}
$scope.setNotification({title:title,text:i18nFilter(err),type:"error"});};$rootScope.showBuyItemModal=$scope.showBuyItemModal;$scope.transformNotificationPerk=function(arr){var arrName=[];if(!arr)return arrName;for(var i=0;i<arr.length;i++){var index=find(arrName,arr[i]['name']);if(index==-1){arrName.push({'name':arr[i]['name'],'number':1})}
else{arrName[index]['number']+=1;}};return arrName;};function find(array,value){for(var i=0;i<array.length;i++){if(array[i]['name']==value)return i;}
return-1;};$scope.init($scope.item,$scope.curr,$scope.hud,$scope.cb);});
bombermine.controller('ShowChangeButtons',function($scope,$rootScope,storage,actions,gamepad,$modalInstance){function selectGp(gamepadId){var profile=gamepad.codeProfiles[gamepadId];if(profile&&$scope.gp!=profile){$scope.gp=profile;$scope.$apply(function(){$scope.sync();});}}
function gamepadKeyDown(buttonCode,gamepadId){selectGp(gamepadId);};function gamepadKeyUp(buttonCode,gamepadId){selectGp(gamepadId);var name=$scope.selectBut;if(actions.list.indexOf(name)<0)return;$scope.gp.bind($scope.selectBut,buttonCode);$scope.$apply(function(){$scope.sync();});};$scope.init=function(){gamepad.on('keydown',gamepadKeyDown);gamepad.on('keyup',gamepadKeyUp);};$scope.init();$scope.modalClose=function(){gamepad.removeListener('keydown',gamepadKeyDown);gamepad.removeListener('keyup',gamepadKeyUp);$modalInstance.close();};$scope.sync=function(){for(var i=0;i<$scope.listButtons.length;i++){var b=$scope.listButtons[i];b.value=actions.getKeyName(actions.inputs.kb.keyMap[b.name]);b.old_value=actions.getButtonName(actions.inputs.gp.keyMap[b.name]);}};$scope.init=function(){$scope.listButtons=actions.list.map(function(x){return{name:x}});$scope.gp=actions.inputs.gp;$scope.sync();$scope.selectBut='';};$scope.init();$scope.select=function(e,name){var name=name||"";$scope.selectBut=name;$(e.target).find('input').focus();};$scope.down=function(e){var code=e.keyCode?e.keyCode:e.which;if(code==9)e.preventDefault();};$scope.change=function(e){var code=e.keyCode?e.keyCode:e.which;var name=$scope.selectBut;if(actions.defs.kb0.actionMap[code])return;if(actions.list.indexOf(name)<0)return;actions.inputs.kb.bind($scope.selectBut,code);$scope.sync();};$scope.save=function(){actions.saveSettings();$scope.modalClose();};$scope.cancel=function(){actions.loadSettings();$scope.modalClose();};$scope.backKB=function(){actions.inputs.kb.loadKeyMap(actions.defs.kb1.keyMap);$scope.sync();};$scope.backGP=function(){actions.inputs.gp.loadKeyMap(actions.defs.gp.keyMap);$scope.sync();};});
bombermine.controller('ShowRooms',function($scope,$rootScope,$modalInstance,params){$scope.params=params;$scope.doFilter=$scope.params.doFilter||false;$scope.trackRoomKey=$scope.params.trackRoomKey||false;$scope.filter=function(roomType){return!$scope.doFilter||roomType=="hardcore"||roomType=="sandbox"||roomType=="pvm";}
$scope.modalClose=function(){$modalInstance.close();};});
bombermine.controller('iframeLightBox',function($scope,$rootScope,$sce){$scope.visible=false;$rootScope.iframeLightBox=function(link,w,h){$scope.visible=true;$scope.link=$sce.trustAsResourceUrl(link);$scope.w=w;$scope.h=$(window).height()-100;}
$scope.modalClose=function(){$scope.visible=false;}});
bombermine.controller('BonusCtrl',function($http,$scope,$rootScope,i18nFilter,UserService){var byName={}
function updateBonuses(){$scope.achievements=[]
var a=$scope.achievements;(function(){var b=$rootScope.config.achievements;for(var i=0;i<b.length;i++){a.push({name:b[i].name,list:b[i].list})}})();byName={};for(var i=0;i<a.length;i++){byName[a[i].name]=a[i]
a[i].level=a[i].next_grade=a[i].progress=0;a[i].max=false;if(a[i].name=="days"){a[i].minutes=a[i].list[0].limit/60;}}
$http.get('/api/v3/bonuses/progress').success(function(data){$rootScope.progress=data;for(var i=0;i<data.bonuses.length;i++){var record=data.bonuses[i];var b=byName[record.bonus_type];if(!b)continue;b.level=record.bonus_level
b.progress=record.progress
b.max=b.level==b.list.length
b.next_grade=!b.max?b.list[b.level].limit-b.progress:0;if(record.bonus_type=="days"){b.max=false;if(record.date==data.today){b.max=true;b.minutes=0;}
else if(record.date==data.yesterday){b.minutes=b.progress/60|0;if(b.level==b.list.length)
b.level=0;}
else{b.level=0;b.minutes=0;}
if(!b.max)
b.minutes=b.list[b.level].limit/60-b.minutes;}}})}
updateBonuses()
$scope.achievementClick=function(name,level){if(($rootScope.user.perm_mask&4)==0)return;$rootScope.messageBox("Set bonus '"+name+"' to level "+level+"?",["ok",{text:"reset",style:""},"cancel"],function(result){if(result==2)return;var lvl=(result==1)?0:+level;$http.post('/api/v3/bonuses/set-bonus-level',{name:name,level:lvl}).success(function(data){byName[name].level=lvl;byName[name].progress=lvl==0?0:byName[name].list[lvl-1].limit;}).error(function(err){})});}});
bombermine.controller('ConstructorCtrl',function($http,$scope,$rootScope,$location,i18nFilter,Game,skinModel){_gaq.push(['_setCustomVar',1,'user_load_constructor',$scope.user.id,1]);var selectedSlotColor="#70d2fc";var slotColor="rgba(0, 0, 0, 0)";var baseDir="/ctor/";var scale;function adjustPreviewSize(){if($(window).height()>=650){var skinCanvas=document.getElementById("skinCanvas");var previewCanvas=document.getElementById("preview");$scope.skinCanvasWidthAdd=skinCanvas.width;$scope.skinCanvasHeightAdd=110;$scope.sizeClass="'double-size'";scale=2;previewCanvas.width-=skinCanvas.width;previewCanvas.height+=skinCanvas.height+10;skinCanvas.width*=2;skinCanvas.height*=2;}else{$scope.skinCanvasHeightAdd=$scope.skinCanvasWidthAdd=0;$scope.sizeClass="";scale=1;}}
$scope.costIsZero=function(cost){return undef(cost)||Costs.isZero(cost);}
function serverGetOwned(onLoad){$http.get('/api/ctor/owned_all').success(function(data){itemsOwned=data.items;colorsOwned=data.colors;skinModel.setCtorConfigs(data.configs);skinModel.dirty=true;$scope.ctor.blocked=false;onLoad();});}
function createColorPicker(){Utils.whenExist("pickerInput",function(inp){var pickerOptions={pickerPosition:'top',pickerFaceColor:'#F3F3F3',pickerInsetColor:'black',pickerBorderColor:0,pickerBorder:1};picker=new jscolor.color(inp,pickerOptions);pickerInterval=setInterval($scope.pickColor,50);});}
$scope.colorValueToThumbStyle=function(value){return{"background-color":intColorToHtml(value)};}
$scope.getName=function(item){var lang=$scope.currentLocale;if(undef(item.name))
return"";if(def(item.name[lang]))
return item.name[lang];if(def(item.name["en"]))
return item.name["en"];return"";}
function showSkin(result){Utils.whenExist("skinCanvas",function(c){var skin=result.skin;var canvas=result.canvas;var ctx=c.getContext("2d");ctx.clearRect(0,0,c.width,c.height);if(!canvas){alert(i18nFilter("c_error_images"));_gaq.push(['_trackEvent','Character','error_skin','errorSkin'+skin]);return;}
skin.name="editor";sprites.addSpriteWithCanvas(canvas,skin);skin=skin.skin;var dx,dy;function updateSize(w,h){if(c.width<w)
c.width=w;if(c.height<h)
c.height=h;dx=(c.width-w)>>1;dy=(c.height-h)>>1;}
var sw=skin.frameWidth;var sh=skin.frameHeight;var cw=Math.max(skinConfig.type.editor.previewFrameSize.x,sw);var ch=Math.max(skinConfig.type.editor.previewFrameSize.y,sh);var cwa=Math.max(skinConfig.type.editor.previewFrameSize.x-sw,0);var cha=Math.max(skinConfig.type.editor.previewFrameSize.y-sh,0);updateSize(2*scale*cw,2*scale*ch);var dw=def(skin.colStand)?skin.colStand*sw:0;ctx.imageSmoothingEnabled=false;ctx.webkitImageSmoothingEnabled=false;ctx.mozImageSmoothingEnabled=false;ctx.drawImage(canvas,dw,2*sh,sw,sh,((3*cwa)>>1)+scale*sw+dx,(cha>>1)+dy,scale*sw,scale*sh);ctx.drawImage(canvas,dw,0,sw,sh,((3*cwa)>>1)+scale*sw+dx,((3*cha)>>1)+scale*sh+dy,scale*sw,scale*sh);ctx.drawImage(canvas,dw,1*sh,sw,sh,(cwa>>1)+dx,(cha>>1)+dy,scale*sw,scale*sh);ctx.drawImage(canvas,dw,3*sh,sw,sh,(cwa>>1)+dx,((3*cha)>>1)+scale*sh+dy,scale*sw,scale*sh);_gaq.push(['_trackEvent','Character','show_skin','show skin on canvas'+skin]);});}
function userMoney(){return Costs.create($scope.user.gold,$scope.user.plutonium);}
function calcDiscount(){return skinTypes.getInitialDiscount(skinConfig.typeKey,findConfig()!=null,$scope.user.rank);}
function updateScopeCost(){$scope.ctor.costItemSlots=[];$scope.ctor.costColorSlots=[];$scope.ctor.costItems=Costs.zero();for(var i=0;i<$scope.features.length;i++){var slot=$scope.features[i];if(!slot.isEnabled())
continue;var selectedCost=slot.getSelectedItem().cost;Costs.add($scope.ctor.costItems,selectedCost);if(!Costs.isZero(selectedCost))
$scope.ctor.costItemSlots.push(slot);}
$scope.ctor.costColors=Costs.zero();for(var i=0;i<$scope.colors.length;i++){Costs.add($scope.ctor.costColors,$scope.colors[i].cost);if(!Costs.isFree($scope.colors[i]))
$scope.ctor.costColorSlots.push($scope.colors[i]);}
$scope.ctor.discount=calcDiscount();$scope.ctor.cost=Costs.zero();Costs.add($scope.ctor.cost,$scope.ctor.costColors);Costs.add($scope.ctor.cost,$scope.ctor.costItems);Costs.applyDiscount($scope.ctor.cost,$scope.ctor.discount);_gaq.push(['_trackEvent','Character','price_updated','Price Updated']);}
function noSkin(){return $scope.ctor.noColors||$scope.ctor.noItems;}
function updateBtnVisibility(){if(skinConfig.changed)
$scope.ctor.buyBtnVisible=true;if(skinConfig.serialize()==$scope.user.skin)
$scope.ctor.buyBtnVisible=false;}
function afterChange(){if(noSkin())return;updateScopeCost();updateBtnVisibility();var obj={name:skinConfig.serialize()};console.log("Skin name: "+obj.name);skinBuilder.build(obj,showSkin);_gaq.push(['_trackEvent','Character','update_skin','After skinConfig.updateSkin();']);}
function createEditorItems(){var tkey=skinConfig.typeKey;$scope.features=[];var list=skinConfig.type.editor.features;for(var i=0;i<list.length;i++){var fkey=list[i];var featureId=new ItemId(tkey,fkey);var items=skinThumbs.genAllThumbs(new ItemId(tkey,fkey));for(var j=items.length-1;j>=0;j--){for(var k=0;k<itemsOwned.length;k++){if(ItemId.equals(items[j].id,itemsOwned[k])){items[j].cost=Costs.zero();break;}}
if(items[j].cost.plut>9000&&($scope.user.perm_mask&4)==0)
items.splice(j,1);}
for(var j=0;j<items.length;j++){items[j].sortKey=Costs.isFree(items[j])?j:items[j].item["new"]?j+1000:j+2000;}
items.sort(function(a,b){return a.sortKey-b.sortKey;});var slot={key:fkey,name:$scope.getName(skinTypes.getFeature(featureId)),optional:skinConfig.isItemOptional(fkey),size:skinConfig.getThumbSize(fkey),items:items,selectedInd:null,isEnabled:function(){return this.selectedInd>=0;},getSelectedItem:function(){return this.items[this.selectedInd];}};$scope.features.push(slot);}
buildThumbs();}
function createEditorColors(){var tkey=skinConfig.typeKey;$scope.colors=[];var list=skinConfig.type.editor.colors;for(var i=0;i<list.length;i++){var ckey=list[i];var colorSlotId=new ColorId(tkey,ckey);var color=skinTypes.getColor(colorSlotId);var boughtIds=filterByProp(colorsOwned,colorSlotId);var unlockCost=skinTypes.colorUnlockCost(tkey,ckey,boughtIds);spliceByProp(boughtIds,{value:DUMMY_COLOR});function createGroup(i18key,values){return{name:i18nFilter(i18key),cost:Costs.zero(),values:values||[],commonCost:false};}
var gropFree=createGroup("c_colors_free_purchased",arrayOfElemtntsProp(boughtIds,"value"));var gropItems=createGroup("c_colors_items",arrayOfElemtntsProp(skinConfig.enumCurItemColorIds(ckey),"value"));var gropCommon=createGroup("c_colors_common");var gropRare=createGroup("c_colors_rare");var gropsCommon=[];var gropsRare=[];var gropsNamed=[];var avilGroups=skinTypes.enumAvailColorGroups(tkey,ckey,boughtIds);var rareCost=color.rareColorCost;for(var j=0;j<avilGroups.length;j++){var group=avilGroups[j];if(def(group.name)){group.name=$scope.getName(group);gropsNamed.push(group);}else if(Costs.isFree(group)){gropFree.values=gropFree.values.concat(group.values);}else if(Costs.orderLess(group.cost,rareCost)){gropsCommon.push(group);}else{gropsRare.push(group);}}
function addGruops(titleGroup,subGroups){if(subGroups.length==0)
return;var allEquals=true;for(var i=1;i<subGroups.length;i++)
allEquals=allEquals&&Costs.equals(subGroups[i].cost,subGroups[i-1].cost);if(allEquals){for(var i=1;i<subGroups.length;i++)
subGroups[0].values=subGroups[0].values.concat(subGroups[i].values);subGroups=[subGroups[0]];subGroups[0].commonCost=true;titleGroup.commonCost=true;titleGroup.cost=subGroups[0].cost;}
groups.push(titleGroup);groups=groups.concat(subGroups);}
var groups=[];if(gropFree.values.length)
groups.push(gropFree);if(gropItems.values.length)
groups.push(gropItems);groups=groups.concat(gropsNamed);addGruops(gropCommon,gropsCommon);addGruops(gropRare,gropsRare);var slot={id:new ColorId(tkey,ckey,-1),name:$scope.getName(color),optional:skinConfig.isColorOptional(ckey),customCost:color.customCost,cost:null,baseUnlockCost:unlockCost,unlockCost:null,style:null,availGroups:groups,isEnabled:function(){return this.id.value>=0;}};$scope.colors.push(slot);}}
function itemSlotStyle(slot,index){return{"border-color":index==slot.selectedInd?selectedSlotColor:slotColor};}
function updateEditorItems(){$scope.ctor.noItems=false;var curItems=skinConfig.getCurItemIds();for(var i=0;i<$scope.features.length;i++){var slot=$scope.features[i];var featureId=new ItemId(skinConfig.typeKey,slot.key);if(skinConfig.getItemEnabled(slot.key)){var id=elementByProp(curItems,featureId);slot.selectedInd=indexByProp(slot.items,{"id":id});}else{slot.selectedInd=-1;}
if(slot.selectedInd<0&&!slot.optional)
$scope.ctor.noItems=true;for(var j=0;j<slot.items.length;j++)
slot.items[j].style=itemSlotStyle(slot,j);slot.emptyStyle=itemSlotStyle(slot,-1);}
_gaq.push(['_trackEvent','Character','update_items','updateEditorItems() fired']);}
function updateEditorColors(chanceAllowCustom){chanceAllowCustom=default_(chanceAllowCustom,1);function findSomeColor(groups){var n=0;for(var i=0;i<groups.length;i++)
n+=groups[i].values.length;n=randomInt(n);for(var i=0;i<groups.length;i++){var v=groups[i].values;if(n<v.length)
return v[n];n-=v.length;}}
for(var i=0;i<$scope.colors.length;i++){var slot=$scope.colors[i];if(!skinConfig.isColorSlotEnabled(slot.id.key)){Costs.attach(slot);continue;}
if(skinConfig.isColorSlotEnabled(slot.id.key)&&!skinConfig.isColorOptional(slot.id.key)&&!skinConfig.isColorEnabled(slot.id.key))
{skinConfig.setColorValue(slot.id.key,SkinTypes.selectCheapestColorFromPresets(slot.availGroups));}
if(skinConfig.isColorEnabled(slot.id.key)){slot.id.value=skinConfig.getColorValue(slot.id.key);try{slot.cost=SkinTypes.calcColorCost(slot.id.value,slot.availGroups,null);}catch(e){if(!Costs.isZero(slot.customCost)&&Math.random()<chanceAllowCustom){slot.cost=slot.customCost;}else{slot.id.value=findSomeColor(slot.availGroups);slot.cost=SkinTypes.calcColorCost(slot.id.value,slot.availGroups,null);}}}else{slot.id.value=-1;slot.cost=Costs.zero();}
slot.unlockCost=indexByProp(skinConfig.enumCurItemColorIds(slot.id.key),slot.id)>=0?Costs.zero():slot.baseUnlockCost;if(slot.id.value>=0){Costs.attach(slot);Costs.add(slot.cost,slot.unlockCost);slot.style=$scope.colorValueToThumbStyle(slot.id.value);}}
_gaq.push(['_trackEvent','Character','update_colors','updateEditorColors() fired']);}
function updateSkinItems(){for(var i=0;i<$scope.features.length;i++){var slot=$scope.features[i];if(slot.isEnabled()){skinConfig.setItemUpdateColors(slot.getSelectedItem().id,colorsOwned);}else
skinConfig.clearItemUpdateColors(slot.key,colorsOwned);}
_gaq.push(['_trackEvent','Character','update_skin_items','updateSkinItems() fired']);}
function updateSkinColors(){for(var i=0;i<$scope.colors.length;i++){var slot=$scope.colors[i];if(!skinConfig.isColorSlotEnabled(slot.id.key))
continue;skinConfig.setColorEnabled(slot.id.key,slot.isEnabled());if(slot.isEnabled())
skinConfig.setColorValue(slot.id.key,slot.id.value);}
for(var i=0;i<$scope.features.length;i++){var feature=$scope.features[i];feature.colorSlots=[];if(feature.isEnabled()){var item=skinTypes.getItem(feature.getSelectedItem().id);for(var j=0;j<$scope.colors.length;j++){var colorSlot=$scope.colors[j];if(item.colorSlots.indexOf(colorSlot.id.key)>=0)
feature.colorSlots.push(colorSlot);}}}}
function syncItemsChange(){updateSkinItems();updateEditorItems();createEditorColors();updateEditorColors();updateSkinColors();afterChange();}
function syncColorsChange(){updateSkinColors();updateEditorColors();afterChange();}
function syncSkinChange(chanceAllowCustom){createEditorItems();updateEditorItems();updateSkinItems();createEditorColors();updateEditorColors(chanceAllowCustom);updateSkinColors();afterChange();}
$scope.flipItem=function(outerInd){if(noSkin())return;skinConfig.flip($scope.features[outerInd].key);afterChange();}
$scope.thumbClick=function(outerInd,innerInd){if(noSkin())return;var slot=$scope.features[outerInd];slot.selectedInd=innerInd;syncItemsChange();}
$scope.colorSlotClick=function(outerInd,innerInd){var sh=$scope.colorsShop;sh.slot=$scope.features[outerInd].colorSlots[innerInd];sh.items=sh.slot.availGroups;createColorPicker(innerInd);setTimeout(function(){if(sh.slot.id.value>0&&def(picker)){var rgb=intToRGB(sh.slot.id.value)
picker.fromRGB(rgb.r/255,rgb.g/255,rgb.b/255);}},0);sh.visible=true;}
function afterColorShop(value){var slot=$scope.colorsShop.slot;if(slot.id.value==value)return false;slot.id.value=value;syncColorsChange();return true;}
$scope.colorShopClick=function(outerInd,ind){afterColorShop($scope.colorsShop.items[outerInd].values[ind]);}
$scope.colorCustomClick=function(){var slot=$scope.colorsShop.slot;var v=floatRGBtoInt(picker.rgb[0],picker.rgb[1],picker.rgb[2]);v=skinTypes.killColorBits(skinConfig.typeKey,slot.id.key,v);afterColorShop(v);}
$scope.shopNoColorClick=function(outerInd,ind){afterColorShop(-1);}
$scope.shopCancel=function(){$scope.colorsShop.visible=false;clearInterval(pickerInterval);}
function findConfig(){if(skinModel.ownsCtorSkin){for(var i=0;i<skinModel.ctorConfigs.length;i++){if(skinModel.ctorConfigs[i].type==skinConfig.typeKey)
return skinModel.ctorConfigs[i];}}
return null;}
$scope.buyClick=function(){var req={code:skinConfig.serialize(),cost:$scope.ctor.cost}
try{var appraisal=skinConfig.apprise(itemsOwned,colorsOwned,$scope.ctor.discount);}catch(e){alert("Error (apprise)");return;}
if(!Costs.equals(appraisal.cost,req.cost)){alert("Error");return;}
if(req.cost.plut>0&&$rootScope.cantBuyAskRegister())return;$scope.ctor.blocked=true;$http.post('/api/ctor/set_or_buy',req).success(function(data){code=data.result;console.log('set_or_buy success '+code);switch(code){case CtorBuyResult.SUCCES:$scope.ctor.buyBtnVisible=false;$scope.user.gold-=req.cost.gold;$scope.user.plutonium-=req.cost.plut;$scope.user.skin=req.code;if(appraisal.items.length+appraisal.colors.length>0){serverGetOwned(syncSkinChange);$rootScope.messageBox("c_skin_purchased",["ok"],function(){});}else{var conf=findConfig();if(conf!=null){conf.skin_code=req.code;}else{skinModel.ctorConfigs.push({type:skinConfig.typeKey,skin_code:req.code});}
$scope.ctor.blocked=false;}
skinModel.dirty=true;Game.appInputRejoin();break;case CtorBuyResult.NOGOLD:$rootScope.showNotEnoughMoney('gold',function(){$scope.ctor.blocked=false;});break;case CtorBuyResult.NOPLUT:$rootScope.showNotEnoughMoney('plut',function(){$scope.ctor.blocked=false;});break;case CtorBuyResult.ERROR:$scope.ctor.blocked=false;alert(i18nFilter("c_server_error"));break;}}).error(function(){$scope.ctor.blocked=false;console.log('set_or_buy error');alert(i18nFilter("c_server_error2"));});}
$scope.changeSkinType=function(tkey){$scope.selectTabSlot=0;if(tkey=="randomize"){skinConfig.setRandomFeatures("same");skinConfig.setRandomColors();syncSkinChange(0.1);}else{skinConfig.setType(tkey);var conf=findConfig();var doInitailRandom=false;if(conf!=null){try{skinConfig.deserialize(conf.skin_code);syncSkinChange();}catch(e){doInitailRandom=true;}}else
doInitailRandom=true;if(doInitailRandom){skinConfig.setRandomFeatures("same",null,true);skinConfig.setRandomColors(null,true);skinConfig.makeItemsAffordable(userMoney(),itemsOwned,colorsOwned,calcDiscount());syncSkinChange(0);}}
_gaq.push(['_trackEvent','Character','change_type','changeSkinType on done']);}
function onLoadOwned(){if(tryUseProposedSkin())
return;var ind=indexByProp(skinModel.ctorConfigs,{skin_code:$scope.user.skin});if(ind<0&&skinModel.ownsCtorSkin)ind=0;if(ind>=0){try{skinConfig.deserialize(skinModel.ctorConfigs[Math.max(ind,0)].skin_code);syncSkinChange();}catch(e){$scope.changeSkinType("?");}}else
$scope.changeSkinType("?");}
$scope.ctor={isExpert:false,blocked:true,noColors:false,noItems:false,buyBtnVisible:true,buyBtnStyle:{}};$scope.colorsShop={visible:false,slot:null};var skinTypes,skinConfig,skinBuilder,skinThumbs,isSkinUpdates;var itemsOwned,colorsOwned;createColorPicker();skinModel.getSkinBuilder(function(sb,cd){skinBuilder=sb;skinTypes=new SkinTypes(cd.json);skinThumbs=new SkinThumbs(skinTypes,sb);skinConfig=new SkinConfig(cd.json);serverGetOwned(onLoadOwned);});function buildThumbs(){var slot=$scope.features[$scope.selectTabSlot];skinThumbs.buildThumbs(slot.items);}
$scope.selectTabSlot=0;$scope.selectTab=function(index){$scope.selectTabSlot=index||0;var slot=$scope.features[$scope.selectTabSlot];buildThumbs();$scope.colorsShop.visible=false;return;}
$scope.pickColor=function(){if($scope.colorsShop.slot&&jscolor.picker&&jscolor.picker.owner){$scope.colorCustomClick();}}
adjustPreviewSize();function tryUseProposedSkin(){var v=$rootScope.proposedSkin;if(v&&"!?".indexOf(v[0])>=0){$scope.changeSkinType(v[1]);$rootScope.proposedSkin=null;return true;}
return false;}
var off_proposedSkin=$rootScope.$watch("proposedSkin",function(){Utils.whenExist(function(){return itemsOwned},function(){Utils.inNextPhase($scope,tryUseProposedSkin);});});$scope.$on("$destroy",function(){off_proposedSkin();clearInterval(pickerInterval);});});
bombermine.directive('gamePreview',function(Game){return{restrict:'A',scope:{selectedSkin:"@gamePreview"},link:function(scope,elem,attrs){if(!Game.previewAttach)return;var canvas=elem[0];Game.previewAttach(canvas);scope.$watch("selectedSkin",function(newVal,oldVal){Game.previewSetSkin(newVal,canvas);});scope.$on('$destroy',function(){Game.previewDetach(canvas);});}}});
bombermine.controller('SettingsCtrl',function($scope,$rootScope,$location,$http,i18nFilter,UserService,$timeout,storage,Sounds){UserService.updateCurrentUser();$scope.disableConfirmButton=false;$scope.emailConfirmed=function(){return $rootScope.user.flags&2;}
$scope.sendConfirmation=function(){if($scope.disableConfirmButton)return;$scope.disableConfirmButton=true;$http.post("/api/v3/user/email/send-confirm",{}).success(function(data){$scope.disableConfirmButton=false;$rootScope.messageBox("email_confirmation_sent",["ok"],function(result){});}).error(function(errors,status){$scope.disableConfirmButton=false;if(status==0)
$rootScope.messageBox("server_no_connection",["ok"],function(result){});else if(status>=500)
$rootScope.messageBox("server_error",["ok"],function(result){});else
$rootScope.messageBox(errors,["ok"],function(result){});})}
$scope.toggleChatRight=function(){$rootScope.chatRight=!$rootScope.chatRight;storage.setItem('chatRight',$rootScope.chatRight);}
$scope.sounds=Sounds;$scope.isMuted=Sounds.isMuted();$scope.getVolume=Sounds.getVolume()*100;$scope.playRandom=Sounds.playRandom;$scope.setMute=function(){$scope.isMuted=!$scope.isMuted;Sounds.setMute($scope.isMuted);}
$scope.changeVolume=function(flag){var self=$scope;if(flag){$scope.getVolume=Math.min(self.getVolume+5,100);}
else{$scope.getVolume=Math.max(self.getVolume-5,0);}
Sounds.setVolume($scope.getVolume);};$scope.styleHUD=+storage.getItem('hudVersion','0');$scope.changeStyleHUD=function(){$scope.styleHUD=$scope.styleHUD?0:1;storage.setItem('hudVersion',$scope.styleHUD);}
$scope.languages=[{type:"en",name:"English"},{type:"ru",name:"Russian"},{type:"jp",name:"Japanese"},{type:"es",name:"Spanish"},{type:"pt-BR",name:"Portugal"},{type:"cz",name:"Czech"}];$scope.curLocale=$rootScope.currentLocale;$scope.changeLanguage=function(type){$scope.curLocale=$rootScope.currentLocale=type;storage.setItem('locale',$scope.curLocale);};})
bombermine.controller('ShopNewPageCtrl',function($http,$scope,$rootScope,i18nFilter,UserService,ShopService){$scope.slotsLimit=$rootScope.user.slots_limit;$scope.isSlotAllowed=function(slotId){if(slotId=='third_slot'){return $scope.slotsLimit==2}else if(slotId=='fourth_slot'){return $scope.slotsLimit==3}else return false}
$scope.perkTime=function(perkName){var user=$rootScope.user;for(var i=0;i<user.perks.length;i++)
if(user.perks[i].name==perkName&&user.perks[i].unit==4)
return user.perks[i].quantity;return 0;}
$scope.activeTab="simple";$scope.ulTab=[{name:"buy_now",active:"simple"==$scope.activeTab,route:"simple"},{name:"basic_shop",active:"basic"==$scope.activeTab,route:"basic"},{name:"advanced_shop",active:"advanced"==$scope.activeTab,route:"advanced"}];$scope.curlevel={"bombs1":0,"power1":1,"money1":2,"scate1":1,"atomic1":2,"atomic2":3,"battle1":2}
$scope.upg={"bombs1":2,"power1":1,"money1":2,"scate1":1,"atomic1":2,"atomic2":3,"battle1":2};$scope.curLevel=function(perk){return $scope.curlevel[perk.name]||0;}
$scope.setCurLevel=function(perk,num){$scope.curlevel[perk.name]=num;}
$scope.isUpgrade=function(perk){return($scope.curlevel[perk.name]>$scope.upg[perk.name]);}
$scope.upgradePrice=function(perk){return perk.levels[$scope.curlevel[perk.name]].upgrade_price;}
$scope.goldPrice=function(perk){return perk.levels[$scope.curlevel[perk.name]].gold_price;}
$scope.plutPrice=function(perk){return perk.levels[$scope.curlevel[perk.name]].price;}
$scope.basicShop=[{"name":"bombs1","type":"timeperks",time:100,levels:[{name:'1',"price":1,"gold_price":1000,"upgrade_price":1},{name:'2',"price":2,"gold_price":2000,"upgrade_price":1},{name:'3',"price":3,"gold_price":3000,"upgrade_price":1}]},{"name":"power1","type":"timeperks",time:1000,levels:[{name:'1',"price":1,"gold_price":1000,"upgrade_price":1},{name:'2',"price":2,"gold_price":2000,"upgrade_price":1},{name:'3',"price":3,"gold_price":4000,"upgrade_price":1}]},{"name":"money1","type":"timeperks",time:60000,levels:[{name:'1',"price":1,"gold_price":1000,"upgrade_price":1},{name:'2',"price":2,"gold_price":2000,"upgrade_price":1},{name:'3',"price":3,"gold_price":3000,"upgrade_price":1}]},{"name":"scate1","type":"timeperks",time:24*600,levels:[{name:'1',"price":1,"gold_price":1000,"upgrade_price":1},{name:'2',"price":2,"gold_price":2000,"upgrade_price":1},{name:'3',"price":3,"gold_price":3000,"upgrade_price":1}]},{"name":"atomic1","type":"timeperks",time:11000,levels:[{name:'1',"price":1,"gold_price":1000,"upgrade_price":1},{name:'2',"price":2,"gold_price":2000,"upgrade_price":1},{name:'3',"price":3,"gold_price":3000,"upgrade_price":1}]},{"name":"atomic2","type":"timeperks",time:1960,levels:[{name:'1',"price":1,"gold_price":1000,"upgrade_price":1},{name:'2',"price":2,"gold_price":2000,"upgrade_price":1},{name:'3',"price":3,"gold_price":3000,"upgrade_price":1},{name:'4',"price":4,"gold_price":4000,"upgrade_price":1}]},{"name":"battle1","type":"timeperks",time:800,levels:[{name:'1',"price":1,"gold_price":1000,"upgrade_price":1},{name:'2',"price":2,"gold_price":2000,"upgrade_price":1},{name:'3',"price":3,"gold_price":3000,"upgrade_price":1}]}];$scope.go=function(route){$scope.activeTab=route;for(var i=0;i<$scope.ulTab.length;i++){if($scope.ulTab[i].route==route){$scope.ulTab[i].active=true;}
else{$scope.ulTab[i].active=false;}}}
$scope.advancedShop=[{name:"advanced boots 1",things:[{"name":"autoshield","price":3,"gold_price":0,"type":"timeperks"},{"name":"autoshield","price":3,"gold_price":0,"type":"timeperks"},{"name":"immune","price":3,"gold_price":0,"type":"timeperks"},{"name":"starter","price":3,"gold_price":0,"type":"timeperks"},{"name":"autojetpack","price":3,"gold_price":0,"type":"timeperks"}]},{name:"advanced boots 2",things:[{"name":"autoshield","price":3,"gold_price":0,"type":"timeperks"},{"name":"premium","price":3,"gold_price":0,"type":"timeperks"},{"name":"immune","price":3,"gold_price":0,"type":"timeperks"},{"name":"autoshield","price":3,"gold_price":0,"type":"timeperks"},{"name":"premium","price":3,"gold_price":0,"type":"timeperks"},{"name":"immune","price":3,"gold_price":0,"type":"timeperks"}]},{name:"advanced boots 3",things:[{"name":"autoshield","price":3,"gold_price":0,"type":"timeperks"},{"name":"premium","price":3,"gold_price":0,"type":"timeperks"},{"name":"immune","price":3,"gold_price":0,"type":"timeperks"},{"name":"starter","price":3,"gold_price":0,"type":"timeperks"},{"name":"autojetpack","price":3,"gold_price":0,"type":"timeperks"},{"name":"autoshield","price":3,"gold_price":0,"type":"timeperks"},{"name":"premium","price":3,"gold_price":0,"type":"timeperks"},{"name":"immune","price":3,"gold_price":0,"type":"timeperks"},]},{name:"advanced boots advanced boots",things:[{"name":"autoshield","price":3,"gold_price":0,"type":"timeperks"},{"name":"autoshield","price":3,"gold_price":0,"type":"timeperks"},{"name":"autoshield","price":3,"gold_price":0,"type":"timeperks"},{"name":"autoshield","price":3,"gold_price":0,"type":"timeperks"},{"name":"autoshield","price":3,"gold_price":0,"type":"timeperks"},{"name":"premium","price":3,"gold_price":0,"type":"timeperks"},{"name":"immune","price":3,"gold_price":0,"type":"timeperks"}]},];$scope.simpleShop=[{"name":"autoshield","type":"timeperks",day:1,"price":5,"gold_price":100000},{"name":"premium","type":"timeperks",day:2,"price":4,"gold_price":90000},{"name":"immune","type":"timeperks",day:3,"price":2,"gold_price":50000},{"name":"starter","type":"timeperks",day:1,"price":12,"gold_price":1500000},{"name":"autojetpack","type":"timeperks",day:9,"price":6,"gold_price":400000},{"name":"premium","type":"timeperks",day:3,"price":4,"gold_price":350000}];$scope.elemSelectSimpleShop=$scope.simpleShop[0];$scope.getNameSimpleShop=function(){return $scope.elemSelectSimpleShop["name"];};$scope.getPriceSimpleShop=function(){return $scope.elemSelectSimpleShop["price"]||0;};$scope.getGoldPriceSimpleShop=function(){return $scope.elemSelectSimpleShop["gold_price"]||0;};$scope.getDaySimpleShop=function(){return $scope.elemSelectSimpleShop["day"]||0;};$scope.selectElemSimpleShop=function(index){var index=index||0;$scope.elemSelectSimpleShop=$scope.simpleShop[index];};});
bombermine.controller('ShopPageCtrl',function($http,$scope,$rootScope,i18nFilter,UserService,ShopService){$scope.slotsLimit=$rootScope.user.slots_limit;$scope.isSlotAllowed=function(slotId){if(slotId=='third_slot'){return $scope.slotsLimit==2}else if(slotId=='fourth_slot'){return $scope.slotsLimit==3}else return false}
$scope.perkTime=function(perkName){var user=$rootScope.user;for(var i=0;i<user.perks.length;i++)
if(user.perks[i].name==perkName&&user.perks[i].unit==4)
return user.perks[i].quantity;return 0;}});
bombermine.controller('SkinsCtrl',function($scope,$rootScope,i18nFilter,$http,Game,$state,skinModel,storage){$scope.skinModel=skinModel;$scope.selectedSkin=skinModel.activeSkin;var collapsed={};try{collapsed=JSON.parse(storage.getItem("collapsedSkinGroups","{}"));}catch(e){}
$scope.$watch(skinModel.getActiveSkin,function(newVal,oldVal){if(!$rootScope.proposedSkin)
$scope.selectSkin(newVal);});var off_proposedSkin=$rootScope.$watch("proposedSkin",function(newVal,oldVal){if(newVal&&"!?".indexOf(newVal[0])<0){var skin=skinModel.byName[newVal];if(skin.shopGroup)
$scope.setCollapsed(skin.shopGroup,false);Utils.inNextPhase($scope,function(){$scope.selectSkin(skin);$rootScope.proposedSkin=null;Utils.whenExist(["skin_outer_"+newVal,"skins_scroll","skins_scroll_base"],function(skinEl,containerEl,baseEl){Utils.whenExist([function(){return Utils.getElementRelativePos(skinEl,containerEl)},function(){return Utils.getElementRelativePos(baseEl,containerEl)}],function(skinPos,basePos){Utils.scroll($scope,containerEl,Math.max(0,skinPos.y-basePos.y-50));});});});}});$scope.editSelectedSkin=function(){skinModel.activateSkin($scope.selectedSkin,function(){$state.go("skins.character");});}
$scope.selectSkin=function(skin){$scope.selectedSkin=skin;console.log("Selected skin name: "+skin.name);}
$scope.buySkinModal=function(item){if($rootScope.cantBuyAskRegister())
return;$rootScope.showBuyItemModal(item,'plut','skins',function(data){console.log('skin is bought',data,$scope.skinModel);var duration=item.duration;var pack=!!item.skins;item=item.skin;item.active=true;skinModel.reload(function(){$scope.activateSkin(item);});});}
$scope.activateSkin=function(item){if($rootScope.user.is_guest&&$rootScope.cantBuyAskRegister())
return;skinModel.activateSkin(item);}
$scope.getSkinStyle=skinModel.getSkinStyle;$scope.getShadowStyle=skinModel.getShadowStyle;$scope.saveOrRemoveSelectedSkin=function(){var doChange=$scope.selectedSkin.saved;skinModel.saveOrRemoveSkin($scope.selectedSkin,function(){if(doChange)
Utils.apply($scope,function(){$scope.selectedSkin=skinModel.activeSkin;});});}
$scope.saveOrRemoveDisabled=function(){return $scope.selectedSkin.saved==-1||($scope.selectedSkin.saved&&skinModel.numberOfSameTypeSkins($scope.selectedSkin)==1);}
$scope.ifNotExpired=function(msg,seconds){return seconds-Date.now()/1000>0?i18nFilter(msg):"";}
$scope.getCollapsed=function(group){return!group.alwaysVisible&&collapsed[group.name];}
$scope.setCollapsed=function(group,v){if(v)
collapsed[group.name]=1;else
delete collapsed[group.name];var list=skinModel.groups.list;for(var key in collapsed){var alive=false;for(var j=0;j<list.length;j++)
alive=alive||list[j].name==key;if(!alive)
delete collapsed[key];}
storage.setItem("collapsedSkinGroups",JSON.stringify(collapsed));}
$scope.flipCollapsed=function(group){$scope.setCollapsed(group,!collapsed[group.name]);}
$scope.$on("$destroy",off_proposedSkin);});
bombermine.controller('SliderCtrl',function($http,$scope,$rootScope,$location,i18nFilter){$scope.sliderPrev=function(index,items){var ul=angular.element("#slider_"+index);slide(ul,true);}
$scope.sliderNext=function(index,items){var ul=angular.element("#slider_"+index)
slide(ul,false);}
function slide(ul,znak){$scope.sizeUl(ul);var wW=ul.parent(".slideUl").width();var w=wW*0.5;var wUl=ul.width();var maxMargin=(-1)*Math.abs(ul.parent(".slideUl").width()-wUl);var prev=ul.parent(".slideUl").parent(".slider").find(".prev_button");var next=ul.parent(".slideUl").parent(".slider").find(".next_button");var sign="-";if(znak)
sign="+";var marginUl=ul[0].style.marginLeft;marginUl=marginUl.substring(0,marginUl.length-2)||0;marginUl=+marginUl+ +(sign+w);var lastLi=ul.children('li').last();$(prev).removeClass("noLink");$(next).removeClass("noLink");if(marginUl<maxMargin){$(next).addClass("noLink");marginUl=maxMargin;}
if(marginUl>0){$(prev).addClass("noLink");marginUl=0;}
if((wUl<wW)||(lastLi[0].innerHTML=="")){marginUl=0;$(prev).addClass("noLink");$(next).addClass("noLink");}
ul[0].style.marginLeft=marginUl+"px";}
$scope.addLi=function(ul,wLi,hLi){var wUl=ul.width();var wSlide=ul.parent('.slideUl').width();var prev=ul.parent(".slideUl").parent(".slider").find(".prev_button");var next=ul.parent(".slideUl").parent(".slider").find(".next_button");if(wUl<wSlide){var d=wSlide-wUl;var n=Math.ceil(d/(wLi+8));for(var i=0;i<n;i++){var li=document.createElement('li');$(li).addClass('thumb');$(li).css({'width':wLi+'px','height':hLi+'px'});ul[0].appendChild(li);}
$(prev).addClass("noLink");$(next).addClass("noLink");}}
$scope.sizeUl=function(ul1){var ul=ul1.children();var w=ul.eq(0).width();var h=ul.eq(0).height();for(var i=1;i<ul.length;i++){if(ul.eq(i).width()>w)
w=ul.eq(i).width();if(ul.eq(i).height()>h)
h=ul.eq(i).height();}
for(var i=0;i<ul.length;i++){var elem=angular.element(ul.eq(i));elem.css({'width':w+'px','height':h+'px'});}
$scope.addLi(ul1,w,h);var color=ul1.parent().parent().prev().children();color.css({'width':w+8+'px','height':h+8+'px'});$scope.addLi(ul1,w,h);}
$scope.changeUl=function(){setTimeout(function(){$scope.sizeUl(angular.element("#slider_0"));$scope.sizeUl(angular.element("#slider_1"));$scope.sizeUl(angular.element("#slider_2"));$scope.sizeUl(angular.element("#slider_3"));},0);}});
bombermine.controller('ResizeController',function($http,$scope,$rootScope,Social,storage){var size_old=JSON.parse(storage.getItem('game_vk_viewport_size','{}'));if(!Social.resizeTo)
size_old={}
$scope.resizeOptions=[{width:1000,height:600},{width:1000,height:700},{width:1000,height:800}];$scope.resizeView=function(size){$scope.setFullscreen(false);if(Social.resizeTo)
Social.resizeTo(size.width,size.height+$rootScope.topBannerHeight);else
window.resizeTo(size.width,size.height+$rootScope.topBannerHeight);size_old.selected=false;size_old=size;size.selected=true;storage.setItem('game_vk_viewport_size',JSON.stringify(size));}
$scope.isFullscreen=function(){if(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement)return true;return false;}
$scope.setFullscreen=function(value){var fs=$scope.isFullscreen();if(fs!=value){if(fs){if(document.cancelFullScreen){document.cancelFullScreen();}else if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else if(document.webkitCancelFullScreen){document.webkitCancelFullScreen();}}else{if(value)
size_old.selected=false;if(document.documentElement.requestFullscreen){document.documentElement.requestFullscreen();}else if(document.documentElement.mozRequestFullScreen){document.documentElement.mozRequestFullScreen();}else if(document.documentElement.webkitRequestFullscreen){document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);}}}}
if(size_old.width&&size_old.height){$scope.resizeOptions.forEach(function(size){if(size_old.width==size.width&&size_old.height==size.height){size_old=size;size.selected=true;}});$scope.resizeView(size_old);}else if(Social.resizeTo){$scope.resizeView($scope.resizeOptions[0]);}});
//@ sourceMappingURL=gob-ui.min.js.map