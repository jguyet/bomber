
var base64={};base64.PADCHAR='=';base64.ALPHA='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';base64.makeDOMException=function(){var e,tmp;try{return new DOMException(DOMException.INVALID_CHARACTER_ERR);}catch(tmp){var ex=new Error("DOM Exception 5");ex.code=ex.number=5;ex.name=ex.description="INVALID_CHARACTER_ERR";ex.toString=function(){return'Error: '+ex.name+': '+ex.message;};return ex;}}
base64.getbyte64=function(s,i){var idx=base64.ALPHA.indexOf(s.charAt(i));if(idx===-1){throw base64.makeDOMException();}
return idx;}
base64.decode=function(s){s=''+s;var getbyte64=base64.getbyte64;var pads,i,b10;var imax=s.length
if(imax===0){return s;}
if(imax%4!==0){throw base64.makeDOMException();}
pads=0
if(s.charAt(imax-1)===base64.PADCHAR){pads=1;if(s.charAt(imax-2)===base64.PADCHAR){pads=2;}
imax-=4;}
var x=[];for(i=0;i<imax;i+=4){b10=(getbyte64(s,i)<<18)|(getbyte64(s,i+1)<<12)|(getbyte64(s,i+2)<<6)|getbyte64(s,i+3);x.push(String.fromCharCode(b10>>16,(b10>>8)&0xff,b10&0xff));}
switch(pads){case 1:b10=(getbyte64(s,i)<<18)|(getbyte64(s,i+1)<<12)|(getbyte64(s,i+2)<<6);x.push(String.fromCharCode(b10>>16,(b10>>8)&0xff));break;case 2:b10=(getbyte64(s,i)<<18)|(getbyte64(s,i+1)<<12);x.push(String.fromCharCode(b10>>16));break;}
return x.join('');}
base64.getbyte=function(s,i){var x=s.charCodeAt(i);if(x>255){throw base64.makeDOMException();}
return x;}
base64.encode=function(s){if(arguments.length!==1){throw new SyntaxError("Not enough arguments");}
var padchar=base64.PADCHAR;var alpha=base64.ALPHA;var getbyte=base64.getbyte;var i,b10;var x=[];s=''+s;var imax=s.length-s.length%3;if(s.length===0){return s;}
for(i=0;i<imax;i+=3){b10=(getbyte(s,i)<<16)|(getbyte(s,i+1)<<8)|getbyte(s,i+2);x.push(alpha.charAt(b10>>18));x.push(alpha.charAt((b10>>12)&0x3F));x.push(alpha.charAt((b10>>6)&0x3f));x.push(alpha.charAt(b10&0x3f));}
switch(s.length-imax){case 1:b10=getbyte(s,i)<<16;x.push(alpha.charAt(b10>>18)+alpha.charAt((b10>>12)&0x3F)+
padchar+padchar);break;case 2:b10=(getbyte(s,i)<<16)|(getbyte(s,i+1)<<8);x.push(alpha.charAt(b10>>18)+alpha.charAt((b10>>12)&0x3F)+
alpha.charAt((b10>>6)&0x3f)+padchar);break;}
return x.join('');}
if(typeof exports!="undefined"){exports.encode=base64.encode;exports.decode=base64.decode;}
(function(view){"use strict";var
Uint8Array=view.Uint8Array,HTMLCanvasElement=view.HTMLCanvasElement,is_base64_regex=/\s*;\s*base64\s*(?:;|$)/i,base64_ranks,decode_base64=function(base64){var
len=base64.length,buffer=new Uint8Array(len/4*3|0),i=0,outptr=0,last=[0,0],state=0,save=0,rank,code,undef;while(len--){code=base64.charCodeAt(i++);rank=base64_ranks[code-43];if(rank!==255&&rank!==undef){last[1]=last[0];last[0]=code;save=(save<<6)|rank;state++;if(state===4){buffer[outptr++]=save>>>16;if(last[1]!==61){buffer[outptr++]=save>>>8;}
if(last[0]!==61){buffer[outptr++]=save;}
state=0;}}}
return buffer.buffer;};if(Uint8Array){base64_ranks=new Uint8Array([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51]);}
if(HTMLCanvasElement&&!HTMLCanvasElement.prototype.toBlob){HTMLCanvasElement.prototype.toBlob=function(callback,type){if(!type){type="image/png";}if(this.mozGetAsFile){callback(this.mozGetAsFile("canvas",type));return;}
var
args=Array.prototype.slice.call(arguments,1),dataURI=this.toDataURL.apply(this,args),header_end=dataURI.indexOf(","),data=dataURI.substring(header_end+1),is_base64=is_base64_regex.test(dataURI.substring(0,header_end)),blob;if(Blob.fake){blob=new Blob
if(is_base64){blob.encoding="base64";}else{blob.encoding="URI";}
blob.data=data;blob.size=data.length;}else if(Uint8Array){if(is_base64){blob=new Blob([decode_base64(data)],{type:type});}else{blob=new Blob([decodeURIComponent(data)],{type:type});}}
callback(blob);};}}(self));
var saveAs=saveAs||(typeof navigator!=='undefined'&&navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator))||(function(view){"use strict";var
doc=view.document,get_URL=function(){return view.URL||view.webkitURL||view;},URL=view.URL||view.webkitURL||view,save_link=doc.createElementNS("http://www.w3.org/1999/xhtml","a"),can_use_save_link=!view.externalHost&&"download"in save_link,click=function(node){var event=doc.createEvent("MouseEvents");event.initMouseEvent("click",true,false,view,0,0,0,0,0,false,false,false,false,0,null);node.dispatchEvent(event);},webkit_req_fs=view.webkitRequestFileSystem,req_fs=view.requestFileSystem||webkit_req_fs||view.mozRequestFileSystem,throw_outside=function(ex){(view.setImmediate||view.setTimeout)(function(){throw ex;},0);},force_saveable_type="application/octet-stream",fs_min_size=0,deletion_queue=[],process_deletion_queue=function(){var i=deletion_queue.length;while(i--){var file=deletion_queue[i];if(typeof file==="string"){URL.revokeObjectURL(file);}else{file.remove();}}
deletion_queue.length=0;},dispatch=function(filesaver,event_types,event){event_types=[].concat(event_types);var i=event_types.length;while(i--){var listener=filesaver["on"+event_types[i]];if(typeof listener==="function"){try{listener.call(filesaver,event||filesaver);}catch(ex){throw_outside(ex);}}}},FileSaver=function(blob,name){var
filesaver=this,type=blob.type,blob_changed=false,object_url,target_view,get_object_url=function(){var object_url=get_URL().createObjectURL(blob);deletion_queue.push(object_url);return object_url;},dispatch_all=function(){dispatch(filesaver,"writestart progress write writeend".split(" "));},fs_error=function(){if(blob_changed||!object_url){object_url=get_object_url(blob);}
if(target_view){target_view.location.href=object_url;}else{window.open(object_url,"_blank");}
filesaver.readyState=filesaver.DONE;dispatch_all();},abortable=function(func){return function(){if(filesaver.readyState!==filesaver.DONE){return func.apply(this,arguments);}};},create_if_not_found={create:true,exclusive:false},slice;filesaver.readyState=filesaver.INIT;if(!name){name="download";}
if(can_use_save_link){object_url=get_object_url(blob);doc=view.document;save_link=doc.createElementNS("http://www.w3.org/1999/xhtml","a");save_link.href=object_url;save_link.download=name;var event=doc.createEvent("MouseEvents");event.initMouseEvent("click",true,false,view,0,0,0,0,0,false,false,false,false,0,null);save_link.dispatchEvent(event);filesaver.readyState=filesaver.DONE;dispatch_all();return;}
if(view.chrome&&type&&type!==force_saveable_type){slice=blob.slice||blob.webkitSlice;blob=slice.call(blob,0,blob.size,force_saveable_type);blob_changed=true;}
if(webkit_req_fs&&name!=="download"){name+=".download";}
if(type===force_saveable_type||webkit_req_fs){target_view=view;}
if(!req_fs){fs_error();return;}
fs_min_size+=blob.size;req_fs(view.TEMPORARY,fs_min_size,abortable(function(fs){fs.root.getDirectory("saved",create_if_not_found,abortable(function(dir){var save=function(){dir.getFile(name,create_if_not_found,abortable(function(file){file.createWriter(abortable(function(writer){writer.onwriteend=function(event){target_view.location.href=file.toURL();deletion_queue.push(file);filesaver.readyState=filesaver.DONE;dispatch(filesaver,"writeend",event);};writer.onerror=function(){var error=writer.error;if(error.code!==error.ABORT_ERR){fs_error();}};"writestart progress write abort".split(" ").forEach(function(event){writer["on"+event]=filesaver["on"+event];});writer.write(blob);filesaver.abort=function(){writer.abort();filesaver.readyState=filesaver.DONE;};filesaver.readyState=filesaver.WRITING;}),fs_error);}),fs_error);};dir.getFile(name,{create:false},abortable(function(file){file.remove();save();}),abortable(function(ex){if(ex.code===ex.NOT_FOUND_ERR){save();}else{fs_error();}}));}),fs_error);}),fs_error);},FS_proto=FileSaver.prototype,saveAs=function(blob,name){return new FileSaver(blob,name);};FS_proto.abort=function(){var filesaver=this;filesaver.readyState=filesaver.DONE;dispatch(filesaver,"abort");};FS_proto.readyState=FS_proto.INIT=0;FS_proto.WRITING=1;FS_proto.DONE=2;FS_proto.error=FS_proto.onwritestart=FS_proto.onprogress=FS_proto.onwrite=FS_proto.onabort=FS_proto.onerror=FS_proto.onwriteend=null;view.addEventListener("unload",process_deletion_queue,false);return saveAs;}(this.self||this.window||this.content));if(typeof module!=='undefined')module.exports=saveAs;
var skinConfigFiles=["s_hamster_v3/hamster","s_pony_v3/mare","s_bomber/bomber_v3","s_dino/dino"];var camoColors=[];var base64decode,base64encode;CtorBuyResult=function(){};CtorBuyResult.SUCCES=0;CtorBuyResult.NOGOLD=1;CtorBuyResult.NOPLUT=2;CtorBuyResult.ERROR=3;var DUMMY_COLOR=0x1000000;function setDefaults(obj,defaults,excludeKeys){if(!defaults)
return;excludeKeys=excludeKeys||[];for(var dkey in defaults){if(undef(obj[dkey])&&excludeKeys.indexOf(dkey)<0){obj[dkey]=defaults[dkey];}}}
function def(v){return typeof v!="undefined"&&v!==null;}
function undef(v){return typeof v=="undefined"||v===null;}
function default_(obj,value){return def(obj)?obj:value;}
function assert(cond,ex){if(!cond)throw"Skinbuilder assertion failed: "+ex;}
function randomInt(maxPlus1){return Math.floor(maxPlus1*Math.random());}
function countKeys(obj){var c=0;for(var key in obj)
c++;return c;}
function keyByIndex(obj,ind){for(var key in obj){if(ind==0)
return key;ind--;}
return null;}
function propByIndex(obj,ind){for(var key in obj){if(ind==0)
return obj[key];ind--;}
return null;}
function indexOfKey(obj,key){var ind=0;for(var k in obj){if(k==key)
return ind;ind++;}
return-1;}
function clone(obj){return typeof jQuery!="undefined"?jQuery.extend(true,{},obj):JSON.parse(JSON.stringify(obj));}
function isArray(obj){return obj&&typeof obj=="object"&&obj.__proto__.push;}
function forceArray(arr,length){if(!isArray(arr))
arr=[arr];if(length){assert(arr.length==1||arr.length==length);while(arr.length<length)
arr.push(arr[0]);}
return arr;}
function forceRows(arr,func){if(!isArray(arr))
arr=[arr];if(arr.length<2)
arr.push(arr[0]);while(arr.length<4)
arr.push(func?func(arr[arr.length-2]):arr[arr.length-2]);return arr;}
function forceRowsCols(a,cols,func){if(!isArray(a))
a=[a];for(var i=0;i<2;i++)
a[i]=typeof a[i]!="undefined"?forceArray(a[i],cols):a[0];for(var i=2;i<4;i++){a[i]=typeof a[i]!="undefined"?forceArray(a[i]):[];if(a[i].length){a[i]=forceArray(a[i],cols);}else{for(var j=0;j<cols;j++)
a[i][j]=func?func(a[i-2][j]):a[i-2][j];}}
return a;}
function matchProp(obj,tmpl){for(var key in tmpl){if(typeof obj[key]!=typeof tmpl[key])
return false;switch(typeof tmpl[key]){case"object":if(!matchProp(obj[key],tmpl[key]))
return false;break;case"function":break;default:if(obj[key]!=tmpl[key])
return false;break;}}
return true;}
function filterByProp(arr,tmpl){var res=[];for(var i=0;i<arr.length;i++){if(matchProp(arr[i],tmpl))
res.push(arr[i]);}
return res;}
function indexByProp(arr,tmpl){for(var i=0;i<arr.length;i++){if(matchProp(arr[i],tmpl))
return i;}
return-1;}
function spliceByProp(arr,tmpl){var i=0;while(i<arr.length){if(matchProp(arr[i],tmpl))
arr.splice(i,1);else
i++;}}
function elementByProp(arr,tmpl){var ind=indexByProp(arr,tmpl);return ind<0?null:arr[ind];}
function randomElement(arr){return arr.length==0?null:arr[randomInt(arr.length)];}
function arrayOfElemtntsProp(arr,propName){var props=[];for(var i=0;i<arr.length;i++)
props.push(arr[i][propName]);return props;}
function hexColorToInt(str){if(typeof str!="string")
return str;var num=parseInt(str,16);return(num>>16)+(num&0xff00)+((num&0xff)<<16);}
Serializer=function(src64){var dst,accum,mult;var src,accumBits,srcInd;var crc=0,crcBits=6;if(def(src64)){try{src64=src64.replace(/_/g,"/");src64=src64.replace(/\$/g,"+");src=base64decode(src64);}catch(ex){throw"Serializer: invalid character";}
accumBits=0;srcInd=0;}else{dst="";accum=0;mult=1;}
function updateCrc(bit){crc=(crc*3+bit)%(1<<crcBits);}
function writeBit(bit){updateCrc(bit);accum+=bit*mult;mult*=2;if(mult==256){dst+=String.fromCharCode(accum);accum=0;mult=1;}}
function readBit(){if(accumBits==0){if(srcInd==src.length){throw"Serializer: source is too short";}
accum=src.charCodeAt(srcInd++);accumBits=8;}
var result=accum&1;accum>>=1;accumBits--;updateCrc(result);return result;}
this.write=function(value,bits){assert(value<=(1<<bits)-1,"value <= (1<<bits)-1");for(var i=0;i<bits;i++){writeBit(value&1);value>>=1;}}
this.read=function(bits){var value=0,mult=1;for(var i=0;i<bits;i++){value+=readBit()*mult;mult*=2;}
return value;}
this.result64=function(){if(mult>1){dst+=String.fromCharCode(accum);mult=1;}
var result=base64encode(dst);result=result.replace(/\//g,"_");result=result.replace(/\+/g,"$");return result;}
this.writeCrc=function(){this.write(crc,crcBits);}
this.readValidateCrc=function(){var v=crc;if(this.read(crcBits)!=v)
throw"Serializer: wrong crc";}}
Serializer.prototype.writeColor=function(color,bits){var r=(color&0xff)>>(8-bits);var g=((color>>8)&0xff)>>(8-bits);var b=((color>>16)&0xff)>>(8-bits);this.write(r,bits);this.write(g,bits);this.write(b,bits);}
Serializer.prototype.readColor=function(bits){var lb=8-bits;var add=(1<<lb)>>1;var r=(this.read(bits)<<lb)+add;var g=(this.read(bits)<<lb)+add;var b=(this.read(bits)<<lb)+add;return r+(g<<8)+(b<<16);}
Serializer.killColorBits=function(value,bits){var lb=8-bits;var add=(1<<lb)>>1;var r=(value&0xff)>>lb;var g=((value>>8)&0xff)>>lb;var b=(value>>16)>>lb;r=(r<<lb)+add;g=(g<<lb)+add;b=(b<<lb)+add;return r+(g<<8)+(b<<16);}
Serializer.prototype.writeBool=function(bool){this.write(bool?1:0,1);}
Serializer.prototype.readBool=function(){return this.read(1)==1;}
function ItemId(typeKey,featureKey,index){this.type=typeKey;this.key=featureKey;if(def(index))
this.index=index;};ItemId.equals=function(a,b){return a.type==b.type&&a.key==b.key&&a.index==b.index;};function ColorId(typeKey,colorKey,value){this.type=typeKey;this.key=colorKey;if(def(value))
this.value=value;};function Costs(){}
Costs.zero=function(){return Costs.create(0,0);}
Costs.big=function(){return Costs.create(0x7FFFFFFF,0x7FFFFFFF);}
Costs.copy=function(cost){return Costs.create(cost.gold,cost.plut);}
Costs.create=function(gold_cost,plut){if(def(gold_cost)&&def(gold_cost.gold)){return{gold:gold_cost.gold,plut:gold_cost.plut}}else{return{gold:default_(gold_cost,0),plut:default_(plut,0)}}}
Costs.add=function(sum,summand){sum.gold+=summand.gold;sum.plut+=summand.plut;}
Costs.applyDiscount=function(cost,discount){cost.gold=Math.max(cost.gold-discount.gold,0);cost.plut=Math.max(cost.plut-discount.plut,0);}
Costs.equals=function(a,b){return a.gold==b.gold&&a.plut==b.plut;}
Costs.orderLess=function(a,b){return a.plut<b.plut||(a.plut==b.plut&&a.gold<b.gold);}
Costs.canAfford=function(fortune,expense){return fortune.plut>=expense.plut&&fortune.gold>=expense.gold;}
Costs.isZero=function(cost){return cost.gold+cost.plut==0;}
Costs.isFree=function(obj){return obj.cost.gold+obj.cost.plut==0;}
Costs.of=function(obj,key){key=key||"cost";if(typeof(obj[key])=="number")
return Costs.create(0,obj[key]);var old=obj[key]||{};return Costs.create(old.gold,old.plut);}
Costs.attach=function(obj,key){key=key||"cost";obj[key]=Costs.of(obj,key);}
function Point(arg,y){if(typeof arg.w!="undefined"){this.x=arg.w;this.y=arg.h;}else if(typeof arg[0]!="undefined"){this.x=arg[0];this.y=default_(arg[1],this.x);}else{this.x=arg;this.y=default_(y,this.x);}}
function Rect(arg,y,w,h){if(typeof arg.w!="undefined"){this.x=default_(arg.x,0);this.y=default_(arg.y,0);this.w=arg.w;this.h=arg.h;}else if(typeof arg.x!="undefined"){this.x=this.y=0;this.w=arg.x;this.h=arg.y;}else if(typeof arg[0]!="undefined"){this.x=arg[0];this.y=arg[1];this.w=arg[2];this.h=arg[3];}else{this.x=arg;this.y=y;this.w=w;this.h=h;}}
Rect.prototype.addLeft=function(d){this.x+=d;this.w-=d;}
Rect.prototype.addTop=function(d){this.y+=d;this.h-=d;}
Rect.fit=function(rects,w,h,flippedRects){flippedRects=flippedRects||[];var allRects=rects.concat(flippedRects);var d=-rects[0].x;if(d>0){for(var i=0;i<rects.length;i++)
rects[i].addLeft(d);for(var i=0;i<flippedRects.length;i++)
flippedRects[i].w-=d;}
d=-rects[0].y;if(d>0){for(var i=0;i<allRects.length;i++)
allRects[i].addTop(d);}
d=rects[0].x+rects[0].w-w;if(d>0){for(var i=0;i<rects.length;i++)
rects[i].w-=d;for(var i=0;i<flippedRects.length;i++)
flippedRects[i].addLeft(d);}
d=rects[0].y+rects[0].h-h;if(d>0){for(var i=0;i<allRects.length;i++)
allRects[i].h-=d;}}
function killColorBits(type,ckey,value){var ser=type.serialization[type.serialization.length-1];var ind=indexByProp(ser.colors,{"key":ckey});if(ind<0)
return value;return Serializer.killColorBits(value,ser.colors[ind].bits);}
function loadCtorJsons(dir,onDone){function loadMultipleJsons(dir,files,onDone){var filesLeft=files.length;var result={};for(var i=0;i<files.length;i++){var name=dir+files[i]+".json";loadJson(name,function(data){for(var key in data)
result[key]=data[key];if(--filesLeft==0)
onDone(result);},function(){if(--filesLeft==0)
onDone(result);});}}
function JA(cond,ex){if(!cond){console.log("Error in skinbuilder JSON: "+ex);error=true;return true;}
return false;}
function JAhas(obj,keys,keysNo){keys=forceArray(keys);keysNo=forceArray(keysNo||[]);for(var i=0;i<keys.length;i++)
JA(def(obj[keys[i]]),obj.constructor.name+" has no "+keys[i]);for(var i=0;i<keysNo.length;i++)
JA(undef(obj[keysNo[i]]),obj.constructor.name+" has "+keysNo[i]);}
function prepareItem(type,item,sheet,feature){function prepareZ(obj){var defs={zSrc:['n'],zMin:[0],zMax:[255],zTranslucent:[0],defaultZ:null,zTest:[true]};setDefaults(obj,defs);for(var key in defs)
obj[key]=forceRows(obj[key]);if(def(obj.zOpaque))
obj.zOpaque=forceRows(obj.zOpaque);for(var i=0;i<type.rows;i++){switch(obj.zSrc[i]){case'n':break;case'a':JAhas(obj,["zOpaque","zTranslucent"]);break;case'r':case'g':case'b':break;}}
if(def(obj.defaultZ)){obj.defaultZ=forceRows(item.defaultZ);}else{obj.defaultZ=[];}}
JA(def(sheet),"def(sheet) "+item._name);setDefaults(item,sheet.defaultItem);if(error)return;setDefaults(item,{cell:sheet.count==1?0:null,tailParallax:[0,0],flippable:false,mirrorLeft:false,alphaBlend:false,hasEraser:false,widen:0,heighten:0,shiftSkinX:0,shiftSkinY:0,colors:{},colorSlots:[],ifColor:[],publicFrame:[0,0],ifZ:null,defaultZ:null,tag:"",dontRenderTags:[],shiftTags:{}});JAhas(item,["sheet","cell","cost"]);JA(item.cell<sheet.count,"item.cell < sheet.count "+item._name);if(def(item.shiftRight))
item.shiftSkinX=item.shiftRight;prepareZ(item);setDefaults(item,{codeMargin:item.zSrc.indexOf("a")>=0?1:0,codeMarginPlus:item.zSrc.indexOf("a")>=0?1:0});item.thumbCrop=new Rect(item.thumbCrop);var thumb=item.thumb;if(def(thumb)||def(feature.defaultThumb)){thumb=thumb||{};setDefaults(thumb,sheet.defaultItem.thumb);setDefaults(thumb,feature.defaultThumb);setDefaults(thumb,{publicFrame:[0,0],shift:[0,0],scale:2,crop:sheet.crop,dummyzSrc:'n',colors:{},recolor:false});thumb.crop=new Rect(thumb.crop);if(thumb.dummyCrop){thumb.dummyCrop=new Rect(thumb.dummyCrop);}
thumb.tailParallax=forceArray(item.tailParallax,2);prepareZ(thumb);for(var ckey in thumb.colors){JAhas(type.colors,[ckey]);thumb.colors[ckey]=hexColorToInt(thumb.colors[ckey]);}
item.thumb=thumb;}
item.tailParallax=forceArray(item.tailParallax,2);item.dontRenderSlots=forceArray(item.dontRenderSlots);item.ifColor=forceArray(item.ifColor);for(var i=0;i<item.ifColor.length;i++){if(typeof(item.ifColor[i])=="string"){JAhas(type.colors,item.ifColor[i]);item.ifColor[i]=type.colors[item.ifColor[i]].code;}}
if(def(item.ifZ))
item.ifZ=forceArray(item.ifZ,2*type.rows);for(var ckey in item.colors){JAhas(type.colors,[ckey]);if(typeof item.colors[ckey]=="string"){item.colors[ckey]=killColorBits(type,ckey,hexColorToInt(item.colors[ckey]));}else{setDefaults(item.colors[ckey],{mul:1,add:0});}}
for(var key in item.shiftTags){var cs=item.shiftTags[key];setDefaults(cs,{dx:[[0]],dy:[[0]]});cs.dx=forceRowsCols(cs.dx,type.cols);cs.dy=forceRowsCols(cs.dy,type.cols);}
for(var i=0;i<item.colorSlots.length;i++)
JAhas(type.colors,[item.colorSlots[i]]);Costs.attach(item);}
function prepareSheet(type,sheet){setDefaults(sheet,{count:1,size:[type.realFrameWidth,type.skin.frameHeight],lockChannels:"",row:[0,1,2,3]});sheet.size=new Point(sheet.size);sheet.crop=new Rect(sheet.crop||sheet.size);sheet.thumbCrop=new Rect(sheet.thumbCrop||sheet.crop);setDefaults(sheet.defaultItem,{thumbCrop:sheet.crop});sheet.dx=forceRowsCols(default_(sheet.dx,[[0]]),type.cols,function(v){return type.realFrameWidth-v-sheet.size.x;});sheet.dy=forceRowsCols(default_(sheet.dy,[[0]]),type.cols);if(error)return;sheet.row=forceRows(sheet.row,function(){return'm'});JAhas(sheet,[],["rows"]);if(error)return;sheet.rows=0;for(var i=0;i<type.rows;i++){if(typeof sheet.row[i]=="number")
sheet.rows=Math.max(sheet.rows,sheet.row[i]+1);}
if(def(sheet.col)){JAhas(sheet,[],["cols"]);sheet.col=forceRowsCols(sheet.col,type.cols);sheet.cols=0;for(var i=0;i<type.rows;i++){for(var j=0;j<type.cols;j++){if(typeof sheet.col[i][j]=="number")
sheet.cols=Math.max(sheet.cols,sheet.col[i][j]+1);}}}else{JAhas(sheet,["cols"]);if(error)return;var col=new Array(type.cols);for(var i=0;i<col.length;i++)
col[i]=Math.min(i,sheet.cols-1);sheet.col=forceRows([col]);}}
function prepareInitialMaxCost(parent,arr){if(undef(arr))
return;var imc=Costs.big();for(var i=0;i<arr.length;i++){if(Costs.orderLess(arr[i].cost,imc))
imc=arr[i].cost;}
Costs.attach(parent,"initialMaxCost");parent.initialMaxCost.gold=Math.max(parent.initialMaxCost.gold,imc.gold);parent.initialMaxCost.plut=Math.max(parent.initialMaxCost.plut,imc.plut);}
function prepareFeature(type,fkey){var feature=type.features[fkey];JAhas(feature,["sheets"]);setDefaults(feature,{defaultItem:{},defaultSheet:{},defaultThumb:null,chanceEmpty:0,dir:"",thumbScale:1,thumbSize:[64],initialItem:null});if(feature.chanceEmpty==0){feature.initialChanceEmpty=default_(feature.initialChanceEmpty,0);JA(feature.initialChanceEmpty==0,"feature.initialChanceEmpty == 0");}else
feature.initialChanceEmpty=default_(feature.initialChanceEmpty,feature.chanceEmpty);setDefaults(feature.defaultSheet,{defaultItem:{}});setDefaults(feature.defaultSheet.defaultItem,feature.defaultItem);feature.thumbSize=new Point(feature.thumbSize);JA(feature.chanceEmpty>=0&&feature.chanceEmpty<1,"feature.chanceEmpty>=0 && feature.chanceEmpty<1");if(error)return;for(var skey in feature.sheets){var sheet=feature.sheets[skey];var excludeKeys=[];if(def(sheet.row)||def(sheet.rows)){excludeKeys.push("row");excludeKeys.push("rows");}
if(def(sheet.col)||def(sheet.cols)){excludeKeys.push("col");excludeKeys.push("cols");}
setDefaults(sheet,{defaultItem:{}});setDefaults(sheet,feature.defaultSheet,excludeKeys);setDefaults(sheet.defaultItem,feature.defaultSheet.defaultItem);prepareSheet(type,sheet);if(error)return;}
if(def(feature.items)){for(var i=0;i<feature.items.length;i++){var item=feature.items[i];if(def(item.index))
JA(item.index==i,"item.index == i "+i);prepareItem(type,item,feature.sheets[item.sheet||feature.defaultItem.sheet],feature);}}else{JA(countKeys(feature.sheets)==1,"countKeys(feature.sheets) == 1 "+fkey);var sheetKey=keyByIndex(feature.sheets,0);JA(feature.sheets[sheetKey].count==1,"feature.sheets[sheetKey].count == 1"+fkey);feature.items=[{cost:{},sheet:sheetKey,cell:0}];prepareItem(type,feature.items[0],feature.sheets[sheetKey],feature);}
if(error)return;prepareInitialMaxCost(feature,feature.items);}
function prepareColor(type,color,ckey){switch(color.type){case"main":color.rnd=color.rnd||[0,255,0,255,0,255];break;case"optional":color.rnd=color.rnd||[0,255,0,255,0,255];JAhas(color,["src","chanceDerived"]);break;case"derived":JAhas(color,["src"]);break;default:JA(0,"unknown color.type");break;}
if(def(color.ifFeatures))
JAhas(type.features,color.ifFeatures);setDefaults(color,{mul:1,add:0,shuffle:false,initialNotEmpty:false,"default":"808080",rareColorCost:type.editor.rareColorCost});Costs.attach(color,"rareColorCost");var allValues=[];color["default"]=killColorBits(type,ckey,hexColorToInt(color["default"]));if(color.type!="derived"){Costs.attach(color);Costs.attach(color,"customCost");color.presets=color.presets||[];for(var i=0;i<color.presets.length;i++){var values=color.presets[i].values;for(var j=0;j<values.length;j++){values[j]=killColorBits(type,ckey,hexColorToInt(values[j]));allValues.push(values[j]);}
Costs.attach(color.presets[i]);}}
allValues.sort();for(var i=1;i<allValues.length;i++){JA(allValues[i-1]!=allValues[i],"color values are not unique: "+type.code+" "+ckey);}
prepareInitialMaxCost(color,color.presets);}
function prepareEditor(type){JAhas(type,["editor"]);if(error)return;var editor=type.editor;setDefaults(editor,{previewFrameWidth:type.skin.frameWidth,previewHeight:type.skin.frameHeight,rareColorCost:{"plut":1}});Costs.attach(editor,"rareColorCost");editor.previewFrameSize=new Point(editor.previewFrameSize);JAhas(editor,["features","colors"]);}
function preparePreset(type,preset){setDefaults(preset,{colors:{}});for(var ckey in preset.colors){JAhas(type.colors,[ckey]);preset.colors[ckey]=killColorBits(type,ckey,hexColorToInt(preset.colors[ckey]));}}
function prepareType(type){JAhas(type,["skin"]);if(error)return;setDefaults(type.skin,{frameHeight:type.skin.frameWidth,renderWidth:type.skin.frameWidth,});setDefaults(type,{version:"0",realFrameWidth:type.skin.frameWidth,initialDiscount:{},initialDiscountMinRank:1,blink:false,colors:{},presets:{},hsv:{},serialization:[{colors:[],features:[]}]});Costs.attach(type,"initialDiscount");function rowLut(i){return def(type.skin.row)?type.skin.row[i]:i;}
type.singleFileMode=def(type.singleFile);if(type.singleFileMode){}else{JA(type.skin.animMirrorLeft!=true,"type.skin.animMirrorLeft != true");if(error)return;type.symmRow=[];type.rowDirection=[];JA(type.rows==4,"type.rows == 4");type.symmRow[rowLut(0)]=rowLut(2);type.symmRow[rowLut(1)]=rowLut(3);type.symmRow[rowLut(2)]=rowLut(0);type.symmRow[rowLut(3)]=rowLut(1);type.rowDirection[rowLut(0)]="u";type.rowDirection[rowLut(1)]="r";type.rowDirection[rowLut(2)]="d";type.rowDirection[rowLut(3)]="l";for(var fkey in type.features){prepareFeature(type,fkey);if(error)return;}
prepareEditor(type);}
for(var ckey in type.colors){prepareColor(type,type.colors[ckey],ckey);if(error)return;}
for(var pkey in type.presets){preparePreset(type,type.presets[pkey]);if(error)return;}
setDefaults(type.hsv,{filterHue:[0,360],modifyAddHue:0});for(var i=0;i<type.serialization.length;i++){var ser=type.serialization[i];setDefaults(ser,{encodingVersion:0});}}
function onLoadJson(data){var types={};for(var key in data){error=false;var type=data[key];type.code=key;prepareType(type);if(error){console.log("Ctor: type '"+type.code+"' has an error");}else{type.dir=dir+type.dir;types[type.code]=type;console.log("Ctor: type '"+type.code+"' is loaded");}}
onDone(types);}
var error;loadMultipleJsons(dir,skinConfigFiles,onLoadJson);}
function SkinTypes(json){this.types=json;}
SkinTypes.prototype.killColorBits=function(tkey,ckey,value){return killColorBits(this.types[tkey],ckey,value);}
SkinTypes.prototype.enumFreeColorIds=function(tkey,ckey){var res=[];var presets=this.types[tkey].colors[ckey].presets;for(var i=0;i<presets.length;i++){var preset=presets[i];if(!Costs.isFree(preset))
continue;for(var j=0;j<preset.values.length;j++){res.push(new ColorId(tkey,ckey,preset.values[j]));}}
return res;};SkinTypes.prototype.enumAvailColorGroups=function(tkey,ckey,ownedColors){var res=[];var presets=this.types[tkey].colors[ckey].presets;for(var i=0;i<presets.length;i++){var preset=presets[i];var group={name:preset.name,cost:preset.cost,values:[]};for(var j=0;j<preset.values.length;j++){var value=preset.values[j];var color=new ColorId(tkey,ckey,value);if(indexByProp(ownedColors,color)<0)
group.values.push(value);}
if(group.values.length>0)
res.push(group);}
return res;}
SkinTypes.prototype.enumFreeItemIds=function(tkey,fkey){var res=[];var feature=this.types[tkey].features[fkey];var items=feature.items;for(var i=0;i<items.length;i++){if(Costs.isFree(items[i]))
res.push(new ItemId(tkey,fkey,i));}
return res;};SkinTypes.selectRandomColorFromPresets=function(presets,maxCost){var values=[];for(var i=0;i<presets.length;i++){if(!Costs.orderLess(maxCost,presets[i].cost))
values=values.concat(presets[i].values);}
return values[randomInt(values.length)];}
SkinTypes.prototype.selectRandomColorFromPresets=function(colorSlotId){var color=this.getColor(colorSlotId);return SkinTypes.selectRandomColorFromPresets(color.presets,color.initialMaxCost);}
SkinTypes.selectCheapestColorFromPresets=function(presets){var cost=Costs.big();var values=[];for(var i=0;i<presets.length;i++){if(Costs.orderLess(presets[i].cost,cost)){values=[];cost=presets[i].cost;}
if(!Costs.orderLess(cost,presets[i].cost))
values=values.concat(presets[i].values);}
return values[randomInt(values.length)];}
SkinTypes.prototype.getColor=function(id){return this.types[id.type].colors[id.key];};SkinTypes.prototype.getFeature=function(id){return this.types[id.type].features[id.key];};SkinTypes.prototype.getSheetKey=function(id){return this.getFeature(id).items[id.index].sheet;};SkinTypes.prototype.getSheet=function(id){var feature=this.getFeature(id);return feature.sheets[feature.items[id.index].sheet];};SkinTypes.prototype.getItem=function(id){return this.getFeature(id).items[id.index];};SkinTypes.getUrlImage=function(type,name){var res=type.dir+name+".png";return isOnServer?res:res+"?version="+type.version;}
SkinTypes.getUrl=function(type,feature,sheet){return SkinTypes.getUrlImage(type,(feature.dir||"")+sheet.file);}
SkinTypes.getUrlSingleFile=function(type){return SkinTypes.getUrlImage(type,type.singleFile);}
SkinTypes.prototype.getUrl=function(itemId){var type=this.types[itemId.type];return SkinTypes.getUrl(type,type.features[itemId.key],this.getSheet(itemId));}
SkinTypes.prototype.colorUnlockCost=function(typeKey,ckey,colorsOwned){var color=this.types[typeKey].colors[ckey];if(Costs.isFree(color)||indexByProp(colorsOwned,{type:typeKey,key:ckey})<0)
return color.cost;return Costs.zero();};SkinTypes.calcColorCost=function(value,presets,customCost){for(var i=0;i<presets.length;i++){var preset=presets[i];if(preset.values.indexOf(value)>=0)
return preset.cost;}
if(undef(customCost)||Costs.isZero(customCost))
throw"Custom colors are disabled";return customCost;};SkinTypes.prototype.getInitialDiscount=function(tkey,hasSkin,rank){return hasSkin||rank<this.types[tkey].initialDiscountMinRank?Costs.zero():this.types[tkey].initialDiscount;};function getPublicFrame(skin){return skin.publicFrame||[(skin.row?skin.row[2]:2)+(!skin.idleAnim?0:skin.animMirrorLeft?3:4),skin.colStand!=null?skin.colStand:skin.col?skin.col[0]:skin.animCount==3?1:0];}
function intToRGB(v){return{r:v&0xff,g:(v>>8)&0xff,b:(v>>16)&0xff};}
function RGBtoInt(v){return v.r+(v.g<<8)+(v.b<<16);}
function RGBtoHSV3(xr,xg,xb){xr/=255;xg/=255;xb/=255;var min=Math.min(xr,xg,xb);var max=Math.max(xr,xg,xb);var result={v:max};var delta=max-min;if(max==0){result.s=0;result.h=-1;return result;}
result.s=delta/max;if(delta>0){if(xr==max)
result.h=(xg-xb)/delta;else if(xg==max)
result.h=2+(xb-xr)/delta;else
result.h=4+(xr-xg)/delta;result.h*=60;if(result.h<0)
result.h+=360;}else
result.h=0;return result;}
function RGBtoHSV(x){return RGBtoHSV3(x.r,x.g,x.b);}
function HSVtoRGB3(xh,xs,xv){v=~~(xv*255);if(xs==0)
return{r:v,g:v,b:v};h=xh/60;var i=Math.floor(h);var f=h-i;var p=~~(v*(1-xs));var q=~~(v*(1-xs*f));var t=~~(v*(1-xs*(1-f)));switch(i){case 0:return{r:v,g:t,b:p};case 1:return{r:q,g:v,b:p};case 2:return{r:p,g:v,b:t};case 3:return{r:p,g:q,b:v};case 4:return{r:t,g:p,b:v};default:return{r:v,g:p,b:q};}}
function HSVtoRGB(x){return HSVtoRGB3(x.h,x.s,x.v);}
function Random(seed){this.int=function(maxPlus1){return my?myUint31()%maxPlus1:Math.floor(maxPlus1*Math.random());}
this.float=function(maxPlus1){return my?myInt32()/4294967296+0.5:Math.random();}
this.bool=function(){return my?myInt32()%2==0:Math.random()<0.5;}
function hashCode(str){var hash=0;if(str.length==0)return hash;for(i=0;i<str.length;i++){char=str.charCodeAt(i);hash=((hash<<5)-hash)+char;hash=hash&hash;}
return hash;}
function myInt32(){m_z=(36969*(m_z&65535)+(m_z>>16))&0xffffffff;m_w=(18000*(m_w&65535)+(m_w>>16))&0xffffffff;return((m_z<<16)+m_w)&0xffffffff;}
function myUint31(){return myInt32()&0x7fffffff;}
var m_z,m_w;var my=def(seed);if(my){m_z=987654321;m_w=typeof seed=="string"?hashCode(seed):seed;}}
function SkinConfig(json){this.skinTypes=new SkinTypes(json);this.types=json;this.colorSlots={};this.itemSlots={};this.postEffects={};this.changed=false;this.camoColors=camoColors||[];this.items={};SkinConfig.versionBits=4;}
SkinConfig.prototype.getCurItem=function(fkey){return this.skinTypes.getItem(this.itemSlots[fkey].id);};SkinConfig.prototype.setPrevItem=function(fkey){var itemSlot=this.itemSlots[fkey];var itemsLength=this.type.features[fkey].items.length;itemSlot.id.index=(itemSlot.id.index-1+itemsLength)%itemsLength;this.changed=true;};SkinConfig.prototype.setNextItem=function(fkey){var itemSlot=this.itemSlots[fkey];var itemsLength=this.type.features[fkey].items.length;itemSlot.id.index=(itemSlot.id.index+1)%itemsLength;this.changed=true;};SkinConfig.prototype.clearItem=function(fkey){this.changed=this.changed||!this.itemSlots[fkey].empty;this.itemSlots[fkey].empty=true;};SkinConfig.prototype.setItem=function(id){var itemSlot=this.itemSlots[id.key];var changed=!ItemId.equals(itemSlot.id,id)||itemSlot.empty;this.changed=this.changed||changed;itemSlot.id=id;itemSlot.empty=false;return changed;};SkinConfig.prototype.setItemUpdateColors=function(id,colorsOwned){this.setItemUpdateColors_(false,id.key,id,colorsOwned);}
SkinConfig.prototype.clearItemUpdateColors=function(ikey,colorsOwned){this.setItemUpdateColors_(true,ikey,null,colorsOwned);}
SkinConfig.prototype.setItemUpdateColors_=function(setEmpty,ikey,id,colorsOwned){var itemSlot=this.itemSlots[ikey];var changed=(setEmpty!=itemSlot.empty)||(!setEmpty&&!ItemId.equals(itemSlot.id,id))
this.changed=this.changed||changed;var ckeysToChange=[];if(!itemSlot.empty){var colors=this.skinTypes.getItem(itemSlot.id).colors;for(var ckey in colors){var colorSlot=this.colorSlots[ckey];if(typeof colors[ckey]=="number"&&this.isColorEnabled(ckey)&&colorSlot.value==colors[ckey])
{var filter=new ColorId(this.typeKey,ckey,colorSlot.value);if(indexByProp(colorsOwned,filter)>=0)
continue;colorSlot.forced=true;if(changed)
ckeysToChange.push(ckey);}}}
itemSlot.id=id;itemSlot.empty=setEmpty;if(!setEmpty&&changed){this.forceItemColorsById(id);var colors=this.skinTypes.getItem(itemSlot.id).colors;for(var ckey in colors){var ind=ckeysToChange.indexOf(ckey);if(ind>=0)
ckeysToChange.splice(ind,1);}}
for(var i=0;i<ckeysToChange.length;i++){var ckey=ckeysToChange[i];var colorSlot=this.colorSlots[ckey];var lnfv=colorSlot.lastNotForcedValue;var colorSlotId=new ColorId(this.typeKey,ckey);if(def(lnfv)&&lnfv>=0){this.setColorValue(ckey,lnfv);}else if(this.skinTypes.getColor(colorSlotId).type=="optional"){this.setColorEnabled(ckey,false);}else{var fci=this.skinTypes.enumFreeColorIds(this.typeKey,ckey);if(fci.length==0)
fci=filtrByProp(colorsOwned,colorSlotId);if(fci.length>0){this.setColorValue(ckey,fci[0].value);}else{}}
colorSlot.forced=false;}};SkinConfig.prototype.isItemOptional=function(fkey){return this.type.features[fkey].chanceEmpty>0;};SkinConfig.prototype.isItemFlippable=function(fkey){if(!this.getItemEnabled(fkey))
return false;return this.getCurItem(fkey).flippable;};SkinConfig.prototype.flip=function(fkey){this.changed=this.changed||this.isItemFlippable(fkey);this.itemSlots[fkey].flip=!this.itemSlots[fkey].flip;};SkinConfig.prototype.getItemEnabled=function(fkey){return!this.itemSlots[fkey].empty;};SkinConfig.prototype.setItemEnabled=function(fkey,enabled){var changed=this.itemSlots[fkey].empty!=!enabled;this.changed=this.changed||changed;this.itemSlots[fkey].empty=!enabled;};SkinConfig.prototype.isColorOptional=function(ckey){return this.type.colors[ckey].type=="optional";};SkinConfig.prototype.isColorSlotEnabled=function(ckey){var color=this.type.colors[ckey];if(undef(color.ifFeatures))
return true;for(var i=0;i<color.ifFeatures.length;i++){var fkey=color.ifFeatures[i];if(this.getItemEnabled(fkey)&&this.getCurItem(fkey).colorSlots.indexOf(ckey)>=0)
{return true;}}
return false;};SkinConfig.prototype.isColorEnabled=function(ckey){var cs=this.colorSlots[ckey];return this.isColorSlotEnabled(ckey)&&!cs.derived&&def(cs.value)&&cs.value>=0;};SkinConfig.prototype.setColorEnabled=function(ckey,enabled){this.changed=this.changed||this.colorSlots[ckey].derived!=!enabled;this.colorSlots[ckey].derived=!enabled;};SkinConfig.prototype.getColorValue=function(ckey){return this.colorSlots[ckey].value;};SkinConfig.prototype.setColorValue=function(ckey,value){if(value<0)
assert(value>=0,"SkinConfig.prototype.setColorValue value >= 0");this.changed=this.changed||this.colorSlots[ckey].value!=value;this.colorSlots[ckey].value=value;};SkinConfig.prototype.createItemSlotForType=function(tkey,fkey,empty,flip,index){return{empty:default_(empty,this.types[tkey].features[fkey].chanceEmpty>0),flip:default_(flip,false),id:new ItemId(tkey,fkey,default_(index,0))};}
SkinConfig.prototype.createItemSlot=function(fkey,empty,flip,index){return this.createItemSlotForType(this.typeKey,fkey,empty,flip,index);}
SkinConfig.prototype.createDefaultColorSlot=function(ckey){switch(this.type.colors[ckey].type){case"main":return{derived:false,value:default_(this.type.colors[ckey]["default"],0x808080)};default:return{derived:true};}}
SkinConfig.prototype.getSheetKey=function(fkey){return this.skinTypes.getSheetKey(this.itemSlots[fkey].id);};SkinConfig.prototype.getSheet=function(fkey){return this.skinTypes.getSheet(this.itemSlots[fkey].id);};SkinConfig.splitCode=function(src){if(src.length<2||(src[0]!='!'&&src[0]!='?'))
throw"incorrect skin code";var tokens=src.split("-");var typeAndData=tokens[0].substring(1);tokens.splice(0,1);var i=typeAndData.indexOf('!');if(i<0){return{type:typeAndData[0],data:typeAndData.substring(1),options:tokens};}else{return{type:typeAndData.substring(0,i),data:typeAndData.substring(i+1),options:tokens};}}
SkinConfig.prototype.serialize=function(){var s=new Serializer();var serVer=this.type.serialization.length-1;var ser=this.type.serialization[serVer];s.write(serVer,SkinConfig.versionBits);for(var i=0;i<ser.features.length;i++){var sf=ser.features[i];var fkey=sf.key;s.writeBool(this.itemSlots[fkey].empty);if(this.itemSlots[fkey].empty)
continue;s.write(this.itemSlots[fkey].id.index,sf.bits);s.writeBool(this.itemSlots[fkey].flip);}
for(var i=0;i<ser.colors.length;i++){var sc=ser.colors[i];var ckey=sc.key;var colorSlot=this.colorSlots[ckey];if(this.isColorSlotEnabled(ckey)){if(this.isColorOptional(ckey))
s.writeBool(colorSlot.derived);if(this.isColorEnabled(ckey))
s.writeColor(this.getColorValue(ckey),sc.bits);}}
s.writeCrc();return"!"
+this.typeKey
+(this.typeKey.length>1?'!':'')
+s.result64();}
SkinConfig.prototype.deserialize=function(src64){this.requestedCode=src64;if(src64[0]=='?'){this.setRandomFeatures(SkinConfig.splitCode(src64).type,src64);this.setRandomColors(src64);return;}
var ex="invalid skin code";var splitted=SkinConfig.splitCode(src64);if(undef(splitted.type))
throw ex;var oldItemSlots=this.itemSlots;var oldColorSlots=this.colorSlots;var oldTypeKey=this.typeKey;var oldType=this.type;var oldPostEffects=this.postEffects;try{this.typeKey=splitted.type;this.type=this.types[this.typeKey];this.itemSlots={};this.colorSlots={};var s,serCfg;if(splitted.data.length>0){s=new Serializer(splitted.data);var version=s.read(SkinConfig.versionBits);assert(version<this.type.serialization.length);serCfg=this.type.serialization[version];for(var i=0;i<serCfg.features.length;i++){var sf=serCfg.features[i];var fkey=sf.key;var itemSlot=this.itemSlots[fkey]={};itemSlot.empty=s.readBool();if(itemSlot.empty){this.itemSlots[fkey]=this.createItemSlotForType(splitted.type,fkey);assert(itemSlot.empty,"new itemSlot.empty");continue;}
var feature=this.type.features[fkey];itemSlot.id=new ItemId(splitted.type,fkey,s.read(sf.bits));assert(itemSlot.id.index<feature.items.length);itemSlot.flip=s.readBool();}}
for(var fkey in this.type.features)
this.itemSlots[fkey]=this.itemSlots[fkey]||this.createItemSlot(fkey);if(splitted.data.length>0){for(var i=0;i<serCfg.colors.length;i++){var sc=serCfg.colors[i];var ckey=sc.key;var color=this.type.colors[ckey];var colorSlot=this.colorSlots[ckey]={};var colorSlotEnabled=this.isColorSlotEnabled(ckey);if(def(sc.legacyOptional)){assert(serCfg.encodingVersion<1,"serCfg.encodingVersion < 1");var derived=s.readBool();colorSlot.derived=false;colorSlot.value=derived?this.colorSlots[sc.legacyOptional].value:s.readColor(sc.bits);continue;}
switch(this.type.colors[ckey].type){case"main":colorSlot.derived=false;break;case"optional":colorSlot.derived=colorSlotEnabled||serCfg.encodingVersion<1?s.readBool():true;break;case"derived":colorSlot.derived=true;break;}
if(!colorSlot.derived){colorSlot.value=colorSlotEnabled||serCfg.encodingVersion<1?s.readColor(sc.bits):null;}}
s.readValidateCrc();}
for(var ckey in this.type.colors){if(undef(this.colorSlots[ckey]))
this.colorSlots[ckey]=this.createDefaultColorSlot(ckey);}
this.postEffects={};for(var i=0;i<splitted.options.length;i++)
this.applyOption(splitted.options[i]);}catch(e){this.itemSlots=oldItemSlots;this.colorSlots=oldColorSlots;this.typeKey=oldTypeKey;this.type=oldType;this.postEffects=oldPostEffects;console.log(e);throw ex;}
this.changed=true;}
SkinConfig.prototype.applyOption=function(option){var code=option[0]
var value=option.substring(1);switch(code){case"p":case"t":var preset=this.type.presets[value];if(undef(preset)){if(code=="p"){throw"unknown skin preset";}else
return;}
for(var ckey in preset.colors){this.setColorValue(ckey,preset.colors[ckey]);}
if(def(preset.addHue)){this.postEffects.addHue=preset.addHue;}
break;default:throw"unknown skin option";}}
SkinConfig.prototype.getCurItemIds=function(){var res=[];for(var fkey in this.itemSlots){var x=this.itemSlots[fkey];if(x.empty)
continue;res.push(this.itemSlots[fkey].id);}
return res;}
SkinConfig.prototype.getCurColorIds=function(){var res=[];for(var ckey in this.colorSlots){if(!this.isColorEnabled(ckey))
continue;var x=this.colorSlots[ckey];res.push(new ColorId(this.typeKey,ckey,x.value));}
return res;}
SkinConfig.prototype.enumCurItemColorIds=function(ckey){var res=[];for(var fkey in this.itemSlots){if(this.getItemEnabled(fkey)){var color=this.getCurItem(fkey).colors[ckey];if(typeof color=="number")
res.push(new ColorId(this.typeKey,ckey,color));}}
return res;}
SkinConfig.prototype.getItemSlotCost=function(fkey,getIfEmpty){if(this.itemSlots[fkey].empty&&!getIfEmpty)
return Costs.zero();return this.skinTypes.getItem(this.itemSlots[fkey].id).cost;};SkinConfig.prototype.apprise=function(itemsOwned,colorsOwned,discount){var result={items:[],colors:[],cost:Costs.zero()};var curItems=this.getCurItemIds();for(var i=0;i<curItems.length;i++){var v=curItems[i];if(indexByProp(itemsOwned,v)>=0)
continue;var cost=this.getItemSlotCost(v.key);if(Costs.isZero(cost))
continue;result.items.push([v.type,v.key,v.index]);Costs.add(result.cost,cost);}
var curColors=this.getCurColorIds();for(var i=0;i<curColors.length;i++){var v=curColors[i];if(indexByProp(colorsOwned,v)>=0||indexByProp(this.enumCurItemColorIds(v.key),v)>=0)
continue;var color=this.skinTypes.getColor(v);var cost=SkinTypes.calcColorCost(v.value,color.presets,color.customCost);var unlockCost=this.skinTypes.colorUnlockCost(v.type,v.key,colorsOwned);if(Costs.isZero(cost)&&Costs.isZero(unlockCost))
continue;result.colors.push([v.type,v.key,Costs.isZero(cost)?DUMMY_COLOR:v.value]);Costs.add(result.cost,cost);Costs.add(result.cost,unlockCost);}
Costs.applyDiscount(result.cost,discount);return result;}
SkinConfig.prototype.createTypeCode=function(tkey){var typeInd;var kc=countKeys(this.types);if(def(this.typeKey)){typeInd=indexOfKey(this.types,this.typeKey)}else{do{typeInd=randomInt(kc);}while(undef(propByIndex(this.types,typeInd).editor));}
if(def(tkey)){switch(tkey){case"prev":case"next":var step=tkey=="prev"?kc-1:1;do{typeInd=(typeInd+step)%kc;}while(undef(propByIndex(this.types,typeInd).editor));break;case"?":do{typeInd=randomInt(kc);}while(undef(propByIndex(this.types,typeInd).editor));break;case"same":break;default:typeInd=indexOfKey(this.types,tkey);}}
return keyByIndex(this.types,typeInd);}
SkinConfig.prototype.setType=function(tkey){tkey=this.createTypeCode(tkey);if(this.typeKey==tkey)
return;this.typeKey=tkey;this.type=this.types[this.typeKey];var type=this.type;this.itemSlots={};for(var fkey in this.type.features){var feature=this.type.features[fkey];this.itemSlots[fkey]=this.createItemSlot(fkey);}
this.colorSlots={};for(var ckey in type.colors){this.colorSlots[ckey]={derived:type.colors[ckey].type!="main",value:type.colors[ckey]["default"]};}
this.changed=true;}
SkinConfig.prototype.setRandomFeatures=function(typeKey,seed,isInitialRandom){var rand=new Random(seed);if(typeKey=="?"){do{this.typeKey=keyByIndex(this.types,rand.int(countKeys(this.types)));}while(undef(this.types[this.typeKey].editor));}else
this.typeKey=this.createTypeCode(typeKey);this.type=this.types[this.typeKey];this.itemSlots={};for(var fkey in this.type.features){if(this.type.editor.features.indexOf(fkey)<0){this.itemSlots[fkey]=this.createItemSlot(fkey);continue;}
var feature=this.type.features[fkey];if(isInitialRandom){var freeId=randomElement(this.skinTypes.enumFreeItemIds(this.typeKey,fkey));var itemIndexes=[];if(feature.initialItem!=null){itemIndexes=[feature.initialItem];}else{for(var i=0;i<feature.items.length;i++){if(Costs.canAfford(feature.initialMaxCost,feature.items[i].cost))
itemIndexes.push(i);}}
this.itemSlots[fkey]=this.createItemSlot(fkey,feature.chanceEmpty>0&&rand.float()<feature.initialChanceEmpty,rand.bool(),def(freeId)?freeId.index:randomElement(itemIndexes));}else{do{this.itemSlots[fkey]=this.createItemSlot(fkey,rand.float()<feature.chanceEmpty,rand.bool(),rand.int(feature.items.length));}while(this.getCurItem(fkey).cost.plut>9000);}}
this.changed=true;};SkinConfig.prototype.makeItemsAffordable=function(maxCost,itemsOwned,colorsOwned,discount){var ck=countKeys(this.itemSlots);for(var i=0;i<20;i++){var appraisal=this.apprise(itemsOwned,colorsOwned,discount);if(Costs.canAfford(maxCost,appraisal.cost))
break;var sn;do{sn=randomInt(ck);}while(this.type.editor.features.indexOf(keyByIndex(this.itemSlots,sn))<0);var success=false;for(var j=0;j<ck;j++,sn=(sn+1)%ck){var fkey=keyByIndex(this.itemSlots,sn);var slot=this.itemSlots[fkey];if(this.type.editor.features.indexOf(fkey)<0||slot.empty)
continue;var curCost=this.getItemSlotCost(fkey);var feature=this.type.features[fkey];var cheaperItems=[];for(var k=0;k<feature.items.length;k++)
if(Costs.orderLess(feature.items[k].cost,curCost))
cheaperItems.push(k);if(cheaperItems.length){slot.id.index=cheaperItems[randomInt(cheaperItems.length)];success=true;break;}else if(feature.initialChanceEmpty>0){slot.empty=true;success=true;break;}}
if(!success)
break;}
this.changed=true;}
SkinConfig.prototype.forceItemColorsById=function(id){var colors=this.skinTypes.getItem(id).colors;for(var ckey in colors){if(typeof colors[ckey]=="number"){if(!this.colorSlots[ckey].forced){this.colorSlots[ckey].lastNotForcedValue=this.isColorEnabled(ckey)?this.colorSlots[ckey].value:-1;}
this.setColorValue(ckey,colors[ckey]);this.setColorEnabled(ckey,true);this.colorSlots[ckey].forced=true;}}}
SkinConfig.prototype.forceItemColors=function(fkey){this.forceItemColorsById(this.itemSlots[fkey].id);}
SkinConfig.prototype.setRandomColors=function(seed,isInitialRandom,onlyUndefined){var rand=new Random(seed);function random(item){var r=item.rnd[0]+rand.int(item.rnd[1]-item.rnd[0]+1);var g=item.rnd[2]+rand.int(item.rnd[3]-item.rnd[2]+1);var b=item.rnd[4]+rand.int(item.rnd[5]-item.rnd[4]+1);if(item.shuffle){var p;switch(rand.int(3)){case 0:p=r;r=g;g=p;break;case 1:p=r;r=b;b=p;break;case 2:break;}
if(rand.bool()){p=g;g=b;b=p;}}
return r+(g<<8)+(b<<16);}
var type=this.type;if(!onlyUndefined)
this.colorSlots={};for(var ckey in type.colors){if(this.type.editor.colors.indexOf(ckey)<0){this.colorSlots[ckey]=this.createDefaultColorSlot(ckey);continue;}
var color=type.colors[ckey];var colorSlot=this.colorSlots[ckey]=this.colorSlots[ckey]||{};if(typeof colorSlot.derived=="undefined"){switch(color.type){case"main":colorSlot.derived=false;break;case"optional":colorSlot.derived=isInitialRandom||rand.float()<color.chanceDerived;break;case"derived":colorSlot.derived=true;break;}}
if(typeof colorSlot.value!="number"){colorSlot.value=!this.isColorSlotEnabled(ckey)?SkinTypes.selectCheapestColorFromPresets(color.presets):isInitialRandom?SkinTypes.selectRandomColorFromPresets(color.presets,color.initialMaxCost):rand.float()<0.75?SkinTypes.selectRandomColorFromPresets(color.presets,Costs.big()):random(color);if(colorSlot.value==null)colorSlot.value=random(color);}}
for(var fkey in this.itemSlots){if(this.getItemEnabled(fkey)&&rand.float()<0.75)
this.forceItemColors(fkey);}
this.changed=true;}
SkinConfig.prototype.setDefaultColors=function(){var type=this.type;this.colorSlots={};for(var ckey in type.colors){var color=type.colors[ckey];this.colorSlots[ckey]=this.colorSlots[ckey]||{};var thisColor=this.colorSlots[ckey];switch(color.type){case"main":case"optional":thisColor.derived=false;break;case"derived":thisColor.derived=true;break;}
if(!thisColor.derived){thisColor.value=color["default"];}}
this.changed=true;}
SkinConfig.prototype.overrideColors=function(colors){if(colors==null)
return;var type=this.type;for(var ckey in colors){this.colorSlots[ckey].value=colors[ckey];this.changed=true;}}
SkinConfig.prototype.deriveColors=function(extraColors){function antiCamo(iv){return iv;}
function derive(item,parent,parent2){var v=intToRGB(parent.finalValue);if(parent2!=null){var v2=intToRGB(parent2.finalValue);v.r=(v.r+v2.r)>>1;v.g=(v.g+v2.g)>>1;v.b=(v.b+v2.b)>>1;}
if(def(item.hue)&&!parent.derived){var hsv=RGBtoHSV(v);if(hsv.h>=0){hsv.h=(hsv.h+item.hue+360)%360;v=HSVtoRGB(hsv);}}
var mulAdd=Math.min(2,Math.max(0.5,(v.r+v.g+v.b+1+3*item.add)/(v.r+v.g+v.b+1)));var mul=item.mul*mulAdd;item.finalValue=RGBtoInt({r:Math.min(255,Math.floor(v.r*mul)),g:Math.min(255,Math.floor(v.g*mul)),b:Math.min(255,Math.floor(v.b*mul))});return item.finalValue;}
var colrChanges={};for(var fkey in this.itemSlots){if(this.getItemEnabled(fkey)){var colors=this.getCurItem(fkey).colors;for(var ckey in colors){if(typeof colors[ckey]!="number")
colrChanges[ckey]=colors[ckey];}}}
var colors=this.colorSlots;for(var ckey in colors){if(typeof colors[ckey].value!="number"&&colors[ckey].value!=null){colrChanges[ckey]=colors[ckey].value;colors[ckey].derived=true;}}
var type=this.type;var ckeys=[];for(var ckey in type.colors)
ckeys.push(ckey);for(var i=ckeys.length-1;i>=0;i--){ckey=ckeys[i];if(!this.colorSlots[ckey].derived)
this.colorSlots[ckey].finalValue=antiCamo(this.colorSlots[ckey].value);}
for(var ckey in type.colors){if(this.colorSlots[ckey].derived){var tc=colrChanges[ckey]||type.colors[ckey];var parent=this.colorSlots[tc.src];if(undef(parent))
continue;var parent2=def(tc.src2)?this.colorSlots[tc.src2]:null;this.colorSlots[ckey].finalValue=derive(tc,parent,parent2);}}}
SkinConfig.prototype.getThumbSize=function(fkey){return this.type.features[fkey].thumbSize;};SkinConfig.prototype.enumThings=function(){this.things={};var dontRenderTags=[];for(var fkey in this.type.features){if(this.getItemEnabled(fkey))
dontRenderTags=dontRenderTags.concat(this.getCurItem(fkey).dontRenderTags);}
for(var fkey in this.type.features){if(this.getItemEnabled(fkey)&&dontRenderTags.indexOf(this.getCurItem(fkey).tag)<0)
this.things[fkey]={};}}
SkinConfig.prototype.calcSize=function(minWidth,minHeight){var type=this.type;var rect=[];for(var i=0;i<type.rows;i++)
rect.push({l:0,u:0,r:type.skin.frameWidth,d:type.skin.frameHeight});var sumShiftSkinX=0,sumShiftSkinY=0;var shifts={};for(var fkey in this.things){var thing=this.things[fkey];var sheet=this.skinTypes.getSheet(this.itemSlots[fkey].id);var item=this.skinTypes.getItem(this.itemSlots[fkey].id);for(var key in item.shiftTags)
shifts[key]=item.shiftTags[key];thing.dx=sheet.dx;thing.dy=sheet.dy;var us=shifts[item.tag];if(us!=null){thing.dx=clone(thing.dx);thing.dy=clone(thing.dy);for(var i=0;i<type.rows;i++){var signx=this.itemSlots[fkey].flip&&("ud".indexOf(type.rowDirection[i])>=0)?-1:1;for(var j=0;j<type.cols;j++){thing.dx[i][j]+=signx*us.dx[i][j];thing.dy[i][j]+=us.dy[i][j];}}}}
for(var fkey in this.things){var thing=this.things[fkey];var sheet=this.skinTypes.getSheet(this.itemSlots[fkey].id);var item=this.skinTypes.getItem(this.itemSlots[fkey].id);sumShiftSkinX+=item.shiftSkinX;sumShiftSkinY+=item.shiftSkinY;for(var i=0;i<type.rows;i++){for(var j=0;j<type.cols;j++){if(typeof thing.dx[i][j]=="number"){rect[i].l=Math.min(rect[i].l,Math.max(Math.min(rect[i].l,thing.dx[i][j]),-item.widen));rect[i].r=Math.max(rect[i].r,Math.min(Math.max(rect[i].r,thing.dx[i][j]+sheet.crop.w),type.skin.frameWidth+item.widen));}
if(typeof thing.dy[i][j]=="number"){rect[i].u=Math.min(rect[i].u,Math.max(Math.min(rect[i].u,thing.dy[i][j]),-item.heighten));rect[i].d=Math.max(rect[i].d,Math.min(Math.max(rect[i].d,thing.dy[i][j]+sheet.crop.h),type.skin.frameHeight+item.heighten));}}}}
this.dx=new Int16Array(type.rows);this.dy=new Int16Array(type.rows);for(var i=0;i<type.rows;i++){this.dy[i]=sumShiftSkinY;rect[i].u+=sumShiftSkinY;rect[i].d+=sumShiftSkinY;rect[i].u=Math.min(rect[i].u,type.skin.frameHeight-rect[i].d);rect[i].d=Math.max(rect[i].d,type.skin.frameHeight-rect[i].u);var rd=type.rowDirection[i];if(rd=="r"||rd=="l"){var d=sumShiftSkinX*(rd=="r"?1:-1);this.dx[i]=d;rect[i].l+=d;rect[i].r+=d;rect[i].l=Math.min(rect[i].l,type.skin.frameWidth-rect[i].r);rect[i].r=Math.max(rect[i].r,type.skin.frameWidth-rect[i].l);}}
var l=rect[0].l;var u=rect[0].u;var r=rect[0].r;var d=rect[0].d;for(var i=1;i<type.rows;i++){l=Math.min(rect[i].l,l);u=Math.min(rect[i].u,u);r=Math.max(rect[i].r,r);d=Math.max(rect[i].d,d);}
for(var i=0;i<type.rows;i++){this.dx[i]-=l;this.dy[i]-=u;}
this.width=r-l;this.height=d-u;if(def(minHeight)){for(var i=0;i<type.rows;i++){if(this.width<minWidth)
this.dx[i]+=~~((minWidth-this.width)/2);if(this.height<minHeight)
this.dy[i]+=~~((minHeight-this.height)/2);}
this.width=Math.max(this.width,minWidth);this.height=Math.max(this.height,minHeight);return;}
this.skinW=this.width*type.cols;this.skinH=this.height*type.rows;}
function intColorToHtml(v){function ts(b){return(b<16?"0":"")+b.toString(16);}
return"#"+ts(v&0xff)+ts((v>>8)&0xff)+ts((v>>16)&0xff);}
function floatRGBtoInt(r,g,b){return~~(r*255+(g*255<<8)+(b*255<<16));}
function channelNumber(ch){switch(ch){case'r':return 0;case'g':return 1;case'b':return 2;default:return 3;}}
function PixelArrays(){}
PixelArrays.fromImage=function(img){var w=img.width;var h=img.height;var canvas=createCanvas(w,h)
var ctx=canvas.getContext('2d');ctx.clearRect(0,0,w,h);ctx.drawImage(img,0,0,w,h,0,0,w,h);return{r:new Uint8Array(ctx.getImageData(0,0,w,h).data),w:w,h:h};}
PixelArrays.create=function(w,h){return{r:new Uint8Array(w*h*4),w:w,h:h};}
PixelArrays.toCanvas=function(arr){var canvas=createCanvas(arr.w,arr.h);var ctx=canvas.getContext('2d');var imageData=ctx.getImageData(0,0,arr.w,arr.h);if(imageData.data.set){imageData.data.set(arr.r);}else{var e=PixelArrays.bytes(arr);for(var p=0;p<e;p++)
imageData.data[p]=arr.r[p];}
ctx.putImageData(imageData,0,0);return canvas;}
PixelArrays.upgrade=function(arr){if(supportsSubarray){arr.g=arr.r.subarray(1);arr.b=arr.r.subarray(2);arr.a=arr.r.subarray(3);}
arr.stride=4*arr.w;}
PixelArrays.downgrade=function(arr){if(supportsSubarray){delete arr.g;delete arr.b;delete arr.a;}}
PixelArrays.copy=function(dst,dstX,dstY,src,srcX,srcY,w,h){assert(dstX+w<=dst.w&&dstY+h<=dst.h&&srcX+w<=src.w&&srcY+h<=src.h,"dstX+w<=dst.w && dstY+h<=dst.h && srcX+w<=src.w && srcY+h<=src.h");var dstBegin=dstY*dst.stride+dstX*4;var srcBegin=srcY*src.stride+srcX*4;for(var j=0;j<4*h;j++){var dstP=dstBegin;var srcP=srcBegin;var dstEnd=dstBegin+4*w;for(;dstP<dstEnd;dstP++,srcP++)
dst.r[dstP]=src.r[srcP];dstBegin+=dst.stride;srcBegin+=src.stride;}}
PixelArrays.area=function(arr){return arr.w*arr.h;}
PixelArrays.bytes=function(arr){return 4*arr.w*arr.h;}
PixelArrays.transferList=function(arr){return[arr.r.buffer];}
function Sprites(){}
Sprites.load=function(jsons,onDone){function afterLoad(){if(finished)
return;var complete=true;for(var ikey in images){if(!images[ikey].complete){complete=false;}else if(images[ikey].width>0&&undef(sprites[ikey])){sprites[ikey]=PixelArrays.fromImage(images[ikey]);}}
if(complete){var size=0;for(var ikey in images)
size+=images[ikey].width*images[ikey].height;console.log("Constructor sprites size: "+Math.round(size*4/1000)+" kB");images=null;url2key=null;finished=true;onDone(sprites);}else{mySetTimeout(afterLoad,30);}}
function addImage(ikey,url){if(url2key[url]==null){images[ikey]=new Image();images[ikey].src=url;url2key[url]=ikey;}else
sprites[ikey]=url2key[url];}
var sprites={},images={},url2key={};var finished=false;for(var tkey in jsons){var type=jsons[tkey];for(var fkey in type.features){feature=type.features[fkey];for(var skey in feature.sheets){addImage(Sprites.key(tkey,fkey,skey),SkinTypes.getUrl(type,feature,feature.sheets[skey]));}}
if(def(type.dummy)){addImage(Sprites.specialKey(tkey,"dummy"),SkinTypes.getUrlImage(type,type.dummy));}}
afterLoad();}
Sprites.get=function(sprites,key){do{key=sprites[key];}while(typeof(key)=="string");return key;}
Sprites.key=function(tkey,fkey,skey){return tkey+'-'+fkey+'-'+skey;}
Sprites.specialKey=function(tkey,name){return tkey+'-'+name;}
Sprites.upgrade=function(sprites){if(def(sprites.upgraded))
return;for(var ikey in sprites){if(typeof(sprites[ikey])=="object")
PixelArrays.upgrade(sprites[ikey]);}
sprites.upgraded=true;}
Sprites.transferList=function(sprites){var result=[];for(var key in sprites){if(typeof sprites[key]=="object")
result.push(sprites[key].r.buffer);}
return result;}
function loadCtorData(dir,onDone){loadCtorJsons(dir,function(json){Sprites.load(json,function(sprites){onDone({json:json,sprites:sprites});});});}
function SkinGraphics(json){SkinConfig.call(this,json);this.calcItemRect=function(sheet,imageWidth,cell){var w=sheet.size.x*sheet.cols;var h=sheet.size.y*sheet.rows;assert(imageWidth%w==0,"imageWidth % ffs.x == 0");var sheetFullCols=~~(imageWidth/w);var fullCol=cell%sheetFullCols;var fullRow=~~(cell/sheetFullCols);return new Rect(fullCol*w,fullRow*h,w,h);}
this.calcExtraPos=function(sheet,imageWidth,cell){var ffs=this.calcItemRect(sheet);var sheetFullCols=~~(imageWidth/ffs.w);var fullRow=~~((sheet.count-1)/sheetFullCols);var sheetCols=~~(imageWidth/sheet.size.x);var col=cell%sheetCols;var row=~~(cell/sheetCols);return new Point(col*sheet.size.x,row*sheet.size.y+(fullRow+1)*ffs.h);}
this.addColors=function(colorSlots,tableInd,itemMargins){this.recolorer.clearCurTable();for(var ckey in this.type.colors){this.recolorer.addColor(this.type.colors[ckey].code,tableInd,colorSlots[ckey].finalValue,this.type.colors[ckey].norm,itemMargins);}}
function clearReserveCanvas(canvas,w,h,forceClear){var dirthy=true;if(def(w)){if(canvas.width<w){canvas.width=w;dirthy=false;}
if(canvas.height<h){canvas.height=h;dirthy=false;}}
if(undef(canvas.context))
canvas.context=canvas.getContext('2d');if(dirthy&&default_(forceClear,true))
canvas.context.clearRect(0,0,w,h);}
this.setCanvas=function(canvas,img,x,y,w,h,oper){clearReserveCanvas(canvas,w,h,!(oper=="source-atop"));canvas.context.globalCompositeOperation=oper||"copy";canvas.context.drawImage(img,x,y,w,h,0,0,w,h);}
this.createDst=function(w,h){this.dstPA=PixelArrays.create(w,h);PixelArrays.upgrade(this.dstPA);this.dstZ=new Uint8Array(PixelArrays.bytes(this.dstPA));this.recolorer=new Recolorer(countKeys(this.type.features));this.dstReIndex=new Plane.createNew(w,h,16);this.dstReBr=new Plane.createChannel_pixelArray(this.dstPA,this.type.brightnessSrc);}
this.prepareRender=function(sprite,item,rect){var zSrc;for(var i=0;i<item.zSrc.length;i++){zSrc=item.zSrc[i];if(zSrc=='r'||zSrc=='g'||zSrc=='b')
break;}
if(item.alphaBlend){this.recolorer.recolorPixelArray(this.dstPA,this.dstReIndex,this.dstReBr);this.recolorer.clearTables();this.addColors(this.colorSlots,0,item);this.srcPA=PixelArrays.create(rect.w,rect.h);PixelArrays.upgrade(this.srcPA);PixelArrays.copy(this.srcPA,0,0,sprite,rect.x,rect.y,rect.w,rect.h);rect.x=rect.y=0;this.srcIpZ=new Plane.createChannelCopy_pixelArray(this.srcPA,zSrc);this.srcIpColors=new Plane.createChannel_pixelArray(this.srcPA,this.type.colorsSrc);this.srcIpBr=new Plane.createChannel_pixelArray(this.srcPA,this.type.brightnessSrc);this.recolorer.recolorPixelArray(this.srcPA,this.srcIpColors,this.srcIpBr,null,this.srcIpZ);this.recolorer.clearTables();}else{this.addColors(this.colorSlots,this.recolAdd>>8,item);this.srcPA=sprite;this.srcIpZ=new Plane.createChannel_pixelArray(this.srcPA,zSrc);this.srcIpColors=new Plane.createChannel_pixelArray(this.srcPA,this.type.colorsSrc);this.srcIpBr=new Plane.createChannel_pixelArray(this.srcPA,this.type.brightnessSrc);}}
this.render=function(dstX,dstY,srcRect,sheet,item,sheetRow,isFirst,row,flip)
{var dstPA=this.dstPA;var dstReIndex=this.dstReIndex;var dstReBr=this.dstReBr;var dstZ=this.dstZ;var srcPA=this.srcPA;var srcIpColors=this.srcIpColors;var srcIpBr=this.srcIpBr;var srcIpZ=this.srcIpZ;var recolAdd=this.recolAdd;var dstArr=dstPA.r;var srcArr=srcPA.r;var dstBegin=4*(dstY*dstPA.w+dstX);var srcBegin=srcRect.y*srcPA.stride+4*srcRect.x;var srcStep=4;var srcP;var z,zMin=item.zMin[row],zMax=item.zMax[row];if(flip){srcBegin+=4*(srcRect.w-1);srcStep=-4;}
var zFunc,zConst;switch(item.zSrc[row]){case'n':zFunc=function(){return dstZ[dstP];};break;case'a':zFunc=supportsSubarray?function(){return srcIpZ.sub[srcP]==255?item.zOpaque[row]:item.zTranslucent[row];}:function(){return srcIpZ.data[srcP+srcIpZ.add]==255?item.zOpaque[row]:item.zTranslucent[row];};break;default:if(typeof(item.zSrc[row])=="number"){zConst=item.zSrc[row];zFunc=function(){return zConst;};}else if(item.alphaBlend){zConst=item.defaultZ[row]||0;zFunc=supportsSubarray?function(){return srcIpZ.sub[srcP]||zConst;}:function(){return srcIpZ.data[srcP+srcIpZ.add]||zConst;};}else{zFunc=supportsSubarray?function(){return self.recolorer.reFlagCurTable[srcIpColors.sub[srcP]]?srcIpZ.sub[srcP]:item.defaultZ[row]||srcIpZ.sub[srcP];}:function(){return self.recolorer.reFlagCurTable[srcIpColors.data[srcP+srcIpColors.add]]?srcIpZ.data[srcP+srcIpZ.add]:item.defaultZ[row]||srcIpZ.data[srcP+srcIpZ.add];};}}
var zTestFunc;var minZ,maxZ;if(def(item.ifZ)){minZ=item.ifZ[sheetRow*2];maxZ=item.ifZ[sheetRow*2+1];zTestFunc=item.zSrc[row]=='n'||isFirst?function(){return dstZ[dstP]>=minZ&&dstZ[dstP]<=maxZ;}:function(){return dstZ[dstP]>=minZ&&dstZ[dstP]<=Mat.max(maxZ,z);}}else{zTestFunc=item.zSrc[row]=='n'||isFirst||!item.zTest[row]?function(){return true;}:function(){return dstZ[dstP]<=z;}}
var aFunc;switch(item.zSrc[row]){case'a':aFunc=function(){return 255;};break;default:aFunc=supportsSubarray?function(){return srcPA.a[srcP];}:function(){return srcArr[srcP+3];};break;}
var setRgbFunc;var writeR=sheet.lockChannels.indexOf("r")<0;var writeG=sheet.lockChannels.indexOf("g")<0;var writeB=sheet.lockChannels.indexOf("b")<0;if(writeR&&writeG&&writeB){setRgbFunc=supportsSubarray?function(r,g,b){dstPA.r[dstP]=r;dstPA.g[dstP]=g;dstPA.b[dstP]=b;}:function(r,g,b){dstArr[dstP]=r;dstArr[dstP+1]=g;dstArr[dstP+2]=b;}}else{setRgbFunc=supportsSubarray?function(r,g,b){if(writeR)dstPA.r[dstP]=r;if(writeG)dstPA.g[dstP]=g;if(writeB)dstPA.b[dstP]=b;}:function(r,g,b){if(writeR)dstArr[dstP]=r;if(writeG)dstArr[dstP+1]=g;if(writeB)dstArr[dstP+2]=b;};}
var setAFunc;if(sheet.lockChannels.indexOf("a")<0){setAFunc=supportsSubarray?function(a){dstPA.a[dstP]=a;}:function(a){dstArr[dstP+3]=a;};}else{setAFunc=function(a){};}
var	blendFuncCopy=supportsSubarray?function(){setRgbFunc(srcPA.r[srcP],srcPA.g[srcP],srcPA.b[srcP]);setAFunc(aFunc());}:function(){setRgbFunc(srcArr[srcP],srcArr[srcP+1],srcArr[srcP+2]);setAFunc(aFunc());};var blendFunc;if(item.alphaBlend){blendFunc=supportsSubarray?function(){var dstA=dstPA.a[dstP];if(dstA==0){blendFuncCopy();}else{var srcA=aFunc();setRgbFunc((srcPA.r[srcP]*srcA+dstPA.r[dstP]*(255-srcA))/255,(srcPA.g[srcP]*srcA+dstPA.g[dstP]*(255-srcA))/255,(srcPA.b[srcP]*srcA+dstPA.b[dstP]*(255-srcA))/255);setAFunc(Math.min(255,dstPA.a[dstP]+srcA));}}:function(){var dstA=dstArr[dstP+3];if(dstA==0){blendFuncCopy();}else{var srcA=aFunc();setRgbFunc((srcArr[srcP]*srcA+dstArr[dstP]*(255-srcA))/255,(srcArr[srcP+1]*srcA+dstArr[dstP+1]*(255-srcA))/255,(srcArr[srcP+2]*srcA+dstArr[dstP+2]*(255-srcA))/255);setAFunc(Math.min(255,dstArr[dstP+3]+srcA));}}}else{blendFunc=function(){blendFuncCopy();setAFunc(aFunc());}}
var testFunc;if(item.ifColor.length>0){testFunc=item.codeMargin+item.codeMarginPlus>0?function(){if(dstArr[dstP+3]==0)
return false;for(var i=0;i<item.ifColor.length;i++){var v=dstReIndex.data[dstP]&0xff;if(v<=item.ifColor[i]+item.codeMarginPlus&&v>=item.ifColor[i]-item.codeMargin)
return true;}
return false;}:function(){return dstArr[dstP+3]>0&&item.ifColor.indexOf(dstReIndex.data[dstP]&0xff)>=0;};}else
testFunc=function(){return true;};for(var j=0;j<srcRect.h;j++){var dstP=dstBegin;srcP=srcBegin;var dstEnd=dstP+4*srcRect.w;if(supportsSubarray){for(;dstP<dstEnd;dstP+=4,srcP+=srcStep){if(srcPA.a[srcP]&&testFunc()){z=zFunc();if(zTestFunc()){dstReIndex.data[dstP]=srcIpColors.sub[srcP]+recolAdd;dstZ[dstP]=z;blendFunc();}}}}else{for(;dstP<dstEnd;dstP+=4,srcP+=srcStep){if(srcArr[srcP+3]&&testFunc()){z=zFunc();if(zTestFunc()){dstReIndex.data[dstP]=srcIpColors.data[srcP+srcIpColors.add]+recolAdd;dstZ[dstP]=z;blendFunc();}}}}
if(item.hasEraser){var ec=this.type.eraserCode+recolAdd;for(dstP=dstBegin;dstP<dstEnd;dstP+=4){if(dstReIndex.data[dstP]==ec)
dstZ[dstP]=dstArr[dstP+3]=0;}}
dstBegin+=dstPA.stride;srcBegin+=srcPA.stride;}}
var self=this;this.recolAdd=this.dstPA=this.dstZ=this.dstReBr=this.dstReIndex=this.srcPA=this.srcIpZ=this.srcIpColors=this.srcIpBr=null;}
SkinGraphics.prototype=Object.create(SkinConfig.prototype);SkinGraphics.prototype.constructor=SkinGraphics;function AugImageData(canvas,x,y,w,h){if(undef(x)){x=y=0;w=canvas.width;h=canvas.height;}
if(undef(canvas.context))
canvas.context=canvas.getContext('2d');this.imageData=canvas.context.getImageData(x,y,w,h);this.data=this.imageData.data;this.stride=4*w;this.x=x;this.y=y;this.w=w;this.h=h;if(supportsSubarray){this.r=this.data;this.g=this.data.subarray(1);this.b=this.data.subarray(2);this.a=this.data.subarray(3);}
this.area=function(){return w*h;}
this.putBack=function(){canvas.context.putImageData(this.imageData,x,y);}}
function Plane(w,h,data,add){this.w=w;this.h=h;this.data=data;this.add=default_(add,0);if(supportsSubarray)
this.sub=this.data.subarray(this.add);}
Plane.createChannel=function(aid,channel){return new Plane(aid.w,aid.h,aid.data,channelNumber(channel));}
Plane.createChannel_pixelArray=function(pa,channel){return new Plane(pa.w,pa.h,pa.r,channelNumber(channel));}
Plane.createChannelCopy=function(aid,channel){var add=channelNumber(channel);var data=new Uint8Array(aid.data.length);for(var i=0;i<data.length;i+=4)
data[i]=aid.data[i+add];return new Plane(aid.w,aid.h,data);}
Plane.createChannelCopy_pixelArray=function(pa,channel){var add=channelNumber(channel);var data=new Uint8Array(pa.r.length);for(var i=0;i<data.length;i+=4)
data[i]=pa.r[i+add];return new Plane(pa.w,pa.h,data);}
Plane.createNew=function(w,h,bits){var data=bits==16?new Uint16Array(4*w*h):new Uint8Array(4*w*h);return new Plane(w,h,data);}
function tranformHSV(aid,hueFilterMin,hueFilterMax,hueAdd){hueFilterMin=default_(hueFilterMin,0);hueFilterMax=default_(hueFilterMax,360);hueAdd=default_(hueAdd,0)+720;assert(aid.x==0&&aid.y==0,"adi.x==0 && aid.y==0");var nBytes=aid.stride*aid.h;var arr=aid.data;for(var p=0;p<nBytes;p+=4){if(arr[p+3]==0)
continue;var hsv=RGBtoHSV3(arr[p],arr[p+1],arr[p+2]);if(hsv.h<0||hsv.h<hueFilterMin&&hsv.h>hueFilterMax||hueFilterMin<hueFilterMax&&(hsv.h<hueFilterMin||hsv.h>hueFilterMax))
{continue;}
hsv.h=(hsv.h+hueAdd)%360;var rgb=HSVtoRGB3(hsv.h,hsv.s,hsv.v);arr[p]=rgb.r;arr[p+1]=rgb.g;arr[p+2]=rgb.b;}}
function Recolorer(tablesCount){var self=this;this.addColor=function(ind,tableInd,color,BRnorm,itemMargins){var add=tableInd*256;for(var i=add+Math.max(0,ind-itemMargins.codeMargin);i<=add+Math.min(255,ind+itemMargins.codeMarginPlus);i++)
{self.reFlagCurTable[i-add]=1;reFlag[i]=1;reR[i]=color&0xff;reG[i]=(color>>8)&0xff;reB[i]=(color>>16)&0xff;reBrnorm[i]=def(BRnorm)?Math.max(BRnorm,1):0;}
empty=false;}
this.clearTables=function(){reFlag=new Uint8Array(colorsCount);reR=new Uint8Array(colorsCount);reG=new Uint8Array(colorsCount);reB=new Uint8Array(colorsCount);reBrnorm=new Uint8Array(colorsCount);empty=true;}
this.clearCurTable=function(){if(self.reFlagCurTable.fill){self.reFlagCurTable.fill(0);}else{for(var i=0;i<self.reFlagCurTable.length;i++)
self.reFlagCurTable[i]=0;}}
this.recolorPixelArray=function(pa,ipIndex,ipBr,rect,ipZ){if(empty)
return;rect=rect||new Rect(pa);var arr=pa.r;for(var j=0;j<rect.h;j++){var p=pa.stride*(rect.y+j)+rect.x*4;var dstEnd=p+4*rect.w;for(;p<dstEnd;p+=4){if(arr[p+3]==0)
continue;var v=ipIndex.data[p+ipIndex.add];if(reFlag[v]){if(reBrnorm[v]){var k=ipBr.data[p+ipBr.add]/reBrnorm[v];var isBlink=this.useBlink&&ipBr.data[p+ipBr.add]==255;if(k<=1){arr[p]=reR[v]*k;arr[p+1]=reG[v]*k;arr[p+2]=reB[v]*k;}else{var r=reR[v]*k;var g=reG[v]*k;var b=reB[v]*k;var s=(Math.max(r,255)+Math.max(g,255)+Math.max(b,255)-765)>>1;if(isBlink)
s+=24;arr[p]=Math.min(255,r+s);arr[p+1]=Math.min(255,g+s);arr[p+2]=Math.min(255,b+s);}
if(isBlink){arr[p]=Math.max(140,arr[p]);arr[p+1]=Math.max(140,arr[p+1]);arr[p+2]=Math.max(140,arr[p+2]);}}else{arr[p]=reR[v];arr[p+1]=reG[v];arr[p+2]=reB[v];}}else if(ipZ){ipZ.data[p+ipZ.add]=0;}}}}
colorsCount=default_(tablesCount,1)*256;var reFlag,reR,reG,reB,reBrnorm,empty;this.reFlagCurTable=new Uint8Array(256);this.clearTables();}
var supportsSubarray,mySetTimeout;
function SkinBuilderSlave(ctorData){SkinGraphics.call(this,ctorData.json);this.sprites=ctorData.sprites;this.build=function(req){return req.name?this.buildSkin(req):this.buildItem(req);}
this.buildSkin=function(req){try{this.deserialize(req.name);}catch(e){return{skin:{name:req.name}};}
var type=this.type;this.enumThings();if(def(req.onlyPublicFrame))
req.onlyPublicFrameSize=0;if(def(req.onlyPublicFrameSize)){this.calcSize(req.onlyPublicFrameSize,req.onlyPublicFrameSize);this.skinW=this.width;this.skinH=this.height;var pf=getPublicFrame(type.skin);this.selectedRow=pf[0];this.selectedCol=pf[1];}else{this.calcSize();this.selectedRow=null;this.selectedCol=null;}
this.createDst(this.skinW,this.skinH);this.deriveColors();this.recolorer.useBlink=type.blink;var isFirst=true;this.recolAdd=0;for(var fkey in this.things){var errorCode=drawLayer(fkey,isFirst);if(errorCode){return{skin:{name:req.name}};}
isFirst=false;this.recolAdd+=256;}
this.recolorer.recolorPixelArray(this.dstPA,this.dstReIndex,this.dstReBr);var skin;if(self.width==self.type.skin.frameWidth&&self.height==self.type.skin.frameHeight){skin=self.type.skin;}else{skin=clone(self.type.skin);skin.renderWidth=Math.floor(skin.renderWidth/skin.frameWidth*self.width);skin.frameWidth=self.width;skin.frameHeight=self.height;}
PixelArrays.downgrade(this.dstPA);return{skin:{name:req.name,skin:skin,},pixelArray:this.dstPA};}
function drawLayer(fkey,isFirst){var itemSlot=self.itemSlots[fkey];var skey=self.getSheetKey(fkey);var sheet=self.getSheet(fkey);var thing=self.things[fkey];var item=self.getCurItem(fkey);var flip=itemSlot.flip&&self.isItemFlippable(fkey);var sprite=Sprites.get(ctorData.sprites,Sprites.key(self.typeKey,fkey,skey));if(!def(sprite)){return 1;}
var itemRect=self.calcItemRect(sheet,sprite.w,item.cell);self.prepareRender(sprite,item,itemRect);for(var i=0;i<sheet.row.length;i++){if(sheet.row[i]===''||(self.selectedRow!=null&&i!=self.selectedRow))
continue;var row=i;var sheetRow=sheet.row[i];var flipRow=flip;var tailParallax=[0,0];if(self.type.rowDirection[i]=="r"||self.type.rowDirection[i]=="l"){var symmRow=self.type.symmRow[i];var symmSheetRow=sheet.row[symmRow];flipRow=item.mirrorLeft?self.type.rowDirection[i]=="l":symmSheetRow!="m"&&(sheetRow=="m"||flip);if(flipRow){row=symmRow;sheetRow=symmSheetRow;}}else if(sheetRow=="m"){sheetRow=sheet.row[self.type.symmRow[i]]
flipRow=!flip;tailParallax=item.tailParallax;}
for(var j=0;j<self.type.cols;j++){if(self.selectedCol!=null&&j!=self.selectedCol)
continue;var fdx=thing.dx[i][j]+self.dx[i]+sheet.crop.x;var fdy=thing.dy[i][j]+self.dy[i]+sheet.crop.y;var srcRect=new Rect(sheet.col[i][j]*sheet.size.x+sheet.crop.x+itemRect.x,sheetRow*sheet.size.y+sheet.crop.y+itemRect.y,sheet.crop.w,sheet.crop.h);var parallaxMul=flip?-1:1;var dstRect=new Rect(fdx+parallaxMul*tailParallax[0],fdy+parallaxMul*tailParallax[1],sheet.crop.w,sheet.crop.h);if(flipRow){Rect.fit([dstRect],self.width,self.height,[srcRect]);}else
Rect.fit([dstRect,srcRect],self.width,self.height);var dstShiftMul=self.selectedRow==null?1:0;self.render(self.width*j*dstShiftMul+dstRect.x,self.height*i*dstShiftMul+dstRect.y,srcRect,sheet,item,sheetRow,isFirst,row,flipRow);}}
return 0;}
this.buildItem=function(id){this.setType(id.type);var skey=this.skinTypes.getSheetKey(id);var sheet=this.skinTypes.getSheet(id);var item=this.skinTypes.getItem(id);var feature=this.skinTypes.getFeature(id)
var publicFrame,hasDummy;var itemCrop,srcRect,dstRect;var sprite=Sprites.get(this.sprites,Sprites.key(id.type,id.key,skey));if(!def(sprite))
return{};var featureRect=this.calcItemRect(sheet,sprite.w,item.cell);var thumb=item.thumb;if(thumb){publicFrame=thumb.publicFrame;hasDummy=def(thumb.dummyCrop);itemCrop=thumb.crop;}else{publicFrame=item.publicFrame;hasDummy=false;itemCrop=item.thumbCrop;}
srcRect=new Rect(featureRect.x+publicFrame[1]*sheet.size.x+itemCrop.x,featureRect.y+publicFrame[0]*sheet.size.y+itemCrop.y,itemCrop.w,itemCrop.h);if(hasDummy){var dummySprite=Sprites.get(this.sprites,Sprites.specialKey(id.type,"dummy"));if(!def(dummySprite))
return{};var w=thumb.dummyCrop.w;var h=thumb.dummyCrop.h;dstRect=new Rect(itemCrop.x+thumb.shift[0],itemCrop.y+thumb.shift[1],srcRect.w,srcRect.h);Rect.fit([dstRect,srcRect],w,h);this.createDst(w,h);}else{dstRect=new Rect(0,0,srcRect.w,srcRect.h);this.createDst(dstRect.w,dstRect.h);}
this.setDefaultColors();for(var ckey in this.colorSlots){if(this.isColorSlotEnabled(ckey)&&this.isColorOptional(ckey))
this.setColorEnabled(ckey,true);}
this.recolorer.useBlink=this.type.blink;this.recolorer.clearTables();if(hasDummy){this.recolAdd=0;this.overrideColors(thumb.colors);this.deriveColors();if(thumb.recolor)
this.addColors(this.colorSlots,0,item);var dummyItem={alphaBlend:0,codeMargin:0,ifColor:[],zMin:[0],zMax:[255],defaultZ:[0]};var dummySheet={lockChannels:""};for(var key in thumb)
dummyItem[key]=thumb[key];this.prepareRender(dummySprite,dummyItem,thumb.dummyCrop);this.render(0,0,thumb.dummyCrop,dummySheet,dummyItem,0,true,0,false);}
this.recolAdd=256;this.overrideColors(item.colors);this.deriveColors();this.addColors(this.colorSlots,1,item);this.prepareRender(sprite,item,srcRect);var sheetRow=publicFrame[0];var row=0;while(row+1<sheet.row.length&&sheet.row[row]!=sheetRow)
row++;this.render(dstRect.x,dstRect.y,srcRect,sheet,item,sheetRow,!hasDummy,row,false);this.recolorer.recolorPixelArray(this.dstPA,this.dstReIndex,this.dstReBr);return{id:id,pixelArray:this.dstPA};}
var self=this;Sprites.upgrade(ctorData.sprites);}
SkinBuilderSlave.prototype=Object.create(SkinGraphics.prototype);SkinBuilderSlave.prototype.constructor=SkinBuilderSlave;function prepareResult(result){if(def(result.pixelArray)){result.canvas=PixelArrays.toCanvas(result.pixelArray);delete result.pixelArray;}}
function SkinBuilderSync(ctorData){this.buildSync=function(req){var result=skinBuilderSlave.build(req);prepareResult(result);return result;}
this.build=function(req,cb){cb(this.buildSync(req));}
var skinBuilderSlave=new SkinBuilderSlave(ctorData);}
function SkinBuilderWorker(ctorData,workerScriptDir){this.build=function(req,cb){queue.push(req);cbQueue.push(cb);if(ready)
buildFromQueue();}
function buildFromQueue(){ready=false;var req=queue[0];queue.splice(0,1);worker.postMessage(req);}
function onMessage(e){if(queue.length>0){buildFromQueue();}else
ready=true;if(e.data!="done"){prepareResult(e.data);cbQueue[0](e.data);cbQueue.splice(0,1);}}
var self=this;var ready=false;var worker=new Worker((workerScriptDir||"")+'skinBuilderWorker.js');var queue=[];var cbQueue=[];assert(!ctorData.sprites.upgraded,"SkinBuilderWorker: !sprites.upgraded");worker.addEventListener('message',onMessage,false);worker.postMessage(ctorData,Sprites.transferList(ctorData.sprites));}
function SkinThumbs(skinTypes,skinBuilder){var self=this;this.genAllThumbs=function(featureId){var thumbs=[];var items=skinTypes.getFeature(featureId).items;for(var i=0;i<items.length;i++){var item=items[i];var thumb={id:new ItemId(featureId.type,featureId.key,i),canvasId:"thumb_"+canvasIdCounter,flippable:item.flippable,cost:item.cost,item:item};thumbs.push(thumb);canvasIdCounter=(canvasIdCounter+1)%1000000;}
return thumbs;}
this.buildThumbs=function(thumbs){var maxTime=30000;var delay=50;function inner(){for(var i=0;i<thumbs.length;i++){var dstCanvas=document.getElementById(thumbs[i].canvasId);if(dstCanvas==null){maxTime-=delay;if(maxTime>0)
setTimeout(inner,delay);return;}
if(dstCanvas.isDone)
continue;buildThumb(dstCanvas,thumbs[i].id);dstCanvas.isDone=true;}}
inner();}
function buildThumb(dstCanvas,id){var item=skinTypes.getItem(id);var scale=item.thumb?item.thumb.scale:2;skinBuilder.build(id,function(result){var canvas=result.canvas;if(canvas){dstCanvas.width=canvas.width*scale;dstCanvas.height=canvas.height*scale;var dstCtx=dstCanvas.getContext('2d');dstCtx.clearRect(0,0,dstCanvas.width,dstCanvas.height);dstCtx.imageSmoothingEnabled=false;dstCtx.webkitImageSmoothingEnabled=false;dstCtx.mozImageSmoothingEnabled=false;dstCtx.drawImage(canvas,0,0,canvas.width,canvas.height,0,0,dstCanvas.width,dstCanvas.height);}});}
var canvasIdCounter=Math.floor(1000000*Math.random());var self=this;}
SkinThumbs.prototype=Object.create(SkinGraphics.prototype);SkinThumbs.prototype.constructor=SkinThumbs;
var MAX_CROP_LENGTH_PERCENT=7;var MAX_CROP_AREA_PERCENT=0.5;var SHOP_THUMB_SIZE=72;var SHOP_THUMB_CELL_SIZE=36;function getPublicFrame(skin){return skin.publicFrame||[(skin.row?skin.row[2]:2)+(!skin.idleAnim?0:skin.animMirrorLeft?3:4),skin.colStand!=null?skin.colStand:skin.idleCol?skin.idleCol[0]:skin.col?skin.col[0]:skin.animCount==3?1:0];}
function calcThumbCrop(data,thumbSize){var sumRow=new Uint16Array(data.height);var sumCol=new Uint16Array(data.width);var p=3;for(var i=0;i<data.height;i++){for(var j=0;j<data.width;j++){var v=data.data[p];if(v>0){sumRow[i]+=v;sumCol[j]+=v;}
p+=4;}}
var minX0=0,minY0=0,maxX0=data.width-1,maxY0=data.height-1;while(minX0+2<maxX0&&sumCol[minX0]==0&&sumCol[maxX0]==0){minX0++;maxX0--;}
while(maxX0-minX0>=thumbSize&&sumCol[minX0]==0)
minX0++;while(maxX0-minX0>=thumbSize&&sumCol[maxX0]==0)
maxX0--;while(minY0+2<maxY0&&sumRow[minY0]==0&&sumRow[maxY0]==0){minY0++;maxY0--;}
while(maxY0-minY0>=thumbSize&&sumRow[minY0]==0)
minY0++;while(maxY0-minY0>=thumbSize&&sumRow[maxY0]==0)
maxY0--;var maxCropLength=~~(MAX_CROP_LENGTH_PERCENT/100*(data.height+data.width)/2);var maxCropArea=~~(MAX_CROP_AREA_PERCENT/100*data.height*data.width*255);var minX=minX0,minY=minY0,maxX=maxX0,maxY=maxY0;var cropL=0,cropR=0,sumL=0,sumR=0;while(maxX-minX>=thumbSize){var sumTL=sumL+sumCol[minX];var sumTR=sumR+sumCol[maxX];if(cropR==maxCropLength||sumTR>maxCropArea||cropL<maxCropLength&&sumTL<=maxCropArea&&sumTL<sumTR)
{sumL=sumTL;if(sumL)
cropL++;minX++;}else{sumR=sumTR;if(sumR)
cropR++;maxX--;}}
var cropU=0,cropD=0,sumU=0,sumD=0;while(maxY-minY>=thumbSize){var sumTU=sumU+sumRow[minY];var sumTD=sumD+sumRow[maxY];if(cropD==maxCropLength||sumTD>maxCropArea||cropU<maxCropLength&&sumTU<=maxCropArea&&sumTU<sumTD)
{sumU=sumTU;if(sumU)
cropU++;minY++;}else{sumD+=sumTD;if(sumD)
cropD++;maxY--;}}
if(cropL>maxCropLength||sumL>maxCropArea||cropU>maxCropLength||sumU>maxCropArea)
return new Rect(minX0,minY0,maxX0-minX0+1,maxY0-minY0+1);return new Rect(minX,minY,maxX-minX+1,maxY-minY+1);}
function calcStrictThumbCrop(data,dataWidth){var dataHeight=data.length/4/dataWidth;var sumRow=new Uint8Array(dataHeight);var sumCol=new Uint8Array(dataWidth);var p=3;for(var i=0;i<dataHeight;i++){for(var j=0;j<dataWidth;j++){if(data[p])
sumRow[i]=sumCol[j]=1;p+=4;}}
var minX0=0,minY0=0,maxX0=dataWidth-1,maxY0=dataHeight-1;while(!sumCol[minX0]&&minX0<maxX0)minX0++;while(!sumCol[maxX0]&&minX0<maxX0)maxX0--;while(!sumRow[minY0]&&minY0<maxY0)minY0++;while(!sumRow[maxY0]&&minY0<maxY0)maxY0--;return{x:minX0,y:minY0,w:maxX0-minX0+1,h:maxY0-minY0+1}}
function makeThumbForCanvas(srcCanvas,thumbSize){if(srcCanvas.width==thumbSize&&srcCanvas.height==thumbSize)
return srcCanvas;var crop;if(Math.max(srcCanvas.width,srcCanvas.height)>thumbSize){var srcImageData=srcCanvas.getContext('2d').getImageData(0,0,srcCanvas.width,srcCanvas.height);crop=calcThumbCrop(srcImageData,thumbSize);}else
crop=new Rect(0,0,srcCanvas.width,srcCanvas.height);var dstW,dstH,dstX,dstY;if(crop.w<=thumbSize&&crop.h<=thumbSize){dstW=crop.w;dstH=crop.h;dstX=~~((thumbSize-dstW)/2);dstY=~~((thumbSize-dstH)/2);}else{if(crop.w>crop.h){dstW=thumbSize;dstH=thumbSize/crop.w*crop.h;}else{dstH=thumbSize;dstW=thumbSize/crop.h*crop.w;}
dstX=(thumbSize-dstW)/2;dstY=(thumbSize-dstH)/2;}
var canvas=createCanvas(thumbSize,thumbSize);canvas.getContext('2d').drawImage(srcCanvas,crop.x,crop.y,crop.w,crop.h,dstX,dstY,dstW,dstH);return canvas;}
function makeThumbForUrl(path,asset,thumbSize,onDone,onError){var img=new Image();img.onload=function(){var skin=asset.skin||{}
var w=skin.frameWidth||32;var h=skin.frameHeight||w;var pf=getPublicFrame(skin);var canvas=createCanvas(w,h);canvas.getContext('2d').drawImage(img,w*pf[1],h*pf[0],w,h,0,0,w,h);onDone(makeThumbForCanvas(canvas,thumbSize));}
img.onerror=onError;img.src=path+asset.filename;}
function drawBigThumb(srcCanvas,srcCtx,srcWidth,srcHeight,renderWidth,dstCtx,dstSize,dstRow,srcX,srcY)
{dstRow=dstRow||0;srcX=srcX|0;srcY=srcY|0;var srcData=srcCtx.getImageData(srcX,srcY,srcWidth,srcHeight).data;var crop=calcStrictThumbCrop(srcData,srcWidth);var scale=renderWidth/srcWidth*(dstSize/SHOP_THUMB_CELL_SIZE);var intScale=~~Math.floor(scale+0.5);if(scale<=intScale*1.1&&scale>=intScale*0.95){scale=intScale;}
var maxScale=dstSize/Math.max(crop.w,crop.h);scale=Math.min(maxScale,scale);var rw=~~(crop.w*scale);var rh=~~(crop.h*scale);var yDown=~~Math.min((dstSize-rh)/2,dstSize/18);var y=dstSize-rh-yDown;var smoothing=scale!=~~scale;dstCtx.imageSmoothingEnabled=smoothing;dstCtx.webkitImageSmoothingEnabled=smoothing;dstCtx.mozImageSmoothingEnabled=smoothing;dstCtx.clearRect(0,dstRow*dstSize,dstSize,dstSize);dstCtx.drawImage(srcCanvas,srcX+crop.x,srcY+crop.y,crop.w,crop.h,(dstSize-rw)>>1,y+dstRow*dstSize,rw,rh);}
function makeBigThumbForCanvas(srcCanvas,renderWidth,thumbSize){var canvas=createCanvas(thumbSize,thumbSize);drawBigThumb(srcCanvas,srcCanvas.getContext("2d"),srcCanvas.width,srcCanvas.height,renderWidth,canvas.getContext("2d"),thumbSize,0);return canvas;}
function calcShadow(srcCtx,srcX,srcY,srcWidth,srcHeight){var minWidth=srcWidth*0.4;var maxWidth=srcWidth*0.8;var maxHeight=srcWidth*0.2;var heightWidthRatio=0.5;var analyzeHeight=~~(srcHeight*0.7);var dy=srcHeight-analyzeHeight;var srcData=srcCtx.getImageData(srcX,srcY+dy,srcWidth,analyzeHeight).data;var p=3;var maxY=-1;var sumMinX=0,sumMaxX=0,countX=0;for(var i=0;i<analyzeHeight;i++){var maxX,minX=-1;for(var j=0;j<srcWidth;j++){if(srcData[p]>128){maxY=i;if(minX<0)
minX=j;maxX=j;}
p+=4;}
if(maxY==i){sumMinX+=minX;sumMaxX+=maxX;countX++;}}
var minX=sumMinX/countX;var maxX=sumMaxX/countX;var w=maxX-minX;if(w<minWidth)
w=(w+minWidth)/2;if(w>maxWidth)
w=(w+maxWidth)/2;var h=w*heightWidthRatio;if(h>maxHeight)
h=(h+maxHeight)/2;return[~~((minX+maxX)/2),maxY+dy,~~w,~~h]}
function shadowStyle(meta){if(undef(meta))
return{};return{'left':''+meta[0]+'px','top':''+meta[1]+'px','width':''+meta[2]+'px','height':''+meta[3]+'px'}}
if(typeof exports!="undefined"){exports.SHOP_THUMB_SIZE=SHOP_THUMB_SIZE;exports.getPublicFrame=getPublicFrame;exports.drawBigThumb=drawBigThumb;exports.makeBigThumbForCanvas=makeBigThumbForCanvas;exports.makeThumbForUrl=makeThumbForUrl;exports.makeThumbForCanvas=makeThumbForCanvas;exports.calcShadow=calcShadow;}
var isOnServer=false;function checkSupportsSubarray(){var data;if(typeof document!="undefined"){var canvas=document.createElement('canvas');canvas.height=canvas.width=8;data=canvas.getContext('2d').getImageData(0,0,8,8).data;}else{data=new Uint8Array(10);}
return def(data.subarray);}
var supportsSubarray=checkSupportsSubarray();var __nativeST__=(typeof window=="undefined"?self:window).setTimeout;var mySetTimeout=function(vCallback,nDelay){var oThis=this,aArgs=Array.prototype.slice.call(arguments,2);return __nativeST__(vCallback instanceof Function?function(){vCallback.apply(oThis,aArgs);}:vCallback,nDelay);};function loadJson(url,onSuccess,onFail){$.getJSON(url).done(function(data,textStatus,jqxhr){if(typeof onSuccess!="undefined")
onSuccess(data);}).fail(function(jqxhr,textStatus,error){console.log("Loading JSON error: "+error);if(typeof onFail!="undefined")
onFail();});}
function createCanvas(w,h){var canvas=document.createElement('canvas');canvas.width=w;canvas.height=h;return canvas;}
base64decode=base64.decode;base64encode=base64.encode;
//@ sourceMappingURL=ctor.min.js.map