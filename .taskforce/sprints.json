{
  "currentSprintNumber": 4,
  "sprints": [
    {
      "sprintNumber": 1,
      "type": "sprint",
      "prompt": "This sprint establishes player identity and fixes the most visible UX gaps in the existing game. Implement a player nickname system where players enter a custom nickname before connecting — the nickname is sent at connection time, stored on the server-side player object, and included in all subsequent broadcasts (join, movement, status). Fix chat sender attribution so messages display the actual sender's nickname instead of a hardcoded placeholder. Add a character skin selection screen shown before connecting, allowing players to preview and choose from the 24 existing character sprite sheets in the assets — the selected skin ID is transmitted at connection time and used in all appearance broadcasts. Build a full-screen loading overlay with a progress indicator that displays while game assets (map sprites, character sheets, bomb sprites) are fetched, dismissing only when all assets are ready and the world is initialized. Add a connection state overlay/toast that appears when the WebSocket connection is lost, showing reconnect status, and updating when restored or permanently failed. Finally, add a favicon, ensure the page title works across browsers, and add Open Graph meta tags (title, description, image) plus a meta description for SEO and social link previews.",
      "tasks": [
        {
          "id": "task-1",
          "title": "Node.js WebSocket game server — core setup",
          "description": "Create the Node.js WebSocket game server to replace the Java `server.jar`. This is the foundational server that all other features depend on.\n\n**Create file: `server.js`** (root of project)\n\n**Dependencies**: `ws` (WebSocket library) — run `npm init -y && npm install ws`\n\n**What to build:**\n1. Create `package.json` with `ws` dependency and start script\n2. In `server.js`:\n   - Import `ws` and `http` modules\n   - Create WebSocket server on port **9998** (same as original Java server)\n   - Maintain a `players` Map keyed by WebSocket connection: `{ id, nickname, skinId, x, y, dir, speed, bytedir, isMoving, alive }`\n   - Auto-increment player IDs starting from 1\n   - Handle `^`-separated packet protocol (split incoming data by `^`, process each packet)\n   - Implement broadcast helper: `broadcast(message, excludeWs)` sends to all connected clients\n   - Implement `broadcastAll(message)` sends to everyone\n\n3. **World management:**\n   - Load map data from `assets/maps/` — parse the tileset and generate a default world grid (40×30 tiles)\n   - On client connect + `WL` request: send `WL{width}|{height}|{tileData}` with semicolon-separated tile values\n   - On `WE` request: send existing players and bombs to the newly connected client\n   - Store world state in memory\n\n4. **Player lifecycle:**\n   - On new `NI{nickname}|{skinId}` message: store nickname and skinId on the player object\n   - On `WE` (entities request): send `PA{id}|{x}|{y}|{dir}|{skinId}|{speed}|1` to the requesting client for itself, and `PA{id}|{x}|{y}|{dir}|{skinId}|{speed}|0` for all other players. Broadcast `PA{newId}|{x}|{y}|{dir}|{skinId}|{speed}|0` to all OTHER clients for the new player.\n   - Spawn position: random walkable tile × 32\n   - On disconnect: broadcast `PD{id}` to all remaining clients, remove from players map\n\n5. **Input handling:**\n   - On `KD{keycode},{time}` and `KU{keycode},{time}`: update player's server-side movement state (bytedir, direction, isMoving)\n   - Compute movement server-side at 60fps tick using same logic as client (`speed * deltaTime`, bytedir bitmask: 4=up, 8=right, 16=down, 32=left)\n   - Broadcast `PM{id}|{x}|{y}|{dir}|{skinId}|{bytedir}|{isMoving}|{time}` to all clients on each movement tick\n   - Handle `PM1|{x}|{y}|{animname}|{animid}` position sync from clients\n\n6. **Bomb handling:**\n   - On space key (keycode 32 in KD): create bomb at player's tile position, assign bomb ID, broadcast `BA{bombId}|{x}|{y}|{range}`\n   - After 3 seconds: compute explosion ranges (check wall collisions), broadcast `BE{bombId}|{sup}|{down}|{left}|{right}`\n   - Update world cells for destroyed blocks (broadcast `WC{tileId}|{x}|{y}`)\n\n7. **Item system:**\n   - On block destruction: random chance to spawn item, broadcast `IA{itemId}|{templateId}|{x}|{y}`\n   - On player walking over item: apply effect (speed boost = templateId 0), broadcast `ID{itemId}|...` and `IS{playerId}|{newSpeed}`\n\n**Acceptance criteria:**\n- Server starts on port 9998 with `node server.js`\n- Multiple browser tabs can connect and see each other\n- Players can move, place bombs, see explosions\n- Same protocol as documented in PROJECT.md\n\n**Also update `http_server.js`**: Change CSS links to use relative paths (remove `http://localhost/test/` prefix) so the static server properly serves all files.",
          "status": "done",
          "priority": "high",
          "assignee": "developer-2",
          "assigneeRole": "developer",
          "dependencies": [],
          "files": [
            "server.js",
            "package.json",
            "http_server.js"
          ],
          "branch": "agent/developer-2",
          "createdBy": "ceo",
          "checkResult": "Implemented Node.js WebSocket game server (server.js) on port 9998 replacing Java server.jar. Faithful port of the Java server logic: map generation (80x42 with destructible/indestructible walls), player lifecycle (spawn/disconnect/respawn), server-side movement at 60fps with collision detection, bomb system with 3s timer and chain explosions, item drops from broken walls (speed/range/bomb powerups), chat relay, NI message support for nickname+skin. Also created http_server.js (static files on port 8060), package.json with ws dependency, and fixed CSS paths in index.html from absolute to relative.",
          "createdAt": 1771982765731,
          "updatedAt": 1771983541274
        },
        {
          "id": "task-2",
          "title": "Pre-connect lobby screen: nickname input + skin selection",
          "description": "Build a pre-connect lobby screen shown BEFORE the WebSocket connection is established. This screen has two sections: nickname entry and character skin selection.\n\n**Modify: `index.html`** — Add lobby overlay HTML\n**Create: `css/lobby.css`** — Lobby-specific styles\n**Modify: `js/globals.js`** — Add `playerNickname` and `playerSkinId` global variables\n\n**What to build:**\n\n1. **HTML structure** (add to `index.html` before the viewport div):\n```html\n<div id=\"lobby-screen\">\n  <div class=\"lobby-container\">\n    <h1 class=\"lobby-title\">Game of Bombs</h1>\n    <div class=\"lobby-nickname\">\n      <label for=\"nickname-input\">Enter your nickname</label>\n      <input type=\"text\" id=\"nickname-input\" maxlength=\"16\" placeholder=\"Player\" autocomplete=\"off\">\n    </div>\n    <div class=\"lobby-skins\">\n      <h2>Choose your character</h2>\n      <div id=\"skin-grid\" class=\"skin-grid\">\n        <!-- 24 skin cards generated by JS -->\n      </div>\n    </div>\n    <button id=\"play-btn\" class=\"play-btn\" disabled>PLAY</button>\n  </div>\n</div>\n```\n\n2. **Skin grid** (`js/lobby.js` — new file):\n   - On DOMContentLoaded, populate `#skin-grid` with 24 cards (skins 0–23)\n   - Each card: `<div class=\"skin-card\" data-skin-id=\"N\"><canvas width=\"32\" height=\"32\"></canvas><span>Skin N</span></div>`\n   - For each card, load `assets/characters/N.png`, draw frame 0 (first frame of \"down\" animation = frame index 8 in a 4×4 grid) onto the card's canvas\n   - On click: add `.selected` class (remove from previous), set `playerSkinId = N`\n   - Default: skin 0 is pre-selected\n\n3. **Nickname validation:**\n   - Enable PLAY button only when: nickname is 1–16 chars AND a skin is selected\n   - On input: trim whitespace, reject empty\n   - Store in global `playerNickname`\n\n4. **PLAY button:**\n   - On click: hide `#lobby-screen` (display:none), call `preload()` which begins asset loading and socket connection\n   - Crucially, `preload()` should NOT auto-run on DOMContentLoaded anymore — it must wait for the PLAY button\n\n5. **Modify `js/initworld.js`:**\n   - Remove the `window.addEventListener(\"DOMContentLoaded\", preload)` auto-start\n   - Instead, the lobby's PLAY button handler calls `preload()`\n\n6. **CSS (`css/lobby.css`):**\n   - Full-screen overlay, dark background (rgba(0,0,0,0.92)), centered content\n   - Lobby title: large, white, game-style font\n   - Nickname input: large, dark-themed input with border highlight on focus\n   - Skin grid: CSS grid, 6 columns, gap 12px, scrollable if needed\n   - Skin card: 80×100px, dark bg (#2a2a2a), border-radius 8px, hover effect (border color change)\n   - Selected card: bright border (#ffcc00), subtle glow\n   - PLAY button: large, green (#4CAF50), full-width max 300px, disabled state greyed out\n   - Responsive: 4 columns on smaller screens\n\n**Acceptance criteria:**\n- Page loads showing lobby screen, NOT the game\n- 24 character skins displayed as preview thumbnails in a grid\n- Player types nickname, selects skin, clicks PLAY\n- Game starts only after PLAY button\n- `playerNickname` and `playerSkinId` globals are set and accessible\n\n**Script tag**: Add `<link rel=\"stylesheet\" href=\"css/lobby.css\">` and `<script src=\"js/lobby.js\"></script>` to index.html (lobby.js BEFORE initworld.js).",
          "status": "done",
          "priority": "high",
          "assignee": "developer-2",
          "assigneeRole": "developer",
          "dependencies": [
            "task-1"
          ],
          "files": [
            "index.html",
            "css/lobby.css",
            "js/lobby.js",
            "js/globals.js",
            "js/initworld.js"
          ],
          "branch": "agent/developer-2",
          "createdBy": "ceo",
          "checkResult": "Implemented lobby screen: full-screen dark overlay with nickname input (1-16 chars validation), 24-skin selection grid with sprite preview thumbnails (frame 8 = down-facing), PLAY button that hides lobby and calls preload(). Added playerNickname/playerSkinId globals. Removed DOMContentLoaded auto-start — game only starts after PLAY. Responsive CSS (6 cols desktop, 4 cols mobile).",
          "createdAt": 1771982791118,
          "updatedAt": 1771983865439
        },
        {
          "id": "task-3",
          "title": "Send nickname + skin at connection time",
          "description": "Wire the nickname and skin selection from the lobby into the WebSocket connection handshake so the server receives them.\n\n**Modify: `js/aks.js`** — Update `InitializeSocket()` to send nickname and skin on connect\n**Modify: `server.js`** — Handle the new `NI` message type\n\n**What to change:**\n\n1. **`js/aks.js` — `InitializeSocket()` function:**\n   - In `socket.onopen`, BEFORE sending `WL`, send `NI{playerNickname}|{playerSkinId}`\n   - This uses the globals set by the lobby screen\n   - Example: if nickname=\"Bob\" and skinId=5, send `NI Bob|5`\n   - Then send `WL` as before\n\n2. **`server.js` — handle `NI` message:**\n   - On receiving `NI{data}`: parse `nickname = data.split('|')[0]`, `skinId = parseInt(data.split('|')[1])`\n   - Store on the player object: `player.nickname = nickname`, `player.skinId = skinId`\n   - Validate: nickname max 16 chars, skinId 0-23. Default to \"Player\" and 0 if invalid.\n\n3. **`server.js` — update PA broadcast format:**\n   - Change player add broadcast to include nickname: `PA{id}|{x}|{y}|{dir}|{skinId}|{speed}|{isCurrent}|{nickname}`\n   - Nickname is appended as the LAST field (index 7) to maintain backward compatibility with existing fields\n\n4. **`server.js` — update PM broadcast format:**\n   - Movement broadcasts already include skin. Add nickname as last field: `PM{id}|{x}|{y}|{dir}|{skinId}|{bytedir}|{isMoving}|{time}|{nickname}`\n\n5. **`js/aks.js` — update PA handler (case \"P\", action \"A\"):**\n   - Parse nickname from index 7: `var nickname = received_msg.substring(2).split(\"|\")[7] || \"Player\";`\n   - Pass nickname to `world.addplayer(id, x, y, dir, skin, speed, bcurrent, nickname)`\n\n6. **`js/aks.js` — update PM handler (case \"P\", action \"M\"):**\n   - Parse nickname from index 8: `var nickname = received_msg.substring(2).split(\"|\")[8] || \"Player\";`\n   - Pass nickname to `world.moveplayer(...)` (add parameter)\n\n7. **`js/world/world.js` — update `addplayer()` and `moveplayer()`:**\n   - `addplayer(id, x, y, dir, skin, speed, bcurrent, nickname)`: set `p.nickname = nickname`\n   - `moveplayer(id, x, y, dir, skin, isMoving, bytedir, timeDiff, nickname)`: set `player.nickname = nickname`\n\n8. **`js/player/player.js`:**\n   - Add `this.nickname = \"Player\"` in Player constructor\n   - In `this.print()`, change the `drawtext` call (line 153) to use `this.nickname` instead of `\"player\" + this.id`:\n     ```js\n     fosfo1.drawtext(\"player\" + this.id, this.nickname, ...)\n     ```\n\n**Acceptance criteria:**\n- Server receives and stores nickname + skinId on connect\n- All PA/PM broadcasts include nickname\n- Player name label above character shows actual nickname, not \"playerN\"\n- Multiple players see each other's nicknames",
          "status": "done",
          "priority": "high",
          "assignee": "developer-2",
          "assigneeRole": "developer",
          "dependencies": [
            "task-1",
            "task-2"
          ],
          "files": [
            "js/aks.js",
            "server.js",
            "js/world/world.js",
            "js/player/player.js"
          ],
          "branch": "agent/developer-2",
          "createdBy": "ceo",
          "checkResult": "Wired nickname + skin from lobby into WebSocket connection: client sends NI{nickname}|{skinId} on connect, server validates and stores on player object. All PA/PM/PS broadcasts now include nickname as last field. Client handlers parse nickname and pass to world.addplayer/moveplayer which store it on player. Nicknames rendered above player sprites with text shadow in the render loop. Also fixed removeplayer to accept id parameter matching how aks.js calls it.",
          "createdAt": 1771982810355,
          "updatedAt": 1771984388752
        },
        {
          "id": "task-4",
          "title": "Fix chat sender attribution — display actual nicknames",
          "description": "Fix the chat system so messages display the sender's actual nickname instead of the hardcoded \"unknow\" placeholder.\n\n**Modify: `js/chat.js`** — Update `addmessagetochat()` to parse and display sender nickname\n**Modify: `server.js`** — Update chat message broadcast to include sender nickname\n**Modify: `js/aks.js`** — Update MN handler to pass nickname to chat\n\n**What to change:**\n\n1. **`server.js` — chat message handling:**\n   - On receiving `MN{text}` from a client:\n     - Look up the sender's player object to get their nickname\n     - Broadcast to ALL clients (including sender): `MN{senderNickname}|{messageText}`\n     - The `|` separates nickname from message text\n\n2. **`js/aks.js` — update MN handler:**\n   - Currently at line 108: `addmessagetochat(received_msg.substring(2));`\n   - Change to parse nickname and text:\n     ```js\n     case \"N\":\n       var chatData = received_msg.substring(2);\n       var separatorIdx = chatData.indexOf('|');\n       var senderNick = chatData.substring(0, separatorIdx);\n       var chatText = chatData.substring(separatorIdx + 1);\n       addmessagetochat(senderNick, chatText);\n     break;\n     ```\n\n3. **`js/chat.js` — update `addmessagetochat(nickname, data)`:**\n   - Change function signature from `addmessagetochat(data)` to `addmessagetochat(nickname, data)`\n   - Replace the hardcoded \"unknow\" with the `nickname` parameter:\n     ```js\n     var addmessagetochat = function(nickname, data) {\n       var elem = document.createElement(\"li\");\n       elem.setAttribute(\"class\", \"ng-scope\");\n       elem.innerHTML = '<span><b class=\"nickname ng-binding\">' + escapeHtml(nickname) + '</b>'\n         + ':</span><span class=\"text\">'\n         + '<span class=\"ng-binding ng-scope\">' + escapeHtml(data) + '</span>'\n         + '</span>';\n       var chat = document.getElementById(\"endchat\");\n       var parentdiv = chat.parentNode;\n       parentdiv.insertBefore(elem, chat);\n       // Auto-scroll to bottom\n       var chatList = document.getElementById(\"listChat\");\n       chatList.scrollTop = chatList.scrollHeight;\n     };\n     ```\n   - Add `escapeHtml` helper at the top of chat.js to prevent XSS:\n     ```js\n     function escapeHtml(str) {\n       var div = document.createElement('div');\n       div.textContent = str;\n       return div.innerHTML;\n     }\n     ```\n\n4. **Highlight own messages:**\n   - Compare `nickname` with `playerNickname` (global from lobby)\n   - If it matches, add class `my-msg` to the `<b>` tag for CSS styling\n\n**Acceptance criteria:**\n- Chat messages show sender's actual nickname (e.g., \"Bob: hello everyone\")\n- No more \"unknow\" placeholder\n- Own messages highlighted with `my-msg` class\n- HTML entities properly escaped (XSS prevention)\n- Chat auto-scrolls to latest message",
          "status": "done",
          "priority": "medium",
          "assignee": "developer-2",
          "assigneeRole": "developer",
          "dependencies": [
            "task-3"
          ],
          "files": [
            "js/chat.js",
            "js/aks.js",
            "server.js"
          ],
          "branch": "agent/developer-2",
          "createdBy": "ceo",
          "checkResult": "Fixed chat sender attribution: server now broadcasts MN{nickname}|{text}, client parses nickname and text via | separator. addmessagetochat takes (nickname, data) params, displays actual sender nickname with escapeHtml XSS prevention. Own messages get my-msg class for highlighting. Chat auto-scrolls to latest message. Removed hardcoded \"unknow\" placeholder.",
          "createdAt": 1771982827107,
          "updatedAt": 1771984677945
        },
        {
          "id": "task-5",
          "title": "Full-screen loading overlay with progress indicator",
          "description": "Build a full-screen loading overlay that displays while game assets are being fetched. It shows a progress bar and asset loading status. Dismisses only when ALL assets are loaded AND the world is initialized.\n\n**Create: `js/loading.js`** — Loading overlay logic\n**Create: `css/loading.css`** — Loading overlay styles\n**Modify: `index.html`** — Add loading overlay HTML and script/link tags\n**Modify: `js/initworld.js`** — Integrate loading progress tracking\n\n**What to build:**\n\n1. **HTML** (add to `index.html`, after lobby-screen div):\n```html\n<div id=\"loading-screen\" style=\"display:none;\">\n  <div class=\"loading-container\">\n    <h2 class=\"loading-title\">Loading Game...</h2>\n    <div class=\"loading-bar-outer\">\n      <div class=\"loading-bar-inner\" id=\"loading-bar\"></div>\n    </div>\n    <div class=\"loading-status\" id=\"loading-status\">Preparing...</div>\n    <div class=\"loading-detail\" id=\"loading-detail\"></div>\n  </div>\n</div>\n```\n\n2. **`js/loading.js`** — Loading manager:\n```js\nvar LoadingManager = {\n  totalAssets: 0,\n  loadedAssets: 0,\n  show: function() { document.getElementById('loading-screen').style.display = 'flex'; },\n  hide: function() { document.getElementById('loading-screen').style.display = 'none'; },\n  setTotal: function(n) { this.totalAssets = n; this.loadedAssets = 0; },\n  assetLoaded: function(name) {\n    this.loadedAssets++;\n    var pct = Math.round((this.loadedAssets / this.totalAssets) * 100);\n    document.getElementById('loading-bar').style.width = pct + '%';\n    document.getElementById('loading-detail').textContent = name;\n    document.getElementById('loading-status').textContent = 'Loading assets... ' + pct + '%';\n  },\n  setStatus: function(text) {\n    document.getElementById('loading-status').textContent = text;\n  },\n  worldReady: function() {\n    this.setStatus('World initialized!');\n    var self = this;\n    setTimeout(function() { self.hide(); }, 300);\n  }\n};\n```\n\n3. **Modify `js/initworld.js` — `preload()` function:**\n   - After hiding lobby screen, show loading screen: `LoadingManager.show()`\n   - Count total assets to load: map sprite (1) + character sheet for selected skin (1) + bomb sprite (1) + explosion sprite (1) + item sprite (1) + red-pixel (1) = **6 assets minimum** + any character sheets for other connected players\n   - Set `LoadingManager.setTotal(6)`\n   - Hook into `fosfo.loadimage()` completion — after each image loads, call `LoadingManager.assetLoaded(imageName)`\n   - The existing preload chain: `fosfo0.loadimage(['assets/maps/1.png']).done(...)` then `fosfo1.loadimage([...]).done(...)` then `InitializeSocket()`\n   - After `initWorld()` is called (inside `socket.onopen` → `WL` response → world creation), call `LoadingManager.worldReady()`\n\n4. **Modify the fosfo loadimage to report progress:**\n   - In the `im.onload` callback in `preload()`, call `LoadingManager.assetLoaded(url)` for each loaded image\n\n5. **Integration flow:**\n   - User clicks PLAY → lobby hides → loading screen shows\n   - Assets load with progress bar updating (0% → 100%)\n   - WebSocket connects → world data received → `initWorld()` → `LoadingManager.worldReady()`\n   - Loading screen fades out, game canvas visible\n\n6. **CSS (`css/loading.css`):**\n   - Full-screen overlay: position fixed, top 0, left 0, 100vw × 100vh, background #111, z-index 10000, display flex, center content\n   - Loading title: white, 24px\n   - Progress bar outer: 400px wide, 12px tall, dark bg (#333), border-radius 6px\n   - Progress bar inner: green (#4CAF50), height 100%, border-radius 6px, transition width 0.3s\n   - Status text: white, 14px, margin-top 12px\n   - Detail text: grey (#888), 12px\n\n**Acceptance criteria:**\n- Loading screen appears immediately after clicking PLAY\n- Progress bar smoothly fills as assets load\n- Shows which asset is currently loading\n- Disappears only after world is fully initialized\n- No game canvas flickering during load",
          "status": "done",
          "priority": "medium",
          "assignee": "developer-1",
          "assigneeRole": "developer",
          "dependencies": [
            "task-2"
          ],
          "files": [
            "js/loading.js",
            "css/loading.css",
            "index.html",
            "js/initworld.js"
          ],
          "branch": "agent/developer-1",
          "createdBy": "ceo",
          "checkResult": "Created full-screen loading overlay with progress bar. Added LoadingManager (js/loading.js) that tracks 6 assets: map sprite, bomb sprite, explosion sprite, item sprite, server connection, and world data. Progress bar fills smoothly as each asset loads, shows current asset name, and fades out after world initialization. CSS overlay with dark background (#111), green progress bar (#4CAF50), and fade animations. Integrated into preload() in initworld.js and WL handler in aks.js.",
          "createdAt": 1771982851116,
          "updatedAt": 1771984216113
        },
        {
          "id": "task-6",
          "title": "Connection state overlay — disconnect/reconnect UI",
          "description": "Add a connection state overlay/toast that appears when the WebSocket connection is lost. Shows reconnect status with attempt count, updates when restored, shows permanent failure after max retries.\n\n**Create: `js/connection-status.js`** — Connection state manager\n**Create: `css/connection-status.css`** — Styles for the overlay/toast\n**Modify: `index.html`** — Add HTML and script/link tags\n**Modify: `js/aks.js`** — Integrate connection state tracking\n\n**What to build:**\n\n1. **HTML** (add to `index.html`):\n```html\n<div id=\"connection-overlay\" style=\"display:none;\">\n  <div class=\"connection-toast\">\n    <div class=\"connection-icon\" id=\"connection-icon\">&#x26A0;</div>\n    <div class=\"connection-text\" id=\"connection-text\">Connection lost</div>\n    <div class=\"connection-detail\" id=\"connection-detail\">Reconnecting...</div>\n  </div>\n</div>\n```\n\n2. **`js/connection-status.js`** — ConnectionStatus manager:\n```js\nvar ConnectionStatus = {\n  maxRetries: 10,\n  currentRetry: 0,\n  isConnected: false,\n  overlay: null,\n  \n  init: function() {\n    this.overlay = document.getElementById('connection-overlay');\n  },\n  \n  onConnected: function() {\n    this.isConnected = true;\n    this.currentRetry = 0;\n    if (this.overlay.style.display !== 'none') {\n      // Show \"Reconnected!\" briefly, then hide\n      document.getElementById('connection-icon').innerHTML = '&#x2714;';\n      document.getElementById('connection-text').textContent = 'Reconnected!';\n      document.getElementById('connection-detail').textContent = '';\n      this.overlay.classList.add('success');\n      var self = this;\n      setTimeout(function() {\n        self.overlay.style.display = 'none';\n        self.overlay.classList.remove('success');\n      }, 2000);\n    }\n  },\n  \n  onDisconnected: function() {\n    this.isConnected = false;\n    this.overlay.style.display = 'flex';\n    this.overlay.classList.remove('success');\n    document.getElementById('connection-icon').innerHTML = '&#x26A0;';\n    document.getElementById('connection-text').textContent = 'Connection lost';\n    this.updateRetryInfo();\n  },\n  \n  onRetrying: function(attempt) {\n    this.currentRetry = attempt;\n    this.updateRetryInfo();\n  },\n  \n  updateRetryInfo: function() {\n    if (this.currentRetry >= this.maxRetries) {\n      document.getElementById('connection-detail').textContent = 'Failed to reconnect. Please refresh the page.';\n      document.getElementById('connection-icon').innerHTML = '&#x2716;';\n      this.overlay.classList.add('failed');\n    } else {\n      document.getElementById('connection-detail').textContent = \n        'Reconnecting... (attempt ' + (this.currentRetry + 1) + '/' + this.maxRetries + ')';\n    }\n  },\n  \n  onPermanentFailure: function() {\n    document.getElementById('connection-detail').textContent = 'Failed to reconnect. Please refresh the page.';\n    document.getElementById('connection-icon').innerHTML = '&#x2716;';\n    this.overlay.classList.add('failed');\n  }\n};\n```\n\n3. **Modify `js/aks.js` — `InitializeSocket()`:**\n   - Add retry counter: `var reconnectAttempt = 0;`\n   - In `socket.onopen`: call `ConnectionStatus.onConnected();` and reset `reconnectAttempt = 0;`\n   - In `socket.onclose`: call `ConnectionStatus.onDisconnected();` then on each retry call `ConnectionStatus.onRetrying(reconnectAttempt++);`\n   - After `maxRetries` (10) attempts: stop retrying, call `ConnectionStatus.onPermanentFailure();`\n   - Current behavior: `setTimeout(InitializeSocket, 1000)` with no limit — add retry logic:\n     ```js\n     socket.onclose = function() {\n       if (reconnectAttempt < ConnectionStatus.maxRetries) {\n         ConnectionStatus.onDisconnected();\n         ConnectionStatus.onRetrying(reconnectAttempt);\n         reconnectAttempt++;\n         setTimeout(InitializeSocket, 2000);\n       } else {\n         ConnectionStatus.onPermanentFailure();\n       }\n     };\n     ```\n\n4. **CSS (`css/connection-status.css`):**\n   - Overlay: position fixed, top 0, left 0, 100vw × 100vh, background rgba(0,0,0,0.6), z-index 9999, display flex, center content\n   - Toast: background #333, padding 24px 32px, border-radius 12px, text-align center, min-width 320px\n   - Icon: font-size 48px, color #ff9800 (warning orange)\n   - Text: white, 18px, font-weight 600\n   - Detail: #aaa, 14px, margin-top 8px\n   - `.success` state: icon color #4CAF50 (green)\n   - `.failed` state: icon color #f44336 (red)\n   - Subtle fade-in animation on overlay appear\n\n**Acceptance criteria:**\n- When WebSocket disconnects, overlay appears immediately with warning icon\n- Shows \"Reconnecting... (attempt 1/10)\" and increments\n- On successful reconnect: shows green checkmark \"Reconnected!\" for 2s, then hides\n- After 10 failed attempts: shows red X \"Failed to reconnect. Please refresh the page.\"\n- Does NOT show on initial connection (only on disconnect after being connected)",
          "status": "done",
          "priority": "medium",
          "assignee": "developer-1",
          "assigneeRole": "developer",
          "dependencies": [
            "task-1",
            "task-2"
          ],
          "files": [
            "js/connection-status.js",
            "css/connection-status.css",
            "index.html",
            "js/aks.js"
          ],
          "branch": "agent/developer-1",
          "createdBy": "ceo",
          "checkResult": "Created connection state overlay with disconnect/reconnect UI. Added ConnectionStatus manager (js/connection-status.js) tracking connection state with max 10 retries at 2s intervals. Shows warning overlay on disconnect with attempt counter, green checkmark on reconnect (auto-hides after 2s), red X with permanent failure message after max retries. Only appears after initial connection is established (not during first connect). Integrated into aks.js onopen/onclose handlers. CSS overlay with semi-transparent background and toast-style notification.",
          "createdAt": 1771982873026,
          "updatedAt": 1771984315622
        },
        {
          "id": "task-7",
          "title": "Favicon, page title, Open Graph meta tags, SEO",
          "description": "Add a favicon, fix the page title for cross-browser compatibility, and add Open Graph meta tags + meta description for SEO and social link previews.\n\n**Create: `assets/favicon.svg`** — SVG bomb favicon\n**Modify: `index.html`** — Add meta tags, favicon link, fix title\n**Create: `assets/og-image.png`** — Open Graph preview image (can be a screenshot or the existing logo)\n\n**What to build:**\n\n1. **Favicon (`assets/favicon.svg`):**\n   - Create a simple SVG bomb icon (circle with fuse) in game colors\n   - SVG content: black circle bomb body, short fuse line, orange spark at tip\n   - Keep it simple and recognizable at 32×32\n\n2. **Fix `<title>` tag in `index.html`:**\n   - Current: `<title ng-bind=\"'title' | i18n\" class=\"ng-binding\">Game of Bombs</title>`\n   - This has Angular binding attributes that are meaningless (no Angular in this project)\n   - Replace with plain: `<title>Game of Bombs — Multiplayer Bomberman</title>`\n\n3. **Add to `<head>` in `index.html`:**\n```html\n<!-- Favicon -->\n<link rel=\"icon\" type=\"image/svg+xml\" href=\"/assets/favicon.svg\">\n<link rel=\"icon\" type=\"image/png\" sizes=\"32x32\" href=\"/assets/favicon.svg\">\n\n<!-- Meta Description -->\n<meta name=\"description\" content=\"Game of Bombs — Free multiplayer Bomberman game. Play online with friends, place bombs, collect power-ups, and dominate the arena!\">\n<meta charset=\"utf-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n\n<!-- Open Graph -->\n<meta property=\"og:type\" content=\"website\">\n<meta property=\"og:title\" content=\"Game of Bombs — Multiplayer Bomberman\">\n<meta property=\"og:description\" content=\"Free multiplayer Bomberman game. Play online with friends, place bombs, collect power-ups, and dominate the arena!\">\n<meta property=\"og:image\" content=\"/assets/og-image.png\">\n<meta property=\"og:url\" content=\"\">\n\n<!-- Twitter Card -->\n<meta name=\"twitter:card\" content=\"summary_large_image\">\n<meta name=\"twitter:title\" content=\"Game of Bombs — Multiplayer Bomberman\">\n<meta name=\"twitter:description\" content=\"Free multiplayer Bomberman game. Play online with friends!\">\n<meta name=\"twitter:image\" content=\"/assets/og-image.png\">\n```\n\n4. **Open Graph image (`assets/og-image.png`):**\n   - Use the existing logo at `i/land/logo.png` — copy it as `assets/og-image.png`\n   - OR create a simple 1200×630 image with the game title and a character sprite on a dark background\n   - If using the existing logo, just reference it directly in the OG tag\n\n5. **Clean up index.html `<head>`:**\n   - Remove the Angular-specific attributes (`ng-bind`, `ng-controller`, `ng-scope`, `ng-show`, `ng-click` etc.) from the title and any other tags where they serve no purpose\n   - Fix the CSS link paths: change `href=\"http://localhost/test/css/...\"` to `href=\"./css/...\"` (relative paths)\n\n**Acceptance criteria:**\n- Browser tab shows a bomb favicon\n- Page title reads \"Game of Bombs — Multiplayer Bomberman\" in all browsers\n- Sharing the URL on social media (Discord, Twitter, Facebook) shows: title, description, and preview image\n- `<meta name=\"description\">` present for Google indexing\n- `<meta charset=\"utf-8\">` and viewport meta present\n- No broken CSS links (relative paths work with http_server.js)",
          "status": "done",
          "priority": "low",
          "assignee": "developer-1",
          "assigneeRole": "developer",
          "dependencies": [],
          "files": [
            "index.html",
            "assets/favicon.svg"
          ],
          "branch": "agent/developer-1",
          "createdBy": "ceo",
          "checkResult": "Added SVG bomb favicon, generated 1200x630 OG preview image from existing logo, added meta charset/viewport/description, Open Graph and Twitter Card meta tags, fixed page title (removed Angular binding), fixed CSS paths from absolute localhost to relative, cleaned up all Angular-specific attributes from HTML.",
          "createdAt": 1771982894366,
          "updatedAt": 1771983227042
        },
        {
          "id": "task-8",
          "title": "Lobby screen visual polish and responsive design",
          "description": "Style the pre-connect lobby screen (nickname + skin selection) to be visually polished and responsive. This task focuses purely on CSS/visual design.\n\n**Modify: `css/lobby.css`** — Comprehensive styling for the lobby\n**Modify: `index.html`** — Minor HTML tweaks for styling hooks if needed\n\n**Design requirements:**\n\n1. **Overall layout:**\n   - Full-screen dark overlay: `background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)`\n   - Centered container, max-width 700px, padding 40px\n   - Subtle backdrop blur effect on the background\n\n2. **Title \"Game of Bombs\":**\n   - Large (36px), bold, white with subtle text-shadow (0 0 20px rgba(255,165,0,0.5))\n   - Uses the existing 'pix' font-face or falls back to sans-serif\n   - Margin-bottom 30px\n\n3. **Nickname input:**\n   - Width 100%, max-width 400px, centered\n   - Height 48px, font-size 18px\n   - Background #1a1a2e, border 2px solid #333, border-radius 8px\n   - Focus: border-color #ffcc00, box-shadow 0 0 8px rgba(255,204,0,0.3)\n   - Color white, placeholder color #666\n   - Label: white, 14px, uppercase, letter-spacing 1px, margin-bottom 8px\n\n4. **Skin grid:**\n   - CSS Grid: 6 columns on desktop, 4 on tablet (< 768px), 3 on mobile (< 480px)\n   - Gap: 12px\n   - Max-height 320px with overflow-y auto (custom scrollbar: thin, dark)\n   - Section title \"Choose your character\": white, 18px, margin 24px 0 16px\n\n5. **Skin card:**\n   - Width auto, aspect-ratio roughly 1:1.2\n   - Background #222, border 2px solid #444, border-radius 8px\n   - Padding 8px, text-align center\n   - Canvas centered in card\n   - Label below canvas: #aaa, 11px\n   - Hover: border-color #ffcc00, transform scale(1.05), transition 0.2s\n   - Selected: border-color #ffcc00, background #2a2a1e, box-shadow 0 0 12px rgba(255,204,0,0.4)\n\n6. **PLAY button:**\n   - Max-width 300px, width 100%, height 52px, margin-top 24px\n   - Background: linear-gradient(135deg, #4CAF50, #45a049)\n   - Color white, font-size 18px, font-weight 700, letter-spacing 2px, text-transform uppercase\n   - Border: none, border-radius 8px, cursor pointer\n   - Hover: brightness(1.1), transform scale(1.02)\n   - Active: transform scale(0.98)\n   - Disabled: background #555, color #888, cursor not-allowed, no hover effects\n   - Transition all 0.2s\n\n7. **Animations:**\n   - Lobby container: fade-in on load (opacity 0→1, translateY 20px→0, duration 0.5s)\n   - Skin cards: stagger appearance (animation-delay based on index) — optional, CSS only\n\n**Acceptance criteria:**\n- Lobby looks polished and game-themed (dark, neon accents)\n- Responsive on desktop, tablet, and mobile\n- Smooth hover/selection animations\n- Custom scrollbar in skin grid on Chrome/Firefox\n- No layout shifts or overflow issues",
          "status": "done",
          "priority": "low",
          "assignee": "designer-1",
          "assigneeRole": "designer",
          "dependencies": [
            "task-2"
          ],
          "files": [
            "css/lobby.css",
            "index.html"
          ],
          "branch": "agent/designer-1",
          "createdBy": "ceo",
          "checkResult": "Polished lobby CSS: gradient bg (#1a1a2e→#16213e→#0f3460), 'pix' font title with orange text-shadow, #ffcc00 neon accents on focus/selected states, skin grid responsive (6col→4col→3col), skin cards with aspect-ratio, scale hover, stagger animation, green gradient PLAY button with brightness/scale transitions, custom scrollbar for Chrome/Firefox, lobby fade-in animation. No HTML changes needed.",
          "createdAt": 1771982915456,
          "updatedAt": 1771984085185
        },
        {
          "id": "task-9",
          "title": "Loading + connection overlay visual polish",
          "description": "Polish the visual design of the loading screen and connection status overlay. This task focuses purely on CSS/styling improvements.\n\n**Modify: `css/loading.css`** — Enhanced loading screen styles\n**Modify: `css/connection-status.css`** — Enhanced connection overlay styles\n\n**Design requirements:**\n\n1. **Loading screen (`css/loading.css`):**\n   - Full-screen: position fixed, 100vw × 100vh, z-index 10000\n   - Background: solid #111 (no transparency — must fully cover game canvas)\n   - Container: centered vertically and horizontally\n   - Title \"Loading Game...\": white, 24px, pulsing opacity animation (0.6→1→0.6, 2s infinite)\n   - Progress bar outer: width 400px (max-width 80vw), height 8px, background #333, border-radius 4px, overflow hidden\n   - Progress bar inner: background `linear-gradient(90deg, #ffcc00, #ff9800)`, height 100%, border-radius 4px, `transition: width 0.3s ease`\n   - Add a subtle animated shine/shimmer effect on the progress bar (CSS keyframes: translucent white stripe moving left to right)\n   - Status text: white, 14px, margin-top 16px\n   - Detail text (asset name): #666, 12px, margin-top 4px\n   - Fade-out transition when hiding: opacity 1→0 over 0.3s, then display none (use JS class toggle)\n\n2. **Connection status overlay (`css/connection-status.css`):**\n   - Overlay: position fixed, 100vw × 100vh, z-index 9999, background rgba(0,0,0,0.7), backdrop-filter blur(4px)\n   - Toast card: background #2a2a2a, border 1px solid #444, border-radius 16px, padding 32px 40px, min-width 320px, text-align center\n   - Box-shadow: 0 8px 32px rgba(0,0,0,0.5)\n   - Warning icon: 48px, color #ff9800\n   - \"Connection lost\" text: white, 20px, font-weight 600, margin-top 12px\n   - Detail text: #aaa, 14px, margin-top 8px\n   - Success state (`.success`): icon green #4CAF50, brief green border pulse animation\n   - Failed state (`.failed`): icon red #f44336, border-color #f44336\n   - Entrance animation: overlay fade-in 0.3s, toast slide-up + fade-in 0.3s\n   - Add a spinning/pulsing animation to the warning icon during reconnection (rotate or pulse)\n\n**Acceptance criteria:**\n- Loading screen: smooth progress bar with shimmer animation\n- Connection overlay: glass-morphism feel with blur backdrop\n- Smooth CSS transitions for all state changes\n- Consistent dark theme matching the game aesthetic\n- No layout jumps on state transitions",
          "status": "done",
          "priority": "low",
          "assignee": "designer-1",
          "assigneeRole": "designer",
          "dependencies": [
            "task-5",
            "task-6"
          ],
          "files": [
            "css/loading.css",
            "css/connection-status.css"
          ],
          "branch": "agent/designer-1",
          "createdBy": "ceo",
          "checkResult": "Polished both overlays. Loading: pulsing title, orange/yellow gradient progress bar with animated shimmer stripe, refined spacing. Connection: glassmorphism (backdrop-filter blur), #2a2a2a toast with 16px radius + deep shadow, slide-up entrance, pulsing icon during reconnect, green pop animation on success with border pulse, red border + static icon on failure. Mobile responsive at 480px.",
          "createdAt": 1771982931743,
          "updatedAt": 1771984561655
        }
      ],
      "stats": {
        "todo": 0,
        "in_progress": 0,
        "to_check": 0,
        "done": 9,
        "total": 9
      },
      "testChecks": [
        {
          "id": "task7-title-meta",
          "category": "SEO",
          "title": "Page title, meta tags, and favicon",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771983220972,
          "sprintNumber": 1
        },
        {
          "id": "server-start",
          "category": "Build",
          "title": "Game server starts on port 9998",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771984827909,
          "sprintNumber": 1
        },
        {
          "id": "http-serve-index",
          "category": "Navigation",
          "title": "Static server serves index.html",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771983334352,
          "sprintNumber": 1
        },
        {
          "id": "player-movement",
          "category": "Gameplay",
          "title": "Player can move with arrow keys",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771983666358,
          "sprintNumber": 1
        },
        {
          "id": "bomb-placement",
          "category": "Gameplay",
          "title": "Player can place bombs with spacebar",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771983699542,
          "sprintNumber": 1
        },
        {
          "id": "multiplayer-connect",
          "category": "Multiplayer",
          "title": "Second player connects and both see each other",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771983421735,
          "sprintNumber": 1
        },
        {
          "id": "player-disconnect",
          "category": "Multiplayer",
          "title": "Player disconnect broadcast",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771983437968,
          "sprintNumber": 1
        },
        {
          "id": "console-errors",
          "category": "Build",
          "title": "No critical console errors",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771985571418,
          "sprintNumber": 1
        },
        {
          "id": "wall-collision",
          "category": "Gameplay",
          "title": "Wall collision stops player movement",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771983473687,
          "sprintNumber": 1
        },
        {
          "id": "wall-destroy-items",
          "category": "Gameplay",
          "title": "Bomb destroys walls and may spawn items",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771983495049,
          "sprintNumber": 1
        },
        {
          "id": "css-paths",
          "category": "Build",
          "title": "CSS files use relative paths (no localhost)",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771985587099,
          "sprintNumber": 1
        },
        {
          "id": "ws-endpoint",
          "category": "API",
          "title": "WebSocket server HTTP endpoint responds",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771983527479,
          "sprintNumber": 1
        },
        {
          "id": "page-load",
          "category": "Navigation",
          "title": "Page loads at localhost:8060",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771984837745,
          "sprintNumber": 1
        },
        {
          "id": "ws-connection",
          "category": "WebSocket",
          "title": "WebSocket connects and receives map data",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771983648203,
          "sprintNumber": 1
        },
        {
          "id": "favicon-title",
          "category": "SEO",
          "title": "Favicon and page title present",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771983719560,
          "sprintNumber": 1
        },
        {
          "id": "meta-tags",
          "category": "SEO",
          "title": "Meta tags present (OG, description, viewport)",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771985222324,
          "sprintNumber": 1
        },
        {
          "id": "lobby-loads",
          "category": "Lobby",
          "title": "Lobby screen shows on page load instead of game",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771983790566,
          "sprintNumber": 1
        },
        {
          "id": "lobby-nickname",
          "category": "Forms",
          "title": "Nickname input enables PLAY button",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771984878509,
          "sprintNumber": 1
        },
        {
          "id": "lobby-skin-select",
          "category": "Forms",
          "title": "Skin selection works",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771984879130,
          "sprintNumber": 1
        },
        {
          "id": "lobby-play-btn",
          "category": "Lobby",
          "title": "PLAY button starts the game",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771983841454,
          "sprintNumber": 1
        },
        {
          "id": "lobby-empty-nick",
          "category": "Edge Cases",
          "title": "PLAY disabled with empty nickname",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771985609384,
          "sprintNumber": 1
        },
        {
          "id": "lobby-polish",
          "category": "Layout",
          "title": "Lobby visual polish - desktop view",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771984053391,
          "sprintNumber": 1
        },
        {
          "id": "lobby-responsive",
          "category": "Layout",
          "title": "Lobby responsive on mobile viewport",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771985425443,
          "sprintNumber": 1
        },
        {
          "id": "loading-overlay",
          "category": "Loading",
          "title": "Loading overlay shows after PLAY and disappears after world init",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771984211114,
          "sprintNumber": 1
        },
        {
          "id": "connection-overlay",
          "category": "Connection",
          "title": "Disconnect overlay shows on WebSocket close",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771984314243,
          "sprintNumber": 1
        },
        {
          "id": "connection-failure",
          "category": "Connection",
          "title": "Permanent failure state after max retries",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771984315297,
          "sprintNumber": 1
        },
        {
          "id": "nickname-skin",
          "category": "Lobby",
          "title": "Nickname and skin sent to server on connect",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771984388464,
          "sprintNumber": 1
        },
        {
          "id": "loading-polish",
          "category": "Layout",
          "title": "Loading overlay visual polish",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771984560389,
          "sprintNumber": 1
        },
        {
          "id": "connection-polish",
          "category": "Layout",
          "title": "Connection overlay visual polish with glassmorphism",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771984561335,
          "sprintNumber": 1
        },
        {
          "id": "chat-nicknames",
          "category": "Chat",
          "title": "Chat messages show actual nicknames",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771984676557,
          "sprintNumber": 1
        },
        {
          "id": "chat-xss",
          "category": "Chat",
          "title": "Chat XSS prevention works",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771985305514,
          "sprintNumber": 1
        },
        {
          "id": "integration-full",
          "category": "Integration",
          "title": "Full end-to-end app flow",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771984753200,
          "sprintNumber": 1
        },
        {
          "id": "http-server-start",
          "category": "Build",
          "title": "HTTP server starts on port 8060",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771984828568,
          "sprintNumber": 1
        },
        {
          "id": "play-button",
          "category": "Navigation",
          "title": "PLAY button starts game",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771984908683,
          "sprintNumber": 1
        },
        {
          "id": "loading-screen",
          "category": "Navigation",
          "title": "Loading screen appears after PLAY",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771984909227,
          "sprintNumber": 1
        },
        {
          "id": "nickname-label",
          "category": "Display",
          "title": "Player label shows only nickname, not both",
          "status": "fixed",
          "error": null,
          "fix": "Removed duplicate drawtext call from player.js since initworld.js already renders nicknames with better styling",
          "timestamp": 1771985173764,
          "sprintNumber": 1
        },
        {
          "id": "page-title",
          "category": "SEO",
          "title": "Page title is correct",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771985221004,
          "sprintNumber": 1
        },
        {
          "id": "favicon",
          "category": "SEO",
          "title": "Favicon loads correctly",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771985221632,
          "sprintNumber": 1
        },
        {
          "id": "chat-nickname",
          "category": "Chat",
          "title": "Chat shows sender nickname instead of 'unknow'",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771985288133,
          "sprintNumber": 1
        },
        {
          "id": "chat-my-msg",
          "category": "Chat",
          "title": "Own messages have my-msg class",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771985288960,
          "sprintNumber": 1
        },
        {
          "id": "conn-disconnect",
          "category": "Connection",
          "title": "Disconnect overlay appears when server stops",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771985347962,
          "sprintNumber": 1
        },
        {
          "id": "conn-reconnect",
          "category": "Connection",
          "title": "Reconnection shows success and hides overlay",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771985383241,
          "sprintNumber": 1
        },
        {
          "id": "conn-failure",
          "category": "Connection",
          "title": "Permanent failure state after max retries",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771985384191,
          "sprintNumber": 1
        },
        {
          "id": "integration-e2e",
          "category": "Integration",
          "title": "Full end-to-end flow: lobby → loading → game",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771985616676,
          "sprintNumber": 1
        },
        {
          "id": "movement",
          "category": "Gameplay",
          "title": "Player movement with keyboard",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771985534347,
          "sprintNumber": 1
        },
        {
          "id": "bomb-place",
          "category": "Gameplay",
          "title": "Bomb placement with spacebar",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771985557880,
          "sprintNumber": 1
        },
        {
          "id": "bomb-explode",
          "category": "Gameplay",
          "title": "Bomb explosion after 3 seconds",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771985558647,
          "sprintNumber": 1
        }
      ],
      "startedAt": 1771982652639,
      "completedAt": 1771985966572
    },
    {
      "sprintNumber": 2,
      "type": "sprint",
      "prompt": "This sprint transforms the endless sandbox into a structured competitive experience. Implement a timed round system where each round runs for a fixed duration (e.g., 3 minutes) and ends when only one player remains alive or the timer expires. At round end, broadcast a game-over event with the winner's identity, display a results screen for a few seconds, then regenerate the map and start a new round automatically. The server must manage round state (waiting, active, ended) and communicate transitions to all clients. Add a collectible power-up system where soft block destruction has a chance to drop items. Implement three power-up types: BombUp (increases max active bomb count), FireUp (increases explosion range), and SpeedUp (increases movement speed). The server spawns power-ups, broadcasts positions for client rendering, tracks per-player stats, and applies effects on pickup. Power-ups persist until collected or destroyed by explosions. Note that the variables for max bombs, bomb range, and player speed already exist as named server-side constants — modify these per-player rather than changing globals. Implement kill tracking: when a player is eliminated, attribute the kill to the bomb owner (reference already exists on the Bomb object). Broadcast kill-feed events to all clients. Display a live HUD scoreboard showing kills/deaths per player during the round, and show a round summary on the results screen. The CSS infrastructure for player statistics display already exists in the stylesheet.",
      "tasks": [
        {
          "id": "task-1",
          "title": "Server: Round state machine (waiting/active/ended)",
          "description": "Implement the round state machine in `server.js`. This is the foundation for Sprint 2.\n\n**Add constants:**\n```\nconst ROUND_DURATION_MS = 180000; // 3 minutes\nconst ROUND_END_DISPLAY_MS = 5000; // 5 seconds results screen\nconst MIN_PLAYERS_TO_START = 2;\n```\n\n**Add round state object:**\n```\nconst roundState = {\n  state: 'waiting', // 'waiting' | 'active' | 'ended'\n  timer: null,\n  startTime: 0,\n  roundNumber: 0\n};\n```\n\n**Implement functions:**\n- `startRound()` — sets state to 'active', records `startTime = Date.now()`, starts countdown timer (`setTimeout` for `ROUND_DURATION_MS`), broadcasts `RS active|{ROUND_DURATION_MS}` to all clients, resets all player stats (kills=0, deaths=0, alive=true, speed=DEFAULT_SPEED, range=DEFAULT_RANGE, maxBombs=DEFAULT_MAX_BOMBS, bombCounter=0), respawns all players\n- `endRound(winnerId, winnerNickname)` — sets state to 'ended', clears round timer, broadcasts `RW{winnerId}|{winnerNickname}`, broadcasts full results `RE{winnerId}|{winnerNick}|{p1Id}|{p1Nick}|{p1Kills}|{p1Deaths};{p2...}`, broadcasts `RS ended|0`, sets timeout for `ROUND_END_DISPLAY_MS` then calls `resetRound()`\n- `resetRound()` — clears all bombs/items/timers, regenerates map (call existing `initializeMap()` after clearing `cells` array), broadcasts `RR` then broadcasts `WL` to all clients with new map data, sets state to 'waiting', checks if enough players to auto-start\n- `checkRoundEnd()` — called after each player death. Counts alive players. If ≤1 alive and state is 'active', call `endRound()` with the survivor as winner (or null if 0 alive)\n- `broadcastRoundState()` — sends `RS{state}|{timeRemaining}` to all clients where timeRemaining = max(0, ROUND_DURATION_MS - (Date.now() - startTime))\n\n**Modify `wss.on('connection')` handler:**\n- After a new player connects and is fully initialized (after WE handler), check if state is 'waiting' and player count >= MIN_PLAYERS_TO_START, auto-call `startRound()`\n- Send current round state to newly connected player\n\n**Modify `ws.on('close')` handler:**\n- After removing player, if state is 'active', call `checkRoundEnd()`\n\n**Broadcast round time remaining every second** during active state (add a `setInterval` that runs only when state==='active').\n\n**Files:** server.js",
          "status": "done",
          "priority": "high",
          "assignee": "developer-1",
          "assigneeRole": "developer",
          "dependencies": [],
          "files": [
            "server.js"
          ],
          "branch": "agent/developer-1",
          "createdBy": "ceo",
          "checkResult": "Implemented round state machine in server.js: added roundState object with waiting/active/ended states, ROUND_DURATION_MS (180s), ROUND_END_DISPLAY_MS (5s), MIN_PLAYERS_TO_START (2). Functions: startRound() resets all player stats/positions and broadcasts RS active; endRound() broadcasts RW winner + RE full results (semicolon-separated players) + RS ended, then auto-resets after 5s; resetRound() clears bombs/items, regenerates map, broadcasts RR+WL; checkRoundEnd() triggers endRound when <=1 alive; broadcastRoundState() sends RS with time remaining every 1s. Auto-starts when >=2 players connect. Disconnect triggers checkRoundEnd. Added kills/deaths to player object.",
          "createdAt": 1771986080012,
          "updatedAt": 1771986556054
        },
        {
          "id": "task-2",
          "title": "Server: Kill tracking + per-player stats + death = spectator",
          "description": "Modify `server.js` to implement kill tracking, per-player stats, and dead player spectator mode.\n\n**Modify `createPlayer()` — add stats fields:**\n```\nkills: 0,\ndeaths: 0,\n```\n(Note: `speed`, `range`, `maxBombs`, `bombCounter`, `alive` already exist on the player object)\n\n**Modify `respawnPlayer()` → rename to `killPlayer(player, killerBomb)`:**\n- Instead of respawning, set `player.alive = false`\n- Increment `player.deaths`\n- Find killer via `killerBomb.launcherId` using `findPlayerById()`\n- If killer exists and killer !== player: increment `killer.kills`\n- If killer === player (self-kill): still increment killer.kills if desired, or skip\n- Broadcast kill feed: `broadcastAll('KF' + killerId + '|' + killerNickname + '|' + player.id + '|' + player.nickname)`\n- Broadcast scoreboard update (call `broadcastScoreboard()`)\n- Broadcast player death: `broadcastAll('PK' + player.id)` (new — tells clients to hide player sprite)\n- Call `checkRoundEnd()` from task-1\n\n**Modify `explodeLine()` — pass bomb reference:**\n- Change signature to `explodeLine(cellList, bomb)` \n- Where it currently calls `respawnPlayer(p)`, instead call `killPlayer(p, bomb)`\n- Remove `playerDied` break — explosion should continue through dead player to hit walls/other players behind\n\n**Modify `explodeBomb()` — pass bomb to explodeLine:**\n- Pass `bomb` as second argument to each `explodeLine()` call\n- In center cell check, also pass `bomb` to `killPlayer()`\n\n**Modify `movePlayer()` — skip dead players:**\n- At start of `movePlayer()`: `if (!player.alive) return;`\n\n**Modify `handleKeyDown()` — block input for dead players:**\n- At start: `if (!player.alive) return;`\n\n**Add `broadcastScoreboard()` function:**\n```\nfunction broadcastScoreboard() {\n  const entries = [];\n  for (const [, p] of players) {\n    entries.push(p.id + '|' + p.nickname + '|' + p.kills + '|' + p.deaths);\n  }\n  broadcastAll('SB' + entries.join(';'));\n}\n```\n\n**Files:** server.js\n**Depends on:** task-1 (round state machine provides checkRoundEnd)",
          "status": "done",
          "priority": "high",
          "assignee": "developer-1",
          "assigneeRole": "developer",
          "dependencies": [
            "task-1"
          ],
          "files": [
            "server.js"
          ],
          "branch": "agent/developer-1",
          "createdBy": "ceo",
          "checkResult": "Replaced respawnPlayer with killPlayer: tracks kills/deaths via bomb.launcherId, broadcasts KF (kill feed) and PK (player killed), calls broadcastScoreboard() and checkRoundEnd() after each death. Modified explodeLine to accept bomb param for kill attribution and removed playerDied break so explosions pass through dead players. Added broadcastScoreboard() sending SB message. Blocked movePlayer and handleKeyDown for dead players.",
          "createdAt": 1771986097050,
          "updatedAt": 1771990759314
        },
        {
          "id": "task-3",
          "title": "Server: Power-up persistence + explosion destroys items",
          "description": "Modify `server.js` power-up/item system so items persist until collected or destroyed by explosions.\n\n**Modify `trySpawnItem()` — remove auto-despawn timer:**\n- Delete the line: `item.timer = setTimeout(() => despawnItem(item), ITEM_DESPAWN_MS);`\n- Set `item.timer = null;` (no auto-despawn)\n- Items now persist on the map indefinitely until collected or exploded\n\n**Modify `explodeLine()` — destroy items on explosion-affected cells:**\n- After the walkable cell check and before `count++`, add:\n```\nif (cell.item) {\n  despawnItem(cell.item);\n}\n```\n- This ensures explosions destroy uncollected power-ups on cells they reach\n\n**Modify `explodeBomb()` — also check center cell for items:**\n- After the center cell player kill check, add:\n```\nif (cell.item) {\n  despawnItem(cell.item);\n}\n```\n\n**Optionally remove the `ITEM_DESPAWN_MS` constant** since it's no longer used (or keep it and document it as unused).\n\n**Verify `pickupItem()` still works correctly** — it already removes the item from the cell and applies effects. The existing logic for templateId 0 (BombUp), 4 (FireUp), 6 (SpeedUp) is correct and doesn't need changes.\n\n**Files:** server.js",
          "status": "done",
          "priority": "medium",
          "assignee": "developer-2",
          "assigneeRole": "developer",
          "dependencies": [],
          "files": [
            "server.js"
          ],
          "branch": "agent/developer-2",
          "createdBy": "ceo",
          "checkResult": "Removed auto-despawn timer from trySpawnItem() so items persist indefinitely. Added item destruction in explodeLine() for explosion-affected cells and in explodeBomb() for the center cell. Items are now only removed by player pickup or explosion. pickupItem() already handles timer clearing correctly.",
          "createdAt": 1771986114157,
          "updatedAt": 1771986519076
        },
        {
          "id": "task-4",
          "title": "Server: Round reset — regenerate map + reset players",
          "description": "Implement the map regeneration and full round reset logic in `server.js`. This completes the round lifecycle.\n\n**Implement `resetRound()` function (or finalize it from task-1):**\n\n1. **Clear all active bombs:**\n```\nfor (const b of bombs) {\n  if (b.timer) clearTimeout(b.timer);\n}\nbombs.length = 0;\n```\n\n2. **Clear all active items:**\n```\nfor (const item of items) {\n  if (item.timer) clearTimeout(item.timer);\n}\nitems.length = 0;\n```\n\n3. **Regenerate the map:**\n```\ncells.length = 0;\ninitializeMap(); // re-populates cells array\n```\n\n4. **Reset all players for new round:**\n```\nfor (const [ws, player] of players) {\n  player.alive = true;\n  player.kills = 0;\n  player.deaths = 0;\n  player.speed = DEFAULT_SPEED;\n  player.range = DEFAULT_RANGE;\n  player.maxBombs = DEFAULT_MAX_BOMBS;\n  player.bombCounter = 0;\n  player.dir = 0;\n  player.olddir = 2;\n  player.onmove = false;\n  // Respawn at random walkable position\n  const spawnCell = getRandomWalkableCellStart();\n  player.x = (spawnCell.x * TILE_SIZE) - 5;\n  player.y = (spawnCell.y * TILE_SIZE) + 10;\n}\n```\n\n5. **Broadcast new map to all clients:**\n- Send `RR` to all (tells clients to prepare for map reload)\n- Then send `WL{width}|{height}|{mapData}` to each client\n- Then send entity data (each player's PA message) to each client\n\n6. **Set round state to 'waiting':**\n- `roundState.state = 'waiting';`\n- If `players.size >= MIN_PLAYERS_TO_START`, auto-call `startRound()` after a short delay (e.g., 2 seconds)\n\n**Modify existing `initializeMap()`** — ensure it clears the cells array first (it currently just pushes, so if called again it would double). Add `cells.length = 0;` at the start of `initializeMap()` if not already there.\n\n**Files:** server.js\n**Depends on:** task-1 (round state machine), task-2 (kill tracking fields)",
          "status": "done",
          "priority": "high",
          "assignee": "developer-1",
          "assigneeRole": "developer",
          "dependencies": [
            "task-1",
            "task-2"
          ],
          "files": [
            "server.js"
          ],
          "branch": "agent/developer-1",
          "createdBy": "ceo",
          "checkResult": "Completed resetRound: resets all player stats (alive, kills, deaths, speed, range, maxBombs, bombCounter, dir, onmove), respawns at random walkable positions, broadcasts RR + WL with new map, sends PA messages for all players to each client for sprite re-creation, added 2s delay before auto-starting next round. Added cells.length=0 guard in initializeMap().",
          "createdAt": 1771986128764,
          "updatedAt": 1771993843912
        },
        {
          "id": "task-5",
          "title": "Client: Protocol handler for new Sprint 2 messages",
          "description": "Modify `js/aks.js` and `js/globals.js` to handle all new Sprint 2 protocol messages.\n\n**Add to `js/globals.js`:**\n```\n// Round state\nvar roundState = 'waiting'; // 'waiting' | 'active' | 'ended'\nvar roundTimeRemaining = 0;\nvar roundWinner = null; // { id, nickname }\nvar roundResults = []; // [{ id, nickname, kills, deaths }, ...]\n\n// Scoreboard\nvar scoreboardData = []; // [{ id, nickname, kills, deaths }, ...]\n\n// Kill feed\nvar killFeed = []; // [{ killerId, killerNick, victimId, victimNick, time }, ...]\n```\n\n**Add to `js/aks.js` socket.onmessage switch — add new case 'R' (round messages):**\n```\ncase \"R\":\n  switch (action) {\n    case \"S\": // Round state: RS{state}|{timeRemainingMs}\n      var parts = received_msg.substring(2).split(\"|\");\n      roundState = parts[0];\n      roundTimeRemaining = Number(parts[1]);\n      if (typeof HUD !== 'undefined') HUD.updateRoundState(roundState, roundTimeRemaining);\n      break;\n    case \"W\": // Round winner: RW{winnerId}|{winnerNickname}\n      var parts = received_msg.substring(2).split(\"|\");\n      roundWinner = { id: Number(parts[0]), nickname: parts[1] };\n      break;\n    case \"R\": // Round reset: RR\n      // Clear local state, prepare for new map\n      if (typeof HUD !== 'undefined') HUD.hideResults();\n      roundWinner = null;\n      roundResults = [];\n      killFeed = [];\n      break;\n    case \"E\": // Round end results: RE{winnerId}|{winnerNick}|{id}|{nick}|{kills}|{deaths};...\n      var data = received_msg.substring(2);\n      var playerEntries = data.split(\";\");\n      var firstEntry = playerEntries[0].split(\"|\");\n      roundWinner = { id: Number(firstEntry[0]), nickname: firstEntry[1] };\n      roundResults = [];\n      for (var i = 0; i < playerEntries.length; i++) {\n        var p = playerEntries[i].split(\"|\");\n        if (p.length >= 6) {\n          roundResults.push({ id: Number(p[2]), nickname: p[3], kills: Number(p[4]), deaths: Number(p[5]) });\n        }\n      }\n      if (typeof HUD !== 'undefined') HUD.showResults(roundWinner, roundResults);\n      break;\n  }\n  break;\n```\n\n**Add case 'K' for kill feed (careful — 'K' already used for KD/KU key events):**\n- Add inside existing case \"K\": `case \"F\":` handler for kill feed\n```\ncase \"F\": // Kill feed: KF{killerId}|{killerNick}|{victimId}|{victimNick}\n  var parts = received_msg.substring(2).split(\"|\");\n  var killEvent = { killerId: Number(parts[0]), killerNick: parts[1], victimId: Number(parts[2]), victimNick: parts[3], time: Date.now() };\n  killFeed.push(killEvent);\n  if (typeof HUD !== 'undefined') HUD.addKillFeedEntry(killEvent);\n  // Also add to chat as kill-info\n  addKillToChat(killEvent.killerNick, killEvent.victimNick);\n  break;\n```\n\n**Add case 'S' for scoreboard (new top-level):**\n```\ncase \"S\":\n  switch (action) {\n    case \"B\": // Scoreboard: SB{id}|{nick}|{kills}|{deaths};{id2}|...\n      var entries = received_msg.substring(2).split(\";\");\n      scoreboardData = [];\n      for (var i = 0; i < entries.length; i++) {\n        var p = entries[i].split(\"|\");\n        if (p.length >= 4) {\n          scoreboardData.push({ id: Number(p[0]), nickname: p[1], kills: Number(p[2]), deaths: Number(p[3]) });\n        }\n      }\n      if (typeof HUD !== 'undefined') HUD.updateScoreboard(scoreboardData);\n      break;\n  }\n  break;\n```\n\n**Handle PK (player killed) — add inside existing case \"P\":**\n```\ncase \"K\": // Player killed: PK{id}\n  var id = Number(received_msg.substring(2));\n  var player = world.getPlayer(id);\n  if (player != null) {\n    player.alive = false;\n    player.remove();\n  }\n  break;\n```\n\n**Add `addKillToChat()` function** (either in aks.js or chat.js):\n```\nfunction addKillToChat(killerNick, victimNick) {\n  var elem = document.createElement(\"li\");\n  elem.setAttribute(\"class\", \"ng-scope kill-info\");\n  elem.innerHTML = '<span class=\"ico bombed\"></span> <b class=\"nickname\">' + escapeHtml(killerNick) + '</b> killed <b class=\"nickname\">' + escapeHtml(victimNick) + '</b>';\n  var chat = document.getElementById(\"endchat\");\n  chat.parentNode.insertBefore(elem, chat);\n  var chatList = document.getElementById(\"listChat\");\n  if (chatList) chatList.scrollTop = chatList.scrollHeight;\n}\n```\n\n**Files:** js/aks.js, js/globals.js\n**Depends on:** task-1 (server sends these messages)",
          "status": "done",
          "priority": "high",
          "assignee": "developer-2",
          "assigneeRole": "developer",
          "dependencies": [
            "task-1"
          ],
          "files": [
            "js/aks.js",
            "js/globals.js"
          ],
          "branch": "agent/developer-2",
          "createdBy": "ceo",
          "checkResult": "Added all Sprint 2 protocol handlers to js/aks.js: RS (round state), RW (round winner), RR (round reset), RE (round end results), SB (scoreboard), KF (kill feed with addKillToChat()), PK (player killed with spectator mode). Added globals to js/globals.js: roundState, roundTimeRemaining, roundWinner, roundResults, scoreboardData, killFeed, isSpectating. Also fixed existing bug: missing break after case \"I\" that caused fall-through to case \"M\".",
          "createdAt": 1771986152329,
          "updatedAt": 1771990759564
        },
        {
          "id": "task-6",
          "title": "Client: HUD HTML containers in index.html",
          "description": "Add HTML containers for the HUD elements (round timer, scoreboard, results screen) to `index.html`.\n\n**Add inside the `#viewport` div (after the canvas divs, before `</div>` closing viewport):**\n\n```html\n<!-- Round Timer HUD -->\n<div id=\"round-timer\" style=\"display:none;\">\n  <div class=\"round-timer-text\" id=\"round-timer-text\">3:00</div>\n  <div class=\"round-timer-state\" id=\"round-timer-state\"></div>\n</div>\n\n<!-- HUD Scoreboard -->\n<div id=\"hud-scoreboard\" style=\"display:none;\">\n  <div class=\"hud-scoreboard-title\">SCOREBOARD</div>\n  <table class=\"hud-scoreboard-table\" id=\"hud-scoreboard-table\">\n    <thead>\n      <tr>\n        <th>Player</th>\n        <th>K</th>\n        <th>D</th>\n      </tr>\n    </thead>\n    <tbody id=\"hud-scoreboard-body\">\n    </tbody>\n  </table>\n</div>\n\n<!-- Results Screen Overlay -->\n<div id=\"results-screen\" style=\"display:none;\">\n  <div class=\"results-container\">\n    <h1 class=\"results-title\" id=\"results-title\">Round Over!</h1>\n    <div class=\"results-winner\" id=\"results-winner\"></div>\n    <div class=\"results-summary\">\n      <table class=\"results-table\" id=\"results-table\">\n        <thead>\n          <tr>\n            <th>#</th>\n            <th>Player</th>\n            <th>Kills</th>\n            <th>Deaths</th>\n          </tr>\n        </thead>\n        <tbody id=\"results-table-body\">\n        </tbody>\n      </table>\n    </div>\n    <div class=\"results-countdown\" id=\"results-countdown\">Next round in 5s...</div>\n  </div>\n</div>\n```\n\n**Add script tag for hud.js** in the `<head>` section, AFTER `js/chat.js` and BEFORE `js/events.js`:\n```html\n<script src=\"./js/hud.js\"></script>\n```\n\n**Add CSS link** in `<head>` after the existing CSS links:\n```html\n<link rel=\"stylesheet\" href=\"./css/hud.css\">\n```\n\n**Files:** index.html",
          "status": "done",
          "priority": "high",
          "assignee": "developer-2",
          "assigneeRole": "developer",
          "dependencies": [],
          "files": [
            "index.html"
          ],
          "branch": "agent/developer-2",
          "createdBy": "ceo",
          "checkResult": "Added HUD HTML containers to index.html: round timer (#round-timer), scoreboard (#hud-scoreboard with Player/K/D table), and results screen overlay (#results-screen with winner display, stats table, countdown). Added css/hud.css link after existing CSS and js/hud.js script after chat.js before events.js. All containers inside #viewport div, initially hidden with display:none.",
          "createdAt": 1771986166989,
          "updatedAt": 1771986452092
        },
        {
          "id": "task-7",
          "title": "Client: HUD CSS — timer, scoreboard, results screen",
          "description": "Create `css/hud.css` with styles for round timer, live scoreboard, and results screen overlay. Use the existing game's visual language: dark backgrounds (#252525, #3d3d3d), gold accent (#ffd21f), white text, semi-transparent overlays. Reference the existing styles in `css/styles.css` for consistency (`.player-statistics`, `#scoreboard-new`, `.wrap-inner` patterns).\n\n**Round Timer (`#round-timer`):**\n- Position: fixed, top center of screen, z-index: 100\n- Background: rgba(0,0,0,0.6), border-radius, padding\n- Timer text: large (28px), bold, white, monospace font for digits\n- State text: smaller (14px), gold (#ffd21f)\n- Animate urgency: when <30s, text turns red; when <10s, add pulse animation\n\n**HUD Scoreboard (`#hud-scoreboard`):**\n- Position: fixed, top-right corner, z-index: 100\n- Background: rgba(37,37,37,0.85), border: 1px solid #ffd21f, border-radius\n- Max-width: 200px, compact design\n- Title: gold (#ffd21f), 12px, uppercase\n- Table: full width, no cell borders\n  - Header: gold text, border-bottom 1px solid #ffd21f\n  - Rows: white text, 11px, alternating background (#363636 / transparent) — matches existing `.player-statistics li:nth-child(odd)` pattern\n  - Kills column: green (#2c8127)\n  - Deaths column: red (#df6767)\n- Current player's row highlighted with a subtle gold left-border\n\n**Results Screen (`#results-screen`):**\n- Position: fixed, full screen, z-index: 1002 (above everything)\n- Background: rgba(0,0,0,0.8) \n- `.results-container`: centered, max-width 500px, background #3d3d3d, border 2px solid #ffd21f, border-radius, padding 30px\n- `.results-title`: gold (#ffd21f), 32px, text-align center\n- `.results-winner`: white, 20px, center, with a crown/trophy emoji or text \"Winner: {name}\"\n- `.results-table`: full width, matches `.player-statistics` pattern\n  - Header: gold, border-bottom\n  - Rows: alternating bg, white text\n  - Winner row: gold background highlight\n- `.results-countdown`: bottom of container, 14px, gray, italic\n\n**Files:** css/hud.css (NEW)",
          "status": "done",
          "priority": "medium",
          "assignee": "designer-1",
          "assigneeRole": "designer",
          "dependencies": [
            "task-6"
          ],
          "files": [
            "css/hud.css"
          ],
          "branch": "agent/designer-1",
          "createdBy": "ceo",
          "checkResult": "Created css/hud.css with full styling for all 3 HUD components. Round timer: fixed top-center, monospace font, urgency states (.urgent red at <30s, .critical pulse at <10s), .waiting state. Scoreboard: fixed top-right, gold #ffd21f border/title, K column green #2c8127, D column red #df6767, alternating rows #363636, .current-player gold left-border. Results screen: z-index 1002 full overlay, #3d3d3d card with gold border, .winner-row highlight, countdown text. Also includes kill-feed-entry styles. Responsive at 768px and 480px. All colors/patterns match existing styles.css conventions.",
          "createdAt": 1771986184395,
          "updatedAt": 1771986638456
        },
        {
          "id": "task-8",
          "title": "Client: HUD JavaScript — timer, scoreboard, results manager",
          "description": "Create `js/hud.js` — a global `HUD` manager object that controls the round timer, live scoreboard, and results screen.\n\n**HUD object (IIFE pattern like lobby.js):**\n```javascript\nvar HUD = (function() {\n  var timerInterval = null;\n  \n  return {\n    // Called when RS message received\n    updateRoundState: function(state, timeRemainingMs) {\n      var timerEl = document.getElementById('round-timer');\n      var timerText = document.getElementById('round-timer-text');\n      var stateText = document.getElementById('round-timer-state');\n      \n      timerEl.style.display = 'block';\n      \n      if (state === 'waiting') {\n        timerText.textContent = '--:--';\n        stateText.textContent = 'Waiting for players...';\n        timerEl.classList.remove('urgent', 'critical');\n      } else if (state === 'active') {\n        stateText.textContent = '';\n        // Update timer display\n        this._updateTimerDisplay(timeRemainingMs);\n        // Start local countdown (update every 100ms for smooth display)\n        this._startLocalTimer(timeRemainingMs);\n      } else if (state === 'ended') {\n        stateText.textContent = 'Round Over!';\n        timerEl.classList.remove('urgent', 'critical');\n        if (timerInterval) clearInterval(timerInterval);\n      }\n    },\n    \n    _startLocalTimer: function(timeRemainingMs) {\n      if (timerInterval) clearInterval(timerInterval);\n      var endTime = Date.now() + timeRemainingMs;\n      var self = this;\n      timerInterval = setInterval(function() {\n        var remaining = Math.max(0, endTime - Date.now());\n        self._updateTimerDisplay(remaining);\n        if (remaining <= 0) clearInterval(timerInterval);\n      }, 100);\n    },\n    \n    _updateTimerDisplay: function(ms) {\n      var timerText = document.getElementById('round-timer-text');\n      var timerEl = document.getElementById('round-timer');\n      var totalSeconds = Math.ceil(ms / 1000);\n      var minutes = Math.floor(totalSeconds / 60);\n      var seconds = totalSeconds % 60;\n      timerText.textContent = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;\n      \n      // Urgency classes\n      timerEl.classList.toggle('urgent', totalSeconds <= 30 && totalSeconds > 10);\n      timerEl.classList.toggle('critical', totalSeconds <= 10);\n    },\n    \n    // Called when SB message received\n    updateScoreboard: function(data) {\n      var container = document.getElementById('hud-scoreboard');\n      var tbody = document.getElementById('hud-scoreboard-body');\n      container.style.display = 'block';\n      \n      // Sort by kills desc, then deaths asc\n      data.sort(function(a, b) { return b.kills - a.kills || a.deaths - b.deaths; });\n      \n      tbody.innerHTML = '';\n      for (var i = 0; i < data.length; i++) {\n        var row = document.createElement('tr');\n        var isCurrentPlayer = (currentPlayer && data[i].id === currentPlayer.id);\n        if (isCurrentPlayer) row.classList.add('current-player');\n        row.innerHTML = '<td class=\"sb-name\">' + escapeHtml(data[i].nickname) + '</td>'\n          + '<td class=\"sb-kills\">' + data[i].kills + '</td>'\n          + '<td class=\"sb-deaths\">' + data[i].deaths + '</td>';\n        tbody.appendChild(row);\n      }\n    },\n    \n    // Called when KF message received\n    addKillFeedEntry: function(killEvent) {\n      // Kill feed is displayed in chat via addKillToChat() — this method can add HUD-level kill feed if desired\n    },\n    \n    // Called when RE message received\n    showResults: function(winner, results) {\n      var screen = document.getElementById('results-screen');\n      var titleEl = document.getElementById('results-title');\n      var winnerEl = document.getElementById('results-winner');\n      var tbody = document.getElementById('results-table-body');\n      var countdownEl = document.getElementById('results-countdown');\n      \n      screen.style.display = 'flex';\n      titleEl.textContent = 'Round Over!';\n      winnerEl.textContent = winner && winner.nickname ? 'Winner: ' + winner.nickname : 'Draw — No Winner';\n      \n      // Sort results by kills desc\n      results.sort(function(a, b) { return b.kills - a.kills || a.deaths - b.deaths; });\n      \n      tbody.innerHTML = '';\n      for (var i = 0; i < results.length; i++) {\n        var row = document.createElement('tr');\n        if (winner && results[i].id === winner.id) row.classList.add('winner-row');\n        row.innerHTML = '<td>' + (i + 1) + '</td>'\n          + '<td>' + escapeHtml(results[i].nickname) + '</td>'\n          + '<td>' + results[i].kills + '</td>'\n          + '<td>' + results[i].deaths + '</td>';\n        tbody.appendChild(row);\n      }\n      \n      // Countdown\n      var seconds = 5;\n      countdownEl.textContent = 'Next round in ' + seconds + 's...';\n      var countdownInterval = setInterval(function() {\n        seconds--;\n        if (seconds <= 0) {\n          clearInterval(countdownInterval);\n          countdownEl.textContent = 'Starting...';\n        } else {\n          countdownEl.textContent = 'Next round in ' + seconds + 's...';\n        }\n      }, 1000);\n    },\n    \n    hideResults: function() {\n      var screen = document.getElementById('results-screen');\n      screen.style.display = 'none';\n    },\n    \n    // Reset everything for new round\n    reset: function() {\n      this.hideResults();\n      document.getElementById('hud-scoreboard-body').innerHTML = '';\n    }\n  };\n})();\n```\n\n**Key behaviors:**\n- Timer syncs from server RS messages; local countdown runs between updates for smooth display\n- Scoreboard auto-shows when first SB message arrives\n- Results screen blocks all game interaction while visible\n- `escapeHtml()` function is already available globally from `js/chat.js`\n\n**Files:** js/hud.js (NEW)\n**Depends on:** task-6 (HTML containers), task-5 (protocol handler calls HUD methods)",
          "status": "done",
          "priority": "medium",
          "assignee": "developer-2",
          "assigneeRole": "developer",
          "dependencies": [
            "task-5",
            "task-6"
          ],
          "files": [
            "js/hud.js"
          ],
          "branch": "agent/developer-2",
          "createdBy": "ceo",
          "checkResult": "Created js/hud.js — IIFE HUD manager with: updateRoundState (timer with local countdown, urgency classes), updateScoreboard (sorted by kills/deaths), showResults (winner + table + countdown), showDeathNotice (spectator notice), hideResults, reset. All methods guard against missing DOM elements. Uses escapeHtml from chat.js for XSS safety.",
          "createdAt": 1771986209859,
          "updatedAt": 1771993948400
        },
        {
          "id": "task-9",
          "title": "Client: Dead player spectator mode + input blocking",
          "description": "Modify client to handle player death state — dead players can't move or place bombs but remain connected and can watch/chat.\n\n**Modify `js/globals.js` — add:**\n```\nvar isSpectating = false;\n```\n\n**Modify `js/events.js` — block movement when spectating:**\n- In `onKeyDown()`: add at the very start: `if (isSpectating) return;`\n- In `onKeyUp()`: add at the very start: `if (isSpectating) return;`\n- This prevents sending KD/KU messages to server when dead\n\n**Modify `js/aks.js` — handle PK (player killed) for current player:**\n- In the existing `case \"K\"` handling for PK messages (added in task-5), add:\n```\nif (currentPlayer && id === currentPlayer.id) {\n  isSpectating = true;\n  // Show death notification\n  if (typeof HUD !== 'undefined') HUD.showDeathNotice();\n}\n```\n\n**Modify `js/aks.js` — reset spectating on round reset (RR handler):**\n- In the `case \"R\"` → `case \"R\"` (RR) handler, add:\n```\nisSpectating = false;\n```\n\n**Add to `js/hud.js` — death notice method:**\n- `showDeathNotice()`: Show a brief \"YOU DIED\" text overlay that fades after 2 seconds. Use the round-timer-state element or create a small notification. Simple approach: set `round-timer-state` text to \"YOU DIED — Spectating\" temporarily.\n\n**Modify `js/player/player.js` — handle alive state:**\n- In `Player.update()`: already has `if (!this.alive) { this.remove(); return; }` — this is correct\n- Ensure dead players are not rendered after receiving PK\n\n**Files:** js/events.js, js/globals.js, js/aks.js, js/hud.js\n**Depends on:** task-5 (protocol handler), task-8 (HUD)",
          "status": "done",
          "priority": "medium",
          "assignee": "developer-1",
          "assigneeRole": "developer",
          "dependencies": [
            "task-5",
            "task-8"
          ],
          "files": [
            "js/events.js",
            "js/globals.js",
            "js/aks.js",
            "js/hud.js"
          ],
          "branch": "agent/developer-1",
          "createdBy": "ceo",
          "checkResult": "Added isSpectating guard to onKeyDown() and onKeyUp() in js/events.js to block movement/bomb input when dead. The PK handler (sets isSpectating=true, calls HUD.showDeathNotice()), isSpectating global in globals.js, HUD.showDeathNotice() in hud.js, RR reset of isSpectating in aks.js, and Player.update() alive check in player.js were all already implemented in prior tasks (task-5, task-8).",
          "createdAt": 1771986225935,
          "updatedAt": 1771994040107
        },
        {
          "id": "task-10",
          "title": "Client: Map reload handling on round reset",
          "description": "Modify the client to properly handle map regeneration when a new round starts (server sends RR then WL with new map data).\n\n**Modify `js/aks.js` — enhance RR handler:**\nIn the existing `case \"R\"` → `case \"R\"` handler (RR message), add cleanup:\n```\n// Clear local game state for new round\nif (world != null) {\n  // Remove all bomb sprites\n  for (var i = 0; i < world.bombs.length; i++) {\n    if (world.bombs[i]) fosfo1.undraw('bomb' + world.bombs[i].id);\n  }\n  world.bombs = [];\n  \n  // Remove all item sprites\n  for (var i = 0; i < world.items.length; i++) {\n    if (world.items[i]) fosfo1.undraw('item' + world.items[i].id);\n  }\n  world.items = [];\n  \n  // Remove all player sprites (they'll be re-added via PA messages)\n  for (var i = 0; i < world.players.length; i++) {\n    if (world.players[i]) fosfo1.undraw('player' + world.players[i].id);\n  }\n  world.players = [];\n}\n\n// Reset spectating\nisSpectating = false;\n\n// Reset kill feed and scoreboard globals\nkillFeed = [];\nscoreboardData = [];\nroundWinner = null;\nroundResults = [];\n```\n\n**Verify WL handler works for map reload:**\nThe existing WL handler in aks.js does:\n```\nfosfo0.clear();\nworld = new World(received_msg.substring(2));\nworld.loadWorld();\n```\nThis creates a brand new World object — which is correct for a full reload. However, we need to make sure the WE (world entities) message is sent after WL to re-receive all players. The server's `resetRound()` (task-4) must send WL followed by PA messages for all players.\n\n**Modify WL handler** — after `world.loadWorld()`, request entities again:\n```\nsendSocketMessage(\"WE\"); // Re-request entities for new round\n```\n(This line already exists in the current WL handler, so just verify it's present.)\n\n**Files:** js/aks.js\n**Depends on:** task-5 (protocol handler), task-4 (server reset sends WL)",
          "status": "done",
          "priority": "medium",
          "assignee": "developer-1",
          "assigneeRole": "developer",
          "dependencies": [
            "task-4",
            "task-5"
          ],
          "files": [
            "js/aks.js"
          ],
          "branch": "agent/developer-1",
          "createdBy": "ceo",
          "checkResult": "Enhanced RR handler in js/aks.js to clear all local game objects (bombs, items, players) using fosfo1.undraw() before new map arrives. Resets isSpectating, scoreboardData, killFeed, roundWinner, roundResults. WL handler already triggers WE re-request for entity reload.",
          "createdAt": 1771986246420,
          "updatedAt": 1771993972607
        },
        {
          "id": "task-11",
          "title": "Server: Send round state + scoreboard to newly connected players",
          "description": "Modify `server.js` to ensure newly connected players receive the current round state and scoreboard immediately after joining.\n\n**Modify `handleWorldEntities()` (the WE handler) — add at the end:**\n\n1. Send current round state:\n```\n// Send current round state\nconst timeRemaining = roundState.state === 'active' \n  ? Math.max(0, ROUND_DURATION_MS - (Date.now() - roundState.startTime)) \n  : 0;\nsendTo(ws, 'RS' + roundState.state + '|' + timeRemaining);\n```\n\n2. Send current scoreboard:\n```\n// Send scoreboard\nbroadcastScoreboard(); // or send just to this player\n```\n\n3. If round is active and player joins mid-round, they should be alive and able to play immediately (their stats start at 0 kills/0 deaths).\n\n4. If round state is 'ended', send the results screen data too:\n```\nif (roundState.state === 'ended' && roundState.lastResults) {\n  sendTo(ws, roundState.lastResults); // cached RE message\n}\n```\n\n**Store last results message** in `endRound()`:\n- When building the RE message string, save it: `roundState.lastResults = reMessage;`\n\n**Auto-start logic:**\n- After a new player connects and entities are sent, if `roundState.state === 'waiting'` and `players.size >= MIN_PLAYERS_TO_START`:\n  - Call `startRound()` after a 3-second delay to give the player time to load\n  - Use: `setTimeout(() => { if (roundState.state === 'waiting' && players.size >= MIN_PLAYERS_TO_START) startRound(); }, 3000);`\n\n**Files:** server.js\n**Depends on:** task-1 (round state), task-2 (scoreboard function)",
          "status": "done",
          "priority": "medium",
          "assignee": "developer-1",
          "assigneeRole": "developer",
          "dependencies": [
            "task-1",
            "task-2"
          ],
          "files": [
            "server.js"
          ],
          "branch": "agent/developer-1",
          "createdBy": "ceo",
          "checkResult": "Added lastResults cache to roundState, cached RE message in endRound(). WE handler now sends broadcastScoreboard() to new players, sends cached RE results if state is 'ended', and uses 3-second delayed auto-start to give clients time to load.",
          "createdAt": 1771986259734,
          "updatedAt": 1771993948736
        }
      ],
      "stats": {
        "todo": 0,
        "in_progress": 0,
        "to_check": 0,
        "done": 11,
        "total": 11
      },
      "testChecks": [
        {
          "id": "task6-hud-html",
          "category": "HUD",
          "title": "Task-6: HUD HTML containers in index.html",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771986451822,
          "sprintNumber": 2
        },
        {
          "id": "task3-powerup-persistence",
          "category": "Server",
          "title": "Task-3: Power-up persistence + explosion destroys items",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771986518399,
          "sprintNumber": 2
        },
        {
          "id": "task1-round-state",
          "category": "Server",
          "title": "Task-1: Round state machine",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771986555743,
          "sprintNumber": 2
        },
        {
          "id": "task7-hud-css",
          "category": "Design",
          "title": "Task-7: HUD CSS styles",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771986638076,
          "sprintNumber": 2
        },
        {
          "id": "task2-code-review",
          "category": "Code Review",
          "title": "Task-2: Server kill tracking code review",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771986868145,
          "sprintNumber": 2
        },
        {
          "id": "task5-code-review",
          "category": "Code Review",
          "title": "Task-5: Client protocol handlers code review",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771986868847,
          "sprintNumber": 2
        },
        {
          "id": "page-load",
          "category": "Navigation",
          "title": "Game page loads correctly",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771987818306,
          "sprintNumber": 2
        },
        {
          "id": "ws-protocol",
          "category": "Protocol",
          "title": "WebSocket protocol: player connect, round start, kill tracking",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771989848026,
          "sprintNumber": 2
        },
        {
          "id": "client-no-errors",
          "category": "Client",
          "title": "No JS runtime errors from new protocol handlers",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771989848994,
          "sprintNumber": 2
        },
        {
          "id": "integration-full-loop",
          "category": "Integration",
          "title": "Full gameplay loop: connect, round start, bomb, kill, round end, reset",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771991759050,
          "sprintNumber": 2
        },
        {
          "id": "task4-code-review",
          "category": "Code Review",
          "title": "Task-4: Round reset code review",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771992763171,
          "sprintNumber": 2
        },
        {
          "id": "task4-round-reset",
          "category": "Integration",
          "title": "Task-4: Round reset - map regen, player reset, auto-restart",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771993843594,
          "sprintNumber": 2
        },
        {
          "id": "task8-hud",
          "category": "HUD",
          "title": "Task-8: HUD timer, scoreboard, results cycle",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771993942290,
          "sprintNumber": 2
        },
        {
          "id": "task11-latejoin",
          "category": "Protocol",
          "title": "Task-11: Round state + scoreboard sent to new players",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771993943490,
          "sprintNumber": 2
        },
        {
          "id": "task10-map-reload",
          "category": "Code Review",
          "title": "Task-10: Client map reload on round reset",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771993971996,
          "sprintNumber": 2
        },
        {
          "id": "task9-spectator",
          "category": "Code Review",
          "title": "Task-9: Dead player spectator mode + input blocking",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771994039647,
          "sprintNumber": 2
        },
        {
          "id": "final-integration",
          "category": "Integration",
          "title": "Final integration: all 11 tasks end-to-end",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771994135256,
          "sprintNumber": 2
        },
        {
          "id": "server-startup",
          "category": "Build",
          "title": "Server starts without crashes",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771994223486,
          "sprintNumber": 2
        },
        {
          "id": "client-load",
          "category": "Navigation",
          "title": "Client loads lobby screen",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771994245560,
          "sprintNumber": 2
        },
        {
          "id": "client-connect",
          "category": "Navigation",
          "title": "Client connects to game server",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771994288827,
          "sprintNumber": 2
        },
        {
          "id": "round-autostart",
          "category": "Round System",
          "title": "Round auto-starts with 2 players",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771994341061,
          "sprintNumber": 2
        },
        {
          "id": "hud-timer",
          "category": "HUD",
          "title": "Round timer displays and counts down",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771994342019,
          "sprintNumber": 2
        },
        {
          "id": "hud-scoreboard",
          "category": "HUD",
          "title": "Scoreboard shows both players with stats",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771994342814,
          "sprintNumber": 2
        },
        {
          "id": "bomb-placement",
          "category": "Gameplay",
          "title": "Bomb placement works during active round",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771994569183,
          "sprintNumber": 2
        },
        {
          "id": "results-screen",
          "category": "HUD",
          "title": "Results screen shows all players",
          "status": "fixed",
          "error": null,
          "fix": "Fixed RE parser, now both players show in results table with correct stats",
          "timestamp": 1771994568226,
          "sprintNumber": 2
        },
        {
          "id": "kill-feed",
          "category": "Round System",
          "title": "Kill feed broadcasts KF message on player death",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771994570314,
          "sprintNumber": 2
        },
        {
          "id": "death-tracking",
          "category": "Round System",
          "title": "Death tracking updates scoreboard (PK + SB messages)",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771994571533,
          "sprintNumber": 2
        },
        {
          "id": "round-end",
          "category": "Round System",
          "title": "Round ends when 1 player remains (checkRoundEnd)",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771994572726,
          "sprintNumber": 2
        },
        {
          "id": "map-regen",
          "category": "Round System",
          "title": "Map regeneration on round reset (RR + new WL)",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771994573775,
          "sprintNumber": 2
        },
        {
          "id": "stats-reset",
          "category": "Round System",
          "title": "Player stats reset between rounds (kills/deaths back to 0)",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771994574678,
          "sprintNumber": 2
        },
        {
          "id": "spectator-mode",
          "category": "Gameplay",
          "title": "Dead player enters spectator mode (no input)",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771994625161,
          "sprintNumber": 2
        },
        {
          "id": "spectator-code",
          "category": "Code Review",
          "title": "Spectator input blocking (client+server) correctly wired",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771994626290,
          "sprintNumber": 2
        },
        {
          "id": "kill-feed-chat",
          "category": "HUD",
          "title": "Kill feed appears in chat panel",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771994653181,
          "sprintNumber": 2
        },
        {
          "id": "powerup-persist",
          "category": "Gameplay",
          "title": "Power-ups persist until collected or exploded",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771994677116,
          "sprintNumber": 2
        },
        {
          "id": "console-errors",
          "category": "Build",
          "title": "No JavaScript console errors during gameplay",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771994686700,
          "sprintNumber": 2
        },
        {
          "id": "integration",
          "category": "Integration",
          "title": "Full round lifecycle integration test",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771994727759,
          "sprintNumber": 2
        }
      ],
      "startedAt": 1771985966577,
      "completedAt": 1771994987460
    },
    {
      "sprintNumber": 3,
      "type": "sprint",
      "prompt": "This sprint enables multiple concurrent game instances and adds visual variety. Implement a full room/lobby system where players can: view a lobby listing available rooms (name, player count, status), create a new named room with configurable player limit (2–8), join an existing room, and see a waiting room screen before the round starts. Each room must have completely isolated state — its own map, player list, bomb state, round timer, power-ups, and scoreboard. Add REST API endpoints under the existing /api/ route namespace for listing and creating rooms. Use Socket.io rooms or namespaces to isolate broadcasts between game instances. The HTML already contains a non-functional room button placeholder that confirms this feature was planned. Room isolation is critical: bombs in room A must never affect room B, and all game state must be fully independent per room. Additionally, implement map theme support using the three tilesets already present in the assets (default, winter, and moon themes). The active theme should be configurable per room or selected randomly at round start. Broadcast the active theme ID to clients when they join so they load the correct tileset.",
      "tasks": [
        {
          "id": "task-1",
          "title": "Install socket.io and update package.json",
          "description": "Install socket.io as a dependency (replacing ws) and serve socket.io-client to the browser.\n\n**Steps:**\n1. Run `npm install socket.io` in the project root\n2. Update `package.json` — socket.io should appear in dependencies\n3. The socket.io client library will be auto-served at `/socket.io/socket.io.js` by the socket.io server\n\n**Files to modify:**\n- `package.json` — add `\"socket.io\": \"^4.7.4\"` to dependencies (keep `ws` temporarily for reference but it will no longer be used)\n\n**Acceptance criteria:**\n- `npm install` runs cleanly\n- `socket.io` appears in `node_modules`\n- `package.json` has socket.io in dependencies",
          "status": "done",
          "priority": "high",
          "assignee": "developer-1",
          "assigneeRole": "developer",
          "dependencies": [],
          "files": [
            "package.json"
          ],
          "branch": "agent/developer-1",
          "createdBy": "ceo",
          "checkResult": "Installed socket.io ^4.8.3 via npm. package.json updated with socket.io in dependencies, ws kept for reference. npm install runs clean, socket.io present in node_modules.",
          "createdAt": 1771995076041,
          "updatedAt": 1771995562411
        },
        {
          "id": "task-2",
          "title": "Create Room class with isolated game state",
          "description": "Create `server/roomManager.js` containing the Room class and RoomManager. This is the core data model for Sprint 3.\n\n**Room class** — each instance holds fully isolated game state:\n```js\nclass Room {\n  constructor(id, name, maxPlayers, themeId, creatorId) {\n    this.id = id;\n    this.name = name;\n    this.maxPlayers = maxPlayers; // 2-8\n    this.themeId = themeId; // 'default' | 'winter' | 'moon' | 'random'\n    this.activeTheme = themeId === 'random' ? pickRandomTheme() : themeId;\n    this.creatorId = creatorId;\n    this.state = 'waiting'; // 'waiting' | 'playing'\n    \n    // Isolated game state (moved from server.js globals)\n    this.cells = [];\n    this.players = new Map(); // socketId -> player object\n    this.bombs = [];\n    this.items = [];\n    this.nextPlayerId = 1;\n    this.nextBombId = 1;\n    this.nextItemId = 1;\n    this.roundState = { state: 'waiting', timer: null, startTime: 0, roundNumber: 0, timeInterval: null, lastResults: null };\n    this.tickInterval = null;\n  }\n}\n```\n\n**RoomManager class:**\n```js\nclass RoomManager {\n  constructor() {\n    this.rooms = new Map(); // roomId -> Room\n    this.nextRoomId = 1;\n  }\n  createRoom(name, maxPlayers, themeId, creatorId) { ... }\n  getRoom(roomId) { ... }\n  removeRoom(roomId) { ... }\n  listRooms() { ... } // returns array of { id, name, playerCount, maxPlayers, status, themeId }\n  getPlayerRoom(socketId) { ... } // find which room a player is in\n}\n```\n\n**Theme mapping constant:**\n```js\nconst THEMES = {\n  'default': 'assets/maps/1.png',\n  'winter': 'assets/maps/1-winter.png', \n  'moon': 'assets/maps/tileset-moon.png'\n};\n```\n\nAlso include the helper function `pickRandomTheme()` that picks randomly from ['default', 'winter', 'moon'].\n\n**Move these functions from server.js into Room prototype methods** (copy them, don't modify server.js yet — that's a separate task):\n- `initializeMap()`, `getMapData()`, `getRandomWalkableCell()`, `getRandomWalkableCellStart()`, `has3PlacesAround()`\n- `getCellByTilePos()`, `getCellAtPixel()`, `getDirCells()`, `countWalkable()`\n- `createCell()`, `getRandomInt()`\n\nExport both classes and the THEMES constant: `module.exports = { Room, RoomManager, THEMES }`\n\n**Persistence:** On room create/delete, save room metadata to `.db/rooms.json` (create `.db/` directory if missing). Use `fs.writeFileSync` for simplicity. Only persist metadata (id, name, maxPlayers, themeId, creatorId) — not live game state.\n\n**Acceptance criteria:**\n- Room class has all isolated state properties\n- RoomManager can create, get, list, remove rooms\n- initializeMap() works per-room on room.cells\n- THEMES maps theme IDs to asset paths\n- `.db/rooms.json` is written on room create/delete\n- Both classes exported properly",
          "status": "done",
          "priority": "high",
          "assignee": "developer-1",
          "assigneeRole": "developer",
          "dependencies": [
            "task-1"
          ],
          "files": [
            "server/roomManager.js"
          ],
          "branch": "agent/developer-1",
          "createdBy": "ceo",
          "checkResult": "Created server/roomManager.js with Room class (isolated game state: cells, players, bombs, items, round state + map init/query methods) and RoomManager class (create/get/list/remove rooms with .db/rooms.json persistence). Exports Room, RoomManager, THEMES, DIR, constants, and helpers. Added .db/ to .gitignore.",
          "createdAt": 1771995095853,
          "updatedAt": 1771995714930
        },
        {
          "id": "task-3",
          "title": "Move game logic methods into Room class",
          "description": "Extract all game logic functions from `server.js` into Room prototype methods in `server/roomManager.js`. Each method must operate on `this.cells`, `this.players`, `this.bombs`, `this.items` instead of global arrays.\n\n**Methods to move (adapt `this.` references):**\n\nPlayer methods:\n- `createPlayer(socket)` — uses `this.nextPlayerId++`, spawns on `this.cells`, returns player object\n- `getClientDirection(player)`\n- `getPlayerCurCell(player)` — uses `this.getCellAtPixel()`\n- `getPlayerPossibleCell(player, dx, dy)`\n- `isWalkableCheckBomb(cell, player)`\n- `findPlayerById(id)` — searches `this.players`\n- `movePlayer(player)` — uses room's MAP_WIDTH/MAP_HEIGHT\n\nBomb methods:\n- `addBomb(player)` — uses `this.nextBombId++`, pushes to `this.bombs`, calls `this.broadcastAll()`\n- `explodeBomb(bomb)` — operates on `this.cells`, `this.players`, `this.bombs`\n- `explodeLine(cellList, bomb)` — calls `this.killPlayer()`, `this.despawnItem()`\n- `removeBomb(bomb)` — from `this.bombs`\n\nItem methods:\n- `trySpawnItem(cell)` — uses `this.nextItemId++`, pushes to `this.items`\n- `despawnItem(item)` — removes from `this.items`\n- `pickupItem(player, item)` — removes from `this.items`\n\nKill/Round methods:\n- `killPlayer(player, bomb)` — uses `this.broadcastAll()`, calls `this.checkRoundEnd()`\n- `broadcastScoreboard()` — iterates `this.players`\n- `startRound()` — operates on `this.roundState`, `this.players`\n- `endRound(winnerId, winnerNickname)`\n- `resetRound()` — clears `this.bombs`, `this.items`, re-inits `this.cells`\n- `checkRoundEnd()`\n- `broadcastRoundState()`\n\nBroadcast methods (CRITICAL — must use Socket.io room scoping):\n- `broadcast(message, excludeSocket)` — `io.to('room:' + this.id).except(excludeSocket.id).emit('game', message)`\n- `broadcastAll(message)` — `io.to('room:' + this.id).emit('game', message)`\n- `sendTo(socket, message)` — `socket.emit('game', message)`\n- `sendCellUpdate(cell)`\n\nMovement:\n- `gameTick()` — iterates `this.players`, calls `this.movePlayer()`\n- `forceKeyUp(player, binDir)`\n\nMessage handling:\n- `handleKeyDown(player, message)`\n- `handleKeyUp(player, message)`\n- `handleChatMessage(player, message)`\n- `handleWorldLoad(player, socket)`\n- `handleWorldEntities(player, socket)`\n- `handleNicknameInit(player, message)`\n- `processMessage(socket, player, message)`\n\n**Important:** The Room constructor must accept an `io` reference (Socket.io server instance) so broadcast methods can use `io.to(...)`. Store as `this.io`.\n\n**Room.startTick() / Room.stopTick():**\n- `startTick()` — `this.tickInterval = setInterval(() => this.gameTick(), TICK_MS)`\n- `stopTick()` — `clearInterval(this.tickInterval)`\n\n**Constants** — keep at module level (same as current server.js):\nMAP_WIDTH=80, MAP_HEIGHT=42, TILE_SIZE=32, TICK_RATE=60, BOMB_TIMER_MS=3000, DEFAULT_SPEED=1.5, DEFAULT_RANGE=2, DEFAULT_MAX_BOMBS=1, ROUND_DURATION_MS=180000, ROUND_END_DISPLAY_MS=5000, MIN_PLAYERS_TO_START=2, DIR bitmasks.\n\n**Acceptance criteria:**\n- All game logic is in Room methods\n- No references to global `cells`, `players`, `bombs`, `items` — always `this.*`\n- Broadcast methods use Socket.io `io.to('room:' + this.id)` pattern\n- `gameTick()` only processes players in this room\n- Room can be instantiated independently with isolated state",
          "status": "done",
          "priority": "high",
          "assignee": "developer-1",
          "assigneeRole": "developer",
          "dependencies": [
            "task-2"
          ],
          "files": [
            "server/roomManager.js"
          ],
          "branch": "agent/developer-1",
          "createdBy": "ceo",
          "checkResult": "Moved all game logic from server.js into Room class methods: player management (createPlayer, movement, direction), bomb system (addBomb, explodeBomb, chain explosions), item system (spawn, despawn, pickup), kill/round state machine (startRound, endRound, resetRound, checkRoundEnd), message handlers (processMessage, handleKeyDown/Up, etc.), and tick system (gameTick, startTick, stopTick). Broadcast methods use Socket.io io.to('room:'+id) pattern. Room and RoomManager constructors accept io parameter. All 36 methods verified working with no global state references.",
          "createdAt": 1771995119561,
          "updatedAt": 1771995963000
        },
        {
          "id": "task-4",
          "title": "Refactor server.js to use Socket.io and RoomManager",
          "description": "Major refactor of `server.js`: replace raw `ws` with Socket.io, remove all global game state, delegate everything to RoomManager.\n\n**Current server.js architecture (to be replaced):**\n- Uses `require('ws')` and `new WebSocket.Server({ server, path: '/echo' })`\n- Global state: `cells[]`, `players Map(ws->player)`, `bombs[]`, `items[]`, `roundState`\n- Single `gameTick()` interval for all players\n- `broadcast()` sends to all connected clients\n\n**New server.js architecture:**\n```js\nconst { Server } = require('socket.io');\nconst { RoomManager, THEMES } = require('./server/roomManager');\n\nconst io = new Server(server, { path: '/echo', cors: { origin: '*' } });\nconst roomManager = new RoomManager();\n\nio.on('connection', (socket) => {\n  console.log('Client connected:', socket.id);\n\n  // Handle nickname init\n  socket.on('nicknameInit', (data) => {\n    socket.nickname = data.nickname;\n    socket.skinId = data.skinId;\n  });\n\n  // Handle room join\n  socket.on('joinRoom', (roomId) => {\n    const room = roomManager.getRoom(roomId);\n    if (!room) { socket.emit('error', 'Room not found'); return; }\n    if (room.players.size >= room.maxPlayers) { socket.emit('error', 'Room is full'); return; }\n    \n    socket.join('room:' + roomId);\n    socket.currentRoomId = roomId;\n    \n    const player = room.createPlayer(socket);\n    room.players.set(socket.id, player);\n    \n    // Send theme\n    socket.emit('game', 'TH' + room.activeTheme);\n    \n    // Send room player list to all in room\n    broadcastRoomPlayerList(room);\n    \n    // If room not yet started, check auto-start conditions\n    // Start tick if first player\n    if (!room.tickInterval) room.startTick();\n  });\n\n  // Handle game messages (same protocol as before)\n  socket.on('game', (message) => {\n    const roomId = socket.currentRoomId;\n    if (!roomId) return;\n    const room = roomManager.getRoom(roomId);\n    if (!room) return;\n    const player = room.players.get(socket.id);\n    if (!player) return;\n    room.processMessage(socket, player, message);\n  });\n\n  // Handle room leave\n  socket.on('leaveRoom', () => { ... });\n\n  // Handle disconnect\n  socket.on('disconnect', () => {\n    const roomId = socket.currentRoomId;\n    if (roomId) {\n      const room = roomManager.getRoom(roomId);\n      if (room) {\n        const player = room.players.get(socket.id);\n        if (player) {\n          room.broadcastAll('PD' + player.id); // but scoped to room via io.to\n          room.players.delete(socket.id);\n          if (room.roundState.state === 'active') room.checkRoundEnd();\n          // Destroy room if empty\n          if (room.players.size === 0) {\n            room.stopTick();\n            roomManager.removeRoom(roomId);\n          }\n          broadcastRoomPlayerList(room);\n        }\n      }\n    }\n  });\n});\n```\n\n**Remove from server.js:**\n- All global state variables (cells, players, bombs, items, roundState, nextId counters)\n- All game logic functions (they're now in Room class)\n- The old `wss = new WebSocket.Server(...)` setup\n- The global `tickInterval`\n\n**Keep in server.js:**\n- HTTP server creation (`http.createServer`)\n- Socket.io server creation\n- Port config (9998)\n- `SIGINT` handler (adapted to stop all room ticks)\n- The `io.on('connection', ...)` handler with room routing\n\n**Add helper function `broadcastRoomPlayerList(room)`:**\nSends `RL{p1Id}|{p1Nick}|{p1SkinId};{p2Id}|{p2Nick}|{p2SkinId};...` to all sockets in the room.\n\n**Handle the `startGame` event** from room creator:\n```js\nsocket.on('startGame', () => {\n  const room = roomManager.getRoom(socket.currentRoomId);\n  if (!room) return;\n  if (room.creatorId !== socket.id) return; // only creator can start\n  if (room.players.size < MIN_PLAYERS_TO_START) return;\n  room.state = 'playing';\n  // Send world load to all players in room\n  for (const [sid, p] of room.players) {\n    const s = io.sockets.sockets.get(sid);\n    if (s) room.handleWorldLoad(p, s);\n  }\n  // Then entities\n  for (const [sid, p] of room.players) {\n    const s = io.sockets.sockets.get(sid);\n    if (s) room.handleWorldEntities(p, s);\n  }\n});\n```\n\n**Acceptance criteria:**\n- Server starts with Socket.io instead of ws\n- No global game state remains in server.js\n- Multiple rooms can exist simultaneously with isolated state\n- Connecting a socket and joining a room works\n- Game messages are routed to correct room\n- Empty rooms are cleaned up\n- Graceful shutdown stops all room ticks",
          "status": "done",
          "priority": "high",
          "assignee": "developer-1",
          "assigneeRole": "developer",
          "dependencies": [
            "task-3"
          ],
          "files": [
            "server.js"
          ],
          "branch": "agent/developer-1",
          "createdBy": "ceo",
          "checkResult": "Rewrote server.js from 1046 lines to 201 lines. Replaced raw ws with Socket.io Server (path: /echo, cors: *). Removed all global game state and game logic functions — everything delegated to RoomManager and Room class. Added Socket.io connection handler with room-scoped routing: joinRoom, leaveRoom, disconnect, startGame, nicknameInit events. Game messages (via 'game' event) are routed to the correct Room using socket.currentRoomId. Added broadcastRoomPlayerList helper (RL protocol). Empty rooms auto-destroyed on last disconnect. Graceful SIGINT iterates all rooms to stop ticks/timers.",
          "createdAt": 1771995144605,
          "updatedAt": 1771996309146
        },
        {
          "id": "task-5",
          "title": "Add REST API endpoints for room listing and creation",
          "description": "Add REST API routes to the HTTP server for listing and creating rooms. Since Socket.io creates its own HTTP server, merge the static file serving and API into the same HTTP server that Socket.io attaches to.\n\n**Modify `http_server.js`** to add API route handling BEFORE the static file fallback:\n\n```js\nconst server = http.createServer((req, res) => {\n  const urlPath = req.url.split('?')[0];\n  \n  // ─── API Routes ──────────────────────────────────\n  if (urlPath === '/api/rooms' && req.method === 'GET') {\n    res.writeHead(200, { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' });\n    const rooms = roomManager.listRooms();\n    res.end(JSON.stringify(rooms));\n    return;\n  }\n  \n  if (urlPath === '/api/rooms' && req.method === 'POST') {\n    let body = '';\n    req.on('data', chunk => body += chunk);\n    req.on('end', () => {\n      try {\n        const { name, maxPlayers, themeId } = JSON.parse(body);\n        // Validate\n        if (!name || name.trim().length === 0 || name.length > 20) {\n          res.writeHead(400, { 'Content-Type': 'application/json' });\n          res.end(JSON.stringify({ error: 'Room name required (1-20 chars)' }));\n          return;\n        }\n        const max = parseInt(maxPlayers) || 4;\n        if (max < 2 || max > 8) {\n          res.writeHead(400, { 'Content-Type': 'application/json' });\n          res.end(JSON.stringify({ error: 'Max players must be 2-8' }));\n          return;\n        }\n        const validThemes = ['default', 'winter', 'moon', 'random'];\n        const theme = validThemes.includes(themeId) ? themeId : 'random';\n        \n        const room = roomManager.createRoom(name.trim(), max, theme, null); // creatorId set on join\n        res.writeHead(201, { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' });\n        res.end(JSON.stringify({ id: room.id, name: room.name, maxPlayers: room.maxPlayers, themeId: room.themeId, status: room.state }));\n      } catch (e) {\n        res.writeHead(400, { 'Content-Type': 'application/json' });\n        res.end(JSON.stringify({ error: 'Invalid JSON body' }));\n      }\n    });\n    return;\n  }\n  \n  // Handle CORS preflight\n  if (req.method === 'OPTIONS') {\n    res.writeHead(204, {\n      'Access-Control-Allow-Origin': '*',\n      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\n      'Access-Control-Allow-Headers': 'Content-Type'\n    });\n    res.end();\n    return;\n  }\n  \n  // ─── Static file serving (existing code) ────────\n  // ... existing static file logic ...\n});\n```\n\n**IMPORTANT architecture decision:** Since `server.js` now creates a Socket.io server on port 9998, and `http_server.js` serves static files on port 8060, the API needs access to the `roomManager` instance. Two approaches:\n\n**Chosen approach:** Merge both servers. The Socket.io HTTP server (port 9998) also serves static files AND API routes. This means:\n1. Move static file serving logic from `http_server.js` into `server.js`'s HTTP request handler\n2. Add API routes to the same request handler\n3. `http_server.js` becomes optional (or a redirect)\n4. Update `package.json` start script to just `node server.js`\n\nAlternatively, export roomManager and import in http_server — but a single server is simpler.\n\n**Update `server.js`** HTTP createServer callback to handle:\n1. `/api/rooms` GET — return `roomManager.listRooms()`\n2. `/api/rooms` POST — create room via `roomManager.createRoom()`\n3. CORS OPTIONS preflight\n4. Static file serving (copy logic from http_server.js)\n5. Default to `index.html` for `/`\n\n**Update `package.json`** scripts:\n- `\"start\": \"node server.js\"` (single server)\n- `\"dev\": \"node server.js\"`\n\n**Acceptance criteria:**\n- `GET /api/rooms` returns JSON array of rooms\n- `POST /api/rooms` with `{\"name\":\"Test\",\"maxPlayers\":4,\"themeId\":\"winter\"}` creates a room and returns 201\n- Invalid inputs return 400 with error message\n- Static files still served correctly\n- CORS headers present on all API responses\n- Single server process on port 9998 handles everything",
          "status": "done",
          "priority": "high",
          "assignee": "developer-1",
          "assigneeRole": "developer",
          "dependencies": [
            "task-4"
          ],
          "files": [
            "server.js",
            "http_server.js",
            "package.json"
          ],
          "branch": "agent/developer-1",
          "createdBy": "ceo",
          "checkResult": "Merged static file serving and REST API into server.js (single server on port 9998). Added GET /api/rooms (returns JSON list via roomManager.listRooms()), POST /api/rooms with validation (name 1-20 chars, maxPlayers 2-8, theme from valid set), and CORS OPTIONS preflight. Updated package.json scripts to single \"node server.js\". Room creatorId is set to first joining socket when API creates with null creator.",
          "createdAt": 1771995166610,
          "updatedAt": 1771996579477
        },
        {
          "id": "task-6",
          "title": "Migrate client WebSocket to Socket.io",
          "description": "Replace the native `WebSocket` usage in `js/aks.js` with Socket.io client. This is the client-side counterpart of the server migration.\n\n**Add socket.io client script to `index.html`:**\nAdd before other scripts:\n```html\n<script src=\"/socket.io/socket.io.js\"></script>\n```\nSocket.io auto-serves this file from the server. Place it right after the jQuery script tag (line 34 in index.html).\n\n**Rewrite `js/aks.js`:**\n\nReplace `InitializeSocket()`:\n```js\nfunction InitializeSocket() {\n  // Connect to Socket.io server (same host, port 9998)\n  socket = io('ws://localhost:9998', { path: '/echo', transports: ['websocket'] });\n\n  socket.on('connect', function() {\n    reconnectAttempt = 0;\n    ConnectionStatus.onConnected();\n    LoadingManager.assetLoaded('Server connection');\n    LoadingManager.setStatus('Joining room...');\n    \n    // Send nickname/skin init\n    socket.emit('nicknameInit', { nickname: playerNickname, skinId: playerSkinId });\n    \n    // Join room (currentRoomId must be set before calling InitializeSocket)\n    socket.emit('joinRoom', currentRoomId);\n    \n    console.log('Socket.io connected');\n  });\n\n  // All game protocol messages come via 'game' event\n  socket.on('game', function(received_msg) {\n    // ... existing message parsing logic (the big switch statement) ...\n    // Keep all existing cases: B/A, B/E, I/A, I/D, I/S, K/F, M/N, P/A, P/D, P/M, P/S, P/K, W/L, W/C, R/S, R/W, R/R, R/E, S/B\n    // Add new cases for Sprint 3 messages\n  });\n\n  // Room-specific events\n  socket.on('roomJoined', function(data) {\n    // data = { roomId, roomName }\n    console.log('Joined room:', data.roomName);\n  });\n\n  socket.on('roomPlayerList', function(data) {\n    // data = array of { id, nickname, skinId }\n    if (typeof RoomUI !== 'undefined') RoomUI.updateWaitingRoom(data);\n  });\n\n  socket.on('gameStart', function() {\n    // Room creator started the game — transition from waiting room to game\n    if (typeof RoomUI !== 'undefined') RoomUI.hideWaitingRoom();\n    document.getElementById('chat').style.display = '';\n    // Request world load\n    sendSocketMessage('WL');\n    initWorld();\n  });\n\n  socket.on('error', function(msg) {\n    console.error('Server error:', msg);\n    alert(msg);\n  });\n\n  socket.on('disconnect', function() {\n    console.log('Socket.io disconnected');\n    if (reconnectAttempt < ConnectionStatus.maxRetries) {\n      ConnectionStatus.onDisconnected();\n      ConnectionStatus.onRetrying(reconnectAttempt);\n      reconnectAttempt++;\n    } else {\n      ConnectionStatus.onPermanentFailure();\n    }\n  });\n}\n```\n\n**Replace `sendSocketMessage()`:**\n```js\nfunction sendSocketMessage(message) {\n  console.log('send:', message);\n  socket.emit('game', message);\n}\n```\n\n**Add new protocol handler for `TH` (theme):**\nIn the `game` event handler switch, add:\n```js\ncase 'T':\n  if (action === 'H') {\n    // TH{themeId} — set active theme\n    currentTheme = received_msg.substring(2);\n    console.log('Theme set to:', currentTheme);\n  }\n  break;\n```\n\n**Modify the WL handler** to use theme-aware tileset:\n```js\ncase 'W':\n  switch(action) {\n    case 'L':\n      fosfo0.clear();\n      world = new World(received_msg.substring(2), currentTheme); // pass theme\n      world.loadWorld();\n      // ...\n```\n\n**Acceptance criteria:**\n- Socket.io client loads from `/socket.io/socket.io.js`\n- `InitializeSocket()` uses `io()` instead of `new WebSocket()`\n- All existing protocol messages still parsed correctly\n- `sendSocketMessage()` uses `socket.emit('game', msg)`\n- New events handled: `roomJoined`, `roomPlayerList`, `gameStart`, `error`\n- TH theme message parsed and stored in `currentTheme` global\n- Reconnection logic still works via Socket.io's built-in reconnect",
          "status": "done",
          "priority": "high",
          "assignee": "developer-2",
          "assigneeRole": "developer",
          "dependencies": [
            "task-4"
          ],
          "files": [
            "js/aks.js",
            "index.html"
          ],
          "branch": "agent/developer-2",
          "createdBy": "ceo",
          "checkResult": "Migrated client from native WebSocket to Socket.io. Replaced sendSocketMessage() to use socket.emit('game', msg). InitializeSocket() now creates Socket.io connection and emits nicknameInit + joinRoom on connect. Added handlers for room events (roomJoined, roomPlayerList, roomCreatorTransfer, gameStart, roomError). Added TH theme protocol handler that updates currentTheme and preloads new tileset. WL and WC handlers now use dynamic theme-aware tileset paths. Socket.io client script tag added to index.html after jQuery.",
          "createdAt": 1771995191580,
          "updatedAt": 1771996615738
        },
        {
          "id": "task-7",
          "title": "Update client globals for room and theme state",
          "description": "Add new global variables to `js/globals.js` for room system and theme support.\n\n**Add these variables to `js/globals.js`:**\n```js\n// Room system\nvar currentRoomId = null;    // ID of the room the player is in\nvar currentRoomName = '';     // Name of current room\nvar isRoomCreator = false;    // Whether current player created the room\nvar roomPlayerList = [];      // Players in the waiting room [{ id, nickname, skinId }]\n\n// Theme system\nvar currentTheme = 'default'; // Active theme: 'default' | 'winter' | 'moon'\nvar THEME_TILESETS = {\n  'default': 'assets/maps/1.png',\n  'winter': 'assets/maps/1-winter.png',\n  'moon': 'assets/maps/tileset-moon.png'\n};\n```\n\n**Acceptance criteria:**\n- All new globals declared and initialized\n- `THEME_TILESETS` maps theme IDs to correct asset file paths matching the actual files in `assets/maps/`\n- No existing globals removed or renamed",
          "status": "done",
          "priority": "high",
          "assignee": "developer-2",
          "assigneeRole": "developer",
          "dependencies": [
            "task-1"
          ],
          "files": [
            "js/globals.js"
          ],
          "branch": "agent/developer-2",
          "createdBy": "ceo",
          "checkResult": "Added room system globals (currentRoomId, currentRoomName, isRoomCreator, roomPlayerList) and theme system globals (currentTheme, THEME_TILESETS mapping default/winter/moon to asset paths) to js/globals.js. No existing globals removed or renamed.",
          "createdAt": 1771995200196,
          "updatedAt": 1771995635516
        },
        {
          "id": "task-8",
          "title": "Build room browser UI (HTML + JS)",
          "description": "Create the room browser screen that appears after nickname/skin selection (after clicking PLAY in the lobby). Players see available rooms and can join or create new ones.\n\n**Add HTML to `index.html`** — insert a new screen div AFTER the lobby-screen div (before loading-screen):\n```html\n<!-- Room Browser Screen -->\n<div id=\"room-browser\" style=\"display:none;\">\n  <div class=\"room-browser-container\">\n    <h1 class=\"room-browser-title\">Game Rooms</h1>\n    <p class=\"room-browser-subtitle\">Join an existing room or create your own</p>\n    \n    <div class=\"room-browser-actions\">\n      <button id=\"create-room-btn\" class=\"create-room-btn\">+ CREATE ROOM</button>\n      <button id=\"refresh-rooms-btn\" class=\"refresh-rooms-btn\">↻ REFRESH</button>\n    </div>\n    \n    <div id=\"room-list\" class=\"room-list\">\n      <!-- Room cards populated by JS -->\n      <div class=\"room-list-empty\" id=\"room-list-empty\">No rooms available. Create one!</div>\n    </div>\n    \n    <!-- Create Room Modal -->\n    <div id=\"create-room-modal\" class=\"create-room-modal\" style=\"display:none;\">\n      <div class=\"create-room-form\">\n        <h2>Create New Room</h2>\n        <div class=\"form-group\">\n          <label for=\"room-name-input\">Room Name</label>\n          <input type=\"text\" id=\"room-name-input\" maxlength=\"20\" placeholder=\"My Room\" autocomplete=\"off\">\n        </div>\n        <div class=\"form-group\">\n          <label for=\"room-max-players\">Max Players</label>\n          <div class=\"slider-group\">\n            <input type=\"range\" id=\"room-max-players\" min=\"2\" max=\"8\" value=\"4\">\n            <span id=\"room-max-players-label\">4</span>\n          </div>\n        </div>\n        <div class=\"form-group\">\n          <label>Map Theme</label>\n          <div class=\"theme-selector\" id=\"theme-selector\">\n            <div class=\"theme-option selected\" data-theme=\"random\">\n              <span class=\"theme-icon\">🎲</span>\n              <span>Random</span>\n            </div>\n            <div class=\"theme-option\" data-theme=\"default\">\n              <span class=\"theme-icon\">🌿</span>\n              <span>Default</span>\n            </div>\n            <div class=\"theme-option\" data-theme=\"winter\">\n              <span class=\"theme-icon\">❄️</span>\n              <span>Winter</span>\n            </div>\n            <div class=\"theme-option\" data-theme=\"moon\">\n              <span class=\"theme-icon\">🌙</span>\n              <span>Moon</span>\n            </div>\n          </div>\n        </div>\n        <div class=\"form-actions\">\n          <button id=\"create-room-confirm\" class=\"create-room-confirm\">CREATE</button>\n          <button id=\"create-room-cancel\" class=\"create-room-cancel\">CANCEL</button>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n\n<!-- Waiting Room Screen -->\n<div id=\"waiting-room\" style=\"display:none;\">\n  <div class=\"waiting-room-container\">\n    <h1 class=\"waiting-room-title\" id=\"waiting-room-title\">Room Name</h1>\n    <div class=\"waiting-room-theme\" id=\"waiting-room-theme\"></div>\n    <div class=\"waiting-room-players\" id=\"waiting-room-players\">\n      <!-- Player cards populated by JS -->\n    </div>\n    <div class=\"waiting-room-status\" id=\"waiting-room-status\">Waiting for players...</div>\n    <button id=\"start-game-btn\" class=\"start-game-btn\" style=\"display:none;\">START GAME</button>\n    <button id=\"leave-room-btn\" class=\"leave-room-btn\">LEAVE ROOM</button>\n  </div>\n</div>\n```\n\n**Create `js/rooms.js`** with `RoomUI` object:\n```js\nvar RoomUI = (function() {\n  var refreshInterval = null;\n\n  function init() { ... }\n  function showBrowser() { ... }   // show room-browser, hide other screens\n  function hideBrowser() { ... }\n  function fetchRooms() { ... }    // GET /api/rooms, render room cards\n  function renderRoomList(rooms) { ... } // build room cards in #room-list\n  function joinRoom(roomId) { ... }     // set currentRoomId, call InitializeSocket()\n  function showCreateModal() { ... }\n  function hideCreateModal() { ... }\n  function createRoom() { ... }         // POST /api/rooms, then joinRoom()\n  function showWaitingRoom(roomName, themeId) { ... }\n  function hideWaitingRoom() { ... }\n  function updateWaitingRoom(playerList) { ... } // render player cards\n  function startAutoRefresh() { refreshInterval = setInterval(fetchRooms, 3000); }\n  function stopAutoRefresh() { clearInterval(refreshInterval); }\n\n  return { init, showBrowser, hideBrowser, fetchRooms, joinRoom, createRoom,\n           showWaitingRoom, hideWaitingRoom, updateWaitingRoom };\n})();\n```\n\n**Room card HTML structure** (generated by renderRoomList):\n```html\n<div class=\"room-card\" data-room-id=\"1\">\n  <div class=\"room-card-header\">\n    <span class=\"room-card-name\">Room Name</span>\n    <span class=\"room-card-theme\">❄️</span>\n  </div>\n  <div class=\"room-card-info\">\n    <span class=\"room-card-players\">3/8 players</span>\n    <span class=\"room-card-status status-waiting\">Waiting</span>\n  </div>\n  <button class=\"room-card-join\">JOIN</button>\n</div>\n```\n\n**Waiting room player card:**\n```html\n<div class=\"waiting-player-card\">\n  <canvas class=\"waiting-player-skin\" width=\"32\" height=\"32\"></canvas>\n  <span class=\"waiting-player-name\">PlayerName</span>\n</div>\n```\n\n**Flow:**\n1. Lobby PLAY button → show room browser (modify `js/lobby.js` `startGame()`)\n2. Room browser fetches rooms, renders cards\n3. Click JOIN → `RoomUI.joinRoom(id)` → sets currentRoomId → calls InitializeSocket() → on connect, emits joinRoom → receives roomJoined → shows waiting room\n4. Click CREATE → shows modal → fill form → POST /api/rooms → joinRoom(newId)\n5. Waiting room shows players via `roomPlayerList` event\n6. START GAME button (only for creator, only when ≥2 players) → `socket.emit('startGame')` → server starts game → gameStart event → hide waiting room, show game\n\n**Modify `js/lobby.js`:**\nChange `startGame()` function to NOT call `preload()` directly. Instead:\n```js\nfunction startGame() {\n  document.getElementById('lobby-screen').style.display = 'none';\n  RoomUI.showBrowser();\n}\n```\n\n**Add `<script src=\"./js/rooms.js\"></script>` to index.html** — add AFTER lobby.js.\n**Add `<link rel=\"stylesheet\" href=\"./css/rooms.css\">` to index.html** head.\n\n**Acceptance criteria:**\n- Room browser screen shows after PLAY\n- Room list populated from GET /api/rooms\n- Auto-refresh every 3 seconds\n- Room cards show name, player count, status, theme icon\n- CREATE ROOM modal works with name, slider, theme selector\n- JOIN button connects to socket and joins room\n- Waiting room shows player list with skin previews\n- START GAME button visible only to creator\n- LEAVE ROOM returns to room browser\n- All UI elements have proper IDs for CSS styling",
          "status": "done",
          "priority": "medium",
          "assignee": "developer-1",
          "assigneeRole": "developer",
          "dependencies": [
            "task-5",
            "task-6",
            "task-7"
          ],
          "files": [
            "js/rooms.js",
            "index.html",
            "js/lobby.js"
          ],
          "branch": "agent/developer-1",
          "createdBy": "ceo",
          "checkResult": "Built room browser UI (HTML + JS + CSS). Room browser screen shows after PLAY with room list from GET /api/rooms, auto-refresh every 3s. Room cards show name, player count, status, theme icon. CREATE ROOM modal with name input, max players slider, theme selector. JOIN button sets currentRoomId and calls InitializeSocket(). Waiting room shows player list with skin previews, START GAME button visible only to creator when >= 2 players. LEAVE ROOM returns to browser. Modified lobby.js startGame() to route through room browser. Added rooms.js script and rooms.css stylesheet to index.html.",
          "createdAt": 1771995232585,
          "updatedAt": 1771996989004
        },
        {
          "id": "task-9",
          "title": "Style room browser, create form, and waiting room",
          "description": "Create `css/rooms.css` with all styles for the room browser screen, create room modal, and waiting room. Follow the existing design language from `css/lobby.css` — dark theme with gradient background (#1a1a2e → #16213e → #0f3460), #ffcc00 accent color, Open Sans font, 8px border-radius cards.\n\n**Room Browser Screen** (`#room-browser`):\n- Same full-screen overlay as lobby: `position: fixed; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)`\n- z-index: 9999 (below lobby at 10000)\n- `.room-browser-container` — centered, max-width: 800px, padding: 40px 32px\n- `.room-browser-title` — same style as `.lobby-title` (white, text-shadow with orange glow)\n- `.room-browser-subtitle` — same as `.lobby-subtitle` (#6b7fa3)\n- `.room-browser-actions` — flex row, gap: 12px, margin-bottom: 20px\n- `.create-room-btn` — green gradient like `.play-btn` (linear-gradient #4CAF50 → #45a049), white text, uppercase\n- `.refresh-rooms-btn` — outline style: border: 2px solid #444, background: transparent, color: #aaa, hover: border-color #ffcc00\n\n**Room List** (`.room-list`):\n- Display: grid, grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)), gap: 16px\n- Max-height: 400px, overflow-y: auto\n- Same scrollbar styles as `.skin-grid`\n- `.room-list-empty` — centered text, color: #666, padding: 40px\n\n**Room Card** (`.room-card`):\n- Background: #222, border: 2px solid #333, border-radius: 8px, padding: 16px\n- Hover: border-color #ffcc00, box-shadow with orange glow\n- `.room-card-header` — flex row between, margin-bottom: 8px\n- `.room-card-name` — font-weight: 600, color: #fff, font-size: 16px\n- `.room-card-theme` — font-size: 20px (emoji icon)\n- `.room-card-info` — flex row between, margin-bottom: 12px\n- `.room-card-players` — color: #aaa, font-size: 14px\n- `.room-card-status` — font-size: 12px, padding: 2px 8px, border-radius: 4px\n  - `.status-waiting` — background: rgba(255,204,0,0.2), color: #ffcc00\n  - `.status-playing` — background: rgba(76,175,80,0.2), color: #4CAF50\n  - `.status-full` — background: rgba(244,67,54,0.2), color: #f44336\n- `.room-card-join` — width: 100%, height: 36px, background: #4CAF50, color: white, border: none, border-radius: 6px, cursor: pointer, font-weight: 600, uppercase\n  - Hover: brightness(1.1)\n  - Disabled (room full): background: #555, color: #888, cursor: not-allowed\n\n**Create Room Modal** (`.create-room-modal`):\n- Full-screen overlay: position: fixed, background: rgba(0,0,0,0.7), z-index: 10001\n- Flex centered\n- `.create-room-form` — background: #1a1a2e, border: 2px solid #333, border-radius: 12px, padding: 32px, max-width: 450px, width: 90%\n- `h2` — color: white, margin-bottom: 24px\n- `.form-group` — margin-bottom: 20px\n- `label` — color: #fff, font-size: 14px, uppercase, letter-spacing: 1px, margin-bottom: 8px, display: block\n- `input[type=text]` — same style as `.lobby-nickname input`\n- `.slider-group` — flex row, align-items: center, gap: 12px\n- `input[type=range]` — custom styled: accent-color: #ffcc00, width: 100%\n- `#room-max-players-label` — color: #ffcc00, font-size: 20px, font-weight: 700, min-width: 24px\n- `.theme-selector` — display: grid, grid-template-columns: repeat(4, 1fr), gap: 8px\n- `.theme-option` — flex column centered, padding: 12px, background: #222, border: 2px solid #444, border-radius: 8px, cursor: pointer\n  - `.theme-option.selected` — border-color: #ffcc00, background: #2a2a1e\n  - Hover: border-color: #ffcc00\n- `.theme-icon` — font-size: 24px, margin-bottom: 4px\n- `.form-actions` — flex row, gap: 12px, margin-top: 24px\n- `.create-room-confirm` — same as `.play-btn` green style\n- `.create-room-cancel` — outline button, border: 2px solid #555, background: transparent, color: #aaa\n\n**Waiting Room** (`#waiting-room`):\n- Same full-screen overlay pattern\n- `.waiting-room-container` — centered, max-width: 600px, text-align: center\n- `.waiting-room-title` — same as lobby title\n- `.waiting-room-theme` — color: #6b7fa3, font-size: 14px, margin-bottom: 20px\n- `.waiting-room-players` — display: grid, grid-template-columns: repeat(4, 1fr), gap: 16px, margin-bottom: 24px\n- `.waiting-player-card` — flex column centered, padding: 16px, background: #222, border: 2px solid #333, border-radius: 8px\n  - `canvas` — image-rendering: pixelated, width: 48px, height: 48px, margin-bottom: 8px\n  - `.waiting-player-name` — color: #fff, font-size: 14px\n- `.waiting-room-status` — color: #ffcc00, font-size: 16px, margin-bottom: 20px, with pulsing animation\n- `.start-game-btn` — same as `.play-btn` but slightly different color (orange: #ff9800)\n- `.leave-room-btn` — outline style, red border: #f44336, color: #f44336\n\n**Animations:**\n- `@keyframes roomFadeIn` — same as lobbyFadeIn\n- `@keyframes pulse` — opacity: 1 → 0.5 → 1 for waiting status text\n- Room cards: stagger appear animation\n\n**Responsive (max-width: 768px):**\n- Room list: single column\n- Theme selector: 2x2 grid\n- Waiting room players: 2 columns\n\n**Responsive (max-width: 480px):**\n- Room card: full width\n- Theme selector: 2x2 grid\n- Waiting room players: 2 columns\n\n**Acceptance criteria:**\n- All components styled consistently with lobby theme\n- Dark background, yellow accent, clean card-based layout\n- Room cards clearly show room info and JOIN button\n- Create modal overlays properly with backdrop\n- Theme selector has visual feedback for selection\n- Waiting room shows player grid with skin previews\n- Responsive at 768px and 480px breakpoints\n- Smooth animations on appear",
          "status": "done",
          "priority": "medium",
          "assignee": "designer-1",
          "assigneeRole": "designer",
          "dependencies": [
            "task-8"
          ],
          "files": [
            "css/rooms.css"
          ],
          "branch": "agent/designer-1",
          "createdBy": "ceo",
          "checkResult": "Replaced developer CSS with spec-compliant styling. Grid layout for room cards with stagger animations, status badges (waiting/playing/full), backdrop-filter modal, orange START GAME button, red LEAVE ROOM, pulse waiting text, disabled states, player card grid with hover effects, full responsive at 768px/480px.",
          "createdAt": 1771995266519,
          "updatedAt": 1771997240208
        },
        {
          "id": "task-10",
          "title": "Implement map theme system on server",
          "description": "Add theme support to the Room class in `server/roomManager.js`. The server needs to:\n\n1. **Store active theme per room** — already in Room constructor (`this.activeTheme`). Ensure `pickRandomTheme()` works correctly:\n```js\nfunction pickRandomTheme() {\n  const themes = ['default', 'winter', 'moon'];\n  return themes[Math.floor(Math.random() * themes.length)];\n}\n```\n\n2. **Re-randomize theme on round reset** — if `this.themeId === 'random'`, pick a new random theme each round:\nIn `Room.resetRound()`, add before broadcasting `RR`:\n```js\nif (this.themeId === 'random') {\n  this.activeTheme = pickRandomTheme();\n}\n// Broadcast new theme to all players in room\nthis.broadcastAll('TH' + this.activeTheme);\n```\n\n3. **Send theme on player join** — in the joinRoom handler in `server.js`, after joining the Socket.io room:\n```js\nsocket.emit('game', 'TH' + room.activeTheme);\n```\nThis is already noted in the server.js refactor task, but verify it's implemented.\n\n4. **Send theme with world entities** — in `Room.handleWorldEntities()`, send `TH` message before sending `WL`:\n```js\nthis.sendTo(socket, 'TH' + this.activeTheme);\n```\n\n**Acceptance criteria:**\n- Each room has an `activeTheme` property\n- Theme is sent to clients via `TH{themeId}` message on join and on round reset\n- Random theme mode picks a new theme each round\n- Theme IDs are one of: 'default', 'winter', 'moon'",
          "status": "done",
          "priority": "medium",
          "assignee": "developer-2",
          "assigneeRole": "developer",
          "dependencies": [
            "task-3"
          ],
          "files": [
            "server/roomManager.js"
          ],
          "branch": "agent/developer-2",
          "createdBy": "ceo",
          "checkResult": "Added theme system to Room class: resetRound() re-randomizes activeTheme when themeId is 'random' via pickRandomTheme(), broadcasts 'TH' message before 'RR'/'WL' so clients can preload the new tileset. handleWorldEntities() sends 'TH' message before player/entity data on join. Theme on player join in server.js joinRoom handler is covered by task-4.",
          "createdAt": 1771995279533,
          "updatedAt": 1771996129409
        },
        {
          "id": "task-11",
          "title": "Implement theme-aware tileset loading on client",
          "description": "Update the client to dynamically load the correct tileset based on the theme received from the server via the `TH` protocol message.\n\n**Modify `js/initworld.js`:**\n\nThe `preload()` function currently hardcodes `assets/maps/1.png`. Change it to use the active theme:\n\n```js\nfunction preload() {\n  LoadingManager.show();\n  LoadingManager.setTotal(6);\n\n  layer0 = document.getElementById(\"layer0\");\n  layer1 = document.getElementById(\"layer1\");\n  ctx0 = layer0.getContext(\"2d\");\n  ctx1 = layer1.getContext(\"2d\");\n  fosfo0 = new fosfo(layer0);\n  fosfo1 = new fosfo(layer1);\n  fosfo0.x = (window.innerWidth - (40 * 32)) / 2;\n  fosfo0.y = 32;\n  fosfo1.x = (window.innerWidth - (40 * 32)) / 2;\n  fosfo1.y = 32;\n\n  // Use theme-aware tileset path\n  var tilesetPath = THEME_TILESETS[currentTheme] || THEME_TILESETS['default'];\n  \n  fosfo0.loadimage([tilesetPath]).done(function() {\n    LoadingManager.assetLoaded(tilesetPath);\n    fosfo1.loadimage(['assets/bombs/1.png', 'assets/bombs/explode/1.png', 'assets/items/1.png']).done(function() {\n      LoadingManager.assetLoaded('assets/bombs/1.png');\n      LoadingManager.assetLoaded('assets/bombs/explode/1.png');\n      LoadingManager.assetLoaded('assets/items/1.png');\n      LoadingManager.setStatus('Loading world...');\n      // World load will be triggered by server after joining room\n      sendSocketMessage(\"WL\");\n      initWorld();\n    });\n  });\n}\n```\n\n**Modify `initWorld()` in `js/initworld.js`:**\nReplace hardcoded `'assets/maps/1.png'` with dynamic path:\n```js\nvar tilesetPath = THEME_TILESETS[currentTheme] || THEME_TILESETS['default'];\nfosfo0.setFramesToImg(tilesetPath, 8, 24);\n```\n\n**Modify `js/world/world.js`:**\n\n1. Update the World constructor to accept a theme parameter:\n```js\nvar World = function(data, theme) {\n  this.theme = theme || 'default';\n  this.tilesetPath = THEME_TILESETS[this.theme] || THEME_TILESETS['default'];\n  // ... rest of constructor\n}\n```\n\n2. In `loadWorld()`, replace all `'assets/maps/1.png'` with `this.tilesetPath`:\n```js\n// Line in loadWorld where tiles are drawn:\ntmp.push(fosfo0.drawframe(\"case\" + id, this.tilesetPath, groundId, countx, county));\n```\n\n3. In `js/aks.js`, the `WC` (cell change) handler also references `'assets/maps/1.png'`. Update it:\n```js\ncase \"C\":\n  var x = Number(received_msg.substring(2).split(\"|\")[1]);\n  var y = Number(received_msg.substring(2).split(\"|\")[2]);\n  var id = Number(received_msg.substring(2).split(\"|\")[0]);\n  var img = world.dataimg[y][x];\n  var tilesetPath = world.tilesetPath || THEME_TILESETS[currentTheme] || THEME_TILESETS['default'];\n  world.dataimg[y][x] = fosfo0.drawframe(img.name, tilesetPath, id, img.x, img.y);\n  world.havechange = true;\nbreak;\n```\n\n**Handle theme change on round reset:**\nWhen `RR` is received (round reset), the client will also receive a new `TH` message. The client must:\n1. Update `currentTheme` (handled in aks.js TH handler)\n2. Reload the tileset if it changed — after receiving `TH`, if the theme differs from the previous one, preload the new tileset:\n```js\ncase 'T':\n  if (action === 'H') {\n    var newTheme = received_msg.substring(2);\n    if (newTheme !== currentTheme) {\n      currentTheme = newTheme;\n      var newTilesetPath = THEME_TILESETS[currentTheme] || THEME_TILESETS['default'];\n      // Preload new tileset into fosfo0\n      fosfo0.loadimage([newTilesetPath]).done(function() {\n        fosfo0.setFramesToImg(newTilesetPath, 8, 24);\n        if (world) world.tilesetPath = newTilesetPath;\n      });\n    } else {\n      currentTheme = newTheme;\n    }\n  }\n  break;\n```\n\n**Acceptance criteria:**\n- Default theme loads `assets/maps/1.png` (current behavior)\n- Winter theme loads `assets/maps/1-winter.png`\n- Moon theme loads `assets/maps/tileset-moon.png`\n- World renders with correct tileset based on theme\n- Cell updates (WC) use correct tileset\n- Theme changes between rounds trigger tileset reload\n- No hardcoded `'assets/maps/1.png'` references remain in client code",
          "status": "done",
          "priority": "medium",
          "assignee": "developer-2",
          "assigneeRole": "developer",
          "dependencies": [
            "task-7",
            "task-6"
          ],
          "files": [
            "js/initworld.js",
            "js/world/world.js",
            "js/aks.js"
          ],
          "branch": "agent/developer-2",
          "createdBy": "ceo",
          "checkResult": "Implemented theme-aware tileset loading across all client files. preload() and initWorld() in initworld.js now use THEME_TILESETS[currentTheme] instead of hardcoded 'assets/maps/1.png'. World constructor accepts theme param and stores tilesetPath. loadWorld() renders tiles using this.tilesetPath. Combined with task-6's TH handler and WC handler changes, all client tileset references are now dynamic. Default loads assets/maps/1.png, winter loads 1-winter.png, moon loads tileset-moon.png. Theme changes between rounds trigger tileset reload via TH handler.",
          "createdAt": 1771995305220,
          "updatedAt": 1771996769693
        },
        {
          "id": "task-12",
          "title": "Update lobby.js flow to route through room browser",
          "description": "Modify `js/lobby.js` so the PLAY button navigates to the room browser instead of directly connecting to the game server.\n\n**Current flow:** PLAY → hide lobby → call `preload()` → connect WebSocket → load game\n**New flow:** PLAY → hide lobby → show room browser → user picks/creates room → join room → show waiting room → game starts → call `preload()` → load game\n\n**Modify `startGame()` function in `js/lobby.js`:**\n```js\nfunction startGame() {\n  var nickname = (playerNickname || '').trim();\n  if (nickname.length === 0) {\n    playerNickname = 'Player';\n  }\n\n  // Hide lobby\n  document.getElementById('lobby-screen').style.display = 'none';\n\n  // Show room browser instead of directly starting game\n  if (typeof RoomUI !== 'undefined') {\n    RoomUI.showBrowser();\n  }\n}\n```\n\nRemove the direct call to `preload()`. The `preload()` function will now be called by `RoomUI` after the game starts (when the server sends the `gameStart` event).\n\n**Acceptance criteria:**\n- PLAY button hides lobby and shows room browser\n- `preload()` is NOT called from lobby.js\n- Existing nickname and skin selection still works\n- `playerNickname` and `playerSkinId` globals are set before transitioning",
          "status": "done",
          "priority": "medium",
          "assignee": "developer-2",
          "assigneeRole": "developer",
          "dependencies": [
            "task-8"
          ],
          "files": [
            "js/lobby.js"
          ],
          "branch": "agent/developer-2",
          "createdBy": "ceo",
          "checkResult": "Verified lobby.js startGame() already routes through room browser (done in task-8 by developer-1). All acceptance criteria met: PLAY hides lobby and shows RoomUI.showBrowser(), preload() is not called from lobby.js, nickname/skin selection works, playerNickname and playerSkinId globals are set before transition. No code changes needed.",
          "createdAt": 1771995316519,
          "updatedAt": 1771997056668
        },
        {
          "id": "task-13",
          "title": "Update chat panel room indicator",
          "description": "Replace the non-functional room button placeholder in `index.html` chat panel with a dynamic room name display.\n\n**Current HTML** (index.html lines 156-163):\n```html\n<div class=\"misc-top\">\n  <h1>hardcore</h1>\n  <div class=\"out_butt\">\n    <div class=\"room\">\n      <div class=\"butt_left_menu\" style=\"text-transform:none;\">Room:\n        <span class=\"colorFoxy\">EU1</span>\n      </div>\n    </div>\n  </div>\n</div>\n```\n\n**Replace with:**\n```html\n<div class=\"misc-top\">\n  <h1 id=\"chat-room-name\">Room</h1>\n  <div class=\"out_butt\">\n    <div class=\"room\">\n      <div class=\"butt_left_menu\" style=\"text-transform:none;\">Room:\n        <span class=\"colorFoxy\" id=\"chat-room-label\">---</span>\n      </div>\n    </div>\n  </div>\n</div>\n```\n\n**Update room name dynamically** — in `js/rooms.js`, when joining a room, update the chat panel:\n```js\nfunction updateChatRoomLabel(roomName) {\n  var label = document.getElementById('chat-room-label');\n  if (label) label.textContent = roomName;\n  var title = document.getElementById('chat-room-name');\n  if (title) title.textContent = roomName;\n}\n```\n\nCall `updateChatRoomLabel(roomName)` in the `roomJoined` socket event handler.\n\n**Acceptance criteria:**\n- \"EU1\" placeholder replaced with dynamic room name\n- Room name updates when player joins a room\n- Shows \"---\" before any room is joined\n- Chat panel header reflects current room name",
          "status": "done",
          "priority": "low",
          "assignee": "developer-2",
          "assigneeRole": "developer",
          "dependencies": [
            "task-8"
          ],
          "files": [
            "index.html",
            "js/rooms.js"
          ],
          "branch": "agent/developer-2",
          "createdBy": "ceo",
          "checkResult": "Replaced hardcoded \"EU1\" in chat panel with dynamic room name. Added id=\"chat-room-name\" and id=\"chat-room-label\" to index.html. Added updateChatRoomLabel() function to RoomUI in rooms.js. Called on roomJoined event to show current room name, reset to \"---\" on leaveRoom. Exported function for external use.",
          "createdAt": 1771995327942,
          "updatedAt": 1771997258412
        },
        {
          "id": "task-14",
          "title": "Wire room join/leave lifecycle and game start flow",
          "description": "Ensure the complete room lifecycle works end-to-end: join → waiting room → game start → play → round end → leave/rejoin.\n\n**In `server.js`**, verify and complete these Socket.io event handlers:\n\n1. **`joinRoom` handler:**\n```js\nsocket.on('joinRoom', (roomId) => {\n  const room = roomManager.getRoom(roomId);\n  if (!room) { socket.emit('roomError', 'Room not found'); return; }\n  if (room.players.size >= room.maxPlayers) { socket.emit('roomError', 'Room is full'); return; }\n  \n  // Leave previous room if any\n  if (socket.currentRoomId) {\n    leaveCurrentRoom(socket);\n  }\n  \n  socket.join('room:' + roomId);\n  socket.currentRoomId = roomId;\n  \n  const player = room.createPlayer(socket);\n  player.nickname = socket.nickname || 'Player';\n  player.skin = socket.skinId || 0;\n  player.skinId = socket.skinId || 0;\n  room.players.set(socket.id, player);\n  \n  // Set creator if first player\n  if (!room.creatorId) room.creatorId = socket.id;\n  \n  // Confirm join\n  socket.emit('roomJoined', { roomId: room.id, roomName: room.name, isCreator: room.creatorId === socket.id });\n  \n  // Send theme\n  socket.emit('game', 'TH' + room.activeTheme);\n  \n  // Broadcast updated player list to room\n  broadcastRoomPlayerList(room);\n  \n  // If room is already playing (rejoin), send world data immediately\n  if (room.state === 'playing') {\n    room.handleWorldLoad(player, socket);\n    room.handleWorldEntities(player, socket);\n  }\n});\n```\n\n2. **`leaveRoom` handler:**\n```js\nsocket.on('leaveRoom', () => {\n  leaveCurrentRoom(socket);\n});\n\nfunction leaveCurrentRoom(socket) {\n  const roomId = socket.currentRoomId;\n  if (!roomId) return;\n  const room = roomManager.getRoom(roomId);\n  if (!room) return;\n  \n  const player = room.players.get(socket.id);\n  if (player) {\n    room.broadcastAll('PD' + player.id);\n    room.players.delete(socket.id);\n  }\n  \n  socket.leave('room:' + roomId);\n  socket.currentRoomId = null;\n  \n  // Transfer creator if creator left\n  if (room.creatorId === socket.id) {\n    const firstPlayer = room.players.keys().next().value;\n    room.creatorId = firstPlayer || null;\n    if (firstPlayer) {\n      const creatorSocket = io.sockets.sockets.get(firstPlayer);\n      if (creatorSocket) creatorSocket.emit('roomCreatorTransfer');\n    }\n  }\n  \n  // Check round end\n  if (room.state === 'playing' && room.roundState.state === 'active') {\n    room.checkRoundEnd();\n  }\n  \n  broadcastRoomPlayerList(room);\n  \n  // Destroy room if empty\n  if (room.players.size === 0) {\n    room.stopTick();\n    room.cleanup(); // clear all timers\n    roomManager.removeRoom(roomId);\n  }\n}\n```\n\n3. **`startGame` handler:**\n```js\nsocket.on('startGame', () => {\n  const room = roomManager.getRoom(socket.currentRoomId);\n  if (!room) return;\n  if (room.creatorId !== socket.id) return;\n  if (room.players.size < 2) return;\n  if (room.state === 'playing') return;\n  \n  room.state = 'playing';\n  room.initializeMap();\n  room.startTick();\n  \n  // Broadcast game start to all players in room\n  io.to('room:' + room.id).emit('gameStart');\n  \n  // Send world data to each player\n  for (const [sid, p] of room.players) {\n    const s = io.sockets.sockets.get(sid);\n    if (s) {\n      room.handleWorldLoad(p, s);\n      // Short delay for world load, then entities\n      setTimeout(() => {\n        room.handleWorldEntities(p, s);\n      }, 100);\n    }\n  }\n});\n```\n\n4. **`broadcastRoomPlayerList(room)` helper:**\n```js\nfunction broadcastRoomPlayerList(room) {\n  const playerList = [];\n  for (const [sid, p] of room.players) {\n    playerList.push({ id: p.id, nickname: p.nickname, skinId: p.skinId });\n  }\n  io.to('room:' + room.id).emit('roomPlayerList', playerList);\n}\n```\n\n**In `js/rooms.js`** (client-side), handle these socket events:\n- `roomJoined` → show waiting room, set `isRoomCreator`, call `preload()` to initialize canvas\n- `roomPlayerList` → update waiting room player cards\n- `roomCreatorTransfer` → set `isRoomCreator = true`, show START button\n- `roomError` → show alert, stay on room browser\n- `gameStart` → hide waiting room, show game viewport and chat\n\n**Room cleanup method** in `server/roomManager.js`:\n```js\nRoom.prototype.cleanup = function() {\n  this.stopTick();\n  if (this.roundState.timer) clearTimeout(this.roundState.timer);\n  if (this.roundState.timeInterval) clearInterval(this.roundState.timeInterval);\n  for (const b of this.bombs) { if (b.timer) clearTimeout(b.timer); }\n  for (const item of this.items) { if (item.timer) clearTimeout(item.timer); }\n};\n```\n\n**Acceptance criteria:**\n- Full join/leave/rejoin lifecycle works\n- Creator can start game, creator transfer works on leave\n- Room destroyed when last player leaves\n- Game state sent on late join (room already playing)\n- All timers cleaned up when room is destroyed\n- Player list updates broadcast to all in room\n- Error cases handled (room full, room not found)",
          "status": "done",
          "priority": "medium",
          "assignee": "developer-1",
          "assigneeRole": "developer",
          "dependencies": [
            "task-8",
            "task-10"
          ],
          "files": [
            "server.js",
            "js/rooms.js",
            "server/roomManager.js"
          ],
          "branch": "agent/developer-1",
          "createdBy": "ceo",
          "checkResult": "Wired full room join/leave lifecycle and game start flow. joinRoom handler now emits roomJoined to client, leaves previous room before joining new one, handles late join (room already playing) by sending world data immediately. leaveRoom transfers creator to next player via roomCreatorTransfer event. startGame emits gameStart to all players, initializes map, starts tick, guards against double-start. broadcastRoomPlayerList now emits roomPlayerList event with JSON array. Added Room.cleanup() method centralizing all timer cleanup, used in removeRoom, handleLeaveRoom, and graceful shutdown. Fixed rooms.js joinRoom socket listener timing.",
          "createdAt": 1771995355524,
          "updatedAt": 1771997718181
        },
        {
          "id": "task-15",
          "title": "Add theme indicator to in-game HUD",
          "description": "Add a small theme indicator to the in-game HUD so players know which map theme is active. Also display the room name in the HUD.\n\n**Modify `index.html`** — add inside the `#viewport` div, near the round timer:\n```html\n<!-- Room & Theme HUD -->\n<div id=\"hud-room-info\" style=\"display:none;\">\n  <span class=\"hud-room-name\" id=\"hud-room-name\"></span>\n  <span class=\"hud-theme-badge\" id=\"hud-theme-badge\"></span>\n</div>\n```\n\n**Add to `css/hud.css`:**\n```css\n#hud-room-info {\n  position: fixed;\n  top: 8px;\n  left: 8px;\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  z-index: 100;\n  pointer-events: none;\n}\n.hud-room-name {\n  font-family: 'Open Sans', sans-serif;\n  font-size: 13px;\n  font-weight: 600;\n  color: rgba(255,255,255,0.7);\n  background: rgba(0,0,0,0.5);\n  padding: 4px 10px;\n  border-radius: 4px;\n}\n.hud-theme-badge {\n  font-size: 13px;\n  color: rgba(255,255,255,0.7);\n  background: rgba(0,0,0,0.5);\n  padding: 4px 10px;\n  border-radius: 4px;\n}\n```\n\n**Update `js/hud.js`** — add method to set room/theme info:\n```js\nsetRoomInfo: function(roomName, themeId) {\n  var container = document.getElementById('hud-room-info');\n  var nameEl = document.getElementById('hud-room-name');\n  var themeEl = document.getElementById('hud-theme-badge');\n  if (!container) return;\n  container.style.display = 'flex';\n  if (nameEl) nameEl.textContent = roomName;\n  var themeLabels = { 'default': '🌿 Default', 'winter': '❄️ Winter', 'moon': '🌙 Moon' };\n  if (themeEl) themeEl.textContent = themeLabels[themeId] || themeId;\n}\n```\n\nCall `HUD.setRoomInfo(currentRoomName, currentTheme)` from `js/rooms.js` when game starts, and from `js/aks.js` when `TH` message is received.\n\n**Acceptance criteria:**\n- Room name shown top-left during gameplay\n- Theme badge shows emoji + theme name\n- Semi-transparent dark background, doesn't obstruct gameplay\n- Updates when theme changes between rounds\n- Hidden when not in a room",
          "status": "done",
          "priority": "low",
          "assignee": "designer-1",
          "assigneeRole": "designer",
          "dependencies": [
            "task-11",
            "task-8"
          ],
          "files": [
            "index.html",
            "css/hud.css",
            "js/hud.js"
          ],
          "branch": "agent/designer-1",
          "createdBy": "ceo",
          "checkResult": "Added room name + theme badge HUD (top-left, semi-transparent). CSS in hud.css with backdrop-filter blur, responsive at 768/480px. HUD.setRoomInfo() and HUD.hideRoomInfo() methods added. Wired into TH handler for theme changes, gameStart for display, leaveRoom for hide.",
          "createdAt": 1771995368968,
          "updatedAt": 1771997466033
        },
        {
          "id": "task-16",
          "title": "Handle room-scoped round reset and reconnection",
          "description": "Ensure round resets and reconnection work correctly in the room context.\n\n**Round reset (server-side in `server/roomManager.js`):**\n\nIn `Room.resetRound()`, update to:\n1. Re-randomize theme if `this.themeId === 'random'` (from task-10)\n2. Broadcast `TH` with new theme BEFORE `RR` and `WL`\n3. Broadcast player list update after respawn\n4. Scope all broadcasts to room via `this.broadcastAll()`\n\nVerify the full reset sequence:\n```js\nRoom.prototype.resetRound = function() {\n  // Clear bombs, items, timers (same as current)\n  // ...\n  \n  // Re-randomize theme if needed\n  if (this.themeId === 'random') {\n    this.activeTheme = pickRandomTheme();\n  }\n  \n  // Regenerate map\n  this.cells.length = 0;\n  this.initializeMap();\n  \n  // Reset all players (same as current but using this.players)\n  // ...\n  \n  // Broadcast theme FIRST (so client can preload tileset)\n  this.broadcastAll('TH' + this.activeTheme);\n  \n  // Then round reset signal and new map\n  this.broadcastAll('RR');\n  this.broadcastAll('WL' + MAP_WIDTH + '|' + MAP_HEIGHT + '|' + this.getMapData());\n  \n  // Send entity data (PA messages)\n  // Use io.sockets.sockets.get(socketId) to get each socket\n  for (const [socketId, player] of this.players) {\n    const socket = this.io.sockets.sockets.get(socketId);\n    if (!socket) continue;\n    // Send self\n    this.sendTo(socket, 'PA' + player.id + '|' + player.x + '|' + player.y + '|' + ...);\n    // Send others\n    for (const [otherSid, otherPlayer] of this.players) {\n      if (otherSid === socketId) continue;\n      this.sendTo(socket, 'PA' + otherPlayer.id + '|' + ...);\n    }\n  }\n  \n  // Set state to waiting, check auto-start\n  this.roundState.state = 'waiting';\n  if (this.players.size >= MIN_PLAYERS_TO_START) {\n    setTimeout(() => {\n      if (this.roundState.state === 'waiting' && this.players.size >= MIN_PLAYERS_TO_START) {\n        this.startRound();\n      }\n    }, 2000);\n  }\n};\n```\n\n**Client-side RR handler** (in `js/aks.js`):\nCurrently works but needs to also handle theme change. The `TH` message arrives BEFORE `RR`, so `currentTheme` is updated first. Then when `WL` arrives, the World constructor receives the correct theme.\n\nVerify the existing `RR` handler in aks.js clears sprites properly and resets `isSpectating`.\n\n**Socket.io reconnection:**\nSocket.io has built-in reconnection. On reconnect:\n1. Client socket fires `connect` event again\n2. Need to re-emit `nicknameInit` and `joinRoom` with the stored `currentRoomId`\n3. Server will re-add player to the room\n\nAdd reconnect handler in `js/aks.js`:\n```js\nsocket.on('connect', function() {\n  reconnectAttempt = 0;\n  ConnectionStatus.onConnected();\n  \n  // Re-send identity\n  socket.emit('nicknameInit', { nickname: playerNickname, skinId: playerSkinId });\n  \n  // Re-join room if we were in one\n  if (currentRoomId) {\n    socket.emit('joinRoom', currentRoomId);\n  }\n});\n```\n\n**Acceptance criteria:**\n- Round resets work within room scope\n- Theme changes properly on round reset (random mode)\n- Client receives TH before RR/WL sequence\n- All player sprites properly cleared and re-created\n- Socket.io reconnection re-joins the same room\n- No state leaks between rooms during resets",
          "status": "done",
          "priority": "medium",
          "assignee": "developer-2",
          "assigneeRole": "developer",
          "dependencies": [
            "task-10",
            "task-11",
            "task-14"
          ],
          "files": [
            "server/roomManager.js",
            "js/aks.js"
          ],
          "branch": "agent/developer-2",
          "createdBy": "ceo",
          "checkResult": "Fixed room-scoped round reset and reconnection: replaced stale player.socket references with io.sockets.sockets.get(socketId) in resetRound() PA messages and handleWorldEntities() other-player notifications. Added roomPlayerList broadcast after round reset respawn. Used socket ID comparison instead of object reference in handleWorldEntities. Verified existing implementation already covers: theme re-randomization on reset, TH→RR→WL broadcast order, client-side RR handler clearing all sprites and resetting isSpectating, and reconnection handler re-sending nicknameInit + joinRoom.",
          "createdAt": 1771995392416,
          "updatedAt": 1771998082522
        },
        {
          "id": "task-17",
          "title": "Create .db directory and room persistence",
          "description": "Set up the `.db/` directory for JSON database storage and implement room metadata persistence.\n\n**Create `.db/` directory** if it doesn't exist. Add it to `.gitignore` if not already there (data files shouldn't be committed, but the directory should be created at runtime).\n\n**In `server/roomManager.js`**, add persistence methods to RoomManager:\n\n```js\nconst fs = require('fs');\nconst path = require('path');\n\nconst DB_DIR = path.join(__dirname, '..', '.db');\nconst ROOMS_DB = path.join(DB_DIR, 'rooms.json');\n\nclass RoomManager {\n  constructor() {\n    this.rooms = new Map();\n    this.nextRoomId = 1;\n    this._ensureDbDir();\n    this._loadRooms();\n  }\n\n  _ensureDbDir() {\n    if (!fs.existsSync(DB_DIR)) {\n      fs.mkdirSync(DB_DIR, { recursive: true });\n    }\n  }\n\n  _loadRooms() {\n    try {\n      if (fs.existsSync(ROOMS_DB)) {\n        const data = JSON.parse(fs.readFileSync(ROOMS_DB, 'utf8'));\n        if (data.nextRoomId) this.nextRoomId = data.nextRoomId;\n        // Don't restore room instances — they need live socket connections\n        // Just restore the ID counter so IDs don't collide\n      }\n    } catch (e) {\n      console.log('No existing rooms.json, starting fresh');\n    }\n  }\n\n  _saveRooms() {\n    try {\n      const data = {\n        nextRoomId: this.nextRoomId,\n        rooms: Array.from(this.rooms.values()).map(r => ({\n          id: r.id,\n          name: r.name,\n          maxPlayers: r.maxPlayers,\n          themeId: r.themeId,\n          createdAt: r.createdAt\n        }))\n      };\n      fs.writeFileSync(ROOMS_DB, JSON.stringify(data, null, 2), 'utf8');\n    } catch (e) {\n      console.error('Failed to save rooms.json:', e.message);\n    }\n  }\n\n  createRoom(name, maxPlayers, themeId, creatorId) {\n    // ... create room ...\n    this._saveRooms();\n    return room;\n  }\n\n  removeRoom(roomId) {\n    // ... remove room ...\n    this._saveRooms();\n  }\n}\n```\n\n**Add `createdAt: Date.now()` to Room constructor.**\n\n**Update `.gitignore`** — add `.db/` if not present:\n```\n.db/\n```\n\nCheck current `.gitignore`:\n```\nnode_modules/\n.db/\n```\n\n**Acceptance criteria:**\n- `.db/` directory created automatically on first run\n- `rooms.json` written on room create/delete\n- Room ID counter persisted across server restarts\n- `.db/` in `.gitignore`\n- Server starts cleanly even with no `.db/` directory\n- Corrupt/missing `rooms.json` doesn't crash server",
          "status": "done",
          "priority": "low",
          "assignee": "developer-2",
          "assigneeRole": "developer",
          "dependencies": [
            "task-2"
          ],
          "files": [
            "server/roomManager.js",
            ".gitignore"
          ],
          "branch": "agent/developer-2",
          "createdBy": "ceo",
          "checkResult": "Hardened .db persistence in RoomManager: added type validation for nextRoomId restore, empty file handling, re-ensures .db/ dir before each save, and improved error logging. The core persistence (.db/ dir creation, rooms.json write on create/delete, ID counter persistence, .gitignore entry) was already implemented in task-2 — this task adds robustness for edge cases (corrupt JSON, empty file, deleted dir).",
          "createdAt": 1771995409055,
          "updatedAt": 1771995880179
        },
        {
          "id": "task-18",
          "title": "Fix Socket.io client script path",
          "description": "Socket.io client script in index.html referenced /socket.io/socket.io.js but the server uses path: '/echo', so the correct path is /echo/socket.io.js. This caused 'io is not defined' error preventing any Socket.io connections.",
          "status": "done",
          "priority": "high",
          "assignee": "bug-tester-1",
          "assigneeRole": "bug_tester",
          "dependencies": [],
          "files": [],
          "branch": "agent/bug-tester-1",
          "createdBy": "bug-tester-1",
          "checkResult": null,
          "createdAt": 1771996976849,
          "updatedAt": 1771996976849
        },
        {
          "id": "task-19",
          "title": "Fix waiting room showing wrong theme icon",
          "description": "The waiting room always showed 'default' theme instead of the room's actual theme (e.g., moon). Root cause: server's roomJoined event didn't include themeId, and the separate TH game message hadn't updated currentTheme yet when showWaitingRoom was called. Fix: added themeId to the roomJoined event payload in server.js.",
          "status": "done",
          "priority": "high",
          "assignee": "bug-tester-1",
          "assigneeRole": "bug_tester",
          "dependencies": [],
          "files": [],
          "branch": "agent/bug-tester-1",
          "createdBy": "bug-tester-1",
          "checkResult": null,
          "createdAt": 1771997859595,
          "updatedAt": 1771997859595
        },
        {
          "id": "task-20",
          "title": "Fix: initialize canvas before game start in room flow",
          "description": "The gameStart handler called initWorld() without first initializing fosfo0/fosfo1 canvas engines (preload() was never called in room-based flow). Extracted canvas init into initCanvas() function and used it in gameStart handler. Removed server-side proactive WL/WE push so client requests world data only after canvas is ready, preventing TypeError crashes (fosfo0.clear undefined, world.addplayer null, etc).",
          "status": "done",
          "priority": "high",
          "assignee": "bug-tester-1",
          "assigneeRole": "bug_tester",
          "dependencies": [],
          "files": [],
          "branch": "agent/bug-tester-1",
          "createdBy": "bug-tester-1",
          "checkResult": null,
          "createdAt": 1771998293344,
          "updatedAt": 1771998293344
        }
      ],
      "stats": {
        "todo": 0,
        "in_progress": 0,
        "to_check": 0,
        "done": 20,
        "total": 20
      },
      "testChecks": [
        {
          "id": "baseline-lobby",
          "category": "Baseline",
          "title": "Lobby page loads correctly",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771995496014,
          "sprintNumber": 3
        },
        {
          "id": "task-1-socketio",
          "category": "Dependencies",
          "title": "socket.io installed and in package.json",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771995561951,
          "sprintNumber": 3
        },
        {
          "id": "task-7-globals",
          "category": "Code",
          "title": "Client globals for room and theme state",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771995635248,
          "sprintNumber": 3
        },
        {
          "id": "task-2-room",
          "category": "Code",
          "title": "Room class with isolated game state",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771995714607,
          "sprintNumber": 3
        },
        {
          "id": "task-17-persistence",
          "category": "Code",
          "title": ".db directory and room persistence",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771995879909,
          "sprintNumber": 3
        },
        {
          "id": "task-3-gamelogic",
          "category": "Code",
          "title": "Game logic methods in Room class",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771995962783,
          "sprintNumber": 3
        },
        {
          "id": "theme-active-prop",
          "category": "Theme System",
          "title": "Room has activeTheme property",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996121422,
          "sprintNumber": 3
        },
        {
          "id": "theme-random-pick",
          "category": "Theme System",
          "title": "pickRandomTheme returns valid theme",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996121988,
          "sprintNumber": 3
        },
        {
          "id": "theme-reset-round",
          "category": "Theme System",
          "title": "Theme re-randomized on round reset + broadcast TH before RR",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996122882,
          "sprintNumber": 3
        },
        {
          "id": "theme-world-entities",
          "category": "Theme System",
          "title": "Theme sent before world entities on join",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996123934,
          "sprintNumber": 3
        },
        {
          "id": "theme-valid-ids",
          "category": "Theme System",
          "title": "Theme IDs are one of: default, winter, moon",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996124710,
          "sprintNumber": 3
        },
        {
          "id": "server-socketio",
          "category": "Server Refactor",
          "title": "Server uses Socket.io instead of ws",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996302767,
          "sprintNumber": 3
        },
        {
          "id": "server-no-globals",
          "category": "Server Refactor",
          "title": "No global game state in server.js",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996303568,
          "sprintNumber": 3
        },
        {
          "id": "server-room-routing",
          "category": "Server Refactor",
          "title": "Game messages routed to correct room",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996304632,
          "sprintNumber": 3
        },
        {
          "id": "server-cleanup",
          "category": "Server Refactor",
          "title": "Empty rooms cleaned up on disconnect",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996305409,
          "sprintNumber": 3
        },
        {
          "id": "server-startup",
          "category": "Server Refactor",
          "title": "Server starts without errors",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996306181,
          "sprintNumber": 3
        },
        {
          "id": "api-get-rooms",
          "category": "REST API",
          "title": "GET /api/rooms returns JSON array",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996572801,
          "sprintNumber": 3
        },
        {
          "id": "api-post-rooms",
          "category": "REST API",
          "title": "POST /api/rooms creates room (201)",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996572898,
          "sprintNumber": 3
        },
        {
          "id": "api-validation",
          "category": "REST API",
          "title": "Invalid inputs return 400",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996573716,
          "sprintNumber": 3
        },
        {
          "id": "api-cors",
          "category": "REST API",
          "title": "CORS headers present on API responses",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996574648,
          "sprintNumber": 3
        },
        {
          "id": "api-static",
          "category": "REST API",
          "title": "Static files served correctly",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996575531,
          "sprintNumber": 3
        },
        {
          "id": "client-socketio-script",
          "category": "Client Migration",
          "title": "Socket.io client script loaded in index.html",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996611496,
          "sprintNumber": 3
        },
        {
          "id": "client-io-connect",
          "category": "Client Migration",
          "title": "InitializeSocket uses io() instead of new WebSocket()",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996612224,
          "sprintNumber": 3
        },
        {
          "id": "client-protocol",
          "category": "Client Migration",
          "title": "All existing protocol messages parsed correctly",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996612939,
          "sprintNumber": 3
        },
        {
          "id": "client-emit",
          "category": "Client Migration",
          "title": "sendSocketMessage uses socket.emit('game', msg)",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996613669,
          "sprintNumber": 3
        },
        {
          "id": "client-room-events",
          "category": "Client Migration",
          "title": "Room events handled: roomJoined, roomPlayerList, gameStart, error",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996614502,
          "sprintNumber": 3
        },
        {
          "id": "client-theme",
          "category": "Client Migration",
          "title": "TH theme message parsed and stored in currentTheme",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996615512,
          "sprintNumber": 3
        },
        {
          "id": "theme-default-tileset",
          "category": "Theme Tileset",
          "title": "Default theme loads assets/maps/1.png",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996764979,
          "sprintNumber": 3
        },
        {
          "id": "theme-dynamic-tileset",
          "category": "Theme Tileset",
          "title": "World/initworld use THEME_TILESETS[currentTheme] dynamically",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996766040,
          "sprintNumber": 3
        },
        {
          "id": "theme-no-hardcoded",
          "category": "Theme Tileset",
          "title": "No hardcoded assets/maps/1.png in active code",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996766987,
          "sprintNumber": 3
        },
        {
          "id": "theme-wc-handler",
          "category": "Theme Tileset",
          "title": "WC cell update uses dynamic tileset path",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996767984,
          "sprintNumber": 3
        },
        {
          "id": "theme-reload",
          "category": "Theme Tileset",
          "title": "TH handler triggers tileset reload on theme change",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996769227,
          "sprintNumber": 3
        },
        {
          "id": "room-browser-shows",
          "category": "Room Browser",
          "title": "Room browser shows after PLAY",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996984242,
          "sprintNumber": 3
        },
        {
          "id": "room-list-api",
          "category": "Room Browser",
          "title": "Room list populated from GET /api/rooms",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996985759,
          "sprintNumber": 3
        },
        {
          "id": "room-cards-info",
          "category": "Room Browser",
          "title": "Room cards show name, player count, status, theme icon",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996986285,
          "sprintNumber": 3
        },
        {
          "id": "create-room-modal",
          "category": "Forms",
          "title": "Create Room modal opens and works",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771999766873,
          "sprintNumber": 3
        },
        {
          "id": "room-ui-ids",
          "category": "Room Browser",
          "title": "All UI elements have proper IDs for CSS styling",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771996988454,
          "sprintNumber": 3
        },
        {
          "id": "lobby-to-browser",
          "category": "Lobby Flow",
          "title": "PLAY hides lobby and shows room browser",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771997055416,
          "sprintNumber": 3
        },
        {
          "id": "lobby-no-preload",
          "category": "Lobby Flow",
          "title": "preload() not called from lobby.js",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771997056290,
          "sprintNumber": 3
        },
        {
          "id": "style-room-cards",
          "category": "Styling",
          "title": "Room cards styled with dark theme, yellow accent",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771997237411,
          "sprintNumber": 3
        },
        {
          "id": "style-create-modal",
          "category": "Styling",
          "title": "Create modal with backdrop, theme selector, slider",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771997238541,
          "sprintNumber": 3
        },
        {
          "id": "style-grid-layout",
          "category": "Styling",
          "title": "Grid layout for room list with proper card sizing",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771997239703,
          "sprintNumber": 3
        },
        {
          "id": "chat-room-dynamic",
          "category": "Chat Panel",
          "title": "Chat panel shows dynamic room name instead of EU1",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771997257108,
          "sprintNumber": 3
        },
        {
          "id": "chat-room-default",
          "category": "Chat Panel",
          "title": "Shows --- before any room is joined",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771997258086,
          "sprintNumber": 3
        },
        {
          "id": "hud-theme-code",
          "category": "Code Review",
          "title": "Task-15: HUD theme indicator code review",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771997397960,
          "sprintNumber": 3
        },
        {
          "id": "hud-theme-visual",
          "category": "Layout",
          "title": "Task-15: HUD theme indicator visual check",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771997465768,
          "sprintNumber": 3
        },
        {
          "id": "task14-code-review",
          "category": "Code Review",
          "title": "Task-14: Room lifecycle code review",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771997716532,
          "sprintNumber": 3
        },
        {
          "id": "task14-server-tests",
          "category": "API",
          "title": "Task-14: Room lifecycle server-side tests (11/11 passed)",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771997717851,
          "sprintNumber": 3
        },
        {
          "id": "integration-lobby",
          "category": "Integration",
          "title": "Lobby → Room Browser flow",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771997831158,
          "sprintNumber": 3
        },
        {
          "id": "bug-waiting-room-theme",
          "category": "Integration",
          "title": "Waiting room shows wrong theme icon",
          "status": "fixed",
          "error": null,
          "fix": "Added themeId to roomJoined event payload in server.js",
          "timestamp": 1771997860759,
          "sprintNumber": 3
        },
        {
          "id": "server-start",
          "category": "Build",
          "title": "Server starts without errors on port 9998",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771998558684,
          "sprintNumber": 3
        },
        {
          "id": "page-load",
          "category": "Navigation",
          "title": "Homepage loads correctly",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771997920518,
          "sprintNumber": 3
        },
        {
          "id": "room-create-api",
          "category": "API",
          "title": "Room creation via API",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771997929336,
          "sprintNumber": 3
        },
        {
          "id": "lobby-flow",
          "category": "Navigation",
          "title": "Lobby to room browser flow",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771997988849,
          "sprintNumber": 3
        },
        {
          "id": "t16-reset-round",
          "category": "Task-16",
          "title": "resetRound() room-scoped with correct broadcast order",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771998020283,
          "sprintNumber": 3
        },
        {
          "id": "t16-reconnect",
          "category": "Task-16",
          "title": "Reconnection handler re-joins room",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771998075819,
          "sprintNumber": 3
        },
        {
          "id": "t16-theme-rr",
          "category": "Task-16",
          "title": "Theme re-randomize on reset + TH→RR→WL order",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771998077213,
          "sprintNumber": 3
        },
        {
          "id": "t16-sprite-clear",
          "category": "Task-16",
          "title": "Client RR handler clears all sprites and resets isSpectating",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771998078170,
          "sprintNumber": 3
        },
        {
          "id": "t16-no-leaks",
          "category": "Task-16",
          "title": "No state leaks between rooms (scoped broadcasts)",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771998079151,
          "sprintNumber": 3
        },
        {
          "id": "integration-create-room",
          "category": "Integration",
          "title": "Create room and join from lobby",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771998140039,
          "sprintNumber": 3
        },
        {
          "id": "integration-2player",
          "category": "Integration",
          "title": "Two players join and start game",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771998395046,
          "sprintNumber": 3
        },
        {
          "id": "integration-game-start",
          "category": "Integration",
          "title": "Game starts without errors after room start",
          "status": "fixed",
          "error": null,
          "fix": "Extracted canvas init into initCanvas() and used it in gameStart handler. Removed server-side proactive WL/WE push.",
          "timestamp": 1771998367917,
          "sprintNumber": 3
        },
        {
          "id": "integration-chat",
          "category": "Integration",
          "title": "In-game chat works between players",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771998460595,
          "sprintNumber": 3
        },
        {
          "id": "integration-hud",
          "category": "Integration",
          "title": "HUD elements: timer, scoreboard, room info",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771998466450,
          "sprintNumber": 3
        },
        {
          "id": "integration-api-rooms",
          "category": "API",
          "title": "GET /api/rooms returns room list",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771998474765,
          "sprintNumber": 3
        },
        {
          "id": "dep-socketio",
          "category": "Build",
          "title": "socket.io in package.json and node_modules",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771998575543,
          "sprintNumber": 3
        },
        {
          "id": "api-rooms-get",
          "category": "API",
          "title": "GET /api/rooms returns JSON array",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771998594746,
          "sprintNumber": 3
        },
        {
          "id": "api-rooms-post",
          "category": "API",
          "title": "POST /api/rooms creates room",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771998609340,
          "sprintNumber": 3
        },
        {
          "id": "api-rooms-validation",
          "category": "API",
          "title": "POST /api/rooms validates inputs",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771998619748,
          "sprintNumber": 3
        },
        {
          "id": "db-persistence",
          "category": "Build",
          "title": ".db/rooms.json persistence works",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771999560603,
          "sprintNumber": 3
        },
        {
          "id": "socketio-client-path",
          "category": "Build",
          "title": "Socket.io client script loads from /echo/socket.io.js",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771999620615,
          "sprintNumber": 3
        },
        {
          "id": "static-files",
          "category": "Build",
          "title": "Static files served correctly on port 9998",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771999634244,
          "sprintNumber": 3
        },
        {
          "id": "lobby-loads",
          "category": "Navigation",
          "title": "Lobby screen loads correctly",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771999665997,
          "sprintNumber": 3
        },
        {
          "id": "lobby-to-rooms",
          "category": "Navigation",
          "title": "PLAY button navigates to room browser",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771999703826,
          "sprintNumber": 3
        },
        {
          "id": "waiting-room",
          "category": "Navigation",
          "title": "Waiting room shows correct room name, theme, player list",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771999770744,
          "sprintNumber": 3
        },
        {
          "id": "leave-room",
          "category": "Navigation",
          "title": "LEAVE ROOM returns to room browser",
          "status": "fixed",
          "error": null,
          "fix": "Added null guards for world in PD handler and all other game message handlers in aks.js",
          "timestamp": 1771999865457,
          "sprintNumber": 3
        },
        {
          "id": "join-room",
          "category": "Navigation",
          "title": "JOIN button connects to room and shows waiting room",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771999924334,
          "sprintNumber": 3
        },
        {
          "id": "theme-waiting-room",
          "category": "Layout",
          "title": "Waiting room shows correct theme icon for each theme",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771999957315,
          "sprintNumber": 3
        },
        {
          "id": "chat-room-label",
          "category": "Layout",
          "title": "Chat panel shows dynamic room name instead of EU1",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1771999977818,
          "sprintNumber": 3
        },
        {
          "id": "game-start-flow",
          "category": "Navigation",
          "title": "Two players join room and start game",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772000189433,
          "sprintNumber": 3
        },
        {
          "id": "game-start-player2",
          "category": "Navigation",
          "title": "Player2 receives gameStart and loads game",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772000223350,
          "sprintNumber": 3
        },
        {
          "id": "hud-room-info",
          "category": "Layout",
          "title": "HUD shows room name and theme badge during gameplay",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772000229532,
          "sprintNumber": 3
        },
        {
          "id": "scoreboard-hud",
          "category": "Layout",
          "title": "Scoreboard displays both players with K/D stats",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772000238390,
          "sprintNumber": 3
        },
        {
          "id": "round-timer",
          "category": "Layout",
          "title": "Round timer counts down correctly",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772000242653,
          "sprintNumber": 3
        },
        {
          "id": "round-end-results",
          "category": "Layout",
          "title": "Round end shows results screen with winner",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772000264818,
          "sprintNumber": 3
        },
        {
          "id": "cors-preflight",
          "category": "API",
          "title": "CORS preflight OPTIONS returns 204",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772000280906,
          "sprintNumber": 3
        },
        {
          "id": "theme-assets",
          "category": "Build",
          "title": "All theme tileset files exist",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772000298859,
          "sprintNumber": 3
        },
        {
          "id": "round-reset",
          "category": "Navigation",
          "title": "Round reset generates new map and respawns players",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772000314456,
          "sprintNumber": 3
        },
        {
          "id": "css-rooms",
          "category": "Layout",
          "title": "rooms.css styles applied correctly",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772000362103,
          "sprintNumber": 3
        }
      ],
      "startedAt": 1771994987465,
      "completedAt": 1772000772694
    },
    {
      "sprintNumber": 4,
      "type": "sprint",
      "prompt": "This sprint makes the game playable on mobile devices and improves overall usability and accessibility. Add a viewport meta tag for correct mobile rendering. Implement on-screen virtual D-pad and bomb button overlays for touch devices — touch events should map to the same input protocol as keyboard events so no server-side changes are needed. The overlay should only appear on touch-capable devices. Mouse event handler stubs already exist in the client events file and can be extended. Render player nickname labels above each character sprite on the game canvas, keeping them legible against varied backgrounds and updating on movement. Add explosion/death visual feedback for the local player: a brief semi-transparent red overlay flash (~300ms) and/or subtle canvas shake when caught in an explosion or killed. Cap chat history at ~100 messages with oldest removal to prevent unbounded DOM growth. Implement chat auto-scroll that shows the latest message, pausing when the user manually scrolls up and resuming when they scroll back to the bottom. The chat panel contains five filter buttons (all, text, kill-feed, mod, common) that are currently non-functional — implement the filter logic so each button toggles message category visibility, at minimum separating kill-feed from player chat. Add baseline accessibility: lang='en' on html element, role='application' on the game viewport, aria-label on the chat input textarea, aria-live='polite' on the chat message list, meaningful aria-label on canvas elements, and ensure all interactive elements are reachable and labeled.",
      "tasks": [
        {
          "id": "task-1",
          "title": "Accessibility attributes on index.html",
          "description": "Add baseline ARIA and accessibility attributes to `index.html`. This is a prerequisite for all other tasks since it modifies the HTML structure.\n\n**Changes to `index.html`:**\n1. `#viewport` div (line 172): add `role=\"application\"` attribute\n2. `#layer0` canvas (line 174): add `aria-label=\"Game world - background layer\"`\n3. `#layer1` canvas (line 175): add `aria-label=\"Game world - entity layer\"`\n4. `#msgText` textarea (line 256): add `aria-label=\"Game chat input\"`\n5. `#listChat` ul (line 250): add `aria-live=\"polite\"` and `aria-label=\"Chat messages\"`\n6. All chat filter buttons (lines 262-275): add `aria-label` describing each button's purpose:\n   - First `.text` button: `aria-label=\"Show text messages\"`\n   - Second `.text` button: `aria-label=\"Show text messages\"`\n   - `.kill` button: `aria-label=\"Show kill feed\"`\n   - `.mod` button: `aria-label=\"Show mod messages\"`\n   - `.common` button: `aria-label=\"Show common messages\"`\n   - `.filter-all` button: `aria-label=\"Show all messages\"`\n7. Ensure `#play-btn`, `#create-room-btn`, `#refresh-rooms-btn`, `#start-game-btn`, `#leave-room-btn` all have descriptive text content already (they do — verify)\n8. Add `tabindex=\"0\"` to `#layer1` canvas so it can receive keyboard focus\n\n**Also add to index.html `<head>`:**\n- Add link to new CSS: `<link rel=\"stylesheet\" href=\"./css/touch-controls.css\">`\n- Add script tags before `</head>`: `<script src=\"./js/touch-controls.js\"></script>` and `<script src=\"./js/chat-filters.js\"></script>` — place them after `events.js` and `chat.js` respectively\n\n**Add inside `#viewport` div (after the canvases, before closing `</div>`):**\n- `<div id=\"explosion-flash\" style=\"display:none;\"></div>` — for explosion red flash overlay\n- `<div id=\"touch-controls\" style=\"display:none;\"></div>` — container for virtual D-pad and bomb button\n\n**Acceptance criteria:**\n- All ARIA attributes present in the DOM\n- New CSS/JS links added\n- Explosion flash and touch controls containers added inside viewport\n- HTML validates with no broken structure",
          "status": "done",
          "priority": "high",
          "assignee": "developer-2",
          "assigneeRole": "developer",
          "dependencies": [],
          "files": [
            "index.html"
          ],
          "branch": "agent/developer-2",
          "createdBy": "ceo",
          "checkResult": "Added all ARIA accessibility attributes to index.html: role=\"application\" on #viewport, aria-labels on both canvas layers/chat list/chat input/all 6 filter buttons, aria-live=\"polite\" on #listChat, tabindex=\"0\" on #layer1. Added touch-controls.css link, touch-controls.js and chat-filters.js script tags. Added #explosion-flash and #touch-controls container divs inside viewport. Verified all buttons have descriptive text content.",
          "createdAt": 1772000882431,
          "updatedAt": 1772001286811
        },
        {
          "id": "task-2",
          "title": "Touch controls CSS styling",
          "description": "Create `css/touch-controls.css` with styles for the virtual D-pad and bomb button overlay.\n\n**Create file: `css/touch-controls.css`**\n\n**D-Pad (bottom-left):**\n- Container: `#touch-controls` — `position: fixed; z-index: 1000; pointer-events: none;` (children get pointer-events: auto)\n- `.touch-dpad` — positioned bottom-left, `left: 20px; bottom: 20px;`, `width: 150px; height: 150px;`, uses CSS grid (3x3) for directional buttons\n- Each direction button (`.dpad-up`, `.dpad-down`, `.dpad-left`, `.dpad-right`): `width: 50px; height: 50px;`, semi-transparent dark background (`rgba(0,0,0,0.5)`), white arrow icon (use CSS borders/triangles or Unicode arrows ▲▼◀▶), `border-radius: 8px`, `pointer-events: auto;`\n- Center cell empty (`.dpad-center`)\n- On touch/active state: brighter background (`rgba(255,255,255,0.3)`)\n\n**Bomb Button (bottom-right):**\n- `.touch-bomb` — positioned bottom-right, `right: 30px; bottom: 40px;`\n- Circular button: `width: 70px; height: 70px; border-radius: 50%;`\n- Semi-transparent dark background with bomb emoji or \"💣\" text\n- `font-size: 28px; color: white;`\n- On touch/active: red-tinted background (`rgba(255,0,0,0.4)`)\n\n**General:**\n- All buttons: `user-select: none; -webkit-user-select: none; touch-action: manipulation;`\n- Add `@media (min-width: 1024px) { #touch-controls { display: none !important; } }` as safety fallback\n- Ensure controls don't block chat panel or HUD elements\n\n**Acceptance criteria:**\n- D-pad visible bottom-left with 4 directional buttons in cross layout\n- Bomb button visible bottom-right as circle\n- Semi-transparent, visually clear against game backgrounds\n- Touch feedback on press (visual state change)\n- Hidden on desktop-width screens as safety",
          "status": "done",
          "priority": "high",
          "assignee": "designer-1",
          "assigneeRole": "designer",
          "dependencies": [],
          "files": [
            "css/touch-controls.css"
          ],
          "branch": "agent/designer-1",
          "createdBy": "ceo",
          "checkResult": "Created css/touch-controls.css with D-pad (bottom-left, 3x3 CSS grid, 50px buttons, CSS triangle arrows) and bomb button (bottom-right, 70px circle). Semi-transparent dark backgrounds with backdrop-filter blur matching existing HUD style. Touch/active states: D-pad brightens to rgba(255,255,255,0.3) with gold border, bomb goes red-tinted rgba(255,0,0,0.4). Hidden on desktop >=1024px. Compact variant for phones <400px.",
          "createdAt": 1772000894373,
          "updatedAt": 1772001195251
        },
        {
          "id": "task-3",
          "title": "Touch controls JS logic (D-pad + bomb)",
          "description": "Create `js/touch-controls.js` implementing virtual D-pad and bomb button for touch devices.\n\n**Create file: `js/touch-controls.js`**\n\n**Detection & initialization:**\n- `TouchControls` object/IIFE\n- `init()` method called from `initWorld()` in `js/initworld.js` (see dependency task)\n- Only activate if touch device: `('ontouchstart' in window) || (navigator.maxTouchPoints > 0)`\n- If not touch device, return early — `#touch-controls` stays `display:none`\n- If touch device, set `#touch-controls` to `display:block` and build the DOM\n\n**DOM construction in `init()`:**\nBuild inside `#touch-controls` container (already added to index.html):\n```\n<div class=\"touch-dpad\">\n  <button class=\"dpad-up\" aria-label=\"Move up\">▲</button>\n  <button class=\"dpad-left\" aria-label=\"Move left\">◀</button>\n  <div class=\"dpad-center\"></div>\n  <button class=\"dpad-right\" aria-label=\"Move right\">▶</button>\n  <button class=\"dpad-down\" aria-label=\"Move down\">▼</button>\n</div>\n<button class=\"touch-bomb\" aria-label=\"Place bomb\">💣</button>\n```\n\n**Touch event mapping:**\n- D-pad buttons map to the SAME key codes used by keyboard in `js/events.js`:\n  - Up: keyCode 38 (up arrow)\n  - Down: keyCode 40 (down arrow)\n  - Left: keyCode 37 (left arrow)\n  - Right: keyCode 39 (right arrow)\n- Bomb button maps to keyCode 32 (space bar)\n\n**On `touchstart` for each dpad button:**\n1. Call `event.preventDefault()` to avoid mouse emulation\n2. Check `isSpectating` — if true, return (same guard as `onKeyDown`)\n3. Set `keyState[keyCode] = true` (using the global `keyState` array from `js/globals.js`)\n4. Call `sendSocketMessage(\"KD\" + keyCode)` — identical to what `onKeyDown()` does\n\n**On `touchend` / `touchcancel` for each dpad button:**\n1. `event.preventDefault()`\n2. Set `keyState[keyCode] = false`\n3. Call `sendSocketMessage(\"KU\" + keyCode)`\n\n**For bomb button — `touchstart` only (tap, not hold):**\n1. `event.preventDefault()`\n2. Check `isSpectating`\n3. Set `keyState[32] = true` then immediately `keyState[32] = false`\n4. Call `sendSocketMessage(\"KD32\")`\n5. After small delay (50ms), call `sendSocketMessage(\"KU32\")`\n\n**Multi-touch support:**\n- Use `touchstart`/`touchend` per-element (not global) so multiple fingers work\n- Each button tracks its own touch independently\n\n**Integration with `js/initworld.js`:**\nAdd at the end of the `initWorld()` function (after event listeners): `if (typeof TouchControls !== 'undefined') TouchControls.init();`\n\n**Acceptance criteria:**\n- D-pad and bomb overlay appear only on touch-capable devices\n- Pressing D-pad directions moves the player exactly like arrow keys\n- Pressing bomb button places a bomb exactly like spacebar\n- Multi-touch works (hold direction + tap bomb)\n- Spectating state is respected (no input when dead)\n- No console errors on desktop (graceful fallback)",
          "status": "done",
          "priority": "high",
          "assignee": "developer-2",
          "assigneeRole": "developer",
          "dependencies": [
            "task-1",
            "task-2"
          ],
          "files": [
            "js/touch-controls.js",
            "js/initworld.js"
          ],
          "branch": "agent/developer-2",
          "createdBy": "ceo",
          "checkResult": "Created js/touch-controls.js: TouchControls IIFE that detects touch devices, builds D-pad (up/down/left/right buttons with arrow glyphs) and bomb button DOM inside #touch-controls container. Touch events map to same keyCodes as keyboard (37-40 arrows, 32 space). Supports multi-touch per-element, respects isSpectating guard, bomb uses tap with 50ms release delay. Added TouchControls.init() call at end of initWorld() in initworld.js.",
          "createdAt": 1772000910826,
          "updatedAt": 1772001444922
        },
        {
          "id": "task-4",
          "title": "Explosion/death visual feedback",
          "description": "Add visual feedback when the local player is caught in an explosion or killed: red flash overlay and canvas shake.\n\n**Modify file: `js/hud.js`**\n\nAdd two new methods to the `HUD` IIFE:\n\n1. **`showExplosionFeedback()`** — called when local player is hit by explosion or killed\n   - Show `#explosion-flash` div (already added to `index.html` by task-1) with `display:block`\n   - Add CSS class `flash-active` to trigger the animation\n   - After 300ms, remove the class and set `display:none`\n   - Apply canvas shake: add class `shake-active` to `#viewport`\n   - After 300ms, remove `shake-active`\n\n2. Update existing `showDeathNotice()` (line ~140) to also call `showExplosionFeedback()` for death events\n\n**Modify file: `js/aks.js`**\n\nIn the `BE` (bomb explode) handler (line ~56-70), after `bomb.explode()`:\n- Check if the current player is within the explosion range\n- The explosion affects cells from bomb position outward in 4 directions (sup/down/left/right cells)\n- Check if `currentPlayer` is alive and their cell position overlaps any explosion cell\n- If overlap detected: call `HUD.showExplosionFeedback()`\n\nAlternatively, simpler approach: in the `PK` (player killed) handler (line ~182-195), when `id === currentPlayer.id`, call `HUD.showExplosionFeedback()` before setting `isSpectating = true`.\n\nAlso: for near-miss feedback (optional but recommended), in the `BE` handler, calculate if `currentPlayer` tile is adjacent to any explosion cell (within 1 tile) and call a lighter version `HUD.showExplosionFeedback()`.\n\n**Modify file: `css/hud.css`**\n\nAdd CSS for the explosion flash and canvas shake:\n\n```css\n/* Explosion red flash overlay */\n#explosion-flash {\n  position: absolute;\n  top: 0; left: 0; right: 0; bottom: 0;\n  background: rgba(255, 0, 0, 0.35);\n  pointer-events: none;\n  z-index: 500;\n  opacity: 0;\n}\n#explosion-flash.flash-active {\n  animation: explosion-flash 300ms ease-out forwards;\n}\n@keyframes explosion-flash {\n  0% { opacity: 1; }\n  100% { opacity: 0; }\n}\n\n/* Canvas shake */\n#viewport.shake-active {\n  animation: canvas-shake 300ms ease-out;\n}\n@keyframes canvas-shake {\n  0%, 100% { transform: translate(0, 0); }\n  10% { transform: translate(-3px, 2px); }\n  20% { transform: translate(3px, -2px); }\n  30% { transform: translate(-2px, -3px); }\n  40% { transform: translate(2px, 3px); }\n  50% { transform: translate(-3px, 1px); }\n  60% { transform: translate(3px, -1px); }\n  70% { transform: translate(-1px, 3px); }\n  80% { transform: translate(1px, -3px); }\n  90% { transform: translate(-2px, 2px); }\n}\n```\n\n**Acceptance criteria:**\n- When player is killed (PK message for local player), red flash + shake occurs\n- Flash is ~300ms semi-transparent red overlay\n- Shake is subtle (2-3px translate jitter) for ~300ms\n- Effects don't interfere with game input or other overlays\n- No visual artifacts after animation completes",
          "status": "done",
          "priority": "medium",
          "assignee": "developer-1",
          "assigneeRole": "developer",
          "dependencies": [
            "task-1"
          ],
          "files": [
            "js/hud.js",
            "js/aks.js",
            "css/hud.css"
          ],
          "branch": "agent/developer-1",
          "createdBy": "ceo",
          "checkResult": "Added explosion/death visual feedback. CSS: #explosion-flash with 300ms red overlay animation, #viewport.shake-active with 300ms subtle translate jitter. JS: HUD.showExplosionFeedback() triggers both flash+shake with reflow-based animation restart. showDeathNotice() now calls showExplosionFeedback() for death events. Also added explosion proximity detection in BE handler — checks if currentPlayer tile overlaps bomb center or any of the 4 explosion directions (sup/down/left/right) and triggers feedback when caught in blast.",
          "createdAt": 1772000930067,
          "updatedAt": 1772001596966
        },
        {
          "id": "task-5",
          "title": "Chat message cap and smart auto-scroll",
          "description": "Implement chat message cap at ~100 messages and smart auto-scroll that pauses when user manually scrolls up.\n\n**Modify file: `js/chat.js`**\n\n1. **Message cap constant:**\n   Add at top: `var CHAT_MAX_MESSAGES = 100;`\n\n2. **Cap function:**\n   Create `pruneOldMessages()`:\n   ```js\n   function pruneOldMessages() {\n     var chatList = document.getElementById(\"listChat\");\n     var endchat = document.getElementById(\"endchat\");\n     if (!chatList) return;\n     // Count all li children except #endchat\n     var items = chatList.querySelectorAll(\"li:not(#endchat)\");\n     while (items.length > CHAT_MAX_MESSAGES) {\n       chatList.removeChild(items[0]);\n       items = chatList.querySelectorAll(\"li:not(#endchat)\");\n     }\n   }\n   ```\n   Call `pruneOldMessages()` at the end of `addmessagetochat()`.\n\n3. **Smart auto-scroll state:**\n   Add global: `var chatAutoScroll = true;`\n\n4. **Scroll detection:**\n   Add scroll listener setup function `initChatScroll()` (called once on game start from `initWorld()` or when chat becomes visible):\n   ```js\n   function initChatScroll() {\n     var chatList = document.getElementById(\"listChat\");\n     if (!chatList) return;\n     chatList.addEventListener(\"scroll\", function() {\n       var atBottom = (chatList.scrollTop + chatList.clientHeight >= chatList.scrollHeight - 5);\n       chatAutoScroll = atBottom;\n     });\n   }\n   ```\n\n5. **Update `addmessagetochat()` (line 37-55):**\n   Replace the existing auto-scroll at the end (lines 51-54) with:\n   ```js\n   pruneOldMessages();\n   if (chatAutoScroll) {\n     chatList.scrollTop = chatList.scrollHeight;\n   }\n   ```\n\n**Modify file: `js/aks.js`**\n\nUpdate `addKillToChat()` function (line 398-406):\n- Add `pruneOldMessages()` call after inserting the element\n- Replace the auto-scroll with the same `chatAutoScroll` check:\n  ```js\n  pruneOldMessages();\n  if (typeof chatAutoScroll !== 'undefined' && chatAutoScroll) {\n    chatList.scrollTop = chatList.scrollHeight;\n  }\n  ```\n\n**Integration:**\nCall `initChatScroll()` from `initWorld()` in `js/initworld.js`, or from the `gameStart` socket handler in `js/aks.js` (when chat div becomes visible).\n\n**Acceptance criteria:**\n- Chat never exceeds ~100 messages — oldest are removed when limit exceeded\n- New messages auto-scroll to bottom by default\n- If user scrolls up, auto-scroll pauses (new messages appear but scroll position preserved)\n- When user scrolls back to bottom, auto-scroll resumes\n- Kill feed messages also respect the same cap and scroll behavior\n- No flickering or janky scroll on message addition",
          "status": "done",
          "priority": "medium",
          "assignee": "developer-1",
          "assigneeRole": "developer",
          "dependencies": [],
          "files": [
            "js/chat.js",
            "js/aks.js",
            "js/initworld.js"
          ],
          "branch": "agent/developer-1",
          "createdBy": "ceo",
          "checkResult": "Added chat message cap at 100 messages with pruneOldMessages() that removes oldest li elements. Implemented smart auto-scroll: chatAutoScroll flag + scroll listener in initChatScroll() pauses auto-scroll when user scrolls up, resumes when back at bottom. Updated both addmessagetochat() and addKillToChat() to prune and respect scroll state. initChatScroll() called from gameStart handler and initWorld().",
          "createdAt": 1772000943748,
          "updatedAt": 1772001299329
        },
        {
          "id": "task-6",
          "title": "Chat filter buttons logic",
          "description": "Implement the chat filter button toggle logic. The five filter buttons already exist in `index.html` (lines 260-276) and have CSS in `css/styles.css` (lines 5895-5953). They are currently non-functional.\n\n**Create file: `js/chat-filters.js`**\n\nCreate a `ChatFilters` IIFE/object:\n\n1. **Filter state:**\n   ```js\n   var activeFilter = 'all'; // 'all' | 'text' | 'kill' | 'mod' | 'common'\n   ```\n\n2. **Message categorization — modify message creation:**\n   Update `addmessagetochat()` in `js/chat.js` to add `data-category=\"chat\"` attribute to each `<li>`.\n   Update `addKillToChat()` in `js/aks.js` to add `data-category=\"kill\"` attribute to each kill `<li>`.\n\n3. **`init()` method:**\n   - Query all filter buttons inside `.chat-filters`\n   - Map button classes to categories:\n     - `.filter-all` → 'all' (show everything)\n     - `.text` buttons → 'text' (show only chat messages, data-category=\"chat\")\n     - `.kill` button → 'kill' (show only kills, data-category=\"kill\")\n     - `.mod` button → 'mod' (show only mod messages, data-category=\"mod\")\n     - `.common` button → 'common' (show only common messages, data-category=\"common\")\n   - Add `click` event listener to each button\n   - On click: set `activeFilter`, toggle `.selected` class on buttons (remove from all, add to clicked), call `applyFilter()`\n\n4. **`applyFilter()` method:**\n   ```js\n   function applyFilter() {\n     var chatList = document.getElementById(\"listChat\");\n     if (!chatList) return;\n     var items = chatList.querySelectorAll(\"li:not(#endchat)\");\n     for (var i = 0; i < items.length; i++) {\n       var category = items[i].getAttribute(\"data-category\") || \"chat\";\n       if (activeFilter === 'all') {\n         items[i].style.display = '';\n       } else if (activeFilter === 'text' && category === 'chat') {\n         items[i].style.display = '';\n       } else if (activeFilter === 'kill' && category === 'kill') {\n         items[i].style.display = '';\n       } else if (activeFilter === category) {\n         items[i].style.display = '';\n       } else {\n         items[i].style.display = 'none';\n       }\n     }\n   }\n   ```\n\n5. **Auto-apply on new messages:**\n   Export a `onNewMessage()` method that applies the current filter to newly added messages. Call this from `addmessagetochat()` and `addKillToChat()` after the element is inserted.\n\n**Modify file: `js/chat.js`**\n- In `addmessagetochat()`, add `elem.setAttribute(\"data-category\", \"chat\");` before inserting\n- After inserting, call `if (typeof ChatFilters !== 'undefined') ChatFilters.onNewMessage(elem);`\n\n**Modify file: `js/aks.js`**\n- In `addKillToChat()`, add `elem.setAttribute(\"data-category\", \"kill\");` before inserting\n- After inserting, call `if (typeof ChatFilters !== 'undefined') ChatFilters.onNewMessage(elem);`\n\n**Initialization:**\nCall `ChatFilters.init()` when chat panel becomes visible — either in `gameStart` handler in `js/aks.js` or at DOMContentLoaded.\n\n**Acceptance criteria:**\n- Clicking \"CHAT\" (filter-all) shows all messages\n- Clicking `.kill` filter shows only kill feed messages, hides chat\n- Clicking `.text` filter shows only chat messages, hides kill feed\n- Active filter button gets `.selected` class (already styled)\n- New messages respect current filter (hidden if filtered out)\n- Filter state persists until changed by user",
          "status": "done",
          "priority": "medium",
          "assignee": "developer-2",
          "assigneeRole": "developer",
          "dependencies": [
            "task-1"
          ],
          "files": [
            "js/chat-filters.js",
            "js/chat.js",
            "js/aks.js"
          ],
          "branch": "agent/developer-2",
          "createdBy": "ceo",
          "checkResult": "Created js/chat-filters.js with ChatFilters IIFE. Filter buttons (.filter-all, .text, .kill, .mod, .common) toggle active filter and .selected class. applyFilter() shows/hides chat list items by data-category attribute. onNewMessage() applies filter to newly added messages. Modified chat.js to add data-category=\"chat\" to chat messages. Modified aks.js to add data-category=\"kill\" to kill feed entries. Both call ChatFilters.onNewMessage after insertion. Initializes on DOMContentLoaded.",
          "createdAt": 1772000959955,
          "updatedAt": 1772001597141
        },
        {
          "id": "task-7",
          "title": "Improve nickname labels legibility on canvas",
          "description": "Enhance the existing player nickname labels rendered on the game canvas to be more legible against varied map backgrounds.\n\n**Current implementation (in `js/initworld.js`, lines 106-133):**\nThe `interval()` function already draws player nicknames above sprites using `fosfo1.ctx` with a black shadow + white text. This works but can be hard to read on bright or busy backgrounds.\n\n**Modify file: `js/initworld.js`**\n\nImprove the nickname rendering block (lines 106-133) inside the `interval()` function:\n\n1. **Add a background pill/badge behind the text:**\n   Before drawing the text for each player:\n   ```js\n   var textWidth = ctx.measureText(p.nickname).width;\n   var badgePadding = 3;\n   var badgeHeight = 14;\n   // Draw rounded rect background\n   ctx.fillStyle = \"rgba(0, 0, 0, 0.55)\";\n   var bx = px - textWidth / 2 - badgePadding;\n   var by = py - badgeHeight + 2;\n   var bw = textWidth + badgePadding * 2;\n   var bh = badgeHeight;\n   ctx.beginPath();\n   ctx.roundRect(bx, by, bw, bh, 3);\n   ctx.fill();\n   ```\n   Then draw the white text on top (no shadow needed since the badge provides contrast).\n\n2. **Handle `ctx.roundRect` fallback** — `roundRect` may not exist on older browsers. Add a polyfill helper at the top of the file:\n   ```js\n   function drawRoundRect(ctx, x, y, w, h, r) {\n     if (ctx.roundRect) { ctx.beginPath(); ctx.roundRect(x, y, w, h, r); ctx.fill(); return; }\n     ctx.beginPath();\n     ctx.moveTo(x + r, y);\n     ctx.lineTo(x + w - r, y);\n     ctx.arcTo(x + w, y, x + w, y + r, r);\n     ctx.lineTo(x + w, y + h - r);\n     ctx.arcTo(x + w, y + h, x + w - r, y + h, r);\n     ctx.lineTo(x + r, y + h);\n     ctx.arcTo(x, y + h, x, y + h - r, r);\n     ctx.lineTo(x, y + r);\n     ctx.arcTo(x, y, x + r, y, r);\n     ctx.fill();\n   }\n   ```\n\n3. **Apply same badge rendering for world-wrap duplicates** (the `dup` loop on lines 123-130).\n\n4. **Highlight current player's name** with a slightly different color (e.g., `rgba(0, 100, 200, 0.6)` badge background for self).\n\n**Acceptance criteria:**\n- Nickname labels have a dark semi-transparent badge behind text\n- Labels are clearly readable against all 3 map themes (default, winter, moon)\n- Current player's label is visually distinct (different badge color)\n- Labels update correctly on player movement\n- World-wrap duplicate labels also have badges\n- No rendering performance regression (keep it simple, no complex paths)",
          "status": "done",
          "priority": "medium",
          "assignee": "developer-1",
          "assigneeRole": "developer",
          "dependencies": [],
          "files": [
            "js/initworld.js"
          ],
          "branch": "agent/developer-1",
          "createdBy": "ceo",
          "checkResult": "Added drawRoundRect() polyfill at top of initworld.js for cross-browser support. Replaced shadow+white text nickname rendering with dark semi-transparent badge pill (rgba(0,0,0,0.55)) behind white text. Current player's badge uses distinct blue (rgba(0,100,200,0.6)). Same badge rendering applied to world-wrap duplicate labels. No performance regression — simple measureText + fillRect per player per frame.",
          "createdAt": 1772000974994,
          "updatedAt": 1772001329399
        }
      ],
      "stats": {
        "todo": 0,
        "in_progress": 0,
        "to_check": 0,
        "done": 7,
        "total": 7
      },
      "testChecks": [
        {
          "id": "task2-css-file",
          "category": "Touch Controls",
          "title": "Touch controls CSS file exists and has correct structure",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772001194931,
          "sprintNumber": 4
        },
        {
          "id": "task1-aria",
          "category": "Accessibility",
          "title": "Task 1: ARIA attributes on index.html",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772001744854,
          "sprintNumber": 4
        },
        {
          "id": "task5-chat-cap",
          "category": "Functionality",
          "title": "Task 5: Chat message cap and smart auto-scroll",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772001946694,
          "sprintNumber": 4
        },
        {
          "id": "task1-page-loads",
          "category": "Accessibility",
          "title": "Page loads with ARIA attributes visible in DOM",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772001285237,
          "sprintNumber": 4
        },
        {
          "id": "task7-nickname-labels",
          "category": "Layout",
          "title": "Task 7: Nickname label legibility",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772002005564,
          "sprintNumber": 4
        },
        {
          "id": "integration-lobby-flow",
          "category": "Integration",
          "title": "Lobby flow: nickname → skin → play → room browser",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772001395723,
          "sprintNumber": 4
        },
        {
          "id": "task3-touch-controls",
          "category": "Touch Controls",
          "title": "Touch controls JS logic - code review and browser test",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772001444306,
          "sprintNumber": 4
        },
        {
          "id": "task4-explosion",
          "category": "Functionality",
          "title": "Task 4: Explosion/death visual feedback",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772001887681,
          "sprintNumber": 4
        },
        {
          "id": "task6-chat-filters",
          "category": "Functionality",
          "title": "Task 6: Chat filter buttons logic",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772001986020,
          "sprintNumber": 4
        },
        {
          "id": "integration-full-flow",
          "category": "Integration",
          "title": "Full flow: lobby → room → create → waiting room (game server)",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772001593871,
          "sprintNumber": 4
        },
        {
          "id": "integration-final",
          "category": "Integration",
          "title": "Final integration test - all features combined",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772001654013,
          "sprintNumber": 4
        },
        {
          "id": "task2-touch-css",
          "category": "Layout",
          "title": "Task 2: Touch controls CSS styling",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772001789651,
          "sprintNumber": 4
        },
        {
          "id": "task3-touch-js",
          "category": "Functionality",
          "title": "Task 3: Touch controls JS logic",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772001835828,
          "sprintNumber": 4
        },
        {
          "id": "integration-load",
          "category": "Integration",
          "title": "App loads without JS errors from sprint changes",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772002032989,
          "sprintNumber": 4
        },
        {
          "id": "integration-lobby",
          "category": "Integration",
          "title": "Lobby interaction still works",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772002060296,
          "sprintNumber": 4
        },
        {
          "id": "integration-chat-combined",
          "category": "Integration",
          "title": "Chat filters + cap + scroll work together",
          "status": "passed",
          "error": null,
          "fix": null,
          "timestamp": 1772002083850,
          "sprintNumber": 4
        }
      ],
      "startedAt": 1772000772698,
      "completedAt": 1772002398204
    }
  ]
}